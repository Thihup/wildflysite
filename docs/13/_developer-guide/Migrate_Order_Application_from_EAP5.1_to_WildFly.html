<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Migrate_order_application_from_eap5.1_to_wildfly | Wildfly</title>
<meta name="generator" content="Jekyll v3.8.3" />
<meta property="og:title" content="Migrate_order_application_from_eap5.1_to_wildfly" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Porting the Order Application from EAP 5.1 to WildFly {wildflyVersion}" />
<meta property="og:description" content="Porting the Order Application from EAP 5.1 to WildFly {wildflyVersion}" />
<link rel="canonical" href="https://jbossorg.github.io/wildflysite/docs/13/_developer-guide/Migrate_Order_Application_from_EAP5.1_to_WildFly.html" />
<meta property="og:url" content="https://jbossorg.github.io/wildflysite/docs/13/_developer-guide/Migrate_Order_Application_from_EAP5.1_to_WildFly.html" />
<meta property="og:site_name" content="Wildfly" />
<script type="application/ld+json">
{"description":"Porting the Order Application from EAP 5.1 to WildFly {wildflyVersion}","@type":"WebPage","url":"https://jbossorg.github.io/wildflysite/docs/13/_developer-guide/Migrate_Order_Application_from_EAP5.1_to_WildFly.html","headline":"Migrate_order_application_from_eap5.1_to_wildfly","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/wildflysite/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://jbossorg.github.io/wildflysite/feed.xml" title="Wildfly" /></head>
<body><div class="header navigation">
  <div class="logo-wrapper">
    <a href="/wildflysite/"><img class="wf-logo" src="/wildflysite/assets/img/wildfly_icons_one-color-logo.png"></a>
  </div>
  <div class="nav-container">
    <nav>
      <div class="nav-mobile"><a id="nav-toggle" href="#!"><span></span></a></div>
      <ul class="nav-list">
        <li>
          <a href="/wildflysite/" class="">Home</a>
        </li>
        <li>
          <a href="/wildflysite/downloads/" class="">Downloads</a>
        </li>
        <li>
          <a href="/wildflysite/blog/" class="">Blog</a>
        </li>
        <li>
          <a href="/wildflysite/about/" class="">About</a>
        </li>
        <li>
          <a href="/wildflysite/contribute/" class="">Contribute</a>
        </li>
        <li>
          <a href="/wildflysite/docs/" class="">Docs</a>
        </li>
        <li>
          <a class="button-cta secondary" href="https://github.com/wildfly/wildfly/fork" target="_blank">Fork</a>
        </li>
      </ul>
    </nav>
  </div>
</div>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <div class="sect1">
<h2 id="Migrate_Order_Application_from_EAP5">Porting the Order Application from EAP 5.1 to WildFly {wildflyVersion}</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Andy Miller ported an example Order application that was used for
performance testing from EAP 5.1 to WildFly {wildflyVersion}. These are the notes he
made during the migration process.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="overview-of-the-application">Overview of the application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The application is relatively simple. it contains three servlets, some
stateless session beans, a stateful session bean, and some entities.</p>
</div>
<div class="paragraph">
<p>In addition to application code changes, modifications were made to the
way the EAR was packaged. This is because WildFly removed support of
some proprietary features that were available in EAP 5.1.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="summary-of-changes">Summary of changes</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="code-changes">Code Changes</h3>
<div class="sect3">
<h4 id="modify-jndi-lookup-code">Modify JNDI lookup code</h4>
<div class="paragraph">
<p>Since this application was first written for EAP 4.2/4.3, which did not
support EJB reference injection, the servlets were using pre-EE 5
methods for looking up stateless and stateful session bean interfaces.
While migrating to WildFly, it seemed a good time to change the code to
use the @EJB annotation, although this was not a required change.</p>
</div>
<div class="paragraph">
<p>The real difference is in the lookup name. WildFly only supports the new
EE 6 portable JNDI names rather than the old EAR structure based names.
The JNDI lookup code changed as follows:</p>
</div>
<div class="paragraph">
<p>Example of code in the EAP 5.1 version:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">try {
    context = new InitialContext();
    distributionCenterManager = (DistributionCenterManager) context.lookup("OrderManagerApp/DistributionCenterManagerBean/local");
} catch(Exception lookupError) {
    throw new ServletException("Couldn't find DistributionCenterManager bean", lookupError);
}
try {
    customerManager = (CustomerManager) context.lookup("OrderManagerApp/CustomerManagerBean/local");
} catch(Exception lookupError) {
    throw new ServletException("Couldn't find CustomerManager bean", lookupError);
}
 
try {
    productManager = (ProductManager) context.lookup("OrderManagerApp/ProductManagerBean/local");
} catch(Exception lookupError) {
    throw new ServletException("Couldn't find the ProductManager bean", lookupError);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Example of how this is now coded in WildFly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@EJB(lookup="java:app/OrderManagerEJB/DistributionCenterManagerBean!services.ejb.DistributionCenterManager")
private DistributionCenterManager distributionCenterManager;
 
@EJB(lookup="java:app/OrderManagerEJB/CustomerManagerBean!services.ejb.CustomerManager")
private CustomerManager customerManager;
 
@EJB(lookup="java:app/OrderManagerEJB/ProductManagerBean!services.ejb.ProductManager")
private ProductManager productManager;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In addition to the change to injection, which was supported in EAP
5.1.0, the lookup name changed from:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">OrderManagerApp/DistributionCenterManagerBean/local</code></pre>
</div>
</div>
<div class="paragraph">
<p>to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">java:app/OrderManagerEJB/DistributionCenterManagerBean!services.ejb.DistributionCenterManager</code></pre>
</div>
</div>
<div class="paragraph">
<p>All the other beans were changed in a similar manner. They are now based
on the portable JNDI names described in EE 6.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="modify-logging-code">Modify logging code</h3>
<div class="paragraph">
<p>The next major change was to logging within the application. The old
version was using the commons logging infrastructure and Log4J that is
bundled in the application server. Rather than bundling third-party
logging, the application was modified to use the new WildFly Logging
infrastructure.</p>
</div>
<div class="paragraph">
<p>The code changes themselves are rather trivial, as this example
illustrates:</p>
</div>
<div class="paragraph">
<p>Old JBoss Commons Logging/Log4J:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">private static Log log = LogFactory.getLog(CustomerManagerBean.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>New WildFly Logging</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">private static Logger logger = Logger.getLogger(CustomerManagerBean.class.toString());</code></pre>
</div>
</div>
<div class="paragraph">
<p>Old JBoss Commons Logging/Log4J:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">if(log.isTraceEnabled()) {
    log.trace("Just flushed " + batchSize + " rows to the database.");
    log.trace("Total rows flushed is " + (i+1));
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>New WildFly Logging:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">if(logger.isLoggable(Level.TRACE)) {
    logger.log(Level.TRACE, "Just flushed " + batchSize + " rows to the database.");
    logger.log(Level.TRACE, "Total rows flushed is " + (i+1));
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In addition to the code changes made to use the new AS7 JBoss log
manager module, you must add this dependency to the <code>MANIFEST.MF</code> file
as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Manifest-Version: 1.0
Dependencies: org.jboss.logmanager</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="modify-the-code-to-use-infinispan-for-2nd-level-cache">Modify the code to use Infinispan for 2nd level cache</h3>
<div class="paragraph">
<p>Jboss Cache has been replaced by Infinispan for 2nd level cache. This
requires modification of the <code>persistence.xml</code> file.</p>
</div>
<div class="paragraph">
<p>This is what the file looked like in EAP 5.1:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">&lt;properties&gt;
&lt;property name="hibernate.cache.region.factory_class" value="org.hibernate.cache.jbc2.JndiMultiplexedJBossCacheRegionFactory"/&gt;
&lt;property name="hibernate.cache.region.jbc2.cachefactory" value="java:CacheManager"/&gt;
&lt;property name="hibernate.cache.use_second_level_cache" value="true"/&gt;
&lt;property name="hibernate.cache.use_query_cache" value="false"/&gt;
&lt;property name="hibernate.cache.use_minimal_puts" value="true"/&gt;
&lt;property name="hibernate.cache.region.jbc2.cfg.entity" value="mvcc-entity"/&gt;
&lt;property name="hibernate.cache.region_prefix" value="services"/&gt;
&lt;/properties&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is how it was modified to use Infinispan for the same
configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">&lt;properties&gt;
&lt;property name="hibernate.cache.use_second_level_cache" value="true"/&gt;
&lt;property name="hibernate.cache.use_minimal_puts" value="true"/&gt;
&lt;/properties&gt;
&lt;shared-cache-mode&gt;ENABLE_SELECTIVE&lt;/shared-cache-mode&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Most of the properties are removed since they will default to the
correct values for the second level cache. See
<a href="https://docs.jboss.org/author/display/AS71/JPA+Reference+Guide#JPAReferenceGuide-UsingtheInfinispansecondlevelcache">"Using
the Infinispan second level cache"</a> for more details.</p>
</div>
<div class="paragraph">
<p>That was the extent of the code changes required to migrate the
application to AS7.</p>
</div>
</div>
<div class="sect2">
<h3 id="ear-packaging-changes">EAR Packaging Changes</h3>
<div class="paragraph">
<p>Due to modular class loading changes, the structure of the existing EAR
failed to deploy successfully in WildFly.</p>
</div>
<div class="paragraph">
<p>The old structure of the EAR was as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">$ jar tf OrderManagerApp.ear
META-INF/MANIFEST.MF
META-INF/application.xml
OrderManagerWeb.war
OrderManagerEntities.jar
OrderManagerEJB.jar
META-INF/</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this structure, the entities and the <code>persistence.xml</code> were in one
jar file, <code>OrderManagerEntities.jar</code>, and the stateless and stateful
session beans were in another jar file, <code>OrderManagerEJB.jar</code>. This did
not work due to modular class loading changes in WildFly. There are a
couple of ways to resolve this issue:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Modify the class path in the <code>MANIFEST.MF</code></p>
</li>
<li>
<p>Flatten the code and put all the beans in one JAR file.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The second approach was selected because it simplified the EAR
structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">$ jar tf OrderManagerApp.ear
META-INF/application.xml
OrderManagerWeb.war
OrderManagerEJB.jar
META-INF/</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since there is no longer an <code>OrderManagerEntities.jar</code> file, the
<code>applcation.xml</code> file was modified to remove the entry.</p>
</div>
<div class="paragraph">
<p>An entry was added to the <code>MANIFEST.MF</code> file in the
<code>OrderManagerWeb.war</code> to resolve another class loading issue resulting
from the modification to use EJB reference injection in the servlets.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Manifest-Version: 1.0
Dependencies: org.jboss.logmanager
Class-Path: OrderManagerEJB.jar</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>Class-Path</code> entry tells the application to look in the
<code>OrderManagerEJB.jar</code> file for the injected beans.</p>
</div>
</div>
<div class="sect2">
<h3 id="summary">Summary</h3>
<div class="paragraph">
<p>Although the existing EAR structure could have worked with additional
modifications to the <code>MANIFEST.MF</code> file, this approach seemed more
appealing because it simplified the structure while maintaining the web
tier in its own WAR.</p>
</div>
<div class="paragraph">
<p>The source files for both versions is attached so you can view the
changes that were made to the application.</p>
</div>
</div>
</div>
</div>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/wildflysite/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Wildfly</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Wildfly</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/wildfly"><svg class="svg-icon"><use xlink:href="/wildflysite/assets/minima-social-icons.svg#github"></use></svg> <span class="username">wildfly</span></a></li><li><a href="https://www.twitter.com/WildFlyAS"><svg class="svg-icon"><use xlink:href="/wildflysite/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">WildFlyAS</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p></p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
