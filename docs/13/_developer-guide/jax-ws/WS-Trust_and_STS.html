<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.5.0 -->
<title>WS-Trust and STS | Wildfly</title>
<meta name="generator" content="Jekyll v3.8.3" />
<meta property="og:title" content="WS-Trust and STS" />
<meta property="og:locale" content="en_US" />
<link rel="canonical" href="https://jbossorg.github.io/wildflysite/docs/13/_developer-guide/jax-ws/WS-Trust_and_STS.html" />
<meta property="og:url" content="https://jbossorg.github.io/wildflysite/docs/13/_developer-guide/jax-ws/WS-Trust_and_STS.html" />
<meta property="og:site_name" content="Wildfly" />
<script type="application/ld+json">
{"@type":"WebPage","url":"https://jbossorg.github.io/wildflysite/docs/13/_developer-guide/jax-ws/WS-Trust_and_STS.html","headline":"WS-Trust and STS","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/wildflysite/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://jbossorg.github.io/wildflysite/feed.xml" title="Wildfly" /></head>
<body><div class="header navigation">
  <div class="logo-wrapper">
    <a href="/wildflysite/"><img class="wf-logo" src="/wildflysite/assets/img/wildfly_icons_one-color-logo.png"></a>
  </div>
  <div class="nav-container">
    <nav>
      <div class="nav-mobile"><a id="nav-toggle" href="#!"><span></span></a></div>
      <ul class="nav-list">
        <li>
          <a href="/wildflysite/" class="">Home</a>
        </li>
        <li>
          <a href="/wildflysite/downloads/" class="">Downloads</a>
        </li>
        <li>
          <a href="/wildflysite/blog/" class="">Blog</a>
        </li>
        <li>
          <a href="/wildflysite/about/" class="">About</a>
        </li>
        <li>
          <a href="/wildflysite/contribute/" class="">Contribute</a>
        </li>
        <li>
          <a href="/wildflysite/docs/" class="">Docs</a>
        </li>
        <li>
          <a class="button-cta secondary" href="https://github.com/wildfly/wildfly/fork" target="_blank">Fork</a>
        </li>
      </ul>
    </nav>
  </div>
</div>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <div class="sect1">
<h2 id="ws-trust-overview">WS-Trust overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://www.oasis-open.org/standards#wstrustv1.4">WS-Trust</a> is a Web
service specification that defines extensions to WS-Security. It is a
general framework for implementing security in a distributed system. The
standard is based on a centralized Security Token Service, STS, which is
capable of authenticating clients and issuing tokens containing various
kinds of authentication and authorization data. The specification
describes a protocol used for issuance, exchange, and validation of
security tokens, however the following specifications play an important
role in the WS-Trust architecture:
<a href="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702/ws-securitypolicy-1.2-spec-os.html">WS-SecurityPolicy
1.2</a>,
<a href="http://docs.oasis-open.org/security/saml/v2.0/saml-core-2.0-os.pdf">SAML
2.0</a>,
<a href="http://docs.oasis-open.org/wss/v1.1/wss-v1.1-spec-os-UsernameTokenProfile.pdf">Username
Token Profile</a>,
<a href="http://docs.oasis-open.org/wss-m/wss/v1.1.1/wss-x509TokenProfile-v1.1.1.html">X.509
Token Profile</a>,
<a href="https://www.oasis-open.org/committees/download.php/16768/wss-v1.1-spec-os-SAMLTokenProfile.pdf">SAML
Token Profile</a>, and
<a href="http://docs.oasis-open.org/wss/v1.1/wss-v1.1-spec-os-KerberosTokenProfile.pdf">Kerberos
Token Profile</a>.</p>
</div>
<div class="paragraph">
<p>The WS-Trust extensions address the needs of applications that span
multiple domains and requires the sharing of security keys by providing
a standards based trusted third party web service (STS) to broker trust
relationships between a Web service requester and a Web service
provider. This architecture also alleviates the pain of service updates
that require credential changes by providing a common location for this
information. The STS is the common access point from which both the
requester and provider retrieves and verifies security tokens.</p>
</div>
<div class="paragraph">
<p>There are three main components of the WS-Trust specification.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The Security Token Service (STS), a web service that issues, renews,
and validates security tokens.</p>
</li>
<li>
<p>The message formats for security token requests and responses.</p>
</li>
<li>
<p>The mechanisms for key exchange</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="security-token-service">Security Token Service</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Security Token Service, STS, is the core of the WS-Trust
specification. It is a standards based mechanism for authentication and
authorization. The STS is an implementation of the WS-Trust
specification&#8217;s protocol for issuing, exchanging, and validating
security tokens, based on token format, namespace, or trust boundaries.
The STS is a web service that acts as a trusted third party to broker
trust relationships between a Web service requester and a Web service
provider. It is a common access point trusted by both requester and
provider to provide interoperable security tokens. It removes the need
for a direct relationship between the two. Because the STS is a
standards based mechanism for authentication, it helps ensure
interoperability across realms and between different platforms.</p>
</div>
<div class="paragraph">
<p>The STS&#8217;s WSDL contract defines how other applications and processes
interact with it. In particular the WSDL defines the WS-Trust and
WS-Security policies that a requester must fulfill in order to
successfully communicate with the STS&#8217;s endpoints. A web service
requester consumes the STS&#8217;s WSDL and with the aid of an STSClient
utility, generates a message request compliant with the stated security
policies and submits it to the STS endpoint. The STS validates the
request and returns an appropriate response.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="apache-cxf-support">Apache CXF support</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Apache CXF is an open-source, fully featured Web services framework. The
JBossWS open source project integrates the JBoss Web Services (JBossWS)
stack with the Apache CXF project modules thus providing WS-Trust and
other JAX-WS functionality in WildFly. This integration makes it easy to
deploy CXF STS implementations, however WildFly can run any WS-Trust
compliant STS. In addition the Apache CXF API provides a STSClient
utility to facilitate web service requester communication with its STS.</p>
</div>
<div class="paragraph">
<p>Detailed information about the Apache CXF&#8217;s WS-Trust implementation can
be found
<a href="http://coheigea.blogspot.it/2011/10/apache-cxf-sts-documentation-part-i.html">here</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="a-basic-ws-trust-scenario">A Basic WS-Trust Scenario</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Here is an example of a basic WS-Trust scenario. It is comprised of a
Web service requester (ws-requester), a Web service provider
(ws-provider), and a Security Token Service (STS). The ws-provider
requires a SAML 2.0 token issued from a designed STS to be presented by
the ws-requester using asymmetric binding. These communication
requirements are declared in the ws-provider&#8217;s WSDL. The STS requires
ws-requester credentials be provided in a WSS UsernameToken format
request using symmetric binding. The STS&#8217;s response is provided
containing a SAML 2.0 token. These communication requirements are
declared in the STS&#8217;s WSDL.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A ws-requester contacts the ws-provider and consumes its WSDL. Upon
finding the security token issuer requirement, it creates and configures
a STSClient with the information it requires to generate a proper
request.</p>
</li>
<li>
<p>The STSClient contacts the STS and consumes its WSDL. The security
policies are discovered. The STSClient creates and sends an
authentication request, with appropriate credentials.</p>
</li>
<li>
<p>The STS verifies the credentials.</p>
</li>
<li>
<p>In response, the STS issues a security token that provides proof
that the ws-requester has authenticated with the STS.</p>
</li>
<li>
<p>The STClient presents a message with the security token to the
ws-provider.</p>
</li>
<li>
<p>The ws-provider verifies the token was issued by the STS, thus
proving the ws-requester has successfully authenticated with the STS.</p>
</li>
<li>
<p>The ws-provider executes the requested service and returns the
results to the the ws-requester.</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="web-service-provider">Web service provider</h3>
<div class="paragraph">
<p>This section examines the crucial elements in providing endpoint
security in the web service provider described in the basic WS-Trust
scenario. The components that will be discussed are.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>web service provider&#8217;s WSDL</p>
</li>
<li>
<p>web service provider&#8217;s Interface and Implementation classes.</p>
</li>
<li>
<p>ServerCallbackHandler class</p>
</li>
<li>
<p>Crypto properties and keystore files</p>
</li>
<li>
<p>MANIFEST.MF</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="web-service-provider-wsdl">Web service provider WSDL</h4>
<div class="paragraph">
<p>The web service provider is a contract-first endpoint. All the WS-trust
and security policies for it are declared in the WSDL,
SecurityService.wsdl. For this scenario a ws-requester is required to
present a SAML 2.0 token issued from a designed STS. The address of the
STS is provided in the WSDL. An asymmetric binding policy is used to
encrypt and sign the SOAP body of messages that pass back and forth
between ws-requester and ws-provider. X.509 certificates are use for the
asymmetric binding. The rules for sharing the public and private keys in
the SOAP request and response messages are declared. A detailed
explanation of the security settings are provided in the comments in the
listing below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml"> &lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;
&lt;definitions targetNamespace="http://www.jboss.org/jbossws/ws-extensions/wssecuritypolicy" name="SecurityService"
        xmlns:tns="http://www.jboss.org/jbossws/ws-extensions/wssecuritypolicy"
        xmlns:xsd="http://www.w3.org/2001/XMLSchema"
        xmlns:soap="http://schemas.xmlsoap.org/wsdl/soap/"
        xmlns="http://schemas.xmlsoap.org/wsdl/"
        xmlns:wsp="http://www.w3.org/ns/ws-policy"
        xmlns:wsam="http://www.w3.org/2007/05/addressing/metadata"
        xmlns:wsu="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd"
        xmlns:wsaws="http://www.w3.org/2005/08/addressing"
        xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"
        xmlns:t="http://docs.oasis-open.org/ws-sx/ws-trust/200512"&gt;
  &lt;types&gt;
    &lt;xsd:schema&gt;
      &lt;xsd:import namespace="http://www.jboss.org/jbossws/ws-extensions/wssecuritypolicy" schemaLocation="SecurityService_schema1.xsd"/&gt;
    &lt;/xsd:schema&gt;
  &lt;/types&gt;
  &lt;message name="sayHello"&gt;
    &lt;part name="parameters" element="tns:sayHello"/&gt;
  &lt;/message&gt;
  &lt;message name="sayHelloResponse"&gt;
    &lt;part name="parameters" element="tns:sayHelloResponse"/&gt;
  &lt;/message&gt;
  &lt;portType name="ServiceIface"&gt;
    &lt;operation name="sayHello"&gt;
      &lt;input message="tns:sayHello"/&gt;
      &lt;output message="tns:sayHelloResponse"/&gt;
    &lt;/operation&gt;
  &lt;/portType&gt;
  &lt;!--
        The wsp:PolicyReference binds the security requirments on all the STS endpoints.
        The wsp:Policy wsu:Id="#AsymmetricSAML2Policy" element is defined later in this file.
  --&gt;
  &lt;binding name="SecurityServicePortBinding" type="tns:ServiceIface"&gt;
    &lt;wsp:PolicyReference URI="#AsymmetricSAML2Policy" /&gt;
    &lt;soap:binding transport="http://schemas.xmlsoap.org/soap/http" style="document"/&gt;
    &lt;operation name="sayHello"&gt;
      &lt;soap:operation soapAction=""/&gt;
      &lt;input&gt;
        &lt;soap:body use="literal"/&gt;
        &lt;wsp:PolicyReference URI="#Input_Policy" /&gt;
      &lt;/input&gt;
      &lt;output&gt;
        &lt;soap:body use="literal"/&gt;
        &lt;wsp:PolicyReference URI="#Output_Policy" /&gt;
      &lt;/output&gt;
    &lt;/operation&gt;
  &lt;/binding&gt;
  &lt;service name="SecurityService"&gt;
    &lt;port name="SecurityServicePort" binding="tns:SecurityServicePortBinding"&gt;
      &lt;soap:address location="http://@jboss.bind.address@:8080/jaxws-samples-wsse-policy-trust/SecurityService"/&gt;
    &lt;/port&gt;
  &lt;/service&gt;

  &lt;wsp:Policy wsu:Id="AsymmetricSAML2Policy"&gt;
        &lt;wsp:ExactlyOne&gt;
            &lt;wsp:All&gt;
  &lt;!--
        The wsam:Addressing element, indicates that the endpoints of this
        web service MUST conform to the WS-Addressing specification.  The
        attribute wsp:Optional="false" enforces this assertion.
  --&gt;
                &lt;wsam:Addressing wsp:Optional="false"&gt;
                    &lt;wsp:Policy /&gt;
                &lt;/wsam:Addressing&gt;
  &lt;!--
        The sp:AsymmetricBinding element indicates that security is provided
        at the SOAP layer. A public/private key combinations is required to
        protect the message.  The initiator will use it's private key to sign
        the message and the recipient's public key is used to encrypt the message.
        The recipient of the message will use it's private key to decrypt it and
        initiator's public key to verify the signature.
  --&gt;
                &lt;sp:AsymmetricBinding&gt;
                    &lt;wsp:Policy&gt;
  &lt;!--
        The sp:InitiatorToken element specifies the elements required in
        generating the initiator request to the ws-provider's service.
  --&gt;
                        &lt;sp:InitiatorToken&gt;
                            &lt;wsp:Policy&gt;
  &lt;!--
        The sp:IssuedToken element asserts that a SAML 2.0 security token is
        expected from the STS using a public key type.  The
        sp:IncludeToken="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702/IncludeToken/AlwaysToRecipient"&gt;
        attribute instructs the runtime to include the initiator's public key
        with every message sent to the recipient.

        The sp:RequestSecurityTokenTemplate element directs that all of the
        children of this element will be copied directly into the body of the
        RequestSecurityToken (RST) message that is sent to the STS when the
        initiator asks the STS to issue a token.
  --&gt;
                                &lt;sp:IssuedToken
                                    sp:IncludeToken="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702/IncludeToken/AlwaysToRecipient"&gt;
                                    &lt;sp:RequestSecurityTokenTemplate&gt;
                                        &lt;t:TokenType&gt;http://docs.oasis-open.org/wss/oasis-wss-saml-token-profile-1.1#SAMLV2.0&lt;/t:TokenType&gt;
                                        &lt;t:KeyType&gt;http://docs.oasis-open.org/ws-sx/ws-trust/200512/PublicKey&lt;/t:KeyType&gt;
                                    &lt;/sp:RequestSecurityTokenTemplate&gt;
                                    &lt;wsp:Policy&gt;
                                        &lt;sp:RequireInternalReference /&gt;
                                    &lt;/wsp:Policy&gt;
  &lt;!--
        The sp:Issuer element defines the STS's address and endpoint information
        This information is used by the STSClient.
  --&gt;
                                    &lt;sp:Issuer&gt;
                                        &lt;wsaws:Address&gt;http://@jboss.bind.address@:8080/jaxws-samples-wsse-policy-trust-sts/SecurityTokenService&lt;/wsaws:Address&gt;
                                        &lt;wsaws:Metadata xmlns:wsdli="http://www.w3.org/2006/01/wsdl-instance"
                                                        wsdli:wsdlLocation="http://@jboss.bind.address@:8080/jaxws-samples-wsse-policy-trust-sts/SecurityTokenService?wsdl"&gt;
                                            &lt;wsaw:ServiceName xmlns:wsaw="http://www.w3.org/2006/05/addressing/wsdl"
                                                            xmlns:stsns="http://docs.oasis-open.org/ws-sx/ws-trust/200512/"
                                                            EndpointName="UT_Port"&gt;stsns:SecurityTokenService&lt;/wsaw:ServiceName&gt;
                                        &lt;/wsaws:Metadata&gt;
                                    &lt;/sp:Issuer&gt;
                                &lt;/sp:IssuedToken&gt;
                            &lt;/wsp:Policy&gt;
                        &lt;/sp:InitiatorToken&gt;
  &lt;!--
        The sp:RecipientToken element asserts the type of public/private key-pair
        expected from the recipient.  The
        sp:IncludeToken="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702/IncludeToken/Never"&gt;
        attribute indicates that the initiator's public key will never be included
        in the reply messages.
 
        The sp:WssX509V3Token10 element indicates that an X509 Version 3 token
        should be used in the message.
  --&gt;
                        &lt;sp:RecipientToken&gt;
                            &lt;wsp:Policy&gt;
                                &lt;sp:X509Token
                                    sp:IncludeToken="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702/IncludeToken/Never"&gt;
                                    &lt;wsp:Policy&gt;
                                        &lt;sp:WssX509V3Token10 /&gt;
                                        &lt;sp:RequireIssuerSerialReference /&gt;
                                    &lt;/wsp:Policy&gt;
                                &lt;/sp:X509Token&gt;
                            &lt;/wsp:Policy&gt;
                        &lt;/sp:RecipientToken&gt;
&lt;!--
     The sp:Layout element,  indicates the layout rules to apply when adding
     items to the security header.  The sp:Lax sub-element indicates items
     are added to the security header in any order that conforms to
     WSS: SOAP Message Security.
--&gt;
                        &lt;sp:Layout&gt;
                            &lt;wsp:Policy&gt;
                                &lt;sp:Lax /&gt;
                            &lt;/wsp:Policy&gt;
                        &lt;/sp:Layout&gt;
                        &lt;sp:IncludeTimestamp /&gt;
                        &lt;sp:OnlySignEntireHeadersAndBody /&gt;
 &lt;!--
     The sp:AlgorithmSuite element, requires the Basic256 algorithm suite
     be used in performing cryptographic operations.
--&gt;
                        &lt;sp:AlgorithmSuite&gt;
                            &lt;wsp:Policy&gt;
                                &lt;sp:Basic256 /&gt;
                            &lt;/wsp:Policy&gt;
                        &lt;/sp:AlgorithmSuite&gt;
                    &lt;/wsp:Policy&gt;
                &lt;/sp:AsymmetricBinding&gt;
&lt;!--
    The sp:Wss11 element declares WSS: SOAP Message Security 1.1 options
    to be supported by the STS.  These particular elements generally refer
    to how keys are referenced within the SOAP envelope.  These are normally
    handled by CXF.
--&gt;
                &lt;sp:Wss11&gt;
                    &lt;wsp:Policy&gt;
                        &lt;sp:MustSupportRefIssuerSerial /&gt;
                        &lt;sp:MustSupportRefThumbprint /&gt;
                        &lt;sp:MustSupportRefEncryptedKey /&gt;
                    &lt;/wsp:Policy&gt;
                &lt;/sp:Wss11&gt;
&lt;!--
    The sp:Trust13 element declares controls for WS-Trust 1.3 options.
    They are policy assertions related to exchanges specifically with
    client and server challenges and entropy behaviors.  Again these are
    normally handled by CXF.
--&gt;
                &lt;sp:Trust13&gt;
                    &lt;wsp:Policy&gt;
                        &lt;sp:MustSupportIssuedTokens /&gt;
                        &lt;sp:RequireClientEntropy /&gt;
                        &lt;sp:RequireServerEntropy /&gt;
                    &lt;/wsp:Policy&gt;
                &lt;/sp:Trust13&gt;
            &lt;/wsp:All&gt;
        &lt;/wsp:ExactlyOne&gt;
    &lt;/wsp:Policy&gt;

    &lt;wsp:Policy wsu:Id="Input_Policy"&gt;
        &lt;wsp:ExactlyOne&gt;
            &lt;wsp:All&gt;
                &lt;sp:EncryptedParts&gt;
                    &lt;sp:Body /&gt;
                &lt;/sp:EncryptedParts&gt;
                &lt;sp:SignedParts&gt;
                    &lt;sp:Body /&gt;
                    &lt;sp:Header Name="To" Namespace="http://www.w3.org/2005/08/addressing" /&gt;
                    &lt;sp:Header Name="From" Namespace="http://www.w3.org/2005/08/addressing" /&gt;
                    &lt;sp:Header Name="FaultTo" Namespace="http://www.w3.org/2005/08/addressing" /&gt;
                    &lt;sp:Header Name="ReplyTo" Namespace="http://www.w3.org/2005/08/addressing" /&gt;
                    &lt;sp:Header Name="MessageID" Namespace="http://www.w3.org/2005/08/addressing" /&gt;
                    &lt;sp:Header Name="RelatesTo" Namespace="http://www.w3.org/2005/08/addressing" /&gt;
                    &lt;sp:Header Name="Action" Namespace="http://www.w3.org/2005/08/addressing" /&gt;
                &lt;/sp:SignedParts&gt;
            &lt;/wsp:All&gt;
        &lt;/wsp:ExactlyOne&gt;
    &lt;/wsp:Policy&gt;

    &lt;wsp:Policy wsu:Id="Output_Policy"&gt;
        &lt;wsp:ExactlyOne&gt;
            &lt;wsp:All&gt;
                &lt;sp:EncryptedParts&gt;
                    &lt;sp:Body /&gt;
                &lt;/sp:EncryptedParts&gt;
                &lt;sp:SignedParts&gt;
                    &lt;sp:Body /&gt;
                    &lt;sp:Header Name="To" Namespace="http://www.w3.org/2005/08/addressing" /&gt;
                    &lt;sp:Header Name="From" Namespace="http://www.w3.org/2005/08/addressing" /&gt;
                    &lt;sp:Header Name="FaultTo" Namespace="http://www.w3.org/2005/08/addressing" /&gt;
                    &lt;sp:Header Name="ReplyTo" Namespace="http://www.w3.org/2005/08/addressing" /&gt;
                    &lt;sp:Header Name="MessageID" Namespace="http://www.w3.org/2005/08/addressing" /&gt;
                    &lt;sp:Header Name="RelatesTo" Namespace="http://www.w3.org/2005/08/addressing" /&gt;
                    &lt;sp:Header Name="Action" Namespace="http://www.w3.org/2005/08/addressing" /&gt;
                &lt;/sp:SignedParts&gt;
            &lt;/wsp:All&gt;
        &lt;/wsp:ExactlyOne&gt;
    &lt;/wsp:Policy&gt;
&lt;/definitions&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="web-service-provider-interface">Web service provider Interface</h4>
<div class="paragraph">
<p>The web service provider interface class, ServiceIface, is a simple
straight forward web service definition.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package org.jboss.test.ws.jaxws.samples.wsse.policy.trust.service;
 
import javax.jws.WebMethod;
import javax.jws.WebService;
 
@WebService
(
   targetNamespace = "http://www.jboss.org/jbossws/ws-extensions/wssecuritypolicy"
)
public interface ServiceIface
{
   @WebMethod
   String sayHello();
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="web-service-provider-implementation">Web service provider Implementation</h4>
<div class="paragraph">
<p>The web service provider implementation class, ServiceImpl, is a simple
POJO. It uses the standard WebService annotation to define the service
endpoint. In addition there are two Apache CXF annotations,
EndpointProperties and EndpointProperty used for configuring the
endpoint for the CXF runtime. These annotations come from the
<a href="https://ws.apache.org/wss4j/">Apache WSS4J project</a>, which provides a
Java implementation of the primary WS-Security standards for Web
Services. These annotations are programmatically adding properties to
the endpoint. With plain Apache CXF, these properties are often set via
the &lt;jaxws:properties&gt; element on the &lt;jaxws:endpoint&gt; element in the
Spring config; these annotations allow the properties to be configured
in the code.</p>
</div>
<div class="paragraph">
<p>WSS4J uses the Crypto interface to get keys and certificates for
encryption/decryption and for signature creation/verification. As is
asserted by the WSDL, X509 keys and certificates are required for this
service. The WSS4J configuration information being provided by
ServiceImpl is for Crypto&#8217;s Merlin implementation. More information will
be provided about this in the keystore section.</p>
</div>
<div class="paragraph">
<p>The first EndpointProperty statement in the listing is declaring the
user&#8217;s name to use for the message signature. It is used as the alias
name in the keystore to get the user&#8217;s cert and private key for
signature. The next two EndpointProperty statements declares the Java
properties file that contains the (Merlin) crypto configuration
information. In this case both for signing and encrypting the messages.
WSS4J reads this file and extra required information for message
handling. The last EndpointProperty statement declares the
ServerCallbackHandler implementation class. It is used to obtain the
user&#8217;s password for the certificates in the keystore file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package org.jboss.test.ws.jaxws.samples.wsse.policy.trust.service;
 
import javax.jws.WebService;
 
import org.apache.cxf.annotations.EndpointProperties;
import org.apache.cxf.annotations.EndpointProperty;
 
@WebService
(
   portName = "SecurityServicePort",
   serviceName = "SecurityService",
   wsdlLocation = "WEB-INF/wsdl/SecurityService.wsdl",
   targetNamespace = "http://www.jboss.org/jbossws/ws-extensions/wssecuritypolicy",
   endpointInterface = "org.jboss.test.ws.jaxws.samples.wsse.policy.trust.service.ServiceIface"
)
@EndpointProperties(value = {
      @EndpointProperty(key = "ws-security.signature.username", value = "myservicekey"),
      @EndpointProperty(key = "ws-security.signature.properties", value = "serviceKeystore.properties"),
      @EndpointProperty(key = "ws-security.encryption.properties", value = "serviceKeystore.properties"),
      @EndpointProperty(key = "ws-security.callback-handler", value = "org.jboss.test.ws.jaxws.samples.wsse.policy.trust.service.ServerCallbackHandler")
})
public class ServiceImpl implements ServiceIface
{
   public String sayHello()
   {
      return "WS-Trust Hello World!";
   }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="servercallbackhandler">ServerCallbackHandler</h4>
<div class="paragraph">
<p>ServerCallbackHandler is a callback handler for the WSS4J Crypto API. It
is used to obtain the password for the private key in the keystore. This
class enables CXF to retrieve the password of the user name to use for
the message signature. A certificates' password is not discoverable. The
creator of the certificate must record the password he assigns and
provide it when requested through the CallbackHandler. In this scenario
skpass is the password for user myservicekey.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java"> package org.jboss.test.ws.jaxws.samples.wsse.policy.trust.service;
 
import java.util.HashMap;
import java.util.Map;
 
import org.jboss.wsf.stack.cxf.extensions.security.PasswordCallbackHandler;
 
public class ServerCallbackHandler extends PasswordCallbackHandler
{
 
   public ServerCallbackHandler()
   {
      super(getInitMap());
   }
 
   private static Map&lt;String, String&gt; getInitMap()
   {
      Map&lt;String, String&gt; passwords = new HashMap&lt;String, String&gt;();
      passwords.put("myservicekey", "skpass");
      return passwords;
   }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="crypto-properties-and-keystore-files">Crypto properties and keystore files</h4>
<div class="paragraph">
<p>WSS4J&#8217;s Crypto implementation is loaded and configured via a Java
properties file that contains Crypto configuration data. The file
contains implementation-specific properties such as a keystore location,
password, default alias and the like. This application is using the
Merlin implementation. File serviceKeystore.properties contains this
information.</p>
</div>
<div class="paragraph">
<p>File servicestore.jks, is a Java KeyStore (JKS) repository. It contains
self signed certificates for myservicekey and mystskey. <em>Self signed
certificates are not appropriate for production use.</em></p>
</div>
<div class="literalblock">
<div class="content">
<pre>org.apache.ws.security.crypto.provider=org.apache.ws.security.components.crypto.Merlin
org.apache.ws.security.crypto.merlin.keystore.type=jks
org.apache.ws.security.crypto.merlin.keystore.password=sspass
org.apache.ws.security.crypto.merlin.keystore.alias=myservicekey
org.apache.ws.security.crypto.merlin.keystore.file=servicestore.jks</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="manifest.mf">MANIFEST.MF</h4>
<div class="paragraph">
<p>When deployed on WildFly this application requires access to the JBossWs
and CXF APIs provided in module org.jboss.ws.cxf.jbossws-cxf-client. The
dependency statement directs the server to provide them at deployment.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Manifest-Version: 1.0
Ant-Version: Apache Ant 1.8.2
Created-By: 1.7.0_25-b15 (Oracle Corporation)
Dependencies: org.jboss.ws.cxf.jbossws-cxf-client</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="security-token-service-sts">Security Token Service (STS)</h3>
<div class="paragraph">
<p>This section examines the crucial elements in providing the Security
Token Service functionality described in the basic WS-Trust scenario.
The components that will be discussed are.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>STS&#8217;s WSDL</p>
</li>
<li>
<p>STS&#8217;s implementation class.</p>
</li>
<li>
<p>STSCallbackHandler class</p>
</li>
<li>
<p>Crypto properties and keystore files</p>
</li>
<li>
<p>MANIFEST.MF</p>
</li>
<li>
<p>Server configuration files</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="sts-wsdl">STS WSDL</h4>
<div class="paragraph">
<p>The STS is a contract-first endpoint. All the WS-trust and security
policies for it are declared in the WSDL, ws-trust-1.4-service.wsdl. A
symmetric binding policy is used to encrypt and sign the SOAP body of
messages that pass back and forth between ws-requester and the STS. The
ws-requester is required to authenticate itself by providing WSS
UsernameToken credentials. The rules for sharing the public and private
keys in the SOAP request and response messages are declared. A detailed
explanation of the security settings are provided in the comments in the
listing below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml"> &lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;wsdl:definitions
        targetNamespace="http://docs.oasis-open.org/ws-sx/ws-trust/200512/"
        xmlns:tns="http://docs.oasis-open.org/ws-sx/ws-trust/200512/"
        xmlns:wstrust="http://docs.oasis-open.org/ws-sx/ws-trust/200512/"
        xmlns:wsdl="http://schemas.xmlsoap.org/wsdl/"
        xmlns:soap="http://schemas.xmlsoap.org/wsdl/soap/"
        xmlns:wsap10="http://www.w3.org/2006/05/addressing/wsdl"
        xmlns:wsu="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd"
        xmlns:wsp="http://www.w3.org/ns/ws-policy"
    xmlns:wst="http://docs.oasis-open.org/ws-sx/ws-trust/200512"
    xmlns:xs="http://www.w3.org/2001/XMLSchema"
    xmlns:wsam="http://www.w3.org/2007/05/addressing/metadata"&gt;
 
  &lt;wsdl:types&gt;
    &lt;xs:schema elementFormDefault="qualified" targetNamespace='http://docs.oasis-open.org/ws-sx/ws-trust/200512'&gt;
 
      &lt;xs:element name='RequestSecurityToken' type='wst:AbstractRequestSecurityTokenType' /&gt;
      &lt;xs:element name='RequestSecurityTokenResponse' type='wst:AbstractRequestSecurityTokenType' /&gt;
 
      &lt;xs:complexType name='AbstractRequestSecurityTokenType' &gt;
        &lt;xs:sequence&gt;
          &lt;xs:any namespace='##any' processContents='lax' minOccurs='0' maxOccurs='unbounded' /&gt;
        &lt;/xs:sequence&gt;
        &lt;xs:attribute name='Context' type='xs:anyURI' use='optional' /&gt;
        &lt;xs:anyAttribute namespace='##other' processContents='lax' /&gt;
      &lt;/xs:complexType&gt;
      &lt;xs:element name='RequestSecurityTokenCollection' type='wst:RequestSecurityTokenCollectionType' /&gt;
      &lt;xs:complexType name='RequestSecurityTokenCollectionType' &gt;
        &lt;xs:sequence&gt;
          &lt;xs:element name='RequestSecurityToken' type='wst:AbstractRequestSecurityTokenType' minOccurs='2' maxOccurs='unbounded'/&gt;
        &lt;/xs:sequence&gt;
      &lt;/xs:complexType&gt;
 
      &lt;xs:element name='RequestSecurityTokenResponseCollection' type='wst:RequestSecurityTokenResponseCollectionType' /&gt;
      &lt;xs:complexType name='RequestSecurityTokenResponseCollectionType' &gt;
        &lt;xs:sequence&gt;
          &lt;xs:element ref='wst:RequestSecurityTokenResponse' minOccurs='1' maxOccurs='unbounded' /&gt;
        &lt;/xs:sequence&gt;
        &lt;xs:anyAttribute namespace='##other' processContents='lax' /&gt;
      &lt;/xs:complexType&gt;
 
    &lt;/xs:schema&gt;
  &lt;/wsdl:types&gt;
 
  &lt;!-- WS-Trust defines the following GEDs --&gt;
  &lt;wsdl:message name="RequestSecurityTokenMsg"&gt;
    &lt;wsdl:part name="request" element="wst:RequestSecurityToken" /&gt;
  &lt;/wsdl:message&gt;
  &lt;wsdl:message name="RequestSecurityTokenResponseMsg"&gt;
    &lt;wsdl:part name="response"
            element="wst:RequestSecurityTokenResponse" /&gt;
  &lt;/wsdl:message&gt;
  &lt;wsdl:message name="RequestSecurityTokenCollectionMsg"&gt;
    &lt;wsdl:part name="requestCollection"
            element="wst:RequestSecurityTokenCollection"/&gt;
  &lt;/wsdl:message&gt;
  &lt;wsdl:message name="RequestSecurityTokenResponseCollectionMsg"&gt;
    &lt;wsdl:part name="responseCollection"
            element="wst:RequestSecurityTokenResponseCollection"/&gt;
  &lt;/wsdl:message&gt;
 
  &lt;!-- This portType an example of a Requestor (or other) endpoint that
         Accepts SOAP-based challenges from a Security Token Service --&gt;
  &lt;wsdl:portType name="WSSecurityRequestor"&gt;
    &lt;wsdl:operation name="Challenge"&gt;
      &lt;wsdl:input message="tns:RequestSecurityTokenResponseMsg"/&gt;
      &lt;wsdl:output message="tns:RequestSecurityTokenResponseMsg"/&gt;
    &lt;/wsdl:operation&gt;
  &lt;/wsdl:portType&gt;
 
 
  &lt;!-- This portType is an example of an STS supporting full protocol --&gt;
&lt;!--
    The wsdl:portType and data types are XML elements defined by the
    WS_Trust specification.  The wsdl:portType defines the endpoints
    supported in the STS implementation.  This WSDL defines all operations
    that an STS implementation can support.
--&gt;
  &lt;wsdl:portType name="STS"&gt;
    &lt;wsdl:operation name="Cancel"&gt;
      &lt;wsdl:input wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Cancel" message="tns:RequestSecurityTokenMsg"/&gt;
      &lt;wsdl:output wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RSTR/CancelFinal" message="tns:RequestSecurityTokenResponseMsg"/&gt;
    &lt;/wsdl:operation&gt;
    &lt;wsdl:operation name="Issue"&gt;
      &lt;wsdl:input wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Issue" message="tns:RequestSecurityTokenMsg"/&gt;
      &lt;wsdl:output wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RSTRC/IssueFinal" message="tns:RequestSecurityTokenResponseCollectionMsg"/&gt;
    &lt;/wsdl:operation&gt;
    &lt;wsdl:operation name="Renew"&gt;
      &lt;wsdl:input wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Renew" message="tns:RequestSecurityTokenMsg"/&gt;
      &lt;wsdl:output wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RSTR/RenewFinal" message="tns:RequestSecurityTokenResponseMsg"/&gt;
    &lt;/wsdl:operation&gt;
    &lt;wsdl:operation name="Validate"&gt;
      &lt;wsdl:input wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Validate" message="tns:RequestSecurityTokenMsg"/&gt;
      &lt;wsdl:output wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RSTR/ValidateFinal" message="tns:RequestSecurityTokenResponseMsg"/&gt;
    &lt;/wsdl:operation&gt;
    &lt;wsdl:operation name="KeyExchangeToken"&gt;
      &lt;wsdl:input wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/KET" message="tns:RequestSecurityTokenMsg"/&gt;
      &lt;wsdl:output wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RSTR/KETFinal" message="tns:RequestSecurityTokenResponseMsg"/&gt;
    &lt;/wsdl:operation&gt;
    &lt;wsdl:operation name="RequestCollection"&gt;
      &lt;wsdl:input message="tns:RequestSecurityTokenCollectionMsg"/&gt;
      &lt;wsdl:output message="tns:RequestSecurityTokenResponseCollectionMsg"/&gt;
    &lt;/wsdl:operation&gt;
  &lt;/wsdl:portType&gt;
 
  &lt;!-- This portType is an example of an endpoint that accepts
         Unsolicited RequestSecurityTokenResponse messages --&gt;
  &lt;wsdl:portType name="SecurityTokenResponseService"&gt;
    &lt;wsdl:operation name="RequestSecurityTokenResponse"&gt;
      &lt;wsdl:input message="tns:RequestSecurityTokenResponseMsg"/&gt;
    &lt;/wsdl:operation&gt;
  &lt;/wsdl:portType&gt;
 
&lt;!--
    The wsp:PolicyReference binds the security requirments on all the STS endpoints.
    The wsp:Policy wsu:Id="UT_policy" element is later in this file.
--&gt;
  &lt;wsdl:binding name="UT_Binding" type="wstrust:STS"&gt;
    &lt;wsp:PolicyReference URI="#UT_policy" /&gt;
      &lt;soap:binding style="document"
          transport="http://schemas.xmlsoap.org/soap/http" /&gt;
      &lt;wsdl:operation name="Issue"&gt;
          &lt;soap:operation
              soapAction="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Issue" /&gt;
          &lt;wsdl:input&gt;
              &lt;wsp:PolicyReference
               URI="#Input_policy" /&gt;
              &lt;soap:body use="literal" /&gt;
          &lt;/wsdl:input&gt;
          &lt;wsdl:output&gt;
              &lt;wsp:PolicyReference
               URI="#Output_policy" /&gt;
              &lt;soap:body use="literal" /&gt;
          &lt;/wsdl:output&gt;
      &lt;/wsdl:operation&gt;
      &lt;wsdl:operation name="Validate"&gt;
          &lt;soap:operation
              soapAction="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Validate" /&gt;
          &lt;wsdl:input&gt;
              &lt;wsp:PolicyReference
               URI="#Input_policy" /&gt;
              &lt;soap:body use="literal" /&gt;
          &lt;/wsdl:input&gt;
          &lt;wsdl:output&gt;
              &lt;wsp:PolicyReference
               URI="#Output_policy" /&gt;
              &lt;soap:body use="literal" /&gt;
          &lt;/wsdl:output&gt;
      &lt;/wsdl:operation&gt;
      &lt;wsdl:operation name="Cancel"&gt;
          &lt;soap:operation
              soapAction="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Cancel" /&gt;
          &lt;wsdl:input&gt;
              &lt;soap:body use="literal" /&gt;
          &lt;/wsdl:input&gt;
          &lt;wsdl:output&gt;
              &lt;soap:body use="literal" /&gt;
          &lt;/wsdl:output&gt;
      &lt;/wsdl:operation&gt;
      &lt;wsdl:operation name="Renew"&gt;
          &lt;soap:operation
              soapAction="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Renew" /&gt;
          &lt;wsdl:input&gt;
              &lt;soap:body use="literal" /&gt;
          &lt;/wsdl:input&gt;
          &lt;wsdl:output&gt;
              &lt;soap:body use="literal" /&gt;
          &lt;/wsdl:output&gt;
      &lt;/wsdl:operation&gt;
      &lt;wsdl:operation name="KeyExchangeToken"&gt;
          &lt;soap:operation
              soapAction="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/KeyExchangeToken" /&gt;
          &lt;wsdl:input&gt;
              &lt;soap:body use="literal" /&gt;
          &lt;/wsdl:input&gt;
          &lt;wsdl:output&gt;
              &lt;soap:body use="literal" /&gt;
          &lt;/wsdl:output&gt;
      &lt;/wsdl:operation&gt;
      &lt;wsdl:operation name="RequestCollection"&gt;
          &lt;soap:operation
              soapAction="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/RequestCollection" /&gt;
          &lt;wsdl:input&gt;
              &lt;soap:body use="literal" /&gt;
          &lt;/wsdl:input&gt;
          &lt;wsdl:output&gt;
              &lt;soap:body use="literal" /&gt;
          &lt;/wsdl:output&gt;
      &lt;/wsdl:operation&gt;
  &lt;/wsdl:binding&gt;

  &lt;wsdl:service name="SecurityTokenService"&gt;
      &lt;wsdl:port name="UT_Port" binding="tns:UT_Binding"&gt;
         &lt;soap:address location="http://localhost:8080/SecurityTokenService/UT" /&gt;
      &lt;/wsdl:port&gt;
  &lt;/wsdl:service&gt;

  &lt;wsp:Policy wsu:Id="UT_policy"&gt;
      &lt;wsp:ExactlyOne&gt;
         &lt;wsp:All&gt;
&lt;!--
    The sp:UsingAddressing element, indicates that the endpoints of this
    web service conforms to the WS-Addressing specification.  More detail
    can be found here: [http://www.w3.org/TR/2006/CR-ws-addr-wsdl-20060529]
--&gt;
            &lt;wsap10:UsingAddressing/&gt;
&lt;!--
    The sp:SymmetricBinding element indicates that security is provided
    at the SOAP layer and any initiator must authenticate itself by providing
    WSS UsernameToken credentials.
--&gt;
            &lt;sp:SymmetricBinding
               xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
               &lt;wsp:Policy&gt;
&lt;!--
    In a symmetric binding, the keys used for encrypting and signing in both
    directions are derived from a single key, the one specified by the
    sp:ProtectionToken element.  The sp:X509Token sub-element declares this
    key to be a X.509 certificate and the
    IncludeToken="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702/IncludeToken/Never"
    attribute adds the requirement that the token MUST NOT be included in
    any messages sent between the initiator and the recipient; rather, an
    external reference to the token should be used.  Lastly the WssX509V3Token10
    sub-element declares that the Username token presented by the initiator
    should be compliant with Web Services Security UsernameToken Profile
    1.0 specification. [ http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-username-token-profile-1.0.pdf ]
--&gt;
                  &lt;sp:ProtectionToken&gt;
                     &lt;wsp:Policy&gt;
                        &lt;sp:X509Token
                           sp:IncludeToken="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702/IncludeToken/Never"&gt;
                           &lt;wsp:Policy&gt;
                              &lt;sp:RequireDerivedKeys /&gt;
                              &lt;sp:RequireThumbprintReference /&gt;
                              &lt;sp:WssX509V3Token10 /&gt;
                           &lt;/wsp:Policy&gt;
                        &lt;/sp:X509Token&gt;
                     &lt;/wsp:Policy&gt;
                  &lt;/sp:ProtectionToken&gt;
&lt;!--
    The sp:AlgorithmSuite element, requires the Basic256 algorithm suite
    be used in performing cryptographic operations.
--&gt;
                  &lt;sp:AlgorithmSuite&gt;
                     &lt;wsp:Policy&gt;
                        &lt;sp:Basic256 /&gt;
                     &lt;/wsp:Policy&gt;
                  &lt;/sp:AlgorithmSuite&gt;
&lt;!--
    The sp:Layout element,  indicates the layout rules to apply when adding
    items to the security header.  The sp:Lax sub-element indicates items
    are added to the security header in any order that conforms to
    WSS: SOAP Message Security.
--&gt;
                  &lt;sp:Layout&gt;
                     &lt;wsp:Policy&gt;
                        &lt;sp:Lax /&gt;
                     &lt;/wsp:Policy&gt;
                  &lt;/sp:Layout&gt;
                  &lt;sp:IncludeTimestamp /&gt;
                  &lt;sp:EncryptSignature /&gt;
                  &lt;sp:OnlySignEntireHeadersAndBody /&gt;
               &lt;/wsp:Policy&gt;
            &lt;/sp:SymmetricBinding&gt;
&lt;!--
    The sp:SignedSupportingTokens element declares that the security header
    of messages must contain a sp:UsernameToken and the token must be signed.
    The attribute IncludeToken="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702/IncludeToken/AlwaysToRecipient"
    on sp:UsernameToken indicates that the token MUST be included in all
    messages sent from initiator to the recipient and that the token MUST
    NOT be included in messages sent from the recipient to the initiator.
    And finally the element sp:WssUsernameToken10 is a policy assertion
    indicating the Username token should be as defined in  Web Services
    Security UsernameToken Profile 1.0
--&gt;
            &lt;sp:SignedSupportingTokens
               xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
               &lt;wsp:Policy&gt;
                  &lt;sp:UsernameToken
                     sp:IncludeToken="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702/IncludeToken/AlwaysToRecipient"&gt;
                     &lt;wsp:Policy&gt;
                        &lt;sp:WssUsernameToken10 /&gt;
                     &lt;/wsp:Policy&gt;
                  &lt;/sp:UsernameToken&gt;
               &lt;/wsp:Policy&gt;
            &lt;/sp:SignedSupportingTokens&gt;
&lt;!--
    The sp:Wss11 element declares WSS: SOAP Message Security 1.1 options
    to be supported by the STS.  These particular elements generally refer
    to how keys are referenced within the SOAP envelope.  These are normally
    handled by CXF.
--&gt;
            &lt;sp:Wss11
               xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
               &lt;wsp:Policy&gt;
                  &lt;sp:MustSupportRefKeyIdentifier /&gt;
                  &lt;sp:MustSupportRefIssuerSerial /&gt;
                  &lt;sp:MustSupportRefThumbprint /&gt;
                  &lt;sp:MustSupportRefEncryptedKey /&gt;
               &lt;/wsp:Policy&gt;
            &lt;/sp:Wss11&gt;
&lt;!--
    The sp:Trust13 element declares controls for WS-Trust 1.3 options.
    They are policy assertions related to exchanges specifically with
    client and server challenges and entropy behaviors.  Again these are
    normally handled by CXF.
--&gt;
            &lt;sp:Trust13
               xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
               &lt;wsp:Policy&gt;
                  &lt;sp:MustSupportIssuedTokens /&gt;
                  &lt;sp:RequireClientEntropy /&gt;
                  &lt;sp:RequireServerEntropy /&gt;
               &lt;/wsp:Policy&gt;
            &lt;/sp:Trust13&gt;
         &lt;/wsp:All&gt;
      &lt;/wsp:ExactlyOne&gt;
   &lt;/wsp:Policy&gt;

   &lt;wsp:Policy wsu:Id="Input_policy"&gt;
      &lt;wsp:ExactlyOne&gt;
         &lt;wsp:All&gt;
            &lt;sp:SignedParts
               xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
               &lt;sp:Body /&gt;
               &lt;sp:Header Name="To"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
               &lt;sp:Header Name="From"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
               &lt;sp:Header Name="FaultTo"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
               &lt;sp:Header Name="ReplyTo"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
               &lt;sp:Header Name="MessageID"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
               &lt;sp:Header Name="RelatesTo"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
               &lt;sp:Header Name="Action"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
            &lt;/sp:SignedParts&gt;
            &lt;sp:EncryptedParts
               xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
               &lt;sp:Body /&gt;
            &lt;/sp:EncryptedParts&gt;
         &lt;/wsp:All&gt;
      &lt;/wsp:ExactlyOne&gt;
   &lt;/wsp:Policy&gt;

   &lt;wsp:Policy wsu:Id="Output_policy"&gt;
      &lt;wsp:ExactlyOne&gt;
         &lt;wsp:All&gt;
            &lt;sp:SignedParts
               xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
               &lt;sp:Body /&gt;
               &lt;sp:Header Name="To"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
               &lt;sp:Header Name="From"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
               &lt;sp:Header Name="FaultTo"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
               &lt;sp:Header Name="ReplyTo"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
               &lt;sp:Header Name="MessageID"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
               &lt;sp:Header Name="RelatesTo"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
               &lt;sp:Header Name="Action"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
            &lt;/sp:SignedParts&gt;
            &lt;sp:EncryptedParts
               xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
               &lt;sp:Body /&gt;
            &lt;/sp:EncryptedParts&gt;
         &lt;/wsp:All&gt;
      &lt;/wsp:ExactlyOne&gt;
   &lt;/wsp:Policy&gt;
 
&lt;/wsdl:definitions&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sts-implementation">STS Implementation</h4>
<div class="paragraph">
<p>The Apache CXF&#8217;s STS, SecurityTokenServiceProvider, is a web service
provider that is compliant with the protocols and functionality defined
by the WS-Trust specification. It has a modular architecture. Many of
its components are configurable or replaceable and there are many
optional features that are enabled by implementing and configuring
plug-ins. Users can customize their own STS by extending from
SecurityTokenServiceProvider and overriding the default settings.
Extensive information about the CXF&#8217;s STS configurable and pluggable
components can be found
<a href="http://coheigea.blogspot.com/2011/11/apache-cxf-sts-documentation-part-viii_10.html">here</a>.</p>
</div>
<div class="paragraph">
<p>This STS implementation class, SimpleSTS, is a POJO that extends from
SecurityTokenServiceProvider. Note that the class is defined with a
WebServiceProvider annotation and not a WebService annotation. This
annotation defines the service as a Provider-based endpoint, meaning it
supports a more messaging-oriented approach to Web services. In
particular, it signals that the exchanged messages will be XML documents
of some type. SecurityTokenServiceProvider is an implementation of the
javax.xml.ws.Provider interface. In comparison the WebService annotation
defines a (service endpoint interface) SEI-based endpoint which supports
message exchange via SOAP envelopes.</p>
</div>
<div class="paragraph">
<p>As was done in the ServiceImpl class, the WSS4J annotations
EndpointProperties and EndpointProperty are providing endpoint
configuration for the CXF runtime. This was previous described
<a href="#web-service-provider-implementation">here</a>.</p>
</div>
<div class="paragraph">
<p>The InInterceptors annotation is used to specify a JBossWS integration
interceptor to be used for authenticating incoming requests; JAAS
integration is used here for authentication, the username/passoword
coming from the UsernameToken in the ws-requester message are used for
authenticating the requester against a security domain on the
application server hosting the STS deployment.</p>
</div>
<div class="paragraph">
<p>In this implementation we are customizing the operations of token
issuance, token validation and their static properties.</p>
</div>
<div class="paragraph">
<p>StaticSTSProperties is used to set select properties for configuring
resources in the STS. You may think this is a duplication of the
settings made with the WSS4J annotations. The values are the same but
the underlaying structures being set are different, thus this
information must be declared in both places.</p>
</div>
<div class="paragraph">
<p>The setIssuer setting is important because it uniquely identifies the
issuing STS. The issuer string is embedded in issued tokens and, when
validating tokens, the STS checks the issuer string value. Consequently,
it is important to use the issuer string in a consistent way, so that
the STS can recognize the tokens that it has issued.</p>
</div>
<div class="paragraph">
<p>The setEndpoints call allows the declaration of a set of allowed token
recipients by address. The addresses are specified as reg-ex patterns.</p>
</div>
<div class="paragraph">
<p>TokenIssueOperation and TokenValidateOperation have a modular structure.
This allows custom behaviors to be injected into the processing of
messages. In this case we are overriding the
SecurityTokenServiceProvider&#8217;s default behavior and performing SAML
token processing and validation. CXF provides an implementation of a
SAMLTokenProvider and SAMLTokenValidator which we are using rather than
writing our own.</p>
</div>
<div class="paragraph">
<p>Learn more about the SAMLTokenProvider
<a href="http://coheigea.blogspot.it/2011/10/apache-cxf-sts-documentation-part-iv.html">here</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package org.jboss.test.ws.jaxws.samples.wsse.policy.trust;

import java.util.Arrays;
import java.util.LinkedList;
import java.util.List;

import javax.xml.ws.WebServiceProvider;

import org.apache.cxf.annotations.EndpointProperties;
import org.apache.cxf.annotations.EndpointProperty;
import org.apache.cxf.interceptor.InInterceptors;
import org.apache.cxf.sts.StaticSTSProperties;
import org.apache.cxf.sts.operation.TokenIssueOperation;
import org.apache.cxf.sts.operation.TokenValidateOperation;
import org.apache.cxf.sts.service.ServiceMBean;
import org.apache.cxf.sts.service.StaticService;
import org.apache.cxf.sts.token.provider.SAMLTokenProvider;
import org.apache.cxf.sts.token.validator.SAMLTokenValidator;
import org.apache.cxf.ws.security.sts.provider.SecurityTokenServiceProvider;

@WebServiceProvider(serviceName = "SecurityTokenService",
      portName = "UT_Port",
      targetNamespace = "http://docs.oasis-open.org/ws-sx/ws-trust/200512/",
      wsdlLocation = "WEB-INF/wsdl/ws-trust-1.4-service.wsdl")
@EndpointProperties(value = {
      @EndpointProperty(key = "ws-security.signature.username", value = "mystskey"),
      @EndpointProperty(key = "ws-security.signature.properties", value = "stsKeystore.properties"),
      @EndpointProperty(key = "ws-security.callback-handler", value = "org.jboss.test.ws.jaxws.samples.wsse.policy.trust.STSCallbackHandler"),
      //to let the JAAS integration deal with validation through the interceptor below
      @EndpointProperty(key = "ws-security.validate.token", value = "false")

})
@InInterceptors(interceptors = {"org.jboss.wsf.stack.cxf.security.authentication.SubjectCreatingPolicyInterceptor"})
public class SampleSTS extends SecurityTokenServiceProvider
{
   public SampleSTS() throws Exception
   {
      super();

      StaticSTSProperties props = new StaticSTSProperties();
      props.setSignaturePropertiesFile("stsKeystore.properties");
      props.setSignatureUsername("mystskey");
      props.setCallbackHandlerClass(STSCallbackHandler.class.getName());
      props.setIssuer("DoubleItSTSIssuer");

      List&lt;ServiceMBean&gt; services = new LinkedList&lt;ServiceMBean&gt;();
      StaticService service = new StaticService();
      service.setEndpoints(Arrays.asList(
              "http://localhost:(\\d)*/jaxws-samples-wsse-policy-trust/SecurityService",
              "http://\\[::1\\]:(\\d)*/jaxws-samples-wsse-policy-trust/SecurityService",
              "http://\\[0:0:0:0:0:0:0:1\\]:(\\d)*/jaxws-samples-wsse-policy-trust/SecurityService"
              ));
      services.add(service);

      TokenIssueOperation issueOperation = new TokenIssueOperation();
      issueOperation.setServices(services);
      issueOperation.getTokenProviders().add(new SAMLTokenProvider());
      issueOperation.setStsProperties(props);

      TokenValidateOperation validateOperation = new TokenValidateOperation();
      validateOperation.getTokenValidators().add(new SAMLTokenValidator());
      validateOperation.setStsProperties(props);

      this.setIssueOperation(issueOperation);
      this.setValidateOperation(validateOperation);
   }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="stscallbackhandler">STSCallbackHandler</h4>
<div class="paragraph">
<p>STSCallbackHandler is a callback handler for the WSS4J Crypto API. It is
used to obtain the password for the private key in the keystore. This
class enables CXF to retrieve the password of the user name to use for
the message signature.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package org.jboss.test.ws.jaxws.samples.wsse.policy.trust.sts;
 
import java.util.HashMap;
import java.util.Map;
 
import org.jboss.wsf.stack.cxf.extensions.security.PasswordCallbackHandler;
 
public class STSCallbackHandler extends PasswordCallbackHandler
{
   public STSCallbackHandler()
   {
      super(getInitMap());
   }
 
   private static Map&lt;String, String&gt; getInitMap()
   {
      Map&lt;String, String&gt; passwords = new HashMap&lt;String, String&gt;();
      passwords.put("mystskey", "stskpass");
      return passwords;
   }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="crypto-properties-and-keystore-files-1">Crypto properties and keystore files</h4>
<div class="paragraph">
<p>WSS4J&#8217;s Crypto implementation is loaded and configured via a Java
properties file that contains Crypto configuration data. The file
contains implementation-specific properties such as a keystore location,
password, default alias and the like. This application is using the
Merlin implementation. File stsKeystore.properties contains this
information.</p>
</div>
<div class="paragraph">
<p>File servicestore.jks, is a Java KeyStore (JKS) repository. It contains
self signed certificates for myservicekey and mystskey. <em>Self signed
certificates are not appropriate for production use.</em></p>
</div>
<div class="literalblock">
<div class="content">
<pre>org.apache.ws.security.crypto.provider=org.apache.ws.security.components.crypto.Merlin
org.apache.ws.security.crypto.merlin.keystore.type=jks
org.apache.ws.security.crypto.merlin.keystore.password=stsspass
org.apache.ws.security.crypto.merlin.keystore.file=stsstore.jks</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="manifest.mf-1">MANIFEST.MF</h4>
<div class="paragraph">
<p>When deployed on WildFly, this application requires access to the
JBossWs and CXF APIs provided in modules
org.jboss.ws.cxf.jbossws-cxf-client and org.apache.cxf. The Apache CXF
internals, org.apache.cxf.impl, are needed to build the STS
configuration in the <code>SampleSTS</code> constructor. The dependency statement
directs the server to provide them at deployment.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Manifest-Version: 1.0
Ant-Version: Apache Ant 1.8.2
Created-By: 1.7.0_25-b15 (Oracle Corporation)
Dependencies: org.jboss.ws.cxf.jbossws-cxf-client,org.apache.cxf.impl</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="security-domain">Security Domain</h4>
<div class="paragraph">
<p>The STS requires a JBoss security domain be configured. The
jboss-web.xml descriptor declares a named security
domain,"JBossWS-trust-sts" to be used by this service for
authentication. This security domain requires two properties files and
the addition of a security-domain declaration in the JBoss server
configuration file.</p>
</div>
<div class="paragraph">
<p>For this scenario the domain needs to contain user <em>alice</em>, password
<em>clarinet</em>, and role <em>friend</em>. See the listings below for
jbossws-users.properties and jbossws-roles.properties. In addition the
following XML must be added to the JBoss security subsystem in the
server configuration file. Replace " <strong>SOME_PATH</strong>" with appropriate
information.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml"> &lt;security-domain name="JBossWS-trust-sts"&gt;
  &lt;authentication&gt;
    &lt;login-module code="UsersRoles" flag="required"&gt;
      &lt;module-option name="usersProperties" value="/SOME_PATH/jbossws-users.properties"/&gt;
      &lt;module-option name="unauthenticatedIdentity" value="anonymous"/&gt;
      &lt;module-option name="rolesProperties" value="/SOME_PATH/jbossws-roles.properties"/&gt;
    &lt;/login-module&gt;
  &lt;/authentication&gt;
&lt;/security-domain&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>jboss-web.xml</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!DOCTYPE jboss-web PUBLIC "-//JBoss//DTD Web Application 2.4//EN" "&gt;
&lt;jboss-web&gt;
  &lt;security-domain&gt;java:/jaas/JBossWS-trust-sts&lt;/security-domain&gt;
&lt;/jboss-web&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>jbossws-users.properties</p>
</div>
<div class="literalblock">
<div class="content">
<pre># A sample users.properties file for use with the UsersRolesLoginModule
alice=clarinet</pre>
</div>
</div>
<div class="paragraph">
<p>jbossws-roles.properties</p>
</div>
<div class="literalblock">
<div class="content">
<pre># A sample roles.properties file for use with the UsersRolesLoginModule
alice=friend</pre>
</div>
</div>
<div class="paragraph">
<p>WS-MetadataExchange and interoperability</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
To achieve better interoperability, you might consider allowing the STS
endpoint to reply to WS-MetadataExchange messages directed to the <code>/mex</code>
URL sub-path (e.g.
<a href="http://localhost:8080/jaxws-samples-wsse-policy-trust-sts/SecurityTokenService/mex" class="bare">http://localhost:8080/jaxws-samples-wsse-policy-trust-sts/SecurityTokenService/mex</a>).
This can be done by tweaking the <em>url-pattern</em> for the underlying
endpoint servlet, for instance by adding a <em>web.xml</em> descriptor as
follows to the deployment:&lt;?xml version="1.0" encoding="UTF-8"?&gt;<br>
&lt;web-app<br>
version="2.5" xmlns="http://java.sun.com/xml/ns/javaee"<br>
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"<br>
xsi:schemaLocation="http://java.sun.com/xml/ns/javaee
<a href="http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd"&gt" class="bare">http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd"&gt</a>;<br>
&lt;servlet&gt;<br>
&lt;servlet-name&gt;TestSecurityTokenService&lt;/servlet-name&gt;<br>
&lt;servlet-class&gt;org.jboss.test.ws.jaxws.samples.wsse.policy.trust.SampleSTS&lt;/servlet-class&gt;<br>
&lt;/servlet&gt;<br>
&lt;servlet-mapping&gt;<br>
&lt;servlet-name&gt;TestSecurityTokenService&lt;/servlet-name&gt;<br>
&lt;url-pattern&gt;/SecurityTokenService/*&lt;/url-pattern&gt;<br>
&lt;/servlet-mapping&gt;<br>
&lt;/web-app&gt;<br>
As a matter of fact, at the time of writing some webservices
implementations (including <em>Metro</em>) assume the <code>/mex</code> URL as the default
choice for directing WS-MetadataExchange requests to and use that to
retrieve STS wsdl contracts.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="web-service-requester">Web service requester</h3>
<div class="paragraph">
<p>This section examines the crucial elements in calling a web service that
implements endpoint security as described in the basic WS-Trust
scenario. The components that will be discussed are.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>web service requester&#8217;s implementation</p>
</li>
<li>
<p>ClientCallbackHandler</p>
</li>
<li>
<p>Crypto properties and keystore files</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="web-service-requester-implementation">Web service requester Implementation</h4>
<div class="paragraph">
<p>The ws-requester, the client, uses standard procedures for creating a
reference to the web service in the first four line. To address the
endpoint security requirements, the web service&#8217;s "Request Context" is
configured with the information needed in message generation. In
addition, the STSClient that communicates with the STS is configured
with similar values. Note the key strings ending with a ".it" suffix.
This suffix flags these settings as belonging to the STSClient. The
internal CXF code assigns this information to the STSClient that is
auto-generated for this service call.</p>
</div>
<div class="paragraph">
<p>There is an alternate method of setting up the STSCLient. The user may
provide their own instance of the STSClient. The CXF code will use this
object and not auto-generate one. This is used in the ActAs and
OnBehalfOf examples. When providing the STSClient in this way, the user
must provide a org.apache.cxf.Bus for it and the configuration keys must
not have the ".it" suffix.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">QName serviceName = new QName("http://www.jboss.org/jbossws/ws-extensions/wssecuritypolicy", "SecurityService");
URL wsdlURL = new URL(serviceURL + "?wsdl");
Service service = Service.create(wsdlURL, serviceName);
ServiceIface proxy = (ServiceIface) service.getPort(ServiceIface.class);

// set the security related configuration information for the service "request"
Map&lt;String, Object&gt; ctx = ((BindingProvider) proxy).getRequestContext();
ctx.put(SecurityConstants.CALLBACK_HANDLER, new ClientCallbackHandler());
ctx.put(SecurityConstants.SIGNATURE_PROPERTIES,
   Thread.currentThread().getContextClassLoader().getResource(
   "META-INF/clientKeystore.properties"));
ctx.put(SecurityConstants.ENCRYPT_PROPERTIES,
   Thread.currentThread().getContextClassLoader().getResource(
   "META-INF/clientKeystore.properties"));
ctx.put(SecurityConstants.SIGNATURE_USERNAME, "myclientkey");
ctx.put(SecurityConstants.ENCRYPT_USERNAME, "myservicekey");


//-- Configuration settings that will be transfered to the STSClient
// "alice" is the name provided for the WSS Username. Her password will
// be retreived from the ClientCallbackHander by the STSClient.
ctx.put(SecurityConstants.USERNAME + ".it", "alice");
ctx.put(SecurityConstants.CALLBACK_HANDLER + ".it", new ClientCallbackHandler());
ctx.put(SecurityConstants.ENCRYPT_PROPERTIES + ".it",
   Thread.currentThread().getContextClassLoader().getResource(
   "META-INF/clientKeystore.properties"));
ctx.put(SecurityConstants.ENCRYPT_USERNAME + ".it", "mystskey");
// alias name in the keystore to get the user's public key to send to the STS
ctx.put(SecurityConstants.STS_TOKEN_USERNAME + ".it", "myclientkey");
// Crypto property configuration to use for the STS
ctx.put(SecurityConstants.STS_TOKEN_PROPERTIES + ".it",
   Thread.currentThread().getContextClassLoader().getResource(
   "META-INF/clientKeystore.properties"));
// write out an X509Certificate structure in UseKey/KeyInfo
ctx.put(SecurityConstants.STS_TOKEN_USE_CERT_FOR_KEYINFO + ".it", "true");
// Setting indicates the  STSclient should not try using the WS-MetadataExchange
// call using STS EPR WSA address when the endpoint contract does not contain
// WS-MetadataExchange info.
ctx.put("ws-security.sts.disable-wsmex-call-using-epr-address", "true");

proxy.sayHello();</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="clientcallbackhandler">ClientCallbackHandler</h4>
<div class="paragraph">
<p>ClientCallbackHandler is a callback handler for the WSS4J Crypto API. It
is used to obtain the password for the private key in the keystore. This
class enables CXF to retrieve the password of the user name to use for
the message signature. Note that "alice" and her password have been
provided here. This information is not in the (JKS) keystore but
provided in the WildFly security domain. It was declared in file
jbossws-users.properties.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package org.jboss.test.ws.jaxws.samples.wsse.policy.trust.shared;

import java.io.IOException;
import javax.security.auth.callback.Callback;
import javax.security.auth.callback.CallbackHandler;
import javax.security.auth.callback.UnsupportedCallbackException;
import org.apache.ws.security.WSPasswordCallback;

public class ClientCallbackHandler implements CallbackHandler {

    public void handle(Callback[] callbacks) throws IOException,
            UnsupportedCallbackException {
        for (int i = 0; i &lt; callbacks.length; i++) {
            if (callbacks[i] instanceof WSPasswordCallback) {
                WSPasswordCallback pc = (WSPasswordCallback) callbacks[i];
                if ("myclientkey".equals(pc.getIdentifier())) {
                    pc.setPassword("ckpass");
                    break;
                } else if ("alice".equals(pc.getIdentifier())) {
                    pc.setPassword("clarinet");
                    break;
                }
            }
        }
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="requester-crypto-properties-and-keystore-files">Requester Crypto properties and keystore files</h4>
<div class="paragraph">
<p>WSS4J&#8217;s Crypto implementation is loaded and configured via a Java
properties file that contains Crypto configuration data. The file
contains implementation-specific properties such as a keystore location,
password, default alias and the like. This application is using the
Merlin implementation. File clientKeystore.properties contains this
information.</p>
</div>
<div class="paragraph">
<p>File clientstore.jks, is a Java KeyStore (JKS) repository. It contains
self signed certificates for myservicekey and mystskey. <em>Self signed
certificates are not appropriate for production use.</em></p>
</div>
<div class="literalblock">
<div class="content">
<pre>org.apache.ws.security.crypto.provider=org.apache.ws.security.components.crypto.Merlin
org.apache.ws.security.crypto.merlin.keystore.type=jks
org.apache.ws.security.crypto.merlin.keystore.password=cspass
org.apache.ws.security.crypto.merlin.keystore.alias=myclientkey
org.apache.ws.security.crypto.merlin.keystore.file=META-INF/clientstore.jks</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="picketlink-sts">PicketLink STS</h3>
<div class="paragraph">
<p><a href="http://www.jboss.org/picketlink">PicketLink</a> provides facilities for
building up an alternative to the Apache CXF Security Token Service
implementation.</p>
</div>
<div class="paragraph">
<p>Similarly to the previous implementation, the STS is served through a
WebServiceProvider annotated POJO:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java"> package org.jboss.test.ws.jaxws.samples.wsse.policy.trust;
 
import javax.annotation.Resource;
import javax.xml.ws.Service;
import javax.xml.ws.ServiceMode;
import javax.xml.ws.WebServiceContext;
import javax.xml.ws.WebServiceProvider;
 
import org.apache.cxf.annotations.EndpointProperties;
import org.apache.cxf.annotations.EndpointProperty;
import org.apache.cxf.interceptor.InInterceptors;
import org.picketlink.identity.federation.core.wstrust.PicketLinkSTS;
 
@WebServiceProvider(serviceName = "PicketLinkSTS", portName = "PicketLinkSTSPort", targetNamespace = "urn:picketlink:identity-federation:sts", wsdlLocation = "WEB-INF/wsdl/PicketLinkSTS.wsdl")
@ServiceMode(value = Service.Mode.MESSAGE)
//be sure to have dependency on org.apache.cxf module when on AS7, otherwise Apache CXF annotations are ignored
@EndpointProperties(value = {
@EndpointProperty(key = "ws-security.signature.username", value = "mystskey"),
@EndpointProperty(key = "ws-security.signature.properties", value = "stsKeystore.properties"),
@EndpointProperty(key = "ws-security.callback-handler", value = "org.jboss.test.ws.jaxws.samples.wsse.policy.trust.STSCallbackHandler"),
@EndpointProperty(key = "ws-security.validate.token", value = "false") //to let the JAAS integration deal with validation through the interceptor below
})
@InInterceptors(interceptors =
 
)
public class PicketLinkSTService extends PicketLinkSTS {
@Resource
public void setWSC(WebServiceContext wctx)
Unknown macro: { this.context = wctx; }
 
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>@WebServiceProvider</code> annotation references the following WS-Policy
enabled wsdl contract; please note the wsdl operations, messages and
such must match the <code>PicketLinkSTS</code> implementation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0"?&gt;
&lt;wsdl:definitions name="PicketLinkSTS" targetNamespace="urn:picketlink:identity-federation:sts"
    xmlns:tns="urn:picketlink:identity-federation:sts"
    xmlns:xsd="http://www.w3.org/2001/XMLSchema"
    xmlns:wsdl="http://schemas.xmlsoap.org/wsdl/"
    xmlns:wsap10="http://www.w3.org/2006/05/addressing/wsdl"
    xmlns:wsp="http://www.w3.org/ns/ws-policy"
    xmlns:wsu="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd"
    xmlns:wst="http://docs.oasis-open.org/ws-sx/ws-trust/200512"
    xmlns:soap12="http://schemas.xmlsoap.org/wsdl/soap12/"&gt;
  &lt;wsdl:types&gt;
    &lt;xs:schema elementFormDefault="qualified" targetNamespace='http://docs.oasis-open.org/ws-sx/ws-trust/200512' xmlns:xs="http://www.w3.org/2001/XMLSchema"&gt;
      &lt;xs:element name='RequestSecurityToken' type='wst:AbstractRequestSecurityTokenType' /&gt;
      &lt;xs:element name='RequestSecurityTokenResponse' type='wst:AbstractRequestSecurityTokenType' /&gt;
      &lt;xs:complexType name='AbstractRequestSecurityTokenType' &gt;
        &lt;xs:sequence&gt;
          &lt;xs:any namespace='##any' processContents='lax' minOccurs='0' maxOccurs='unbounded' /&gt;
        &lt;/xs:sequence&gt;
        &lt;xs:attribute name='Context' type='xs:anyURI' use='optional' /&gt;
        &lt;xs:anyAttribute namespace='##other' processContents='lax' /&gt;
      &lt;/xs:complexType&gt;
      &lt;xs:element name='RequestSecurityTokenCollection' type='wst:RequestSecurityTokenCollectionType' /&gt;
      &lt;xs:complexType name='RequestSecurityTokenCollectionType' &gt;
        &lt;xs:sequence&gt;
          &lt;xs:element name='RequestSecurityToken' type='wst:AbstractRequestSecurityTokenType' minOccurs='2' maxOccurs='unbounded'/&gt;
        &lt;/xs:sequence&gt;
      &lt;/xs:complexType&gt;
      &lt;xs:element name='RequestSecurityTokenResponseCollection' type='wst:RequestSecurityTokenResponseCollectionType' /&gt;
      &lt;xs:complexType name='RequestSecurityTokenResponseCollectionType' &gt;
        &lt;xs:sequence&gt;
          &lt;xs:element ref='wst:RequestSecurityTokenResponse' minOccurs='1' maxOccurs='unbounded' /&gt;
        &lt;/xs:sequence&gt;
        &lt;xs:anyAttribute namespace='##other' processContents='lax' /&gt;
      &lt;/xs:complexType&gt;
    &lt;/xs:schema&gt;
  &lt;/wsdl:types&gt;

  &lt;wsdl:message name="RequestSecurityTokenMsg"&gt;
    &lt;wsdl:part name="request" element="wst:RequestSecurityToken" /&gt;
  &lt;/wsdl:message&gt;
  &lt;wsdl:message name="RequestSecurityTokenResponseCollectionMsg"&gt;
    &lt;wsdl:part name="responseCollection"
            element="wst:RequestSecurityTokenResponseCollection"/&gt;
  &lt;/wsdl:message&gt;

  &lt;wsdl:portType name="SecureTokenService"&gt;
    &lt;wsdl:operation name="IssueToken"&gt;
      &lt;wsdl:input wsap10:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Issue" message="tns:RequestSecurityTokenMsg"/&gt;
      &lt;wsdl:output wsap10:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RSTRC/IssueFinal" message="tns:RequestSecurityTokenResponseCollectionMsg"/&gt;
    &lt;/wsdl:operation&gt;
  &lt;/wsdl:portType&gt;
  &lt;wsdl:binding name="STSBinding" type="tns:SecureTokenService"&gt;
    &lt;wsp:PolicyReference URI="#UT_policy" /&gt;
    &lt;soap12:binding transport="http://schemas.xmlsoap.org/soap/http"/&gt;
    &lt;wsdl:operation name="IssueToken"&gt;
      &lt;soap12:operation soapAction="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Issue" style="document"/&gt;
      &lt;wsdl:input&gt;
        &lt;wsp:PolicyReference URI="#Input_policy" /&gt;
        &lt;soap12:body use="literal"/&gt;
      &lt;/wsdl:input&gt;
      &lt;wsdl:output&gt;
        &lt;wsp:PolicyReference URI="#Output_policy" /&gt;
        &lt;soap12:body use="literal"/&gt;
      &lt;/wsdl:output&gt;
    &lt;/wsdl:operation&gt;
  &lt;/wsdl:binding&gt;
  &lt;wsdl:service name="PicketLinkSTS"&gt;
    &lt;wsdl:port name="PicketLinkSTSPort" binding="tns:STSBinding"&gt;
      &lt;soap12:address location="http://localhost:8080/picketlink-sts/PicketLinkSTS"/&gt;
    &lt;/wsdl:port&gt;
  &lt;/wsdl:service&gt;

  &lt;wsp:Policy wsu:Id="UT_policy"&gt;
      &lt;wsp:ExactlyOne&gt;
         &lt;wsp:All&gt;
            &lt;wsap10:UsingAddressing/&gt;
            &lt;sp:SymmetricBinding
               xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
               &lt;wsp:Policy&gt;
                  &lt;sp:ProtectionToken&gt;
                     &lt;wsp:Policy&gt;
                        &lt;sp:X509Token
                           sp:IncludeToken="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702/IncludeToken/Never"&gt;
                           &lt;wsp:Policy&gt;
                              &lt;sp:RequireDerivedKeys /&gt;
                              &lt;sp:RequireThumbprintReference /&gt;
                              &lt;sp:WssX509V3Token10 /&gt;
                           &lt;/wsp:Policy&gt;
                        &lt;/sp:X509Token&gt;
                     &lt;/wsp:Policy&gt;
                  &lt;/sp:ProtectionToken&gt;
                  &lt;sp:AlgorithmSuite&gt;
                     &lt;wsp:Policy&gt;
                        &lt;sp:Basic256 /&gt;
                     &lt;/wsp:Policy&gt;
                  &lt;/sp:AlgorithmSuite&gt;
                  &lt;sp:Layout&gt;
                     &lt;wsp:Policy&gt;
                        &lt;sp:Lax /&gt;
                     &lt;/wsp:Policy&gt;
                  &lt;/sp:Layout&gt;
                  &lt;sp:IncludeTimestamp /&gt;
                  &lt;sp:EncryptSignature /&gt;
                  &lt;sp:OnlySignEntireHeadersAndBody /&gt;
               &lt;/wsp:Policy&gt;
            &lt;/sp:SymmetricBinding&gt;
            &lt;sp:SignedSupportingTokens
               xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
               &lt;wsp:Policy&gt;
                  &lt;sp:UsernameToken
                     sp:IncludeToken="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702/IncludeToken/AlwaysToRecipient"&gt;
                     &lt;wsp:Policy&gt;
                        &lt;sp:WssUsernameToken10 /&gt;
                     &lt;/wsp:Policy&gt;
                  &lt;/sp:UsernameToken&gt;
               &lt;/wsp:Policy&gt;
            &lt;/sp:SignedSupportingTokens&gt;
            &lt;sp:Wss11
               xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
               &lt;wsp:Policy&gt;
                  &lt;sp:MustSupportRefKeyIdentifier /&gt;
                  &lt;sp:MustSupportRefIssuerSerial /&gt;
                  &lt;sp:MustSupportRefThumbprint /&gt;
                  &lt;sp:MustSupportRefEncryptedKey /&gt;
               &lt;/wsp:Policy&gt;
            &lt;/sp:Wss11&gt;
            &lt;sp:Trust13
               xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
               &lt;wsp:Policy&gt;
                  &lt;sp:MustSupportIssuedTokens /&gt;
                  &lt;sp:RequireClientEntropy /&gt;
                  &lt;sp:RequireServerEntropy /&gt;
               &lt;/wsp:Policy&gt;
            &lt;/sp:Trust13&gt;
         &lt;/wsp:All&gt;
      &lt;/wsp:ExactlyOne&gt;
   &lt;/wsp:Policy&gt;

   &lt;wsp:Policy wsu:Id="Input_policy"&gt;
      &lt;wsp:ExactlyOne&gt;
         &lt;wsp:All&gt;
            &lt;sp:SignedParts
               xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
               &lt;sp:Body /&gt;
               &lt;sp:Header Name="To"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
               &lt;sp:Header Name="From"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
               &lt;sp:Header Name="FaultTo"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
               &lt;sp:Header Name="ReplyTo"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
               &lt;sp:Header Name="MessageID"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
               &lt;sp:Header Name="RelatesTo"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
               &lt;sp:Header Name="Action"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
            &lt;/sp:SignedParts&gt;
            &lt;sp:EncryptedParts
               xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
               &lt;sp:Body /&gt;
            &lt;/sp:EncryptedParts&gt;
         &lt;/wsp:All&gt;
      &lt;/wsp:ExactlyOne&gt;
   &lt;/wsp:Policy&gt;

   &lt;wsp:Policy wsu:Id="Output_policy"&gt;
      &lt;wsp:ExactlyOne&gt;
         &lt;wsp:All&gt;
            &lt;sp:SignedParts
               xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
               &lt;sp:Body /&gt;
               &lt;sp:Header Name="To"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
               &lt;sp:Header Name="From"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
               &lt;sp:Header Name="FaultTo"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
               &lt;sp:Header Name="ReplyTo"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
               &lt;sp:Header Name="MessageID"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
               &lt;sp:Header Name="RelatesTo"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
               &lt;sp:Header Name="Action"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
            &lt;/sp:SignedParts&gt;
            &lt;sp:EncryptedParts
               xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
               &lt;sp:Body /&gt;
            &lt;/sp:EncryptedParts&gt;
         &lt;/wsp:All&gt;
      &lt;/wsp:ExactlyOne&gt;
   &lt;/wsp:Policy&gt;

&lt;/wsdl:definitions&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Differently from the Apache CXF STS example described above, the
PicketLink based STS gets its configuration from a picketlink-sts.xml
descriptor which must be added in WEB-INF into the deployment; please
refer to the PicketLink documentation for further information:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;PicketLinkSTS xmlns="urn:picketlink:identity-federation:config:1.0"
    STSName="PicketLinkSTS" TokenTimeout="7200" EncryptToken="false"&gt;
    &lt;KeyProvider ClassName="org.picketlink.identity.federation.core.impl.KeyStoreKeyManager"&gt;
        &lt;Auth Key="KeyStoreURL" Value="stsstore.jks"/&gt;
        &lt;Auth Key="KeyStorePass" Value="stsspass"/&gt;
        &lt;Auth Key="SigningKeyAlias" Value="mystskey"/&gt;
        &lt;Auth Key="SigningKeyPass" Value="stskpass"/&gt;
        &lt;ValidatingAlias Key="http://localhost:8080/jaxws-samples-wsse-policy-trust/SecurityService" Value="myservicekey"/&gt;
    &lt;/KeyProvider&gt;
    &lt;TokenProviders&gt;
            &lt;TokenProvider ProviderClass="org.picketlink.identity.federation.core.wstrust.plugins.saml.SAML11TokenProvider"
                TokenType="http://docs.oasis-open.org/wss/oasis-wss-saml-token-profile-1.1#SAMLV1.1"
            TokenElement="Assertion"
            TokenElementNS="urn:oasis:names:tc:SAML:1.0:assertion"/&gt;
            &lt;TokenProvider ProviderClass="org.picketlink.identity.federation.core.wstrust.plugins.saml.SAML20TokenProvider"
                TokenType="http://docs.oasis-open.org/wss/oasis-wss-saml-token-profile-1.1#SAMLV2.0"
            TokenElement="Assertion"
            TokenElementNS="urn:oasis:names:tc:SAML:2.0:assertion"/&gt;
    &lt;/TokenProviders&gt;
&lt;/PicketLinkSTS&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, the PicketLink alternative approach of course requires
different WildFly module dependencies to be declared in the MANIFEST.MF:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Manifest-Version: 1.0
Ant-Version: Apache Ant 1.8.2
Created-By: 1.6.0_26-b03 (Sun Microsystems Inc.)
Dependencies: org.apache.ws.security,org.apache.cxf,org.picketlink</pre>
</div>
</div>
<div class="paragraph">
<p>Here is how the PicketLink STS endpoint is packaged:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">alessio@inuyasha /dati/jbossws/stack/cxf/trunk $ jar -tvf ./modules/testsuite/cxf-tests/target/test-libs/jaxws-samples-wsse-policy-trustPicketLink-sts.war
     0 Mon Sep 03 17:38:38 CEST 2012 META-INF/
   174 Mon Sep 03 17:38:36 CEST 2012 META-INF/MANIFEST.MF
     0 Mon Sep 03 17:38:38 CEST 2012 WEB-INF/
     0 Mon Sep 03 17:38:38 CEST 2012 WEB-INF/classes/
     0 Mon Sep 03 16:35:50 CEST 2012 WEB-INF/classes/org/
     0 Mon Sep 03 16:35:50 CEST 2012 WEB-INF/classes/org/jboss/
     0 Mon Sep 03 16:35:50 CEST 2012 WEB-INF/classes/org/jboss/test/
     0 Mon Sep 03 16:35:52 CEST 2012 WEB-INF/classes/org/jboss/test/ws/
     0 Mon Sep 03 16:35:50 CEST 2012 WEB-INF/classes/org/jboss/test/ws/jaxws/
     0 Mon Sep 03 16:35:52 CEST 2012 WEB-INF/classes/org/jboss/test/ws/jaxws/samples/
     0 Mon Sep 03 16:35:50 CEST 2012 WEB-INF/classes/org/jboss/test/ws/jaxws/samples/wsse/
     0 Mon Sep 03 16:35:50 CEST 2012 WEB-INF/classes/org/jboss/test/ws/jaxws/samples/wsse/policy/
     0 Mon Sep 03 16:35:52 CEST 2012 WEB-INF/classes/org/jboss/test/ws/jaxws/samples/wsse/policy/trust/
  1686 Mon Sep 03 16:35:50 CEST 2012 WEB-INF/classes/org/jboss/test/ws/jaxws/samples/wsse/policy/trust/PicketLinkSTService.class
  1148 Mon Sep 03 16:35:52 CEST 2012 WEB-INF/classes/org/jboss/test/ws/jaxws/samples/wsse/policy/trust/STSCallbackHandler.class
   251 Mon Sep 03 17:38:34 CEST 2012 WEB-INF/jboss-web.xml
     0 Mon Sep 03 16:35:50 CEST 2012 WEB-INF/wsdl/
  9070 Mon Sep 03 17:38:34 CEST 2012 WEB-INF/wsdl/PicketLinkSTS.wsdl
  1267 Mon Sep 03 17:38:34 CEST 2012 WEB-INF/classes/picketlink-sts.xml
  1054 Mon Sep 03 16:35:50 CEST 2012 WEB-INF/classes/stsKeystore.properties
  3978 Mon Sep 03 16:35:50 CEST 2012 WEB-INF/classes/stsstore.jks</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ActAs_WS-Trust_Scenario">ActAs WS-Trust Scenario</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The ActAs feature is used in scenarios that require composite
delegation. It is commonly used in multi-tiered systems where an
application calls a service on behalf of a logged in user or a service
calls another service on behalf of the original caller.</p>
</div>
<div class="paragraph">
<p>ActAs is nothing more than a new sub-element in the RequestSecurityToken
(RST). It provides additional information about the original caller when
a token is negotiated with the STS. The ActAs element usually takes the
form of a token with identity claims such as name, role, and
authorization code, for the client to access the service.</p>
</div>
<div class="paragraph">
<p>The ActAs scenario is an extension of
<a href="#ActAs_WS-Trust_Scenario">the basic
WS-Trust scenario</a>. In this example the ActAs service calls the
ws-service on behalf of a user. There are only a couple of additions to
the basic scenario&#8217;s code. An ActAs web service provider and callback
handler have been added. The ActAs web services' WSDL imposes the same
security policies as the ws-provider. UsernameTokenCallbackHandler is
new. It is a utility that generates the content for the ActAs element.
And lastly there are a couple of code additions in the STS to support
the ActAs request.</p>
</div>
<div class="sect2">
<h3 id="web-service-provider-2">Web service provider</h3>
<div class="paragraph">
<p>This section examines the web service elements from the basic WS-Trust
scenario that have been changed to address the needs of the ActAs
example. The components are</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ActAs web service provider&#8217;s WSDL</p>
</li>
<li>
<p>ActAs web service provider&#8217;s Interface and Implementation classes.</p>
</li>
<li>
<p>ActAsCallbackHandler class</p>
</li>
<li>
<p>UsernameTokenCallbackHandler</p>
</li>
<li>
<p>Crypto properties and keystore files</p>
</li>
<li>
<p>MANIFEST.MF</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="web-service-provider-wsdl-2">Web service provider WSDL</h4>
<div class="paragraph">
<p>The ActAs web service provider&#8217;s WSDL is a clone of the ws-provider&#8217;s
WSDL. The wsp:Policy section is the same. There are changes to the
service endpoint, targetNamespace, portType, binding name, and service.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;
&lt;definitions targetNamespace="http://www.jboss.org/jbossws/ws-extensions/actaswssecuritypolicy" name="ActAsService"
             xmlns:tns="http://www.jboss.org/jbossws/ws-extensions/actaswssecuritypolicy"
             xmlns:xsd="http://www.w3.org/2001/XMLSchema"
             xmlns:soap="http://schemas.xmlsoap.org/wsdl/soap/"
             xmlns="http://schemas.xmlsoap.org/wsdl/"
             xmlns:wsp="http://www.w3.org/ns/ws-policy"
             xmlns:wsam="http://www.w3.org/2007/05/addressing/metadata"
             xmlns:wsu="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd"
             xmlns:wsaws="http://www.w3.org/2005/08/addressing"
             xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"
             xmlns:t="http://docs.oasis-open.org/ws-sx/ws-trust/200512"&gt;
    &lt;types&gt;
        &lt;xsd:schema&gt;
            &lt;xsd:import namespace="http://www.jboss.org/jbossws/ws-extensions/actaswssecuritypolicy"
                    schemaLocation="ActAsService_schema1.xsd"/&gt;
        &lt;/xsd:schema&gt;
    &lt;/types&gt;
    &lt;message name="sayHello"&gt;
        &lt;part name="parameters" element="tns:sayHello"/&gt;
    &lt;/message&gt;
    &lt;message name="sayHelloResponse"&gt;
        &lt;part name="parameters" element="tns:sayHelloResponse"/&gt;
    &lt;/message&gt;
    &lt;portType name="ActAsServiceIface"&gt;
        &lt;operation name="sayHello"&gt;
            &lt;input message="tns:sayHello"/&gt;
            &lt;output message="tns:sayHelloResponse"/&gt;
        &lt;/operation&gt;
    &lt;/portType&gt;
    &lt;binding name="ActAsServicePortBinding" type="tns:ActAsServiceIface"&gt;
        &lt;wsp:PolicyReference URI="#AsymmetricSAML2Policy" /&gt;
        &lt;soap:binding transport="http://schemas.xmlsoap.org/soap/http" style="document"/&gt;
        &lt;operation name="sayHello"&gt;
            &lt;soap:operation soapAction=""/&gt;
            &lt;input&gt;
                &lt;soap:body use="literal"/&gt;
                &lt;wsp:PolicyReference URI="#Input_Policy" /&gt;
            &lt;/input&gt;
            &lt;output&gt;
                &lt;soap:body use="literal"/&gt;
                &lt;wsp:PolicyReference URI="#Output_Policy" /&gt;
            &lt;/output&gt;
        &lt;/operation&gt;
    &lt;/binding&gt;
    &lt;service name="ActAsService"&gt;
        &lt;port name="ActAsServicePort" binding="tns:ActAsServicePortBinding"&gt;
            &lt;soap:address location="http://@jboss.bind.address@:8080/jaxws-samples-wsse-policy-trust-actas/ActAsService"/&gt;
        &lt;/port&gt;
    &lt;/service&gt;
 
&lt;/definitions&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="web-service-interface">Web Service Interface</h4>
<div class="paragraph">
<p>The web service provider interface class, ActAsServiceIface, is a simple
web service definition.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package org.jboss.test.ws.jaxws.samples.wsse.policy.trust.actas;
 
import javax.jws.WebMethod;
import javax.jws.WebService;
 
@WebService
(
   targetNamespace = "http://www.jboss.org/jbossws/ws-extensions/actaswssecuritypolicy"
)
public interface ActAsServiceIface
{
   @WebMethod
   String sayHello();
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="web-service-implementation">Web Service Implementation</h4>
<div class="paragraph">
<p>The web service provider implementation class, ActAsServiceImpl, is a
simple POJO. It uses the standard WebService annotation to define the
service endpoint and two Apache WSS4J annotations, EndpointProperties
and EndpointProperty used for configuring the endpoint for the CXF
runtime. The WSS4J configuration information provided is for WSS4J&#8217;s
Crypto Merlin implementation.</p>
</div>
<div class="paragraph">
<p>ActAsServiceImpl is calling ServiceImpl acting on behalf of the user.
Method setupService performs the requisite configuration setup.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package org.jboss.test.ws.jaxws.samples.wsse.policy.trust.actas;
 
import org.apache.cxf.Bus;
import org.apache.cxf.BusFactory;
import org.apache.cxf.annotations.EndpointProperties;
import org.apache.cxf.annotations.EndpointProperty;
import org.apache.cxf.ws.security.SecurityConstants;
import org.apache.cxf.ws.security.trust.STSClient;
import org.jboss.test.ws.jaxws.samples.wsse.policy.trust.service.ServiceIface;
import org.jboss.test.ws.jaxws.samples.wsse.policy.trust.shared.WSTrustAppUtils;
 
import javax.jws.WebService;
import javax.xml.namespace.QName;
import javax.xml.ws.BindingProvider;
import javax.xml.ws.Service;
import java.net.MalformedURLException;
import java.net.URL;
import java.util.Map;
 
@WebService
(
   portName = "ActAsServicePort",
   serviceName = "ActAsService",
   wsdlLocation = "WEB-INF/wsdl/ActAsService.wsdl",
   targetNamespace = "http://www.jboss.org/jbossws/ws-extensions/actaswssecuritypolicy",
   endpointInterface = "org.jboss.test.ws.jaxws.samples.wsse.policy.trust.actas.ActAsServiceIface"
)
 
@EndpointProperties(value = {
      @EndpointProperty(key = "ws-security.signature.username", value = "myactaskey"),
      @EndpointProperty(key = "ws-security.signature.properties", value =  "actasKeystore.properties"),
      @EndpointProperty(key = "ws-security.encryption.properties", value = "actasKeystore.properties"),
      @EndpointProperty(key = "ws-security.callback-handler", value = "org.jboss.test.ws.jaxws.samples.wsse.policy.trust.actas.ActAsCallbackHandler")
})
 
public class ActAsServiceImpl implements ActAsServiceIface
{
   public String sayHello() {
      try {
         ServiceIface proxy = setupService();
         return "ActAs " + proxy.sayHello();
      } catch (MalformedURLException e) {
         e.printStackTrace();
      }
      return null;
   }
 
   private  ServiceIface setupService()throws MalformedURLException {
      ServiceIface proxy = null;
      Bus bus = BusFactory.newInstance().createBus();
 
      try {
         BusFactory.setThreadDefaultBus(bus);
 
         final String serviceURL = "http://" + WSTrustAppUtils.getServerHost() + ":8080/jaxws-samples-wsse-policy-trust/SecurityService";
         final QName serviceName = new QName("http://www.jboss.org/jbossws/ws-extensions/wssecuritypolicy", "SecurityService");
         final URL wsdlURL = new URL(serviceURL + "?wsdl");
         Service service = Service.create(wsdlURL, serviceName);
         proxy = (ServiceIface) service.getPort(ServiceIface.class);
 
         Map&lt;String, Object&gt; ctx = ((BindingProvider) proxy).getRequestContext();
         ctx.put(SecurityConstants.CALLBACK_HANDLER, new ActAsCallbackHandler());
 
         ctx.put(SecurityConstants.SIGNATURE_PROPERTIES,
            Thread.currentThread().getContextClassLoader().getResource("actasKeystore.properties" ));
         ctx.put(SecurityConstants.SIGNATURE_USERNAME, "myactaskey" );
         ctx.put(SecurityConstants.ENCRYPT_PROPERTIES,
            Thread.currentThread().getContextClassLoader().getResource("../../META-INF/clientKeystore.properties" ));
         ctx.put(SecurityConstants.ENCRYPT_USERNAME, "myservicekey");
 
         STSClient stsClient = new STSClient(bus);
         Map&lt;String, Object&gt; props = stsClient.getProperties();
         props.put(SecurityConstants.USERNAME, "alice");
         props.put(SecurityConstants.ENCRYPT_USERNAME, "mystskey");
         props.put(SecurityConstants.STS_TOKEN_USERNAME, "myactaskey" );
         props.put(SecurityConstants.STS_TOKEN_PROPERTIES,
            Thread.currentThread().getContextClassLoader().getResource("actasKeystore.properties" ));
         props.put(SecurityConstants.STS_TOKEN_USE_CERT_FOR_KEYINFO, "true");
 
         ctx.put(SecurityConstants.STS_CLIENT, stsClient);
 
      } finally {
         bus.shutdown(true);
      }
 
      return proxy;
   }
 
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="actascallbackhandler">ActAsCallbackHandler</h4>
<div class="paragraph">
<p>ActAsCallbackHandler is a callback handler for the WSS4J Crypto API. It
is used to obtain the password for the private key in the keystore. This
class enables CXF to retrieve the password of the user name to use for
the message signature. This class has been revised to return the
passwords for this service, myactaskey and the "actas" user, alice.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package org.jboss.test.ws.jaxws.samples.wsse.policy.trust.actas;
 
import org.jboss.wsf.stack.cxf.extensions.security.PasswordCallbackHandler;
import java.util.HashMap;
import java.util.Map;
 
public class ActAsCallbackHandler extends PasswordCallbackHandler {
 
   public ActAsCallbackHandler()
   {
      super(getInitMap());
   }
 
   private static Map&lt;String, String&gt; getInitMap()
   {
      Map&lt;String, String&gt; passwords = new HashMap&lt;String, String&gt;();
      passwords.put("myactaskey", "aspass");
      passwords.put("alice", "clarinet");
      return passwords;
   }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="usernametokencallbackhandler">UsernameTokenCallbackHandler</h4>
<div class="paragraph">
<p>The ActAs and OnBeholdOf sub-elements of the RequestSecurityToken are
required to be defined as WSSE Username Tokens. This utility generates
the properly formated element.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package org.jboss.test.ws.jaxws.samples.wsse.policy.trust.shared;
 
import org.apache.cxf.helpers.DOMUtils;
import org.apache.cxf.message.Message;
import org.apache.cxf.ws.security.SecurityConstants;
import org.apache.cxf.ws.security.trust.delegation.DelegationCallback;
import org.apache.ws.security.WSConstants;
import org.apache.ws.security.message.token.UsernameToken;
import org.w3c.dom.Document;
import org.w3c.dom.Node;
import org.w3c.dom.Element;
import org.w3c.dom.ls.DOMImplementationLS;
import org.w3c.dom.ls.LSSerializer;
 
import javax.security.auth.callback.Callback;
import javax.security.auth.callback.CallbackHandler;
import javax.security.auth.callback.UnsupportedCallbackException;
import java.io.IOException;
import java.util.Map;
 
/**
* A utility to provide the 3 different input parameter types for jaxws property
* "ws-security.sts.token.act-as" and "ws-security.sts.token.on-behalf-of".
* This implementation obtains a username and password via the jaxws property
* "ws-security.username" and "ws-security.password" respectively, as defined
* in SecurityConstants.  It creates a wss UsernameToken to be used as the
* delegation token.
*/
 
public class UsernameTokenCallbackHandler implements CallbackHandler {
 
   public void handle(Callback[] callbacks)
      throws IOException, UnsupportedCallbackException {
      for (int i = 0; i &lt; callbacks.length; i++) {
         if (callbacks[i] instanceof DelegationCallback) {
            DelegationCallback callback = (DelegationCallback) callbacks[i];
            Message message = callback.getCurrentMessage();
 
            String username =
               (String)message.getContextualProperty(SecurityConstants.USERNAME);
            String password =
               (String)message.getContextualProperty(SecurityConstants.PASSWORD);
            if (username != null) {
               Node contentNode = message.getContent(Node.class);
               Document doc = null;
               if (contentNode != null) {
                  doc = contentNode.getOwnerDocument();
               } else {
                  doc = DOMUtils.createDocument();
               }
               UsernameToken usernameToken = createWSSEUsernameToken(username,password, doc);
               callback.setToken(usernameToken.getElement());
            }
         } else {
            throw new UnsupportedCallbackException(callbacks[i], "Unrecognized Callback");
         }
      }
   }
 
   /**
    * Provide UsernameToken as a string.
    * @param ctx
    * @return
    */
   public String getUsernameTokenString(Map&lt;String, Object&gt; ctx){
      Document doc = DOMUtils.createDocument();
      String result = null;
      String username = (String)ctx.get(SecurityConstants.USERNAME);
      String password = (String)ctx.get(SecurityConstants.PASSWORD);
      if (username != null) {
         UsernameToken usernameToken = createWSSEUsernameToken(username,password, doc);
         result = toString(usernameToken.getElement().getFirstChild().getParentNode());
      }
      return result;
   }
 
   /**
    *
    * @param username
    * @param password
    * @return
    */
   public String getUsernameTokenString(String username, String password){
      Document doc = DOMUtils.createDocument();
      String result = null;
      if (username != null) {
         UsernameToken usernameToken = createWSSEUsernameToken(username,password, doc);
         result = toString(usernameToken.getElement().getFirstChild().getParentNode());
      }
      return result;
   }
 
   /**
    * Provide UsernameToken as a DOM Element.
    * @param ctx
    * @return
    */
   public Element getUsernameTokenElement(Map&lt;String, Object&gt; ctx){
      Document doc = DOMUtils.createDocument();
      Element result = null;
      UsernameToken usernameToken = null;
         String username = (String)ctx.get(SecurityConstants.USERNAME);
      String password = (String)ctx.get(SecurityConstants.PASSWORD);
      if (username != null) {
         usernameToken = createWSSEUsernameToken(username,password, doc);
         result = usernameToken.getElement();
      }
      return result;
   }
 
   /**
    *
    * @param username
    * @param password
    * @return
    */
   public Element getUsernameTokenElement(String username, String password){
      Document doc = DOMUtils.createDocument();
      Element result = null;
      UsernameToken usernameToken = null;
      if (username != null) {
         usernameToken = createWSSEUsernameToken(username,password, doc);
         result = usernameToken.getElement();
      }
      return result;
   }
 
   private UsernameToken createWSSEUsernameToken(String username, String password, Document doc) {
 
      UsernameToken usernameToken = new UsernameToken(true, doc,
         (password == null)? null: WSConstants.PASSWORD_TEXT);
      usernameToken.setName(username);
      usernameToken.addWSUNamespace();
      usernameToken.addWSSENamespace();
      usernameToken.setID("id-" + username);
 
      if (password != null){
         usernameToken.setPassword(password);
      }
 
      return usernameToken;
   }
 
 
   private String toString(Node node) {
      String str = null;
 
      if (node != null) {
         DOMImplementationLS lsImpl = (DOMImplementationLS)
            node.getOwnerDocument().getImplementation().getFeature("LS", "3.0");
         LSSerializer serializer = lsImpl.createLSSerializer();
         serializer.getDomConfig().setParameter("xml-declaration", false); //by default its true, so set it to false to get String without xml-declaration
         str = serializer.writeToString(node);
      }
      return str;
   }
 
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="crypto-properties-and-keystore-files">Crypto properties and keystore files</h4>
<div class="paragraph">
<p>The ActAs service must provide its own credentials. The requisite
properties file, actasKeystore.properties, and keystore, actasstore.jks,
were created.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>org.apache.ws.security.crypto.provider=org.apache.ws.security.components.crypto.Merlin
org.apache.ws.security.crypto.merlin.keystore.type=jks
org.apache.ws.security.crypto.merlin.keystore.password=aapass
org.apache.ws.security.crypto.merlin.keystore.alias=myactaskey
org.apache.ws.security.crypto.merlin.keystore.file=actasstore.jks</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="manifest.mf">MANIFEST.MF</h4>
<div class="paragraph">
<p>When deployed on WildFly this application requires access to the JBossWs
and CXF APIs provided in modules org.jboss.ws.cxf.jbossws-cxf-client and
org.apache.cxf. The Apache CXF internals, org.apache.cxf.impl, are
needed in handling the ActAs and OnBehalfOf extensions. The dependency
statement directs the server to provide them at deployment.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Manifest-Version: 1.0
Ant-Version: Apache Ant 1.8.2
Created-By: 1.7.0_25-b15 (Oracle Corporation)
Dependencies: org.jboss.ws.cxf.jbossws-cxf-client, org.apache.cxf.impl</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="security-token-service">Security Token Service</h3>
<div class="paragraph">
<p>This section examines the STS elements from the basic WS-Trust scenario
that have been changed to address the needs of the ActAs example. The
components are.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>STS&#8217;s implementation class.</p>
</li>
<li>
<p>STSCallbackHandler class</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="sts-implementation-class">STS Implementation class</h4>
<div class="paragraph">
<p>The initial description of SampleSTS can be found
<a href="#sts-implementation-class">here</a>.</p>
</div>
<div class="paragraph">
<p>The declaration of the set of allowed token recipients by address has
been extended to accept ActAs addresses and OnBehalfOf addresses. The
addresses are specified as reg-ex patterns.</p>
</div>
<div class="paragraph">
<p>The TokenIssueOperation requires class, UsernameTokenValidator be
provided in order to validate the contents of the OnBehalfOf claims and
class, UsernameTokenDelegationHandler to be provided in order to process
the token delegation request of the ActAs on OnBehalfOf user.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java"> package org.jboss.test.ws.jaxws.samples.wsse.policy.trust.sts;
 
import java.util.Arrays;
import java.util.LinkedList;
import java.util.List;
 
import javax.xml.ws.WebServiceProvider;
 
import org.apache.cxf.annotations.EndpointProperties;
import org.apache.cxf.annotations.EndpointProperty;
import org.apache.cxf.interceptor.InInterceptors;
import org.apache.cxf.sts.StaticSTSProperties;
import org.apache.cxf.sts.operation.TokenIssueOperation;
import org.apache.cxf.sts.operation.TokenValidateOperation;
import org.apache.cxf.sts.service.ServiceMBean;
import org.apache.cxf.sts.service.StaticService;
import org.apache.cxf.sts.token.delegation.UsernameTokenDelegationHandler;
import org.apache.cxf.sts.token.provider.SAMLTokenProvider;
import org.apache.cxf.sts.token.validator.SAMLTokenValidator;
import org.apache.cxf.sts.token.validator.UsernameTokenValidator;
import org.apache.cxf.ws.security.sts.provider.SecurityTokenServiceProvider;
 
@WebServiceProvider(serviceName = "SecurityTokenService",
      portName = "UT_Port",
      targetNamespace = "http://docs.oasis-open.org/ws-sx/ws-trust/200512/",
      wsdlLocation = "WEB-INF/wsdl/ws-trust-1.4-service.wsdl")
//be sure to have dependency on org.apache.cxf module when on AS7, otherwise Apache CXF annotations are ignored
@EndpointProperties(value = {
      @EndpointProperty(key = "ws-security.signature.username", value = "mystskey"),
      @EndpointProperty(key = "ws-security.signature.properties", value = "stsKeystore.properties"),
      @EndpointProperty(key = "ws-security.callback-handler", value = "org.jboss.test.ws.jaxws.samples.wsse.policy.trust.sts.STSCallbackHandler"),
      @EndpointProperty(key = "ws-security.validate.token", value = "false") //to let the JAAS integration deal with validation through the interceptor below
})
@InInterceptors(interceptors = {"org.jboss.wsf.stack.cxf.security.authentication.SubjectCreatingPolicyInterceptor"})
public class SampleSTS extends SecurityTokenServiceProvider
{
   public SampleSTS() throws Exception
   {
      super();
 
      StaticSTSProperties props = new StaticSTSProperties();
      props.setSignatureCryptoProperties("stsKeystore.properties");
      props.setSignatureUsername("mystskey");
      props.setCallbackHandlerClass(STSCallbackHandler.class.getName());
      props.setIssuer("DoubleItSTSIssuer");
 
      List&lt;ServiceMBean&gt; services = new LinkedList&lt;ServiceMBean&gt;();
      StaticService service = new StaticService();
      service.setEndpoints(Arrays.asList(
         "http://localhost:(\\d)*/jaxws-samples-wsse-policy-trust/SecurityService",
         "http://\\[::1\\]:(\\d)*/jaxws-samples-wsse-policy-trust/SecurityService",
         "http://\\[0:0:0:0:0:0:0:1\\]:(\\d)*/jaxws-samples-wsse-policy-trust/SecurityService",
 
         "http://localhost:(\\d)*/jaxws-samples-wsse-policy-trust-actas/ActAsService",
         "http://\\[::1\\]:(\\d)*/jaxws-samples-wsse-policy-trust-actas/ActAsService",
         "http://\\[0:0:0:0:0:0:0:1\\]:(\\d)*/jaxws-samples-wsse-policy-trust-actas/ActAsService",
 
         "http://localhost:(\\d)*/jaxws-samples-wsse-policy-trust-onbehalfof/OnBehalfOfService",
         "http://\\[::1\\]:(\\d)*/jaxws-samples-wsse-policy-trust-onbehalfof/OnBehalfOfService",
         "http://\\[0:0:0:0:0:0:0:1\\]:(\\d)*/jaxws-samples-wsse-policy-trust-onbehalfof/OnBehalfOfService"
      ));
      services.add(service);
 
      TokenIssueOperation issueOperation = new TokenIssueOperation();
      issueOperation.setServices(services);
      issueOperation.getTokenProviders().add(new SAMLTokenProvider());
      // required for OnBehalfOf
      issueOperation.getTokenValidators().add(new UsernameTokenValidator());
      // added for OnBehalfOf and ActAs
      issueOperation.getDelegationHandlers().add(new UsernameTokenDelegationHandler());
      issueOperation.setStsProperties(props);
 
      TokenValidateOperation validateOperation = new TokenValidateOperation();
      validateOperation.getTokenValidators().add(new SAMLTokenValidator());
      validateOperation.setStsProperties(props);
 
      this.setIssueOperation(issueOperation);
      this.setValidateOperation(validateOperation);
   }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="stscallbackhandler">STSCallbackHandler</h4>
<div class="paragraph">
<p>The user, alice, and corresponding password was required to be added for
the ActAs example.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package org.jboss.test.ws.jaxws.samples.wsse.policy.trust.sts;
 
import java.util.HashMap;
import java.util.Map;
 
import org.jboss.wsf.stack.cxf.extensions.security.PasswordCallbackHandler;
 
public class STSCallbackHandler extends PasswordCallbackHandler
{
   public STSCallbackHandler()
   {
      super(getInitMap());
   }
 
   private static Map&lt;String, String&gt; getInitMap()
   {
      Map&lt;String, String&gt; passwords = new HashMap&lt;String, String&gt;();
      passwords.put("mystskey", "stskpass");
      passwords.put("alice", "clarinet");
      return passwords;
   }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="web-service-requester">Web service requester</h3>
<div class="paragraph">
<p>This section examines the ws-requester elements from the basic WS-Trust
scenario that have been changed to address the needs of the ActAs
example. The component is</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ActAs web service requester implementation class</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="web-service-requester-implementation">Web service requester Implementation</h4>
<div class="paragraph">
<p>The ActAs ws-requester, the client, uses standard procedures for
creating a reference to the web service in the first four lines. To
address the endpoint security requirements, the web service&#8217;s "Request
Context" is configured via the BindingProvider. Information needed in
the message generation is provided through it. The ActAs user,
myactaskey, is declared in this section and UsernameTokenCallbackHandler
is used to provide the contents of the ActAs element to the STSClient.
In this example a STSClient object is created and provided to the
proxy&#8217;s request context. The alternative is to provide keys tagged with
the ".it" suffix as was done in
<a href="https://docs.jboss.org/author/display/JBWS/WS-Trust+and+STS#WS-TrustandSTS-WebservicerequesterImplementation">the
Basic Scenario client</a>. The use of ActAs is configured through the props
map using the SecurityConstants.STS_TOKEN_ACT_AS key. The alternative is
to use the STSClient.setActAs method.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java"> final QName serviceName = new QName("http://www.jboss.org/jbossws/ws-extensions/actaswssecuritypolicy", "ActAsService");
final URL wsdlURL = new URL(serviceURL + "?wsdl");
Service service = Service.create(wsdlURL, serviceName);
ActAsServiceIface proxy = (ActAsServiceIface) service.getPort(ActAsServiceIface.class);
 
Bus bus = BusFactory.newInstance().createBus();
try {
    BusFactory.setThreadDefaultBus(bus);
 
    Map&lt;String, Object&gt; ctx = proxy.getRequestContext();
 
    ctx.put(SecurityConstants.CALLBACK_HANDLER, new ClientCallbackHandler());
    ctx.put(SecurityConstants.ENCRYPT_PROPERTIES,
        Thread.currentThread().getContextClassLoader().getResource(
        "META-INF/clientKeystore.properties"));
    ctx.put(SecurityConstants.ENCRYPT_USERNAME, "myactaskey");
    ctx.put(SecurityConstants.SIGNATURE_PROPERTIES,
        Thread.currentThread().getContextClassLoader().getResource(
        "META-INF/clientKeystore.properties"));
    ctx.put(SecurityConstants.SIGNATURE_USERNAME, "myclientkey");
 
    // Generate the ActAs element contents and pass to the STSClient as a string
    UsernameTokenCallbackHandler ch = new UsernameTokenCallbackHandler();
    String str = ch.getUsernameTokenString("alice","clarinet");
    ctx.put(SecurityConstants.STS_TOKEN_ACT_AS, str);
 
    STSClient stsClient = new STSClient(bus);
    Map&lt;String, Object&gt; props = stsClient.getProperties();
    props.put(SecurityConstants.USERNAME, "bob");
    props.put(SecurityConstants.CALLBACK_HANDLER, new ClientCallbackHandler());
    props.put(SecurityConstants.ENCRYPT_PROPERTIES,
        Thread.currentThread().getContextClassLoader().getResource(
        "META-INF/clientKeystore.properties"));
    props.put(SecurityConstants.ENCRYPT_USERNAME, "mystskey");
    props.put(SecurityConstants.STS_TOKEN_USERNAME, "myclientkey");
    props.put(SecurityConstants.STS_TOKEN_PROPERTIES,
        Thread.currentThread().getContextClassLoader().getResource(
        "META-INF/clientKeystore.properties"));
    props.put(SecurityConstants.STS_TOKEN_USE_CERT_FOR_KEYINFO, "true");
 
    ctx.put(SecurityConstants.STS_CLIENT, stsClient);
} finally {
    bus.shutdown(true);
}
proxy.sayHello();</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="OnBehalfOf_WS-Trust_Scenario">OnBehalfOf WS-Trust Scenario</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The OnBehalfOf feature is used in scenarios that use the proxy pattern.
In such scenarios, the client cannot access the STS directly, instead it
communicates through a proxy gateway. The proxy gateway authenticates
the caller and puts information about the caller into the OnBehalfOf
element of the RequestSecurityToken (RST) sent to the real STS for
processing. The resulting token contains only claims related to the
client of the proxy, making the proxy completely transparent to the
receiver of the issued token.</p>
</div>
<div class="paragraph">
<p>OnBehalfOf is nothing more than a new sub-element in the RST. It
provides additional information about the original caller when a token
is negotiated with the STS. The OnBehalfOf element usually takes the
form of a token with identity claims such as name, role, and
authorization code, for the client to access the service.</p>
</div>
<div class="paragraph">
<p>The OnBehalfOf scenario is an extension of
<a href="#OnBehalfOf_WS-Trust_Scenario">the
basic WS-Trust scenario</a>. In this example the OnBehalfOf service calls
the ws-service on behalf of a user. There are only a couple of additions
to the basic scenario&#8217;s code. An OnBehalfOf web service provider and
callback handler have been added. The OnBehalfOf web services' WSDL
imposes the same security policies as the ws-provider.
UsernameTokenCallbackHandler is a utility shared with ActAs. It
generates the content for the OnBehalfOf element. And lastly there are
code additions in the STS that both OnBehalfOf and ActAs share in
common.</p>
</div>
<div class="paragraph">
<p>Infor here [
<a href="http://coheigea.blogspot.it/2012/01/apache-cxf-251-sts-updates.html">Open
Source Security: Apache CXF 2.5.1 STS updates</a> ]</p>
</div>
<div class="sect2">
<h3 id="web-service-provider-3">Web service provider</h3>
<div class="paragraph">
<p>This section examines the web service elements from the basic WS-Trust
scenario that have been changed to address the needs of the OnBehalfOf
example. The components are.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>web service provider&#8217;s WSDL</p>
</li>
<li>
<p>web service provider&#8217;s Interface and Implementation classes.</p>
</li>
<li>
<p>OnBehalfOfCallbackHandler class</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="web-service-provider-wsdl-3">Web service provider WSDL</h4>
<div class="paragraph">
<p>The OnBehalfOf web service provider&#8217;s WSDL is a clone of the
ws-provider&#8217;s WSDL. The wsp:Policy section is the same. There are
changes to the service endpoint, targetNamespace, portType, binding
name, and service.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;
&lt;definitions targetNamespace="http://www.jboss.org/jbossws/ws-extensions/onbehalfofwssecuritypolicy" name="OnBehalfOfService"
             xmlns:tns="http://www.jboss.org/jbossws/ws-extensions/onbehalfofwssecuritypolicy"
             xmlns:xsd="http://www.w3.org/2001/XMLSchema"
             xmlns:soap="http://schemas.xmlsoap.org/wsdl/soap/"
             xmlns="http://schemas.xmlsoap.org/wsdl/"
             xmlns:wsp="http://www.w3.org/ns/ws-policy"
             xmlns:wsam="http://www.w3.org/2007/05/addressing/metadata"
             xmlns:wsu="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd"
             xmlns:wsaws="http://www.w3.org/2005/08/addressing"
             xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"
             xmlns:t="http://docs.oasis-open.org/ws-sx/ws-trust/200512"&gt;
    &lt;types&gt;
        &lt;xsd:schema&gt;
            &lt;xsd:import namespace="http://www.jboss.org/jbossws/ws-extensions/onbehalfofwssecuritypolicy"
                  schemaLocation="OnBehalfOfService_schema1.xsd"/&gt;
        &lt;/xsd:schema&gt;
    &lt;/types&gt;
    &lt;message name="sayHello"&gt;
        &lt;part name="parameters" element="tns:sayHello"/&gt;
    &lt;/message&gt;
    &lt;message name="sayHelloResponse"&gt;
        &lt;part name="parameters" element="tns:sayHelloResponse"/&gt;
    &lt;/message&gt;
    &lt;portType name="OnBehalfOfServiceIface"&gt;
        &lt;operation name="sayHello"&gt;
            &lt;input message="tns:sayHello"/&gt;
            &lt;output message="tns:sayHelloResponse"/&gt;
        &lt;/operation&gt;
    &lt;/portType&gt;
    &lt;binding name="OnBehalfOfServicePortBinding" type="tns:OnBehalfOfServiceIface"&gt;
        &lt;wsp:PolicyReference URI="#AsymmetricSAML2Policy" /&gt;
        &lt;soap:binding transport="http://schemas.xmlsoap.org/soap/http" style="document"/&gt;
        &lt;operation name="sayHello"&gt;
            &lt;soap:operation soapAction=""/&gt;
            &lt;input&gt;
                &lt;soap:body use="literal"/&gt;
                &lt;wsp:PolicyReference URI="#Input_Policy" /&gt;
            &lt;/input&gt;
            &lt;output&gt;
                &lt;soap:body use="literal"/&gt;
                &lt;wsp:PolicyReference URI="#Output_Policy" /&gt;
            &lt;/output&gt;
        &lt;/operation&gt;
    &lt;/binding&gt;
    &lt;service name="OnBehalfOfService"&gt;
        &lt;port name="OnBehalfOfServicePort" binding="tns:OnBehalfOfServicePortBinding"&gt;
            &lt;soap:address location="http://@jboss.bind.address@:8080/jaxws-samples-wsse-policy-trust-onbehalfof/OnBehalfOfService"/&gt;
        &lt;/port&gt;
    &lt;/service&gt;
&lt;/definitions&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="web-service-interface">Web Service Interface</h4>
<div class="paragraph">
<p>The web service provider interface class, OnBehalfOfServiceIface, is a
simple web service definition.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package org.jboss.test.ws.jaxws.samples.wsse.policy.trust.onbehalfof;
 
import javax.jws.WebMethod;
import javax.jws.WebService;
 
@WebService
(
   targetNamespace = "http://www.jboss.org/jbossws/ws-extensions/onbehalfofwssecuritypolicy"
)
public interface OnBehalfOfServiceIface
{
   @WebMethod
   String sayHello();
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="web-service-implementation">Web Service Implementation</h4>
<div class="paragraph">
<p>The web service provider implementation class, OnBehalfOfServiceImpl, is
a simple POJO. It uses the standard WebService annotation to define the
service endpoint and two Apache WSS4J annotations, EndpointProperties
and EndpointProperty used for configuring the endpoint for the CXF
runtime. The WSS4J configuration information provided is for WSS4J&#8217;s
Crypto Merlin implementation.</p>
</div>
<div class="paragraph">
<p>OnBehalfOfServiceImpl is calling the ServiceImpl acting on behalf of the
user. Method setupService performs the requisite configuration setup.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package org.jboss.test.ws.jaxws.samples.wsse.policy.trust.onbehalfof;
 
import org.apache.cxf.Bus;
import org.apache.cxf.BusFactory;
import org.apache.cxf.annotations.EndpointProperties;
import org.apache.cxf.annotations.EndpointProperty;
import org.apache.cxf.ws.security.SecurityConstants;
import org.apache.cxf.ws.security.trust.STSClient;
import org.jboss.test.ws.jaxws.samples.wsse.policy.trust.service.ServiceIface;
import org.jboss.test.ws.jaxws.samples.wsse.policy.trust.shared.WSTrustAppUtils;
 
import javax.jws.WebService;
import javax.xml.namespace.QName;
import javax.xml.ws.BindingProvider;
import javax.xml.ws.Service;
import java.net.*;
import java.util.Map;
 
@WebService
(
   portName = "OnBehalfOfServicePort",
   serviceName = "OnBehalfOfService",
   wsdlLocation = "WEB-INF/wsdl/OnBehalfOfService.wsdl",
   targetNamespace = "http://www.jboss.org/jbossws/ws-extensions/onbehalfofwssecuritypolicy",
   endpointInterface = "org.jboss.test.ws.jaxws.samples.wsse.policy.trust.onbehalfof.OnBehalfOfServiceIface"
)
 
@EndpointProperties(value = {
      @EndpointProperty(key = "ws-security.signature.username", value = "myactaskey"),
      @EndpointProperty(key = "ws-security.signature.properties", value =  "actasKeystore.properties"),
      @EndpointProperty(key = "ws-security.encryption.properties", value = "actasKeystore.properties"),
      @EndpointProperty(key = "ws-security.callback-handler", value = "org.jboss.test.ws.jaxws.samples.wsse.policy.trust.onbehalfof.OnBehalfOfCallbackHandler")
})
 
public class OnBehalfOfServiceImpl implements OnBehalfOfServiceIface
{
   public String sayHello() {
      try {
 
         ServiceIface proxy = setupService();
         return "OnBehalfOf " + proxy.sayHello();
 
      } catch (MalformedURLException e) {
         e.printStackTrace();
      }
      return null;
   }
 
   /**
    *
    * @return
    * @throws MalformedURLException
    */
   private  ServiceIface setupService()throws MalformedURLException {
      ServiceIface proxy = null;
      Bus bus = BusFactory.newInstance().createBus();
 
      try {
         BusFactory.setThreadDefaultBus(bus);
 
         final String serviceURL = "http://" + WSTrustAppUtils.getServerHost() + ":8080/jaxws-samples-wsse-policy-trust/SecurityService";
         final QName serviceName = new QName("http://www.jboss.org/jbossws/ws-extensions/wssecuritypolicy", "SecurityService");
         final URL wsdlURL = new URL(serviceURL + "?wsdl");
         Service service = Service.create(wsdlURL, serviceName);
         proxy = (ServiceIface) service.getPort(ServiceIface.class);
 
         Map&lt;String, Object&gt; ctx = ((BindingProvider) proxy).getRequestContext();
         ctx.put(SecurityConstants.CALLBACK_HANDLER, new OnBehalfOfCallbackHandler());
 
         ctx.put(SecurityConstants.SIGNATURE_PROPERTIES,
            Thread.currentThread().getContextClassLoader().getResource(
            "actasKeystore.properties" ));
         ctx.put(SecurityConstants.SIGNATURE_USERNAME, "myactaskey" );
         ctx.put(SecurityConstants.ENCRYPT_PROPERTIES,
            Thread.currentThread().getContextClassLoader().getResource(
            "../../META-INF/clientKeystore.properties" ));
         ctx.put(SecurityConstants.ENCRYPT_USERNAME, "myservicekey");
 
         STSClient stsClient = new STSClient(bus);
         Map&lt;String, Object&gt; props = stsClient.getProperties();
         props.put(SecurityConstants.USERNAME, "bob");
         props.put(SecurityConstants.ENCRYPT_USERNAME, "mystskey");
         props.put(SecurityConstants.STS_TOKEN_USERNAME, "myactaskey" );
         props.put(SecurityConstants.STS_TOKEN_PROPERTIES,
            Thread.currentThread().getContextClassLoader().getResource(
            "actasKeystore.properties" ));
         props.put(SecurityConstants.STS_TOKEN_USE_CERT_FOR_KEYINFO, "true");
 
         ctx.put(SecurityConstants.STS_CLIENT, stsClient);
 
      } finally {
         bus.shutdown(true);
      }
 
      return proxy;
   }
 
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="onbehalfofcallbackhandler">OnBehalfOfCallbackHandler</h4>
<div class="paragraph">
<p>OnBehalfOfCallbackHandler is a callback handler for the WSS4J Crypto
API. It is used to obtain the password for the private key in the
keystore. This class enables CXF to retrieve the password of the user
name to use for the message signature. This class has been revised to
return the passwords for this service, myactaskey and the "OnBehalfOf"
user, alice.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java"> package org.jboss.test.ws.jaxws.samples.wsse.policy.trust.onbehalfof;
 
import org.jboss.wsf.stack.cxf.extensions.security.PasswordCallbackHandler;
import java.util.HashMap;
import java.util.Map;
 
public class OnBehalfOfCallbackHandler extends PasswordCallbackHandler {
 
   public OnBehalfOfCallbackHandler()
   {
      super(getInitMap());
   }
 
   private static Map&lt;String, String&gt; getInitMap()
   {
      Map&lt;String, String&gt; passwords = new HashMap&lt;String, String&gt;();
      passwords.put("myactaskey", "aspass");
      passwords.put("alice", "clarinet");
      passwords.put("bob", "trombone");
      return passwords;
   }
 
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="web-service-requester">Web service requester</h3>
<div class="paragraph">
<p>This section examines the ws-requester elements from the basic WS-Trust
scenario that have been changed to address the needs of the OnBehalfOf
example. The component is</p>
</div>
<div class="ulist">
<ul>
<li>
<p>OnBehalfOf web service requester implementation class</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="web-service-requester-implementation">Web service requester Implementation</h4>
<div class="paragraph">
<p>The OnBehalfOf ws-requester, the client, uses standard procedures for
creating a reference to the web service in the first four lines. To
address the endpoint security requirements, the web service&#8217;s "Request
Context" is configured via the BindingProvider. Information needed in
the message generation is provided through it. The OnBehalfOf user,
alice, is declared in this section and the callbackHandler,
UsernameTokenCallbackHandler is provided to the STSClient for generation
of the contents for the OnBehalfOf message element. In this example a
STSClient object is created and provided to the proxy&#8217;s request context.
The alternative is to provide keys tagged with the ".it" suffix as was
done in
<a href="#src-557281_OnBehalfOfWS-TrustScenario-WebservicerequesterImplementation">the
Basic Scenario client</a>. The use of OnBehalfOf is configured by the
method call stsClient.setOnBehalfOf. The alternative is to use the key
SecurityConstants.STS_TOKEN_ON_BEHALF_OF and a value in the props map.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">final QName serviceName = new QName("http://www.jboss.org/jbossws/ws-extensions/onbehalfofwssecuritypolicy", "OnBehalfOfService");
final URL wsdlURL = new URL(serviceURL + "?wsdl");
Service service = Service.create(wsdlURL, serviceName);
OnBehalfOfServiceIface proxy = (OnBehalfOfServiceIface) service.getPort(OnBehalfOfServiceIface.class);
 
 
Bus bus = BusFactory.newInstance().createBus();
try {
 
    BusFactory.setThreadDefaultBus(bus);
 
    Map&lt;String, Object&gt; ctx = proxy.getRequestContext();
 
    ctx.put(SecurityConstants.CALLBACK_HANDLER, new ClientCallbackHandler());
    ctx.put(SecurityConstants.ENCRYPT_PROPERTIES,
        Thread.currentThread().getContextClassLoader().getResource(
        "META-INF/clientKeystore.properties"));
    ctx.put(SecurityConstants.ENCRYPT_USERNAME, "myactaskey");
    ctx.put(SecurityConstants.SIGNATURE_PROPERTIES,
        Thread.currentThread().getContextClassLoader().getResource(
        "META-INF/clientKeystore.properties"));
    ctx.put(SecurityConstants.SIGNATURE_USERNAME, "myclientkey");
 
    // user and password OnBehalfOf user
    // UsernameTokenCallbackHandler will extract this information when called
    ctx.put(SecurityConstants.USERNAME,"alice");
    ctx.put(SecurityConstants.PASSWORD, "clarinet");
 
    STSClient stsClient = new STSClient(bus);
 
    // Providing the STSClient the mechanism to create the claims contents for OnBehalfOf
    stsClient.setOnBehalfOf(new UsernameTokenCallbackHandler());
 
    Map&lt;String, Object&gt; props = stsClient.getProperties();
    props.put(SecurityConstants.CALLBACK_HANDLER, new ClientCallbackHandler());
    props.put(SecurityConstants.ENCRYPT_PROPERTIES,
        Thread.currentThread().getContextClassLoader().getResource(
        "META-INF/clientKeystore.properties"));
    props.put(SecurityConstants.ENCRYPT_USERNAME, "mystskey");
    props.put(SecurityConstants.STS_TOKEN_USERNAME, "myclientkey");
    props.put(SecurityConstants.STS_TOKEN_PROPERTIES,
        Thread.currentThread().getContextClassLoader().getResource(
        "META-INF/clientKeystore.properties"));
    props.put(SecurityConstants.STS_TOKEN_USE_CERT_FOR_KEYINFO, "true");
 
    ctx.put(SecurityConstants.STS_CLIENT, stsClient);
 
} finally {
    bus.shutdown(true);
}
proxy.sayHello();</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="SAML_Bearer_Assertion_Scenario">SAML Bearer Assertion Scenario</h2>
<div class="sectionbody">
<div class="paragraph">
<p>WS-Trust deals with managing software security tokens. A SAML assertion
is a type of security token. In the SAML Bearer scenario, the service
provider automatically trusts that the incoming SOAP request came from
the subject defined in the SAML token after the service verifies the
tokens signature.</p>
</div>
<div class="paragraph">
<p>Implementation of this scenario has the following requirements.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>SAML tokens with a Bearer subject confirmation method must be
protected so the token can not be snooped. In most cases, a bearer token
combined with HTTPS is sufficient to prevent "a man in the middle"
getting possession of the token. This means a security policy that uses
a sp:TransportBinding and sp:HttpsToken.</p>
</li>
<li>
<p>A bearer token has no encryption or signing keys associated with it,
therefore a sp:IssuedToken of bearer keyType should be used with a
sp:SupportingToken or a sp:SignedSupportingTokens.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="web-service-provider-4">Web service Provider</h3>
<div class="paragraph">
<p>This section examines the web service elements for the SAML Bearer
scenario. The components are</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Bearer web service provider&#8217;s WSDL</p>
</li>
<li>
<p>SSL configuration</p>
</li>
<li>
<p>Bearer web service provider&#8217;s Interface and Implementation classes.</p>
</li>
<li>
<p>Crypto properties and keystore files</p>
</li>
<li>
<p>MANIFEST.MF</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="web-service-provider-wsdl-4">Web service provider WSDL</h4>
<div class="paragraph">
<p>The web service provider is a contract-first endpoint. All the WS-trust
and security policies for it are declared in WSDL, BearerService.wsdl.
For this scenario a ws-requester is required to present a SAML 2.0
Bearer token issued from a designed STS. The address of the STS is
provided in the WSDL. HTTPS, a TransportBinding and HttpsToken policy
are used to protect the SOAP body of messages that pass back and forth
between ws-requester and ws-provider. A detailed explanation of the
security settings are provided in the comments in the listing below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;
&lt;definitions targetNamespace="http://www.jboss.org/jbossws/ws-extensions/bearerwssecuritypolicy"
             name="BearerService"
             xmlns:tns="http://www.jboss.org/jbossws/ws-extensions/bearerwssecuritypolicy"
             xmlns:xsd="http://www.w3.org/2001/XMLSchema"
             xmlns:soap="http://schemas.xmlsoap.org/wsdl/soap/"
             xmlns="http://schemas.xmlsoap.org/wsdl/"
             xmlns:wsp="http://www.w3.org/ns/ws-policy"
             xmlns:wsam="http://www.w3.org/2007/05/addressing/metadata"
             xmlns:wsu="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd"
             xmlns:wsaws="http://www.w3.org/2005/08/addressing"
             xmlns:wsx="http://schemas.xmlsoap.org/ws/2004/09/mex"
             xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"
             xmlns:t="http://docs.oasis-open.org/ws-sx/ws-trust/200512"&gt;
 
  &lt;types&gt;
    &lt;xsd:schema&gt;
      &lt;xsd:import namespace="http://www.jboss.org/jbossws/ws-extensions/bearerwssecuritypolicy"
                  schemaLocation="BearerService_schema1.xsd"/&gt;
    &lt;/xsd:schema&gt;
  &lt;/types&gt;
  &lt;message name="sayHello"&gt;
    &lt;part name="parameters" element="tns:sayHello"/&gt;
  &lt;/message&gt;
  &lt;message name="sayHelloResponse"&gt;
    &lt;part name="parameters" element="tns:sayHelloResponse"/&gt;
  &lt;/message&gt;
  &lt;portType name="BearerIface"&gt;
    &lt;operation name="sayHello"&gt;
      &lt;input message="tns:sayHello"/&gt;
      &lt;output message="tns:sayHelloResponse"/&gt;
    &lt;/operation&gt;
  &lt;/portType&gt;
 
&lt;!--
        The wsp:PolicyReference binds the security requirments on all the endpoints.
        The wsp:Policy wsu:Id="#TransportSAML2BearerPolicy" element is defined later in this file.
--&gt;
  &lt;binding name="BearerServicePortBinding" type="tns:BearerIface"&gt;
    &lt;wsp:PolicyReference URI="#TransportSAML2BearerPolicy" /&gt;
    &lt;soap:binding transport="http://schemas.xmlsoap.org/soap/http" style="document"/&gt;
    &lt;operation name="sayHello"&gt;
      &lt;soap:operation soapAction=""/&gt;
      &lt;input&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/input&gt;
      &lt;output&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/output&gt;
    &lt;/operation&gt;
  &lt;/binding&gt;
 
&lt;!--
  The soap:address has been defined to use JBoss's https port, 8443.  This is
  set in conjunction with the sp:TransportBinding policy for https.
--&gt;
  &lt;service name="BearerService"&gt;
    &lt;port name="BearerServicePort" binding="tns:BearerServicePortBinding"&gt;
      &lt;soap:address location="https://@jboss.bind.address@:8443/jaxws-samples-wsse-policy-trust-bearer/BearerService"/&gt;
    &lt;/port&gt;
  &lt;/service&gt;
 
 
  &lt;wsp:Policy wsu:Id="TransportSAML2BearerPolicy"&gt;
    &lt;wsp:ExactlyOne&gt;
      &lt;wsp:All&gt;
  &lt;!--
        The wsam:Addressing element, indicates that the endpoints of this
        web service MUST conform to the WS-Addressing specification.  The
        attribute wsp:Optional="false" enforces this assertion.
  --&gt;
        &lt;wsam:Addressing wsp:Optional="false"&gt;
          &lt;wsp:Policy /&gt;
        &lt;/wsam:Addressing&gt;
 
&lt;!--
  The sp:TransportBinding element indicates that security is provided by the
  message exchange transport medium, https.  WS-Security policy specification
  defines the sp:HttpsToken for use in exchanging messages transmitted over HTTPS.
--&gt;
        &lt;sp:TransportBinding
          xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
          &lt;wsp:Policy&gt;
            &lt;sp:TransportToken&gt;
              &lt;wsp:Policy&gt;
                &lt;sp:HttpsToken&gt;
                  &lt;wsp:Policy/&gt;
                &lt;/sp:HttpsToken&gt;
              &lt;/wsp:Policy&gt;
            &lt;/sp:TransportToken&gt;
&lt;!--
     The sp:AlgorithmSuite element, requires the TripleDes algorithm suite
     be used in performing cryptographic operations.
--&gt;
            &lt;sp:AlgorithmSuite&gt;
              &lt;wsp:Policy&gt;
                &lt;sp:TripleDes /&gt;
              &lt;/wsp:Policy&gt;
            &lt;/sp:AlgorithmSuite&gt;
&lt;!--
     The sp:Layout element,  indicates the layout rules to apply when adding
     items to the security header.  The sp:Lax sub-element indicates items
     are added to the security header in any order that conforms to
     WSS: SOAP Message Security.
--&gt;
            &lt;sp:Layout&gt;
              &lt;wsp:Policy&gt;
                &lt;sp:Lax /&gt;
              &lt;/wsp:Policy&gt;
            &lt;/sp:Layout&gt;
            &lt;sp:IncludeTimestamp /&gt;
          &lt;/wsp:Policy&gt;
        &lt;/sp:TransportBinding&gt;
 
&lt;!--
  The sp:SignedSupportingTokens element causes the supporting tokens
  to be signed using the primary token that is used to sign the message.
--&gt;
        &lt;sp:SignedSupportingTokens
          xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
          &lt;wsp:Policy&gt;
&lt;!--
  The sp:IssuedToken element asserts that a SAML 2.0 security token of type
  Bearer is expected from the STS.  The
  sp:IncludeToken="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702/IncludeToken/AlwaysToRecipient"&gt;
  attribute instructs the runtime to include the initiator's public key
  with every message sent to the recipient.
 
  The sp:RequestSecurityTokenTemplate element directs that all of the
  children of this element will be copied directly into the body of the
  RequestSecurityToken (RST) message that is sent to the STS when the
  initiator asks the STS to issue a token.
--&gt;
            &lt;sp:IssuedToken
              sp:IncludeToken="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702/IncludeToken/AlwaysToRecipient"&gt;
              &lt;sp:RequestSecurityTokenTemplate&gt;
                &lt;t:TokenType&gt;http://docs.oasis-open.org/wss/oasis-wss-saml-token-profile-1.1#SAMLV2.0&lt;/t:TokenType&gt;
                &lt;t:KeyType&gt;http://docs.oasis-open.org/ws-sx/ws-trust/200512/Bearer&lt;/t:KeyType&gt;
              &lt;/sp:RequestSecurityTokenTemplate&gt;
              &lt;wsp:Policy&gt;
                &lt;sp:RequireInternalReference /&gt;
              &lt;/wsp:Policy&gt;
&lt;!--
  The sp:Issuer element defines the STS's address and endpoint information
  This information is used by the STSClient.
--&gt;
              &lt;sp:Issuer&gt;
                &lt;wsaws:Address&gt;http://@jboss.bind.address@:8080/jaxws-samples-wsse-policy-trust-sts-bearer/SecurityTokenService&lt;/wsaws:Address&gt;
                &lt;wsaws:Metadata
                  xmlns:wsdli="http://www.w3.org/2006/01/wsdl-instance"
                  wsdli:wsdlLocation="http://@jboss.bind.address@:8080/jaxws-samples-wsse-policy-trust-sts-bearer/SecurityTokenService?wsdl"&gt;
                  &lt;wsaw:ServiceName
                    xmlns:wsaw="http://www.w3.org/2006/05/addressing/wsdl"
                    xmlns:stsns="http://docs.oasis-open.org/ws-sx/ws-trust/200512/"
                    EndpointName="UT_Port"&gt;stsns:SecurityTokenService&lt;/wsaw:ServiceName&gt;
                &lt;/wsaws:Metadata&gt;
              &lt;/sp:Issuer&gt;
 
            &lt;/sp:IssuedToken&gt;
          &lt;/wsp:Policy&gt;
        &lt;/sp:SignedSupportingTokens&gt;
&lt;!--
    The sp:Wss11 element declares WSS: SOAP Message Security 1.1 options
    to be supported by the STS.  These particular elements generally refer
    to how keys are referenced within the SOAP envelope.  These are normally
    handled by CXF.
--&gt;
        &lt;sp:Wss11&gt;
          &lt;wsp:Policy&gt;
            &lt;sp:MustSupportRefIssuerSerial /&gt;
            &lt;sp:MustSupportRefThumbprint /&gt;
            &lt;sp:MustSupportRefEncryptedKey /&gt;
          &lt;/wsp:Policy&gt;
        &lt;/sp:Wss11&gt;
&lt;!--
    The sp:Trust13 element declares controls for WS-Trust 1.3 options.
    They are policy assertions related to exchanges specifically with
    client and server challenges and entropy behaviors.  Again these are
    normally handled by CXF.
--&gt;
        &lt;sp:Trust13&gt;
          &lt;wsp:Policy&gt;
            &lt;sp:MustSupportIssuedTokens /&gt;
            &lt;sp:RequireClientEntropy /&gt;
            &lt;sp:RequireServerEntropy /&gt;
          &lt;/wsp:Policy&gt;
        &lt;/sp:Trust13&gt;
      &lt;/wsp:All&gt;
    &lt;/wsp:ExactlyOne&gt;
  &lt;/wsp:Policy&gt;
 
&lt;/definitions&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="ssl-configuration">SSL configuration</h4>
<div class="paragraph">
<p>This web service is using https, therefore the JBoss server must be
configured to provide SSL support in the Web subsystem. There are 2
components to SSL configuration.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>create a certificate keystore</p>
</li>
<li>
<p>declare an SSL connector in the Web subsystem of the JBoss server
configuration file.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Follow the directions in the, " <em>Using the pure Java implementation
supplied by JSSE</em>" section in the
<a href="https://docs.jboss.org/author/display/WFLY8/SSL+setup+guide">SSL Setup
Guide</a>.</p>
</div>
<div class="paragraph">
<p>Here is an example of an SSL connector declaration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;subsystem xmlns="urn:jboss:domain:web:1.4" default-virtual-server="default-host" native="false"&gt;
  .....
  &lt;connector name="jbws-https-connector" protocol="HTTP/1.1" scheme="https" socket-binding="https" secure="true" enabled="true"&gt;
    &lt;ssl key-alias="tomcat" password="changeit" certificate-key-file="/myJbossHome/security/test.keystore" verify-client="false"/&gt;
  &lt;/connector&gt;
  ...</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="web-service-interface">Web service Interface</h4>
<div class="paragraph">
<p>The web service provider interface class, BearerIface, is a simple
straight forward web service definition.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package org.jboss.test.ws.jaxws.samples.wsse.policy.trust.bearer;
 
import javax.jws.WebMethod;
import javax.jws.WebService;
 
@WebService
(
   targetNamespace = "http://www.jboss.org/jbossws/ws-extensions/bearerwssecuritypolicy"
)
public interface BearerIface
{
   @WebMethod
   String sayHello();
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="web-service-implementation">Web service Implementation</h4>
<div class="paragraph">
<p>The web service provider implementation class, BearerImpl, is a simple
POJO. It uses the standard WebService annotation to define the service
endpoint. In addition there are two Apache CXF annotations,
EndpointProperties and EndpointProperty used for configuring the
endpoint for the CXF runtime. These annotations come from the
<a href="https://ws.apache.org/wss4j/">Apache WSS4J project</a>, which provides a
Java implementation of the primary WS-Security standards for Web
Services. These annotations are programmatically adding properties to
the endpoint. With plain Apache CXF, these properties are often set via
the &lt;jaxws:properties&gt; element on the &lt;jaxws:endpoint&gt; element in the
Spring config; these annotations allow the properties to be configured
in the code.</p>
</div>
<div class="paragraph">
<p>WSS4J uses the Crypto interface to get keys and certificates for
signature creation/verification, as is asserted by the WSDL for this
service. The WSS4J configuration information being provided by
BearerImpl is for Crypto&#8217;s Merlin implementation. More information will
be provided about this in the keystore section.</p>
</div>
<div class="paragraph">
<p>Because the web service provider automatically trusts that the incoming
SOAP request came from the subject defined in the SAML token there is no
need for a Crypto callbackHandler class or a signature username, unlike
in prior examples, however in order to verify the message signature, the
Java properties file that contains the (Merlin) crypto configuration
information is still required.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package org.jboss.test.ws.jaxws.samples.wsse.policy.trust.bearer;
 
import org.apache.cxf.annotations.EndpointProperties;
import org.apache.cxf.annotations.EndpointProperty;
 
import javax.jws.WebService;
 
@WebService
(
   portName = "BearerServicePort",
   serviceName = "BearerService",
   wsdlLocation = "WEB-INF/wsdl/BearerService.wsdl",
   targetNamespace = "http://www.jboss.org/jbossws/ws-extensions/bearerwssecuritypolicy",
   endpointInterface = "org.jboss.test.ws.jaxws.samples.wsse.policy.trust.bearer.BearerIface"
)
@EndpointProperties(value = {
   @EndpointProperty(key = "ws-security.signature.properties", value = "serviceKeystore.properties")
})
public class BearerImpl implements BearerIface
{
   public String sayHello()
   {
      return "Bearer WS-Trust Hello World!";
   }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="crypto-properties-and-keystore-files">Crypto properties and keystore files</h4>
<div class="paragraph">
<p>WSS4J&#8217;s Crypto implementation is loaded and configured via a Java
properties file that contains Crypto configuration data. The file
contains implementation-specific properties such as a keystore location,
password, default alias and the like. This application is using the
Merlin implementation. File serviceKeystore.properties contains this
information.</p>
</div>
<div class="paragraph">
<p>File servicestore.jks, is a Java KeyStore (JKS) repository. It contains
self signed certificates for myservicekey and mystskey. <em>Self signed
certificates are not appropriate for production use.</em></p>
</div>
<div class="literalblock">
<div class="content">
<pre>org.apache.ws.security.crypto.provider=org.apache.ws.security.components.crypto.Merlin
org.apache.ws.security.crypto.merlin.keystore.type=jks
org.apache.ws.security.crypto.merlin.keystore.password=sspass
org.apache.ws.security.crypto.merlin.keystore.alias=myservicekey
org.apache.ws.security.crypto.merlin.keystore.file=servicestore.jks</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="manifest.mf">MANIFEST.MF</h4>
<div class="paragraph">
<p>When deployed on WildFly this application requires access to the JBossWs
and CXF APIs provided in module org.jboss.ws.cxf.jbossws-cxf-client. The
dependency statement directs the server to provide them at deployment.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Manifest-Version: 1.0
Ant-Version: Apache Ant 1.8.2
Created-By: 1.7.0_25-b15 (Oracle Corporation)
Dependencies: org.jboss.ws.cxf.jbossws-cxf-client</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="bearer-security-token-service">Bearer Security Token Service</h3>
<div class="paragraph">
<p>This section examines the crucial elements in providing the Security
Token Service functionality for providing a SAML Bearer token. The
components that will be discussed are.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Security Domain</p>
</li>
<li>
<p>STS&#8217;s WSDL</p>
</li>
<li>
<p>STS&#8217;s implementation class</p>
</li>
<li>
<p>STSBearerCallbackHandler</p>
</li>
<li>
<p>Crypto properties and keystore files</p>
</li>
<li>
<p>MANIFEST.MF</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="security-domain">Security Domain</h4>
<div class="paragraph">
<p>The STS requires a JBoss security domain be configured. The
jboss-web.xml descriptor declares a named security
domain,"JBossWS-trust-sts" to be used by this service for
authentication. This security domain requires two properties files and
the addition of a security-domain declaration in the JBoss server
configuration file.</p>
</div>
<div class="paragraph">
<p>For this scenario the domain needs to contain user <em>alice</em>, password
<em>clarinet</em>, and role <em>friend</em>. See the listings below for
jbossws-users.properties and jbossws-roles.properties. In addition the
following XML must be added to the JBoss security subsystem in the
server configuration file. Replace " <strong>SOME_PATH</strong>" with appropriate
information.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;security-domain name="JBossWS-trust-sts"&gt;
  &lt;authentication&gt;
    &lt;login-module code="UsersRoles" flag="required"&gt;
      &lt;module-option name="usersProperties" value="/SOME_PATH/jbossws-users.properties"/&gt;
      &lt;module-option name="unauthenticatedIdentity" value="anonymous"/&gt;
      &lt;module-option name="rolesProperties" value="/SOME_PATH/jbossws-roles.properties"/&gt;
    &lt;/login-module&gt;
  &lt;/authentication&gt;
&lt;/security-domain&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>jboss-web.xml</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!DOCTYPE jboss-web PUBLIC "-//JBoss//DTD Web Application 2.4//EN" "&gt;
&lt;jboss-web&gt;
  &lt;security-domain&gt;java:/jaas/JBossWS-trust-sts&lt;/security-domain&gt;
&lt;/jboss-web&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>jbossws-users.properties</p>
</div>
<div class="literalblock">
<div class="content">
<pre># A sample users.properties file for use with the UsersRolesLoginModule
alice=clarinet</pre>
</div>
</div>
<div class="paragraph">
<p>jbossws-roles.properties</p>
</div>
<div class="literalblock">
<div class="content">
<pre># A sample roles.properties file for use with the UsersRolesLoginModule
alice=friend</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="stss-wsdl">STS&#8217;s WSDL</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;wsdl:definitions
  targetNamespace="http://docs.oasis-open.org/ws-sx/ws-trust/200512/"
  xmlns:tns="http://docs.oasis-open.org/ws-sx/ws-trust/200512/"
  xmlns:wstrust="http://docs.oasis-open.org/ws-sx/ws-trust/200512/"
  xmlns:wsdl="http://schemas.xmlsoap.org/wsdl/"
  xmlns:soap="http://schemas.xmlsoap.org/wsdl/soap/"
  xmlns:wsap10="http://www.w3.org/2006/05/addressing/wsdl"
  xmlns:wsu="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd"
  xmlns:wsp="http://www.w3.org/ns/ws-policy"
  xmlns:wst="http://docs.oasis-open.org/ws-sx/ws-trust/200512"
  xmlns:xs="http://www.w3.org/2001/XMLSchema"
  xmlns:wsam="http://www.w3.org/2007/05/addressing/metadata"&gt;
 
  &lt;wsdl:types&gt;
    &lt;xs:schema elementFormDefault="qualified"
               targetNamespace='http://docs.oasis-open.org/ws-sx/ws-trust/200512'&gt;
 
      &lt;xs:element name='RequestSecurityToken'
                  type='wst:AbstractRequestSecurityTokenType'/&gt;
      &lt;xs:element name='RequestSecurityTokenResponse'
                  type='wst:AbstractRequestSecurityTokenType'/&gt;
 
      &lt;xs:complexType name='AbstractRequestSecurityTokenType'&gt;
        &lt;xs:sequence&gt;
          &lt;xs:any namespace='##any' processContents='lax' minOccurs='0'
                  maxOccurs='unbounded'/&gt;
        &lt;/xs:sequence&gt;
        &lt;xs:attribute name='Context' type='xs:anyURI' use='optional'/&gt;
        &lt;xs:anyAttribute namespace='##other' processContents='lax'/&gt;
      &lt;/xs:complexType&gt;
      &lt;xs:element name='RequestSecurityTokenCollection'
                  type='wst:RequestSecurityTokenCollectionType'/&gt;
      &lt;xs:complexType name='RequestSecurityTokenCollectionType'&gt;
        &lt;xs:sequence&gt;
          &lt;xs:element name='RequestSecurityToken'
                      type='wst:AbstractRequestSecurityTokenType' minOccurs='2'
                      maxOccurs='unbounded'/&gt;
        &lt;/xs:sequence&gt;
      &lt;/xs:complexType&gt;
 
      &lt;xs:element name='RequestSecurityTokenResponseCollection'
                  type='wst:RequestSecurityTokenResponseCollectionType'/&gt;
      &lt;xs:complexType name='RequestSecurityTokenResponseCollectionType'&gt;
        &lt;xs:sequence&gt;
          &lt;xs:element ref='wst:RequestSecurityTokenResponse' minOccurs='1'
                      maxOccurs='unbounded'/&gt;
        &lt;/xs:sequence&gt;
        &lt;xs:anyAttribute namespace='##other' processContents='lax'/&gt;
      &lt;/xs:complexType&gt;
 
    &lt;/xs:schema&gt;
  &lt;/wsdl:types&gt;
 
  &lt;!-- WS-Trust defines the following GEDs --&gt;
  &lt;wsdl:message name="RequestSecurityTokenMsg"&gt;
    &lt;wsdl:part name="request" element="wst:RequestSecurityToken"/&gt;
  &lt;/wsdl:message&gt;
  &lt;wsdl:message name="RequestSecurityTokenResponseMsg"&gt;
    &lt;wsdl:part name="response"
               element="wst:RequestSecurityTokenResponse"/&gt;
  &lt;/wsdl:message&gt;
  &lt;wsdl:message name="RequestSecurityTokenCollectionMsg"&gt;
    &lt;wsdl:part name="requestCollection"
               element="wst:RequestSecurityTokenCollection"/&gt;
  &lt;/wsdl:message&gt;
  &lt;wsdl:message name="RequestSecurityTokenResponseCollectionMsg"&gt;
    &lt;wsdl:part name="responseCollection"
               element="wst:RequestSecurityTokenResponseCollection"/&gt;
  &lt;/wsdl:message&gt;
 
  &lt;!-- This portType an example of a Requestor (or other) endpoint that
  Accepts SOAP-based challenges from a Security Token Service --&gt;
  &lt;wsdl:portType name="WSSecurityRequestor"&gt;
    &lt;wsdl:operation name="Challenge"&gt;
      &lt;wsdl:input message="tns:RequestSecurityTokenResponseMsg"/&gt;
      &lt;wsdl:output message="tns:RequestSecurityTokenResponseMsg"/&gt;
    &lt;/wsdl:operation&gt;
  &lt;/wsdl:portType&gt;
 
  &lt;!-- This portType is an example of an STS supporting full protocol --&gt;
  &lt;!--
      The wsdl:portType and data types are XML elements defined by the
      WS_Trust specification.  The wsdl:portType defines the endpoints
      supported in the STS implementation.  This WSDL defines all operations
      that an STS implementation can support.
  --&gt;
  &lt;wsdl:portType name="STS"&gt;
    &lt;wsdl:operation name="Cancel"&gt;
      &lt;wsdl:input
        wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Cancel"
        message="tns:RequestSecurityTokenMsg"/&gt;
      &lt;wsdl:output
        wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RSTR/CancelFinal"
        message="tns:RequestSecurityTokenResponseMsg"/&gt;
    &lt;/wsdl:operation&gt;
    &lt;wsdl:operation name="Issue"&gt;
      &lt;wsdl:input
        wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Issue"
        message="tns:RequestSecurityTokenMsg"/&gt;
      &lt;wsdl:output
        wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RSTRC/IssueFinal"
        message="tns:RequestSecurityTokenResponseCollectionMsg"/&gt;
    &lt;/wsdl:operation&gt;
    &lt;wsdl:operation name="Renew"&gt;
      &lt;wsdl:input
        wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Renew"
        message="tns:RequestSecurityTokenMsg"/&gt;
      &lt;wsdl:output
        wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RSTR/RenewFinal"
        message="tns:RequestSecurityTokenResponseMsg"/&gt;
    &lt;/wsdl:operation&gt;
    &lt;wsdl:operation name="Validate"&gt;
      &lt;wsdl:input
        wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Validate"
        message="tns:RequestSecurityTokenMsg"/&gt;
      &lt;wsdl:output
        wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RSTR/ValidateFinal"
        message="tns:RequestSecurityTokenResponseMsg"/&gt;
    &lt;/wsdl:operation&gt;
    &lt;wsdl:operation name="KeyExchangeToken"&gt;
      &lt;wsdl:input
        wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/KET"
        message="tns:RequestSecurityTokenMsg"/&gt;
      &lt;wsdl:output
        wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RSTR/KETFinal"
        message="tns:RequestSecurityTokenResponseMsg"/&gt;
    &lt;/wsdl:operation&gt;
    &lt;wsdl:operation name="RequestCollection"&gt;
      &lt;wsdl:input message="tns:RequestSecurityTokenCollectionMsg"/&gt;
      &lt;wsdl:output message="tns:RequestSecurityTokenResponseCollectionMsg"/&gt;
    &lt;/wsdl:operation&gt;
  &lt;/wsdl:portType&gt;
 
  &lt;!-- This portType is an example of an endpoint that accepts
  Unsolicited RequestSecurityTokenResponse messages --&gt;
  &lt;wsdl:portType name="SecurityTokenResponseService"&gt;
    &lt;wsdl:operation name="RequestSecurityTokenResponse"&gt;
      &lt;wsdl:input message="tns:RequestSecurityTokenResponseMsg"/&gt;
    &lt;/wsdl:operation&gt;
  &lt;/wsdl:portType&gt;
 
  &lt;!--
      The wsp:PolicyReference binds the security requirments on all the STS endpoints.
      The wsp:Policy wsu:Id="UT_policy" element is later in this file.
  --&gt;
  &lt;wsdl:binding name="UT_Binding" type="wstrust:STS"&gt;
    &lt;wsp:PolicyReference URI="#UT_policy"/&gt;
    &lt;soap:binding style="document"
                  transport="http://schemas.xmlsoap.org/soap/http"/&gt;
    &lt;wsdl:operation name="Issue"&gt;
      &lt;soap:operation
        soapAction="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Issue"/&gt;
      &lt;wsdl:input&gt;
        &lt;wsp:PolicyReference
          URI="#Input_policy"/&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:input&gt;
      &lt;wsdl:output&gt;
        &lt;wsp:PolicyReference
          URI="#Output_policy"/&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:output&gt;
    &lt;/wsdl:operation&gt;
    &lt;wsdl:operation name="Validate"&gt;
      &lt;soap:operation
        soapAction="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Validate"/&gt;
      &lt;wsdl:input&gt;
        &lt;wsp:PolicyReference
          URI="#Input_policy"/&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:input&gt;
      &lt;wsdl:output&gt;
        &lt;wsp:PolicyReference
          URI="#Output_policy"/&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:output&gt;
    &lt;/wsdl:operation&gt;
    &lt;wsdl:operation name="Cancel"&gt;
      &lt;soap:operation
        soapAction="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Cancel"/&gt;
      &lt;wsdl:input&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:input&gt;
      &lt;wsdl:output&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:output&gt;
    &lt;/wsdl:operation&gt;
    &lt;wsdl:operation name="Renew"&gt;
      &lt;soap:operation
        soapAction="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Renew"/&gt;
      &lt;wsdl:input&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:input&gt;
      &lt;wsdl:output&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:output&gt;
    &lt;/wsdl:operation&gt;
    &lt;wsdl:operation name="KeyExchangeToken"&gt;
      &lt;soap:operation
        soapAction="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/KeyExchangeToken"/&gt;
      &lt;wsdl:input&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:input&gt;
      &lt;wsdl:output&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:output&gt;
    &lt;/wsdl:operation&gt;
    &lt;wsdl:operation name="RequestCollection"&gt;
      &lt;soap:operation
        soapAction="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/RequestCollection"/&gt;
      &lt;wsdl:input&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:input&gt;
      &lt;wsdl:output&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:output&gt;
    &lt;/wsdl:operation&gt;
  &lt;/wsdl:binding&gt;
 
  &lt;wsdl:service name="SecurityTokenService"&gt;
    &lt;wsdl:port name="UT_Port" binding="tns:UT_Binding"&gt;
      &lt;soap:address location="http://localhost:8080/SecurityTokenService/UT"/&gt;
    &lt;/wsdl:port&gt;
  &lt;/wsdl:service&gt;
 
 
  &lt;wsp:Policy wsu:Id="UT_policy"&gt;
    &lt;wsp:ExactlyOne&gt;
      &lt;wsp:All&gt;
        &lt;!--
            The sp:UsingAddressing element, indicates that the endpoints of this
            web service conforms to the WS-Addressing specification.  More detail
            can be found here: [http://www.w3.org/TR/2006/CR-ws-addr-wsdl-20060529]
        --&gt;
        &lt;wsap10:UsingAddressing/&gt;
        &lt;!--
            The sp:SymmetricBinding element indicates that security is provided
            at the SOAP layer and any initiator must authenticate itself by providing
            WSS UsernameToken credentials.
        --&gt;
        &lt;sp:SymmetricBinding
          xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
          &lt;wsp:Policy&gt;
            &lt;!--
                In a symmetric binding, the keys used for encrypting and signing in both
                directions are derived from a single key, the one specified by the
                sp:ProtectionToken element.  The sp:X509Token sub-element declares this
                key to be a X.509 certificate and the
                IncludeToken="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702/IncludeToken/Never"
                attribute adds the requirement that the token MUST NOT be included in
                any messages sent between the initiator and the recipient; rather, an
                external reference to the token should be used.  Lastly the WssX509V3Token10
                sub-element declares that the Username token presented by the initiator
                should be compliant with Web Services Security UsernameToken Profile
                1.0 specification. [ http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-username-token-profile-1.0.pdf ]
            --&gt;
            &lt;sp:ProtectionToken&gt;
              &lt;wsp:Policy&gt;
                &lt;sp:X509Token
                  sp:IncludeToken="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702/IncludeToken/Never"&gt;
                  &lt;wsp:Policy&gt;
                    &lt;sp:RequireDerivedKeys/&gt;
                    &lt;sp:RequireThumbprintReference/&gt;
                    &lt;sp:WssX509V3Token10/&gt;
                  &lt;/wsp:Policy&gt;
                &lt;/sp:X509Token&gt;
              &lt;/wsp:Policy&gt;
            &lt;/sp:ProtectionToken&gt;
            &lt;!--
                The sp:AlgorithmSuite element, requires the Basic256 algorithm suite
                be used in performing cryptographic operations.
            --&gt;
            &lt;sp:AlgorithmSuite&gt;
              &lt;wsp:Policy&gt;
                &lt;sp:Basic256/&gt;
              &lt;/wsp:Policy&gt;
            &lt;/sp:AlgorithmSuite&gt;
            &lt;!--
                The sp:Layout element,  indicates the layout rules to apply when adding
                items to the security header.  The sp:Lax sub-element indicates items
                are added to the security header in any order that conforms to
                WSS: SOAP Message Security.
            --&gt;
            &lt;sp:Layout&gt;
              &lt;wsp:Policy&gt;
                &lt;sp:Lax/&gt;
              &lt;/wsp:Policy&gt;
            &lt;/sp:Layout&gt;
            &lt;sp:IncludeTimestamp/&gt;
            &lt;sp:EncryptSignature/&gt;
            &lt;sp:OnlySignEntireHeadersAndBody/&gt;
          &lt;/wsp:Policy&gt;
        &lt;/sp:SymmetricBinding&gt;
 
        &lt;!--
            The sp:SignedSupportingTokens element declares that the security header
            of messages must contain a sp:UsernameToken and the token must be signed.
            The attribute IncludeToken="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702/IncludeToken/AlwaysToRecipient"
            on sp:UsernameToken indicates that the token MUST be included in all
            messages sent from initiator to the recipient and that the token MUST
            NOT be included in messages sent from the recipient to the initiator.
            And finally the element sp:WssUsernameToken10 is a policy assertion
            indicating the Username token should be as defined in  Web Services
            Security UsernameToken Profile 1.0
        --&gt;
        &lt;sp:SignedSupportingTokens
          xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
          &lt;wsp:Policy&gt;
            &lt;sp:UsernameToken
              sp:IncludeToken="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702/IncludeToken/AlwaysToRecipient"&gt;
              &lt;wsp:Policy&gt;
                &lt;sp:WssUsernameToken10/&gt;
              &lt;/wsp:Policy&gt;
            &lt;/sp:UsernameToken&gt;
          &lt;/wsp:Policy&gt;
        &lt;/sp:SignedSupportingTokens&gt;
        &lt;!--
            The sp:Wss11 element declares WSS: SOAP Message Security 1.1 options
            to be supported by the STS.  These particular elements generally refer
            to how keys are referenced within the SOAP envelope.  These are normally
            handled by CXF.
        --&gt;
        &lt;sp:Wss11
          xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
          &lt;wsp:Policy&gt;
            &lt;sp:MustSupportRefKeyIdentifier/&gt;
            &lt;sp:MustSupportRefIssuerSerial/&gt;
            &lt;sp:MustSupportRefThumbprint/&gt;
            &lt;sp:MustSupportRefEncryptedKey/&gt;
          &lt;/wsp:Policy&gt;
        &lt;/sp:Wss11&gt;
        &lt;!--
            The sp:Trust13 element declares controls for WS-Trust 1.3 options.
            They are policy assertions related to exchanges specifically with
            client and server challenges and entropy behaviors.  Again these are
            normally handled by CXF.
        --&gt;
        &lt;sp:Trust13
          xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
          &lt;wsp:Policy&gt;
            &lt;sp:MustSupportIssuedTokens/&gt;
            &lt;sp:RequireClientEntropy/&gt;
            &lt;sp:RequireServerEntropy/&gt;
          &lt;/wsp:Policy&gt;
        &lt;/sp:Trust13&gt;
      &lt;/wsp:All&gt;
    &lt;/wsp:ExactlyOne&gt;
  &lt;/wsp:Policy&gt;
 
  &lt;wsp:Policy wsu:Id="Input_policy"&gt;
    &lt;wsp:ExactlyOne&gt;
      &lt;wsp:All&gt;
        &lt;sp:SignedParts
          xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
          &lt;sp:Body/&gt;
          &lt;sp:Header Name="To"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
          &lt;sp:Header Name="From"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
          &lt;sp:Header Name="FaultTo"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
          &lt;sp:Header Name="ReplyTo"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
          &lt;sp:Header Name="MessageID"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
          &lt;sp:Header Name="RelatesTo"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
          &lt;sp:Header Name="Action"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
        &lt;/sp:SignedParts&gt;
      &lt;/wsp:All&gt;
    &lt;/wsp:ExactlyOne&gt;
  &lt;/wsp:Policy&gt;
 
  &lt;wsp:Policy wsu:Id="Output_policy"&gt;
    &lt;wsp:ExactlyOne&gt;
      &lt;wsp:All&gt;
        &lt;sp:SignedParts
          xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
          &lt;sp:Body/&gt;
          &lt;sp:Header Name="To"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
          &lt;sp:Header Name="From"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
          &lt;sp:Header Name="FaultTo"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
          &lt;sp:Header Name="ReplyTo"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
          &lt;sp:Header Name="MessageID"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
          &lt;sp:Header Name="RelatesTo"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
          &lt;sp:Header Name="Action"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
        &lt;/sp:SignedParts&gt;
      &lt;/wsp:All&gt;
    &lt;/wsp:ExactlyOne&gt;
  &lt;/wsp:Policy&gt;
 
&lt;/wsdl:definitions&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="stss-implementation-class">STS&#8217;s implementation class</h4>
<div class="paragraph">
<p>The Apache CXF&#8217;s STS, SecurityTokenServiceProvider, is a web service
provider that is compliant with the protocols and functionality defined
by the WS-Trust specification. It has a modular architecture. Many of
its components are configurable or replaceable and there are many
optional features that are enabled by implementing and configuring
plug-ins. Users can customize their own STS by extending from
SecurityTokenServiceProvider and overriding the default settings.
Extensive information about the CXF&#8217;s STS configurable and pluggable
components can be found
<a href="http://coheigea.blogspot.com/2011/11/apache-cxf-sts-documentation-part-viii_10.html">here</a>.</p>
</div>
<div class="paragraph">
<p>This STS implementation class, SampleSTSBearer, is a POJO that extends
from SecurityTokenServiceProvider. Note that the class is defined with a
WebServiceProvider annotation and not a WebService annotation. This
annotation defines the service as a Provider-based endpoint, meaning it
supports a more messaging-oriented approach to Web services. In
particular, it signals that the exchanged messages will be XML documents
of some type. SecurityTokenServiceProvider is an implementation of the
javax.xml.ws.Provider interface. In comparison the WebService annotation
defines a (service endpoint interface) SEI-based endpoint which supports
message exchange via SOAP envelopes.</p>
</div>
<div class="paragraph">
<p>As was done in the BearerImpl class, the WSS4J annotations
EndpointProperties and EndpointProperty are providing endpoint
configuration for the CXF runtime. The first EndpointProperty statement
in the listing is declaring the user&#8217;s name to use for the message
signature. It is used as the alias name in the keystore to get the
user&#8217;s cert and private key for signature. The next two EndpointProperty
statements declares the Java properties file that contains the (Merlin)
crypto configuration information. In this case both for signing and
encrypting the messages. WSS4J reads this file and extra required
information for message handling. The last EndpointProperty statement
declares the STSBearerCallbackHandler implementation class. It is used
to obtain the user&#8217;s password for the certificates in the keystore file.</p>
</div>
<div class="paragraph">
<p>In this implementation we are customizing the operations of token
issuance, token validation and their static properties.</p>
</div>
<div class="paragraph">
<p>StaticSTSProperties is used to set select properties for configuring
resources in the STS. You may think this is a duplication of the
settings made with the WSS4J annotations. The values are the same but
the underlaying structures being set are different, thus this
information must be declared in both places.</p>
</div>
<div class="paragraph">
<p>The setIssuer setting is important because it uniquely identifies the
issuing STS. The issuer string is embedded in issued tokens and, when
validating tokens, the STS checks the issuer string value. Consequently,
it is important to use the issuer string in a consistent way, so that
the STS can recognize the tokens that it has issued.</p>
</div>
<div class="paragraph">
<p>The setEndpoints call allows the declaration of a set of allowed token
recipients by address. The addresses are specified as reg-ex patterns.</p>
</div>
<div class="paragraph">
<p>TokenIssueOperation has a modular structure. This allows custom
behaviors to be injected into the processing of messages. In this case
we are overriding the SecurityTokenServiceProvider&#8217;s default behavior
and performing SAML token processing. CXF provides an implementation of
a SAMLTokenProvider which we are using rather than writing our own.</p>
</div>
<div class="paragraph">
<p>Learn more about the SAMLTokenProvider
<a href="http://coheigea.blogspot.it/2011/10/apache-cxf-sts-documentation-part-iv.html">here</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package org.jboss.test.ws.jaxws.samples.wsse.policy.trust.stsbearer;
 
import org.apache.cxf.annotations.EndpointProperties;
import org.apache.cxf.annotations.EndpointProperty;
import org.apache.cxf.sts.StaticSTSProperties;
import org.apache.cxf.sts.operation.TokenIssueOperation;
import org.apache.cxf.sts.service.ServiceMBean;
import org.apache.cxf.sts.service.StaticService;
import org.apache.cxf.sts.token.provider.SAMLTokenProvider;
import org.apache.cxf.ws.security.sts.provider.SecurityTokenServiceProvider;
 
import javax.xml.ws.WebServiceProvider;
import java.util.Arrays;
import java.util.LinkedList;
import java.util.List;
 
@WebServiceProvider(serviceName = "SecurityTokenService",
      portName = "UT_Port",
      targetNamespace = "http://docs.oasis-open.org/ws-sx/ws-trust/200512/",
      wsdlLocation = "WEB-INF/wsdl/bearer-ws-trust-1.4-service.wsdl")
//be sure to have dependency on org.apache.cxf module when on AS7, otherwise Apache CXF annotations are ignored
@EndpointProperties(value = {
      @EndpointProperty(key = "ws-security.signature.username", value = "mystskey"),
      @EndpointProperty(key = "ws-security.signature.properties", value = "stsKeystore.properties"),
      @EndpointProperty(key = "ws-security.callback-handler", value = "org.jboss.test.ws.jaxws.samples.wsse.policy.trust.stsbearer.STSBearerCallbackHandler")
})
public class SampleSTSBearer extends SecurityTokenServiceProvider
{
 
   public SampleSTSBearer() throws Exception
   {
      super();
 
      StaticSTSProperties props = new StaticSTSProperties();
      props.setSignatureCryptoProperties("stsKeystore.properties");
      props.setSignatureUsername("mystskey");
      props.setCallbackHandlerClass(STSBearerCallbackHandler.class.getName());
      props.setEncryptionCryptoProperties("stsKeystore.properties");
      props.setEncryptionUsername("myservicekey");
      props.setIssuer("DoubleItSTSIssuer");
 
      List&lt;ServiceMBean&gt; services = new LinkedList&lt;ServiceMBean&gt;();
      StaticService service = new StaticService();
      service.setEndpoints(Arrays.asList(
         "https://localhost:(\\d)*/jaxws-samples-wsse-policy-trust-bearer/BearerService",
         "https://\\[::1\\]:(\\d)*/jaxws-samples-wsse-policy-trust-bearer/BearerService",
         "https://\\[0:0:0:0:0:0:0:1\\]:(\\d)*/jaxws-samples-wsse-policy-trust-bearer/BearerService"
      ));
      services.add(service);
 
      TokenIssueOperation issueOperation = new TokenIssueOperation();
      issueOperation.getTokenProviders().add(new SAMLTokenProvider());
      issueOperation.setServices(services);
      issueOperation.setStsProperties(props);
      this.setIssueOperation(issueOperation);
   }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="stsbearercallbackhandler">STSBearerCallbackHandler</h4>
<div class="paragraph">
<p>STSBearerCallbackHandler is a callback handler for the WSS4J Crypto API.
It is used to obtain the password for the private key in the keystore.
This class enables CXF to retrieve the password of the user name to use
for the message signature.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package org.jboss.test.ws.jaxws.samples.wsse.policy.trust.stsbearer;
 
import org.jboss.wsf.stack.cxf.extensions.security.PasswordCallbackHandler;
 
import java.util.HashMap;
import java.util.Map;
 
public class STSBearerCallbackHandler extends PasswordCallbackHandler
{
   public STSBearerCallbackHandler()
   {
      super(getInitMap());
   }
 
   private static Map&lt;String, String&gt; getInitMap()
   {
      Map&lt;String, String&gt; passwords = new HashMap&lt;String, String&gt;();
      passwords.put("mystskey", "stskpass");
      passwords.put("alice", "clarinet");
      return passwords;
   }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="crypto-properties-and-keystore-files-1">Crypto properties and keystore files</h4>
<div class="paragraph">
<p>WSS4J&#8217;s Crypto implementation is loaded and configured via a Java
properties file that contains Crypto configuration data. The file
contains implementation-specific properties such as a keystore location,
password, default alias and the like. This application is using the
Merlin implementation. File stsKeystore.properties contains this
information.</p>
</div>
<div class="paragraph">
<p>File servicestore.jks, is a Java KeyStore (JKS) repository. It contains
self signed certificates for myservicekey and mystskey. <em>Self signed
certificates are not appropriate for production use.</em></p>
</div>
<div class="literalblock">
<div class="content">
<pre>org.apache.ws.security.crypto.provider=org.apache.ws.security.components.crypto.Merlin
org.apache.ws.security.crypto.merlin.keystore.type=jks
org.apache.ws.security.crypto.merlin.keystore.password=stsspass
org.apache.ws.security.crypto.merlin.keystore.file=stsstore.jks</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="manifest.mf-1">MANIFEST.MF</h4>
<div class="paragraph">
<p>When deployed on WildFly, this application requires access to the
JBossWs and CXF APIs provided in modules
org.jboss.ws.cxf.jbossws-cxf-client and org.apache.cxf. The Apache CXF
internals, org.apache.cxf.impl, are needed to build the STS
configuration in the <code>SampleSTS</code> constructor. The dependency statement
directs the server to provide them at deployment.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Manifest-Version: 1.0
Ant-Version: Apache Ant 1.8.2
Created-By: 1.7.0_25-b15 (Oracle Corporation)
Dependencies: org.jboss.ws.cxf.jbossws-cxf-client,org.apache.cxf.impl</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="web-service-requester">Web service requester</h3>
<div class="paragraph">
<p>This section examines the crucial elements in calling a web service that
implements endpoint security as described in the SAML Bearer scenario.
The components that will be discussed are.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Web service requester&#8217;s implementation</p>
</li>
<li>
<p>ClientCallbackHandler</p>
</li>
<li>
<p>Crypto properties and keystore files</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="web-service-requester-implementation">Web service requester Implementation</h4>
<div class="paragraph">
<p>The ws-requester, the client, uses standard procedures for creating a
reference to the web service. To address the endpoint security
requirements, the web service&#8217;s "Request Context" is configured with the
information needed in message generation. In addition, the STSClient
that communicates with the STS is configured with similar values. Note
the key strings ending with a ".it" suffix. This suffix flags these
settings as belonging to the STSClient. The internal CXF code assigns
this information to the STSClient that is auto-generated for this
service call.</p>
</div>
<div class="paragraph">
<p>There is an alternate method of setting up the STSCLient. The user may
provide their own instance of the STSClient. The CXF code will use this
object and not auto-generate one. When providing the STSClient in this
way, the user must provide a org.apache.cxf.Bus for it and the
configuration keys must not have the ".it" suffix. This is used in the
ActAs and OnBehalfOf examples.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">  String serviceURL = "https://" + getServerHost() + ":8443/jaxws-samples-wsse-policy-trust-bearer/BearerService";
 
  final QName serviceName = new QName("http://www.jboss.org/jbossws/ws-extensions/bearerwssecuritypolicy", "BearerService");
  Service service = Service.create(new URL(serviceURL + "?wsdl"), serviceName);
  BearerIface proxy = (BearerIface) service.getPort(BearerIface.class);
 
  Map&lt;String, Object&gt; ctx = ((BindingProvider)proxy).getRequestContext();
 
  // set the security related configuration information for the service "request"
  ctx.put(SecurityConstants.CALLBACK_HANDLER, new ClientCallbackHandler());
  ctx.put(SecurityConstants.SIGNATURE_PROPERTIES,
    Thread.currentThread().getContextClassLoader().getResource(
    "META-INF/clientKeystore.properties"));
  ctx.put(SecurityConstants.ENCRYPT_PROPERTIES,
    Thread.currentThread().getContextClassLoader().getResource(
    "META-INF/clientKeystore.properties"));
  ctx.put(SecurityConstants.SIGNATURE_USERNAME, "myclientkey");
  ctx.put(SecurityConstants.ENCRYPT_USERNAME, "myservicekey");
 
  //-- Configuration settings that will be transfered to the STSClient
  // "alice" is the name provided for the WSS Username. Her password will
  // be retreived from the ClientCallbackHander by the STSClient.
  ctx.put(SecurityConstants.USERNAME + ".it", "alice");
  ctx.put(SecurityConstants.CALLBACK_HANDLER + ".it", new ClientCallbackHandler());
  ctx.put(SecurityConstants.ENCRYPT_PROPERTIES + ".it",
    Thread.currentThread().getContextClassLoader().getResource(
    "META-INF/clientKeystore.properties"));
  ctx.put(SecurityConstants.ENCRYPT_USERNAME + ".it", "mystskey");
  ctx.put(SecurityConstants.STS_TOKEN_USERNAME + ".it", "myclientkey");
  ctx.put(SecurityConstants.STS_TOKEN_PROPERTIES + ".it",
    Thread.currentThread().getContextClassLoader().getResource(
    "META-INF/clientKeystore.properties"));
  ctx.put(SecurityConstants.STS_TOKEN_USE_CERT_FOR_KEYINFO + ".it", "true");
 
  proxy.sayHello();</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="clientcallbackhandler">ClientCallbackHandler</h4>
<div class="paragraph">
<p><a href="https://docs.jboss.org/author/display/JBWS/WS-Trust+and+STS#WS-TrustandSTS-ClientCallbackHandler" class="bare">https://docs.jboss.org/author/display/JBWS/WS-Trust+and+STS#WS-TrustandSTS-ClientCallbackHandler</a></p>
</div>
<div class="paragraph">
<p>ClientCallbackHandler is a callback handler for the WSS4J Crypto API. It
is used to obtain the password for the private key in the keystore. This
class enables CXF to retrieve the password of the user name to use for
the message signature. Note that "alice" and her password have been
provided here. This information is not in the (JKS) keystore but
provided in the WildFly security domain. It was declared in file
jbossws-users.properties.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package org.jboss.test.ws.jaxws.samples.wsse.policy.trust.shared;
 
import java.io.IOException;
import javax.security.auth.callback.Callback;
import javax.security.auth.callback.CallbackHandler;
import javax.security.auth.callback.UnsupportedCallbackException;
import org.apache.ws.security.WSPasswordCallback;
 
public class ClientCallbackHandler implements CallbackHandler {
 
    public void handle(Callback[] callbacks) throws IOException,
            UnsupportedCallbackException {
        for (int i = 0; i &lt; callbacks.length; i++) {
            if (callbacks[i] instanceof WSPasswordCallback) {
                WSPasswordCallback pc = (WSPasswordCallback) callbacks[i];
                if ("myclientkey".equals(pc.getIdentifier())) {
                    pc.setPassword("ckpass");
                    break;
                } else if ("alice".equals(pc.getIdentifier())) {
                    pc.setPassword("clarinet");
                    break;
                } else if ("bob".equals(pc.getIdentifier())) {
                    pc.setPassword("trombone");
                    break;
                } else if ("myservicekey".equals(pc.getIdentifier())) {  // rls test  added for bearer test
                   pc.setPassword("skpass");
                   break;
                }
            }
        }
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="crypto-properties-and-keystore-files-2">Crypto properties and keystore files</h4>
<div class="paragraph">
<p><a href="https://docs.jboss.org/author/display/JBWS/WS-Trust+and+STS#WS-TrustandSTS-RequesterCryptopropertiesandkeystorefiles" class="bare">https://docs.jboss.org/author/display/JBWS/WS-Trust+and+STS#WS-TrustandSTS-RequesterCryptopropertiesandkeystorefiles</a></p>
</div>
<div class="paragraph">
<p>WSS4J&#8217;s Crypto implementation is loaded and configured via a Java
properties file that contains Crypto configuration data. The file
contains implementation-specific properties such as a keystore location,
password, default alias and the like. This application is using the
Merlin implementation. File clientKeystore.properties contains this
information.</p>
</div>
<div class="paragraph">
<p>File clientstore.jks, is a Java KeyStore (JKS) repository. It contains
self signed certificates for myservicekey and mystskey. <em>Self signed
certificates are not appropriate for production use.</em></p>
</div>
<div class="literalblock">
<div class="content">
<pre>org.apache.ws.security.crypto.provider=org.apache.ws.security.components.crypto.Merlin
org.apache.ws.security.crypto.merlin.keystore.type=jks
org.apache.ws.security.crypto.merlin.keystore.password=cspass
org.apache.ws.security.crypto.merlin.keystore.alias=myclientkey
org.apache.ws.security.crypto.merlin.keystore.file=META-INF/clientstore.jks</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="SAML_Holder-Of-Key_Assertion_Scenario">SAML Holder-Of-Key Assertion Scenario</h2>
<div class="sectionbody">
<div class="paragraph">
<p>WS-Trust deals with managing software security tokens. A SAML assertion
is a type of security token. In the Holder-Of-Key method, the STS
creates a SAML token containing the client&#8217;s public key and signs the
SAML token with its private key. The client includes the SAML token and
signs the outgoing soap envelope to the web service with its private
key. The web service validates the SOAP message and the SAML token.</p>
</div>
<div class="paragraph">
<p>Implementation of this scenario has the following requirements.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>SAML tokens with a Holder-Of-Key subject confirmation method must be
protected so the token can not be snooped. In most cases, a
Holder-Of-Key token combined with HTTPS is sufficient to prevent "a man
in the middle" getting possession of the token. This means a security
policy that uses a sp:TransportBinding and sp:HttpsToken.</p>
</li>
<li>
<p>A Holder-Of-Key token has no encryption or signing keys associated
with it, therefore a sp:IssuedToken of SymmetricKey or PublicKey keyType
should be used with a sp:SignedEndorsingSupportingTokens.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="web-service-provider-5">Web service Provider</h3>
<div class="paragraph">
<p>This section examines the web service elements for the SAML
Holder-Of-Key scenario. The components are</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Web service provider&#8217;s WSDL</p>
</li>
<li>
<p>SSL configuration</p>
</li>
<li>
<p>Web service provider&#8217;s Interface and Implementation classes.</p>
</li>
<li>
<p>Crypto properties and keystore files</p>
</li>
<li>
<p>MANIFEST.MF</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="web-service-provider-wsdl-5">Web service provider WSDL</h4>
<div class="paragraph">
<p>The web service provider is a contract-first endpoint. All the WS-trust
and security policies for it are declared in the WSDL,
HolderOfKeyService.wsdl. For this scenario a ws-requester is required to
present a SAML 2.0 token of SymmetricKey keyType, issued from a designed
STS. The address of the STS is provided in the WSDL. A transport binding
policy is used. The token is declared to be signed and endorsed,
sp:SignedEndorsingSupportingTokens. A detailed explanation of the
security settings are provided in the comments in the listing below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;
&lt;definitions targetNamespace="http://www.jboss.org/jbossws/ws-extensions/holderofkeywssecuritypolicy"
             name="HolderOfKeyService"
        xmlns:tns="http://www.jboss.org/jbossws/ws-extensions/holderofkeywssecuritypolicy"
        xmlns:xsd="http://www.w3.org/2001/XMLSchema"
        xmlns:soap="http://schemas.xmlsoap.org/wsdl/soap/"
        xmlns="http://schemas.xmlsoap.org/wsdl/"
        xmlns:wsp="http://www.w3.org/ns/ws-policy"
        xmlns:wsam="http://www.w3.org/2007/05/addressing/metadata"
    xmlns:wsu="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd"
    xmlns:wsaws="http://www.w3.org/2005/08/addressing"
    xmlns:wsx="http://schemas.xmlsoap.org/ws/2004/09/mex"
    xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"
    xmlns:t="http://docs.oasis-open.org/ws-sx/ws-trust/200512"&gt;
 
  &lt;types&gt;
    &lt;xsd:schema&gt;
      &lt;xsd:import namespace="http://www.jboss.org/jbossws/ws-extensions/holderofkeywssecuritypolicy"
                  schemaLocation="HolderOfKeyService_schema1.xsd"/&gt;
    &lt;/xsd:schema&gt;
  &lt;/types&gt;
  &lt;message name="sayHello"&gt;
    &lt;part name="parameters" element="tns:sayHello"/&gt;
  &lt;/message&gt;
  &lt;message name="sayHelloResponse"&gt;
    &lt;part name="parameters" element="tns:sayHelloResponse"/&gt;
  &lt;/message&gt;
  &lt;portType name="HolderOfKeyIface"&gt;
    &lt;operation name="sayHello"&gt;
      &lt;input message="tns:sayHello"/&gt;
      &lt;output message="tns:sayHelloResponse"/&gt;
    &lt;/operation&gt;
  &lt;/portType&gt;
&lt;!--
        The wsp:PolicyReference binds the security requirments on all the endpoints.
        The wsp:Policy wsu:Id="#TransportSAML2HolderOfKeyPolicy" element is defined later in this file.
--&gt;
  &lt;binding name="HolderOfKeyServicePortBinding" type="tns:HolderOfKeyIface"&gt;
    &lt;wsp:PolicyReference URI="#TransportSAML2HolderOfKeyPolicy" /&gt;
    &lt;soap:binding transport="http://schemas.xmlsoap.org/soap/http" style="document"/&gt;
    &lt;operation name="sayHello"&gt;
      &lt;soap:operation soapAction=""/&gt;
      &lt;input&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/input&gt;
      &lt;output&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/output&gt;
    &lt;/operation&gt;
  &lt;/binding&gt;
&lt;!--
  The soap:address has been defined to use JBoss's https port, 8443.  This is
  set in conjunction with the sp:TransportBinding policy for https.
--&gt;
  &lt;service name="HolderOfKeyService"&gt;
    &lt;port name="HolderOfKeyServicePort" binding="tns:HolderOfKeyServicePortBinding"&gt;
      &lt;soap:address location="https://@jboss.bind.address@:8443/jaxws-samples-wsse-policy-trust-holderofkey/HolderOfKeyService"/&gt;
    &lt;/port&gt;
  &lt;/service&gt;
 
 
  &lt;wsp:Policy wsu:Id="TransportSAML2HolderOfKeyPolicy"&gt;
    &lt;wsp:ExactlyOne&gt;
      &lt;wsp:All&gt;
  &lt;!--
        The wsam:Addressing element, indicates that the endpoints of this
        web service MUST conform to the WS-Addressing specification.  The
        attribute wsp:Optional="false" enforces this assertion.
  --&gt;
        &lt;wsam:Addressing wsp:Optional="false"&gt;
          &lt;wsp:Policy /&gt;
        &lt;/wsam:Addressing&gt;
&lt;!--
  The sp:TransportBinding element indicates that security is provided by the
  message exchange transport medium, https.  WS-Security policy specification
  defines the sp:HttpsToken for use in exchanging messages transmitted over HTTPS.
--&gt;
          &lt;sp:TransportBinding
            xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
            &lt;wsp:Policy&gt;
              &lt;sp:TransportToken&gt;
                &lt;wsp:Policy&gt;
                  &lt;sp:HttpsToken&gt;
                    &lt;wsp:Policy/&gt;
                  &lt;/sp:HttpsToken&gt;
                &lt;/wsp:Policy&gt;
              &lt;/sp:TransportToken&gt;
&lt;!--
     The sp:AlgorithmSuite element, requires the TripleDes algorithm suite
     be used in performing cryptographic operations.
--&gt;
              &lt;sp:AlgorithmSuite&gt;
                &lt;wsp:Policy&gt;
                  &lt;sp:TripleDes /&gt;
                &lt;/wsp:Policy&gt;
              &lt;/sp:AlgorithmSuite&gt;
&lt;!--
     The sp:Layout element,  indicates the layout rules to apply when adding
     items to the security header.  The sp:Lax sub-element indicates items
     are added to the security header in any order that conforms to
     WSS: SOAP Message Security.
--&gt;
              &lt;sp:Layout&gt;
                &lt;wsp:Policy&gt;
                  &lt;sp:Lax /&gt;
                &lt;/wsp:Policy&gt;
              &lt;/sp:Layout&gt;
              &lt;sp:IncludeTimestamp /&gt;
            &lt;/wsp:Policy&gt;
          &lt;/sp:TransportBinding&gt;
 
&lt;!--
  The sp:SignedEndorsingSupportingTokens, when transport level security level is
  used there will be no message signature and the signature generated by the
  supporting token will sign the Timestamp.
--&gt;
        &lt;sp:SignedEndorsingSupportingTokens
          xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
          &lt;wsp:Policy&gt;
&lt;!--
  The sp:IssuedToken element asserts that a SAML 2.0 security token of type
  Bearer is expected from the STS.  The
  sp:IncludeToken="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702/IncludeToken/AlwaysToRecipient"&gt;
  attribute instructs the runtime to include the initiator's public key
  with every message sent to the recipient.
 
  The sp:RequestSecurityTokenTemplate element directs that all of the
  children of this element will be copied directly into the body of the
  RequestSecurityToken (RST) message that is sent to the STS when the
  initiator asks the STS to issue a token.
--&gt;
            &lt;sp:IssuedToken
              sp:IncludeToken="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702/IncludeToken/AlwaysToRecipient"&gt;
              &lt;sp:RequestSecurityTokenTemplate&gt;
                &lt;t:TokenType&gt;http://docs.oasis-open.org/wss/oasis-wss-saml-token-profile-1.1#SAMLV2.0&lt;/t:TokenType&gt;
 &lt;!--
   KeyType of "SymmetricKey", the client must prove to the WS service that it
   possesses a particular symmetric session key.
 --&gt;
                &lt;t:KeyType&gt;http://docs.oasis-open.org/ws-sx/ws-trust/200512/SymmetricKey&lt;/t:KeyType&gt;
              &lt;/sp:RequestSecurityTokenTemplate&gt;
              &lt;wsp:Policy&gt;
                &lt;sp:RequireInternalReference /&gt;
              &lt;/wsp:Policy&gt;
&lt;!--
  The sp:Issuer element defines the STS's address and endpoint information
  This information is used by the STSClient.
--&gt;
              &lt;sp:Issuer&gt;
                &lt;wsaws:Address&gt;http://@jboss.bind.address@:8080/jaxws-samples-wsse-policy-trust-sts-holderofkey/SecurityTokenService&lt;/wsaws:Address&gt;
                &lt;wsaws:Metadata
                  xmlns:wsdli="http://www.w3.org/2006/01/wsdl-instance"
                  wsdli:wsdlLocation="http://@jboss.bind.address@:8080/jaxws-samples-wsse-policy-trust-sts-holderofkey/SecurityTokenService?wsdl"&gt;
                  &lt;wsaw:ServiceName
                    xmlns:wsaw="http://www.w3.org/2006/05/addressing/wsdl"
                    xmlns:stsns="http://docs.oasis-open.org/ws-sx/ws-trust/200512/"
                    EndpointName="UT_Port"&gt;stsns:SecurityTokenService&lt;/wsaw:ServiceName&gt;
                &lt;/wsaws:Metadata&gt;
              &lt;/sp:Issuer&gt;
 
            &lt;/sp:IssuedToken&gt;
          &lt;/wsp:Policy&gt;
        &lt;/sp:SignedEndorsingSupportingTokens&gt;
&lt;!--
    The sp:Wss11 element declares WSS: SOAP Message Security 1.1 options
    to be supported by the STS.  These particular elements generally refer
    to how keys are referenced within the SOAP envelope.  These are normally
    handled by CXF.
--&gt;
        &lt;sp:Wss11&gt;
          &lt;wsp:Policy&gt;
            &lt;sp:MustSupportRefIssuerSerial /&gt;
            &lt;sp:MustSupportRefThumbprint /&gt;
            &lt;sp:MustSupportRefEncryptedKey /&gt;
          &lt;/wsp:Policy&gt;
        &lt;/sp:Wss11&gt;
&lt;!--
    The sp:Trust13 element declares controls for WS-Trust 1.3 options.
    They are policy assertions related to exchanges specifically with
    client and server challenges and entropy behaviors.  Again these are
    normally handled by CXF.
--&gt;
        &lt;sp:Trust13&gt;
          &lt;wsp:Policy&gt;
            &lt;sp:MustSupportIssuedTokens /&gt;
            &lt;sp:RequireClientEntropy /&gt;
            &lt;sp:RequireServerEntropy /&gt;
          &lt;/wsp:Policy&gt;
        &lt;/sp:Trust13&gt;
      &lt;/wsp:All&gt;
    &lt;/wsp:ExactlyOne&gt;
  &lt;/wsp:Policy&gt;
 
&lt;/definitions&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="ssl-configuration">SSL configuration</h4>
<div class="paragraph">
<p><a href="https://docs.jboss.org/author/display/JBWS/WS-Trust+and+STS#WS-TrustandSTS-SSLconfiguration" class="bare">https://docs.jboss.org/author/display/JBWS/WS-Trust+and+STS#WS-TrustandSTS-SSLconfiguration</a></p>
</div>
<div class="paragraph">
<p>This web service is using https, therefore the JBoss server must be
configured to provide SSL support in the Web subsystem. There are 2
components to SSL configuration.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>create a certificate keystore</p>
</li>
<li>
<p>declare an SSL connector in the Web subsystem of the JBoss server
configuration file.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Follow the directions in the, " <em>Using the pure Java implementation
supplied by JSSE</em>" section in the link:#[SSL Setup
Guide|../../../../../../../../../../display/WFLY8/SSL+setup+guide|||\].</p>
</div>
<div class="paragraph">
<p>Here is an example of an SSL connector declaration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">&lt;subsystem xmlns="urn:jboss:domain:web:1.4" default-virtual-server="default-host" native="false"&gt;
.....
  &lt;connector name="jbws-https-connector" protocol="HTTP/1.1" scheme="https" socket-binding="https" secure="true" enabled="true"&gt;
    &lt;ssl key-alias="tomcat" password="changeit" certificate-key-file="/myJbossHome/security/test.keystore" verify-client="false"/&gt;
  &lt;/connector&gt;
...</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="web-service-interface">Web service Interface</h4>
<div class="paragraph">
<p>The web service provider interface class, HolderOfKeyIface, is a simple
straight forward web service definition.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package org.jboss.test.ws.jaxws.samples.wsse.policy.trust.holderofkey;
 
import javax.jws.WebMethod;
import javax.jws.WebService;
 
@WebService
(
   targetNamespace = "http://www.jboss.org/jbossws/ws-extensions/holderofkeywssecuritypolicy"
)
public interface HolderOfKeyIface {
   @WebMethod
   String sayHello();
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="web-service-implementation">Web service Implementation</h4>
<div class="paragraph">
<p>The web service provider implementation class, HolderOfKeyImpl, is a
simple POJO. It uses the standard WebService annotation to define the
service endpoint. In addition there are two Apache CXF annotations,
EndpointProperties and EndpointProperty used for configuring the
endpoint for the CXF runtime. These annotations come from the
<a href="https://ws.apache.org/wss4j/">Apache WSS4J project</a>, which provides a
Java implementation of the primary WS-Security standards for Web
Services. These annotations are programmatically adding properties to
the endpoint. With plain Apache CXF, these properties are often set via
the &lt;jaxws:properties&gt; element on the &lt;jaxws:endpoint&gt; element in the
Spring config; these annotations allow the properties to be configured
in the code.</p>
</div>
<div class="paragraph">
<p>WSS4J uses the Crypto interface to get keys and certificates for
signature creation/verification, as is asserted by the WSDL for this
service. The WSS4J configuration information being provided by
HolderOfKeyImpl is for Crypto&#8217;s Merlin implementation. More information
will be provided about this in the keystore section.</p>
</div>
<div class="paragraph">
<p>The first EndpointProperty statement in the listing disables ensurance
of compliance with the Basic Security Profile 1.1. The next
EndpointProperty statements declares the Java properties file that
contains the (Merlin) crypto configuration information. The last
EndpointProperty statement declares the STSHolderOfKeyCallbackHandler
implementation class. It is used to obtain the user&#8217;s password for the
certificates in the keystore file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package org.jboss.test.ws.jaxws.samples.wsse.policy.trust.holderofkey;
 
import org.apache.cxf.annotations.EndpointProperties;
import org.apache.cxf.annotations.EndpointProperty;
 
import javax.jws.WebService;
 
@WebService
   (
      portName = "HolderOfKeyServicePort",
      serviceName = "HolderOfKeyService",
      wsdlLocation = "WEB-INF/wsdl/HolderOfKeyService.wsdl",
      targetNamespace = "http://www.jboss.org/jbossws/ws-extensions/holderofkeywssecuritypolicy",
      endpointInterface = "org.jboss.test.ws.jaxws.samples.wsse.policy.trust.holderofkey.HolderOfKeyIface"
   )
@EndpointProperties(value = {
   @EndpointProperty(key = "ws-security.is-bsp-compliant", value = "false"),
   @EndpointProperty(key = "ws-security.signature.properties", value = "serviceKeystore.properties"),
   @EndpointProperty(key = "ws-security.callback-handler", value = "org.jboss.test.ws.jaxws.samples.wsse.policy.trust.holderofkey.HolderOfKeyCallbackHandler")
})
public class HolderOfKeyImpl implements HolderOfKeyIface
{
   public String sayHello()
   {
      return "Holder-Of-Key WS-Trust Hello World!";
   }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="crypto-properties-and-keystore-files">Crypto properties and keystore files</h4>
<div class="paragraph">
<p>WSS4J&#8217;s Crypto implementation is loaded and configured via a Java
properties file that contains Crypto configuration data. The file
contains implementation-specific properties such as a keystore location,
password, default alias and the like. This application is using the
Merlin implementation. File serviceKeystore.properties contains this
information.</p>
</div>
<div class="paragraph">
<p>File servicestore.jks, is a Java KeyStore (JKS) repository. It contains
self signed certificates for myservicekey and mystskey. <em>Self signed
certificates are not appropriate for production use.</em></p>
</div>
<div class="literalblock">
<div class="content">
<pre>org.apache.ws.security.crypto.provider=org.apache.ws.security.components.crypto.Merlin
org.apache.ws.security.crypto.merlin.keystore.type=jks
org.apache.ws.security.crypto.merlin.keystore.password=sspass
org.apache.ws.security.crypto.merlin.keystore.alias=myservicekey
org.apache.ws.security.crypto.merlin.keystore.file=servicestore.jks</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="manifest.mf">MANIFEST.MF</h4>
<div class="paragraph">
<p><a href="https://docs.jboss.org/author/display/JBWS/WS-Trust+and+STS#WS-TrustandSTS-MANIFEST.MF" class="bare">https://docs.jboss.org/author/display/JBWS/WS-Trust+and+STS#WS-TrustandSTS-MANIFEST.MF</a></p>
</div>
<div class="paragraph">
<p>When deployed on WildFly this application requires access to the JBossWs
and CXF APIs provided in module org.jboss.ws.cxf.jbossws-cxf-client. The
dependency statement directs the server to provide them at deployment.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Manifest-Version:1.0
Ant-Version: Apache Ant1.8.2
Created-By:1.7.0_25-b15 (Oracle Corporation)
Dependencies: org.jboss.ws.cxf.jbossws-cxf-client</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="security-token-service">Security Token Service</h3>
<div class="paragraph">
<p>This section examines the crucial elements in providing the Security
Token Service functionality for providing a SAML Holder-Of-Key token.
The components that will be discussed are.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Security Domain</p>
</li>
<li>
<p>STS&#8217;s WSDL</p>
</li>
<li>
<p>STS&#8217;s implementation class</p>
</li>
<li>
<p>STSBearerCallbackHandler</p>
</li>
<li>
<p>Crypto properties and keystore files</p>
</li>
<li>
<p>MANIFEST.MF</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="security-domain">Security Domain</h4>
<div class="paragraph">
<p>The STS requires a JBoss security domain be configured. The
jboss-web.xml descriptor declares a named security
domain,"JBossWS-trust-sts" to be used by this service for
authentication. This security domain requires two properties files and
the addition of a security-domain declaration in the JBoss server
configuration file.</p>
</div>
<div class="paragraph">
<p>For this scenario the domain needs to contain user <em>alice</em>, password
<em>clarinet</em>, and role <em>friend</em>. See the listings below for
jbossws-users.properties and jbossws-roles.properties. In addition the
following XML must be added to the JBoss security subsystem in the
server configuration file. Replace " <strong>SOME_PATH</strong>" with appropriate
information.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;security-domain name="JBossWS-trust-sts"&gt;
  &lt;authentication&gt;
   &lt;login-module code="UsersRoles" flag="required"&gt;
     &lt;module-option name="usersProperties" value="/SOME_PATH/jbossws-users.properties"/&gt;
     &lt;module-option name="unauthenticatedIdentity" value="anonymous"/&gt;
     &lt;module-option name="rolesProperties" value="/SOME_PATH/jbossws-roles.properties"/&gt;
   &lt;/login-module&gt;
  &lt;/authentication&gt;
&lt;/security-domain&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>jboss-web.xml</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!DOCTYPE jboss-web PUBLIC"-//JBoss//DTD Web Application 2.4//EN" "&gt;
&lt;jboss-web&gt;
  &lt;security-domain&gt;java:/jaas/JBossWS-trust-sts&lt;/security-domain&gt;
&lt;/jboss-web&gt;</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 100%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"> </th>
</tr>
</thead>
</table>
<div class="paragraph">
<p>jbossws-users.properties</p>
</div>
<div class="literalblock">
<div class="content">
<pre># A sample users.properties filefor use with the UsersRolesLoginModule
alice=clarinet</pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 100%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"> </th>
</tr>
</thead>
</table>
<div class="paragraph">
<p>jbossws-roles.properties</p>
</div>
<div class="literalblock">
<div class="content">
<pre># A sample roles.properties filefor use with the UsersRolesLoginModule
alice=friend</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="stss-wsdl">STS&#8217;s WSDL</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;wsdl:definitions
  targetNamespace="http://docs.oasis-open.org/ws-sx/ws-trust/200512/"
  xmlns:tns="http://docs.oasis-open.org/ws-sx/ws-trust/200512/"
  xmlns:wstrust="http://docs.oasis-open.org/ws-sx/ws-trust/200512/"
  xmlns:wsdl="http://schemas.xmlsoap.org/wsdl/"
  xmlns:soap="http://schemas.xmlsoap.org/wsdl/soap/"
  xmlns:wsap10="http://www.w3.org/2006/05/addressing/wsdl"
  xmlns:wsu="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd"
  xmlns:wsp="http://www.w3.org/ns/ws-policy"
  xmlns:wst="http://docs.oasis-open.org/ws-sx/ws-trust/200512"
  xmlns:xs="http://www.w3.org/2001/XMLSchema"
  xmlns:wsam="http://www.w3.org/2007/05/addressing/metadata"&gt;
 
  &lt;wsdl:types&gt;
    &lt;xs:schema elementFormDefault="qualified"
               targetNamespace='http://docs.oasis-open.org/ws-sx/ws-trust/200512'&gt;
 
      &lt;xs:element name='RequestSecurityToken'
                  type='wst:AbstractRequestSecurityTokenType'/&gt;
      &lt;xs:element name='RequestSecurityTokenResponse'
                  type='wst:AbstractRequestSecurityTokenType'/&gt;
 
      &lt;xs:complexType name='AbstractRequestSecurityTokenType'&gt;
        &lt;xs:sequence&gt;
          &lt;xs:any namespace='##any' processContents='lax' minOccurs='0'
                  maxOccurs='unbounded'/&gt;
        &lt;/xs:sequence&gt;
        &lt;xs:attribute name='Context' type='xs:anyURI' use='optional'/&gt;
        &lt;xs:anyAttribute namespace='##other' processContents='lax'/&gt;
      &lt;/xs:complexType&gt;
      &lt;xs:element name='RequestSecurityTokenCollection'
                  type='wst:RequestSecurityTokenCollectionType'/&gt;
      &lt;xs:complexType name='RequestSecurityTokenCollectionType'&gt;
        &lt;xs:sequence&gt;
          &lt;xs:element name='RequestSecurityToken'
                      type='wst:AbstractRequestSecurityTokenType' minOccurs='2'
                      maxOccurs='unbounded'/&gt;
        &lt;/xs:sequence&gt;
      &lt;/xs:complexType&gt;
 
      &lt;xs:element name='RequestSecurityTokenResponseCollection'
                  type='wst:RequestSecurityTokenResponseCollectionType'/&gt;
      &lt;xs:complexType name='RequestSecurityTokenResponseCollectionType'&gt;
        &lt;xs:sequence&gt;
          &lt;xs:element ref='wst:RequestSecurityTokenResponse' minOccurs='1'
                      maxOccurs='unbounded'/&gt;
        &lt;/xs:sequence&gt;
        &lt;xs:anyAttribute namespace='##other' processContents='lax'/&gt;
      &lt;/xs:complexType&gt;
 
    &lt;/xs:schema&gt;
  &lt;/wsdl:types&gt;
 
  &lt;!-- WS-Trust defines the following GEDs --&gt;
  &lt;wsdl:message name="RequestSecurityTokenMsg"&gt;
    &lt;wsdl:part name="request" element="wst:RequestSecurityToken"/&gt;
  &lt;/wsdl:message&gt;
  &lt;wsdl:message name="RequestSecurityTokenResponseMsg"&gt;
    &lt;wsdl:part name="response"
               element="wst:RequestSecurityTokenResponse"/&gt;
  &lt;/wsdl:message&gt;
  &lt;wsdl:message name="RequestSecurityTokenCollectionMsg"&gt;
    &lt;wsdl:part name="requestCollection"
               element="wst:RequestSecurityTokenCollection"/&gt;
  &lt;/wsdl:message&gt;
  &lt;wsdl:message name="RequestSecurityTokenResponseCollectionMsg"&gt;
    &lt;wsdl:part name="responseCollection"
               element="wst:RequestSecurityTokenResponseCollection"/&gt;
  &lt;/wsdl:message&gt;
 
  &lt;!-- This portType an example of a Requestor (or other) endpoint that
         Accepts SOAP-based challenges from a Security Token Service --&gt;
  &lt;wsdl:portType name="WSSecurityRequestor"&gt;
    &lt;wsdl:operation name="Challenge"&gt;
      &lt;wsdl:input message="tns:RequestSecurityTokenResponseMsg"/&gt;
      &lt;wsdl:output message="tns:RequestSecurityTokenResponseMsg"/&gt;
    &lt;/wsdl:operation&gt;
  &lt;/wsdl:portType&gt;
 
  &lt;!-- This portType is an example of an STS supporting full protocol --&gt;
  &lt;wsdl:portType name="STS"&gt;
    &lt;wsdl:operation name="Cancel"&gt;
      &lt;wsdl:input
        wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Cancel"
        message="tns:RequestSecurityTokenMsg"/&gt;
      &lt;wsdl:output
        wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RSTR/CancelFinal"
        message="tns:RequestSecurityTokenResponseMsg"/&gt;
    &lt;/wsdl:operation&gt;
    &lt;wsdl:operation name="Issue"&gt;
      &lt;wsdl:input
        wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Issue"
        message="tns:RequestSecurityTokenMsg"/&gt;
      &lt;wsdl:output
        wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RSTRC/IssueFinal"
        message="tns:RequestSecurityTokenResponseCollectionMsg"/&gt;
    &lt;/wsdl:operation&gt;
    &lt;wsdl:operation name="Renew"&gt;
      &lt;wsdl:input
        wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Renew"
        message="tns:RequestSecurityTokenMsg"/&gt;
      &lt;wsdl:output
        wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RSTR/RenewFinal"
        message="tns:RequestSecurityTokenResponseMsg"/&gt;
    &lt;/wsdl:operation&gt;
    &lt;wsdl:operation name="Validate"&gt;
      &lt;wsdl:input
        wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Validate"
        message="tns:RequestSecurityTokenMsg"/&gt;
      &lt;wsdl:output
        wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RSTR/ValidateFinal"
        message="tns:RequestSecurityTokenResponseMsg"/&gt;
    &lt;/wsdl:operation&gt;
    &lt;wsdl:operation name="KeyExchangeToken"&gt;
      &lt;wsdl:input
        wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/KET"
        message="tns:RequestSecurityTokenMsg"/&gt;
      &lt;wsdl:output
        wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RSTR/KETFinal"
        message="tns:RequestSecurityTokenResponseMsg"/&gt;
    &lt;/wsdl:operation&gt;
    &lt;wsdl:operation name="RequestCollection"&gt;
      &lt;wsdl:input message="tns:RequestSecurityTokenCollectionMsg"/&gt;
      &lt;wsdl:output message="tns:RequestSecurityTokenResponseCollectionMsg"/&gt;
    &lt;/wsdl:operation&gt;
  &lt;/wsdl:portType&gt;
 
  &lt;!-- This portType is an example of an endpoint that accepts
         Unsolicited RequestSecurityTokenResponse messages --&gt;
  &lt;wsdl:portType name="SecurityTokenResponseService"&gt;
    &lt;wsdl:operation name="RequestSecurityTokenResponse"&gt;
      &lt;wsdl:input message="tns:RequestSecurityTokenResponseMsg"/&gt;
    &lt;/wsdl:operation&gt;
  &lt;/wsdl:portType&gt;
 
  &lt;wsdl:binding name="UT_Binding" type="wstrust:STS"&gt;
    &lt;wsp:PolicyReference URI="#UT_policy"/&gt;
    &lt;soap:binding style="document"
                  transport="http://schemas.xmlsoap.org/soap/http"/&gt;
    &lt;wsdl:operation name="Issue"&gt;
      &lt;soap:operation
        soapAction="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Issue"/&gt;
      &lt;wsdl:input&gt;
        &lt;wsp:PolicyReference
          URI="#Input_policy"/&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:input&gt;
      &lt;wsdl:output&gt;
        &lt;wsp:PolicyReference
          URI="#Output_policy"/&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:output&gt;
    &lt;/wsdl:operation&gt;
    &lt;wsdl:operation name="Validate"&gt;
      &lt;soap:operation
        soapAction="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Validate"/&gt;
      &lt;wsdl:input&gt;
        &lt;wsp:PolicyReference
          URI="#Input_policy"/&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:input&gt;
      &lt;wsdl:output&gt;
        &lt;wsp:PolicyReference
          URI="#Output_policy"/&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:output&gt;
    &lt;/wsdl:operation&gt;
    &lt;wsdl:operation name="Cancel"&gt;
      &lt;soap:operation
        soapAction="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Cancel"/&gt;
      &lt;wsdl:input&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:input&gt;
      &lt;wsdl:output&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:output&gt;
    &lt;/wsdl:operation&gt;
    &lt;wsdl:operation name="Renew"&gt;
      &lt;soap:operation
        soapAction="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Renew"/&gt;
      &lt;wsdl:input&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:input&gt;
      &lt;wsdl:output&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:output&gt;
    &lt;/wsdl:operation&gt;
    &lt;wsdl:operation name="KeyExchangeToken"&gt;
      &lt;soap:operation
        soapAction="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/KeyExchangeToken"/&gt;
      &lt;wsdl:input&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:input&gt;
      &lt;wsdl:output&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:output&gt;
    &lt;/wsdl:operation&gt;
    &lt;wsdl:operation name="RequestCollection"&gt;
      &lt;soap:operation
        soapAction="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/RequestCollection"/&gt;
      &lt;wsdl:input&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:input&gt;
      &lt;wsdl:output&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:output&gt;
    &lt;/wsdl:operation&gt;
  &lt;/wsdl:binding&gt;
 
  &lt;wsdl:service name="SecurityTokenService"&gt;
    &lt;wsdl:port name="UT_Port" binding="tns:UT_Binding"&gt;
      &lt;soap:address location="http://localhost:8080/SecurityTokenService/UT"/&gt;
    &lt;/wsdl:port&gt;
  &lt;/wsdl:service&gt;
 
  &lt;wsp:Policy wsu:Id="UT_policy"&gt;
    &lt;wsp:ExactlyOne&gt;
      &lt;wsp:All&gt;
        &lt;wsap10:UsingAddressing/&gt;
        &lt;sp:SymmetricBinding
          xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
          &lt;wsp:Policy&gt;
            &lt;sp:ProtectionToken&gt;
              &lt;wsp:Policy&gt;
                &lt;sp:X509Token
                  sp:IncludeToken="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702/IncludeToken/Never"&gt;
                  &lt;wsp:Policy&gt;
                    &lt;sp:RequireDerivedKeys/&gt;
                    &lt;sp:RequireThumbprintReference/&gt;
                    &lt;sp:WssX509V3Token10/&gt;
                  &lt;/wsp:Policy&gt;
                &lt;/sp:X509Token&gt;
              &lt;/wsp:Policy&gt;
            &lt;/sp:ProtectionToken&gt;
            &lt;sp:AlgorithmSuite&gt;
              &lt;wsp:Policy&gt;
                &lt;sp:Basic256/&gt;
              &lt;/wsp:Policy&gt;
            &lt;/sp:AlgorithmSuite&gt;
            &lt;sp:Layout&gt;
              &lt;wsp:Policy&gt;
                &lt;sp:Lax/&gt;
              &lt;/wsp:Policy&gt;
            &lt;/sp:Layout&gt;
            &lt;sp:IncludeTimestamp/&gt;
            &lt;sp:EncryptSignature/&gt;
            &lt;sp:OnlySignEntireHeadersAndBody/&gt;
          &lt;/wsp:Policy&gt;
        &lt;/sp:SymmetricBinding&gt;
        &lt;sp:SignedSupportingTokens
          xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
          &lt;wsp:Policy&gt;
            &lt;sp:UsernameToken
              sp:IncludeToken="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702/IncludeToken/AlwaysToRecipient"&gt;
              &lt;wsp:Policy&gt;
                &lt;sp:WssUsernameToken10/&gt;
              &lt;/wsp:Policy&gt;
            &lt;/sp:UsernameToken&gt;
          &lt;/wsp:Policy&gt;
        &lt;/sp:SignedSupportingTokens&gt;
        &lt;sp:Wss11
          xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
          &lt;wsp:Policy&gt;
            &lt;sp:MustSupportRefKeyIdentifier/&gt;
            &lt;sp:MustSupportRefIssuerSerial/&gt;
            &lt;sp:MustSupportRefThumbprint/&gt;
            &lt;sp:MustSupportRefEncryptedKey/&gt;
          &lt;/wsp:Policy&gt;
        &lt;/sp:Wss11&gt;
        &lt;sp:Trust13
          xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
          &lt;wsp:Policy&gt;
            &lt;sp:MustSupportIssuedTokens/&gt;
            &lt;sp:RequireClientEntropy/&gt;
            &lt;sp:RequireServerEntropy/&gt;
          &lt;/wsp:Policy&gt;
        &lt;/sp:Trust13&gt;
      &lt;/wsp:All&gt;
    &lt;/wsp:ExactlyOne&gt;
  &lt;/wsp:Policy&gt;
 
  &lt;wsp:Policy wsu:Id="Input_policy"&gt;
    &lt;wsp:ExactlyOne&gt;
      &lt;wsp:All&gt;
        &lt;sp:SignedParts
          xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
          &lt;sp:Body/&gt;
          &lt;sp:Header Name="To"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
          &lt;sp:Header Name="From"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
          &lt;sp:Header Name="FaultTo"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
          &lt;sp:Header Name="ReplyTo"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
          &lt;sp:Header Name="MessageID"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
          &lt;sp:Header Name="RelatesTo"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
          &lt;sp:Header Name="Action"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
        &lt;/sp:SignedParts&gt;
      &lt;/wsp:All&gt;
    &lt;/wsp:ExactlyOne&gt;
  &lt;/wsp:Policy&gt;
 
  &lt;wsp:Policy wsu:Id="Output_policy"&gt;
    &lt;wsp:ExactlyOne&gt;
      &lt;wsp:All&gt;
        &lt;sp:SignedParts
          xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
          &lt;sp:Body/&gt;
          &lt;sp:Header Name="To"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
          &lt;sp:Header Name="From"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
          &lt;sp:Header Name="FaultTo"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
          &lt;sp:Header Name="ReplyTo"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
          &lt;sp:Header Name="MessageID"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
          &lt;sp:Header Name="RelatesTo"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
          &lt;sp:Header Name="Action"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
        &lt;/sp:SignedParts&gt;
      &lt;/wsp:All&gt;
    &lt;/wsp:ExactlyOne&gt;
  &lt;/wsp:Policy&gt;
 
&lt;/wsdl:definitions&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="stss-implementation-class">STS&#8217;s implementation class</h4>
<div class="paragraph">
<p>The Apache CXF&#8217;s STS, SecurityTokenServiceProvider, is a web service
provider that is compliant with the protocols and functionality defined
by the WS-Trust specification. It has a modular architecture. Many of
its components are configurable or replaceable and there are many
optional features that are enabled by implementing and configuring
plug-ins. Users can customize their own STS by extending from
SecurityTokenServiceProvider and overriding the default settings.
Extensive information about the CXF&#8217;s STS configurable and pluggable
components can be found
<a href="http://coheigea.blogspot.com/2011/11/apache-cxf-sts-documentation-part-viii_10.html">here</a>.</p>
</div>
<div class="paragraph">
<p>This STS implementation class, SampleSTSHolderOfKey, is a POJO that
extends from SecurityTokenServiceProvider. Note that the class is
defined with a WebServiceProvider annotation and not a WebService
annotation. This annotation defines the service as a Provider-based
endpoint, meaning it supports a more messaging-oriented approach to Web
services. In particular, it signals that the exchanged messages will be
XML documents of some type. SecurityTokenServiceProvider is an
implementation of the javax.xml.ws.Provider interface. In comparison the
WebService annotation defines a (service endpoint interface) SEI-based
endpoint which supports message exchange via SOAP envelopes.</p>
</div>
<div class="paragraph">
<p>As was done in the HolderOfKeyImpl class, the WSS4J annotations
EndpointProperties and EndpointProperty are providing endpoint
configuration for the CXF runtime. The first EndpointProperty statements
declares the Java properties file that contains the (Merlin) crypto
configuration information. WSS4J reads this file and extra required
information for message handling. The last EndpointProperty statement
declares the STSHolderOfKeyCallbackHandler implementation class. It is
used to obtain the user&#8217;s password for the certificates in the keystore
file.</p>
</div>
<div class="paragraph">
<p>In this implementation we are customizing the operations of token
issuance and their static properties.</p>
</div>
<div class="paragraph">
<p>StaticSTSProperties is used to set select properties for configuring
resources in the STS. You may think this is a duplication of the
settings made with the WSS4J annotations. The values are the same but
the underlaying structures being set are different, thus this
information must be declared in both places.</p>
</div>
<div class="paragraph">
<p>The setIssuer setting is important because it uniquely identifies the
issuing STS. The issuer string is embedded in issued tokens and, when
validating tokens, the STS checks the issuer string value. Consequently,
it is important to use the issuer string in a consistent way, so that
the STS can recognize the tokens that it has issued.</p>
</div>
<div class="paragraph">
<p>The setEndpoints call allows the declaration of a set of allowed token
recipients by address. The addresses are specified as reg-ex patterns.</p>
</div>
<div class="paragraph">
<p>TokenIssueOperation has a modular structure. This allows custom
behaviors to be injected into the processing of messages. In this case
we are overriding the SecurityTokenServiceProvider&#8217;s default behavior
and performing SAML token processing. CXF provides an implementation of
a SAMLTokenProvider which we are using rather than writing our own.</p>
</div>
<div class="paragraph">
<p>Learn more about the SAMLTokenProvider
<a href="http://coheigea.blogspot.it/2011/10/apache-cxf-sts-documentation-part-iv.html">here</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package org.jboss.test.ws.jaxws.samples.wsse.policy.trust.stsholderofkey;
 
import org.apache.cxf.annotations.EndpointProperties;
import org.apache.cxf.annotations.EndpointProperty;
import org.apache.cxf.sts.StaticSTSProperties;
import org.apache.cxf.sts.operation.TokenIssueOperation;
import org.apache.cxf.sts.service.ServiceMBean;
import org.apache.cxf.sts.service.StaticService;
import org.apache.cxf.sts.token.provider.SAMLTokenProvider;
import org.apache.cxf.ws.security.sts.provider.SecurityTokenServiceProvider;
 
import javax.xml.ws.WebServiceProvider;
import java.util.Arrays;
import java.util.LinkedList;
import java.util.List;
 
/**
 * User: rsearls
 * Date: 3/14/14
 */
@WebServiceProvider(serviceName = "SecurityTokenService",
   portName = "UT_Port",
   targetNamespace = "http://docs.oasis-open.org/ws-sx/ws-trust/200512/",
   wsdlLocation = "WEB-INF/wsdl/holderofkey-ws-trust-1.4-service.wsdl")
//be sure to have dependency on org.apache.cxf module when on AS7, otherwise Apache CXF annotations are ignored
@EndpointProperties(value = {
   @EndpointProperty(key = "ws-security.signature.properties", value = "stsKeystore.properties"),
   @EndpointProperty(key = "ws-security.callback-handler", value = "org.jboss.test.ws.jaxws.samples.wsse.policy.trust.stsholderofkey.STSHolderOfKeyCallbackHandler")
})
public class SampleSTSHolderOfKey extends SecurityTokenServiceProvider
{
 
   public SampleSTSHolderOfKey() throws Exception
   {
      super();
 
      StaticSTSProperties props = new StaticSTSProperties();
      props.setSignatureCryptoProperties("stsKeystore.properties");
      props.setSignatureUsername("mystskey");
      props.setCallbackHandlerClass(STSHolderOfKeyCallbackHandler.class.getName());
      props.setEncryptionCryptoProperties("stsKeystore.properties");
      props.setEncryptionUsername("myservicekey");
      props.setIssuer("DoubleItSTSIssuer");
 
      List&lt;ServiceMBean&gt; services = new LinkedList&lt;ServiceMBean&gt;();
      StaticService service = new StaticService();
      service.setEndpoints(Arrays.asList(
         "https://localhost:(\\d)*/jaxws-samples-wsse-policy-trust-holderofkey/HolderOfKeyService",
         "https://\\[::1\\]:(\\d)*/jaxws-samples-wsse-policy-trust-holderofkey/HolderOfKeyService",
         "https://\\[0:0:0:0:0:0:0:1\\]:(\\d)*/jaxws-samples-wsse-policy-trust-holderofkey/HolderOfKeyService"
      ));
 
      services.add(service);
 
      TokenIssueOperation issueOperation = new TokenIssueOperation();
      issueOperation.getTokenProviders().add(new SAMLTokenProvider());
      issueOperation.setServices(services);
      issueOperation.setStsProperties(props);
      this.setIssueOperation(issueOperation);
 
   }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="holderofkeycallbackhandler">HolderOfKeyCallbackHandler</h4>
<div class="paragraph">
<p>STSHolderOfKeyCallbackHandler is a callback handler for the WSS4J Crypto
API. It is used to obtain the password for the private key in the
keystore. This class enables CXF to retrieve the password of the user
name to use for the message signature.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package org.jboss.test.ws.jaxws.samples.wsse.policy.trust.stsholderofkey;
 
import org.jboss.wsf.stack.cxf.extensions.security.PasswordCallbackHandler;
 
import java.util.HashMap;
import java.util.Map;
 
/**
 * User: rsearls
 * Date: 3/19/14
 */
public class STSHolderOfKeyCallbackHandler extends PasswordCallbackHandler
{
   public STSHolderOfKeyCallbackHandler()
   {
      super(getInitMap());
   }
 
   private static Map&lt;String, String&gt; getInitMap()
   {
      Map&lt;String, String&gt; passwords = new HashMap&lt;String, String&gt;();
      passwords.put("mystskey", "stskpass");
      passwords.put("alice", "clarinet");
      return passwords;
   }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="crypto-properties-and-keystore-files-1">Crypto properties and keystore files</h4>
<div class="paragraph">
<p>WSS4J&#8217;s Crypto implementation is loaded and configured via a Java
properties file that contains Crypto configuration data. The file
contains implementation-specific properties such as a keystore location,
password, default alias and the like. This application is using the
Merlin implementation. File stsKeystore.properties contains this
information.</p>
</div>
<div class="paragraph">
<p>File servicestore.jks, is a Java KeyStore (JKS) repository. It contains
self signed certificates for myservicekey and mystskey. <em>Self signed
certificates are not appropriate for production use.</em></p>
</div>
<div class="literalblock">
<div class="content">
<pre>org.apache.ws.security.crypto.provider=org.apache.ws.security.components.crypto.Merlin
org.apache.ws.security.crypto.merlin.keystore.type=jks
org.apache.ws.security.crypto.merlin.keystore.password=stsspass
org.apache.ws.security.crypto.merlin.keystore.file=stsstore.jks</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="manifest.mf-1">MANIFEST.MF</h4>
<div class="paragraph">
<p>When deployed on WildFly, this application requires access to the
JBossWs and CXF APIs provided in modules
org.jboss.ws.cxf.jbossws-cxf-client and org.apache.cxf. The Apache CXF
internals, org.apache.cxf.impl, are needed to build the STS
configuration in the SampleSTSHolderOfKey constructor. The dependency
statement directs the server to provide them at deployment.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Manifest-Version:1.0
Ant-Version: Apache Ant1.8.2
Created-By:1.7.0_25-b15 (Oracle Corporation)
Dependencies: org.jboss.ws.cxf.jbossws-cxf-client,org.apache.cxf.impl</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="web-service-requester">Web service requester</h3>
<div class="paragraph">
<p>This section examines the crucial elements in calling a web service that
implements endpoint security as described in the SAML Holder-Of-Key
scenario. The components that will be discussed are.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>web service requester&#8217;s implementation</p>
</li>
<li>
<p>ClientCallbackHandler</p>
</li>
<li>
<p>Crypto properties and keystore files</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="web-service-requester-implementation">Web service requester Implementation</h4>
<div class="paragraph">
<p>The ws-requester, the client, uses standard procedures for creating a
reference to the web service. To address the endpoint security
requirements, the web service&#8217;s "Request Context" is configured with the
information needed in message generation. In addition, the STSClient
that communicates with the STS is configured with similar values. Note
the key strings ending with a ".it" suffix. This suffix flags these
settings as belonging to the STSClient. The internal CXF code assigns
this information to the STSClient that is auto-generated for this
service call.</p>
</div>
<div class="paragraph">
<p>There is an alternate method of setting up the STSCLient. The user may
provide their own instance of the STSClient. The CXF code will use this
object and not auto-generate one. When providing the STSClient in this
way, the user must provide a org.apache.cxf.Bus for it and the
configuration keys must not have the ".it" suffix. This is used in the
ActAs and OnBehalfOf examples.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">String serviceURL = "https://" + getServerHost() + ":8443/jaxws-samples-wsse-policy-trust-holderofkey/HolderOfKeyService";
 
final QName serviceName = new QName("http://www.jboss.org/jbossws/ws-extensions/holderofkeywssecuritypolicy", "HolderOfKeyService");
final URL wsdlURL = new URL(serviceURL + "?wsdl");
Service service = Service.create(wsdlURL, serviceName);
HolderOfKeyIface proxy = (HolderOfKeyIface) service.getPort(HolderOfKeyIface.class);
 
Map&lt;String, Object&gt; ctx = ((BindingProvider)proxy).getRequestContext();
 
// set the security related configuration information for the service "request"
ctx.put(SecurityConstants.CALLBACK_HANDLER, new ClientCallbackHandler());
ctx.put(SecurityConstants.SIGNATURE_PROPERTIES,
  Thread.currentThread().getContextClassLoader().getResource(
  "META-INF/clientKeystore.properties"));
ctx.put(SecurityConstants.ENCRYPT_PROPERTIES,
  Thread.currentThread().getContextClassLoader().getResource(
  "META-INF/clientKeystore.properties"));
ctx.put(SecurityConstants.SIGNATURE_USERNAME, "myclientkey");
ctx.put(SecurityConstants.ENCRYPT_USERNAME, "myservicekey");
 
//-- Configuration settings that will be transfered to the STSClient
// "alice" is the name provided for the WSS Username. Her password will
// be retreived from the ClientCallbackHander by the STSClient.
ctx.put(SecurityConstants.USERNAME + ".it", "alice");
ctx.put(SecurityConstants.CALLBACK_HANDLER + ".it", new ClientCallbackHandler());
ctx.put(SecurityConstants.ENCRYPT_PROPERTIES + ".it",
  Thread.currentThread().getContextClassLoader().getResource(
  "META-INF/clientKeystore.properties"));
ctx.put(SecurityConstants.ENCRYPT_USERNAME + ".it", "mystskey");
ctx.put(SecurityConstants.STS_TOKEN_USERNAME + ".it", "myclientkey");
ctx.put(SecurityConstants.STS_TOKEN_PROPERTIES + ".it",
  Thread.currentThread().getContextClassLoader().getResource(
  "META-INF/clientKeystore.properties"));
ctx.put(SecurityConstants.STS_TOKEN_USE_CERT_FOR_KEYINFO + ".it", "true");
 
proxy.sayHello();</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="clientcallbackhandler">ClientCallbackHandler</h4>
<div class="paragraph">
<p>ClientCallbackHandler is a callback handler for the WSS4J Crypto API. It
is used to obtain the password for the private key in the keystore. This
class enables CXF to retrieve the password of the user name to use for
the message signature. Note that "alice" and her password have been
provided here. This information is not in the (JKS) keystore but
provided in the WildFly security domain. It was declared in file
jbossws-users.properties.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package org.jboss.test.ws.jaxws.samples.wsse.policy.trust.shared;
 
import java.io.IOException;
import javax.security.auth.callback.Callback;
import javax.security.auth.callback.CallbackHandler;
import javax.security.auth.callback.UnsupportedCallbackException;
import org.apache.ws.security.WSPasswordCallback;
 
public class ClientCallbackHandler implements CallbackHandler {
 
    public void handle(Callback[] callbacks) throws IOException,
            UnsupportedCallbackException {
        for (int i = 0; i &lt; callbacks.length; i++) {
            if (callbacks[i] instanceof WSPasswordCallback) {
                WSPasswordCallback pc = (WSPasswordCallback) callbacks[i];
                if ("myclientkey".equals(pc.getIdentifier())) {
                    pc.setPassword("ckpass");
                    break;
                } else if ("alice".equals(pc.getIdentifier())) {
                    pc.setPassword("clarinet");
                    break;
                } else if ("bob".equals(pc.getIdentifier())) {
                    pc.setPassword("trombone");
                    break;
                } else if ("myservicekey".equals(pc.getIdentifier())) {  // rls test  added for bearer test
                   pc.setPassword("skpass");
                   break;
                }
            }
        }
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="crypto-properties-and-keystore-files-2">Crypto properties and keystore files</h4>
<div class="paragraph">
<p>WSS4J&#8217;s Crypto implementation is loaded and configured via a Java
properties file that contains Crypto configuration data. The file
contains implementation-specific properties such as a keystore location,
password, default alias and the like. This application is using the
Merlin implementation. File clientKeystore.properties contains this
information.</p>
</div>
<div class="paragraph">
<p>File clientstore.jks, is a Java KeyStore (JKS) repository. It contains
self signed certificates for myservicekey and mystskey. <em>Self signed
certificates are not appropriate for production use.</em></p>
</div>
<div class="literalblock">
<div class="content">
<pre>org.apache.ws.security.crypto.provider=org.apache.ws.security.components.crypto.Merlin
org.apache.ws.security.crypto.merlin.keystore.type=jks
org.apache.ws.security.crypto.merlin.keystore.password=cspass
org.apache.ws.security.crypto.merlin.keystore.alias=myclientkey
org.apache.ws.security.crypto.merlin.keystore.file=META-INF/clientstore.jks</pre>
</div>
</div>
</div>
</div>
</div>
</div>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/wildflysite/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Wildfly</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Wildfly</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/wildfly"><svg class="svg-icon"><use xlink:href="/wildflysite/assets/minima-social-icons.svg#github"></use></svg> <span class="username">wildfly</span></a></li><li><a href="https://www.twitter.com/WildFlyAS"><svg class="svg-icon"><use xlink:href="/wildflysite/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">WildFlyAS</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p></p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
