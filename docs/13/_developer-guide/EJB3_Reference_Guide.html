<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.5.0 -->
<title>EJB 3 Reference Guide | Wildfly</title>
<meta name="generator" content="Jekyll v3.8.3" />
<meta property="og:title" content="EJB 3 Reference Guide" />
<meta property="og:locale" content="en_US" />
<link rel="canonical" href="https://jbossorg.github.io/wildflysite/docs/13/_developer-guide/EJB3_Reference_Guide.html" />
<meta property="og:url" content="https://jbossorg.github.io/wildflysite/docs/13/_developer-guide/EJB3_Reference_Guide.html" />
<meta property="og:site_name" content="Wildfly" />
<script type="application/ld+json">
{"@type":"WebPage","url":"https://jbossorg.github.io/wildflysite/docs/13/_developer-guide/EJB3_Reference_Guide.html","headline":"EJB 3 Reference Guide","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/wildflysite/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://jbossorg.github.io/wildflysite/feed.xml" title="Wildfly" /></head>
<body><div class="header navigation">
  <div class="logo-wrapper">
    <a href="/wildflysite/"><img class="wf-logo" src="/wildflysite/assets/img/wildfly_icons_one-color-logo.png"></a>
  </div>
  <div class="nav-container">
    <nav>
      <div class="nav-mobile"><a id="nav-toggle" href="#!"><span></span></a></div>
      <ul class="nav-list">
        <li>
          <a href="/wildflysite/" class="">Home</a>
        </li>
        <li>
          <a href="/wildflysite/downloads/" class="">Downloads</a>
        </li>
        <li>
          <a href="/wildflysite/blog/" class="">Blog</a>
        </li>
        <li>
          <a href="/wildflysite/about/" class="">About</a>
        </li>
        <li>
          <a href="/wildflysite/contribute/" class="">Contribute</a>
        </li>
        <li>
          <a href="/wildflysite/docs/" class="">Docs</a>
        </li>
        <li>
          <a class="button-cta secondary" href="https://github.com/wildfly/wildfly/fork" target="_blank">Fork</a>
        </li>
      </ul>
    </nav>
  </div>
</div>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This chapter details the extensions that are available when developing
Enterprise Java Beans <sup>tm</sup> on WildFly {wildflyVersion}.</p>
</div>
<div class="paragraph">
<p>Currently there is no support for configuring the extensions using an
implementation specific descriptor file.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="resource-adapter-for-message-driven-beans">Resource Adapter for Message Driven Beans</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Each Message Driven Bean must be connected to a resource adapter.</p>
</div>
<div class="sect2">
<h3 id="specification-of-resource-adapter-using-metadata-annotations">Specification of Resource Adapter using Metadata Annotations</h3>
<div class="paragraph">
<p>The <code>ResourceAdapter</code> annotation is used to specify the resource adapter
with which the MDB should connect.</p>
</div>
<div class="paragraph">
<p>The <code>value</code> of the annotation is the name of the deployment unit
containing the resource adapter. For example <code>jms-ra.rar</code>.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@MessageDriven(messageListenerInterface = PostmanPat.class)
@ResourceAdapter("ejb3-rar.rar")</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="run-as-principal">Run-as Principal</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Whenever a run-as role is specified for a given method invocation the
default anonymous principal is used as the caller principal. This
principal can be overridden by specifying a run-as principal.</p>
</div>
<div class="sect2">
<h3 id="specification-of-run-as-principal-using-metadata-annotations">Specification of Run-as Principal using Metadata Annotations</h3>
<div class="paragraph">
<p>The <code>RunAsPrincipal</code> annotation is used to specify the run-as principal
to use for a given method invocation.</p>
</div>
<div class="paragraph">
<p>The <code>value</code> of the annotation specifies the name of the principal to
use. The actual type of the principal is undefined and should not be
relied upon.</p>
</div>
<div class="paragraph">
<p>Using this annotation without specifying a run-as role is considered an
error.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@RunAs("admin")
@RunAsPrincipal("MyBean")</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="security-domain">Security Domain</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Each Enterprise Java Bean <sup>tm</sup> can be associated with a security domain.
Only when an EJB is associated with a security domain will
authentication and authorization be enforced.</p>
</div>
<div class="sect2">
<h3 id="specification-of-security-domain-using-metadata-annotations">Specification of Security Domain using Metadata Annotations</h3>
<div class="paragraph">
<p>The <code>SecurityDomain</code> annotation is used to specify the security domain
to associate with the EJB.</p>
</div>
<div class="paragraph">
<p>The <code>value</code> of the annotation is the name of the security domain to be
used.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@SecurityDomain("other")</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="transaction-timeout">Transaction Timeout</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For any newly started transaction a transaction timeout can be specified
in seconds.</p>
</div>
<div class="paragraph">
<p>When a transaction timeout of <code>0</code> is used, then the actual transaction
timeout will default to the domain configured default.<br>
<em>TODO: add link to tx subsystem</em></p>
</div>
<div class="paragraph">
<p>Although this is only applicable when using transaction attribute
<code>REQUIRED</code> or <code>REQUIRES_NEW</code> the application server will not detect
invalid setups.</p>
</div>
<div class="paragraph">
<p>New Transactions</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Take care that even when transaction attribute <code>REQUIRED</code> is specified,
the timeout will only be applicable if a <strong>new</strong> transaction is started.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="specification-of-transaction-timeout-with-metadata-annotations">Specification of Transaction Timeout with Metadata Annotations</h3>
<div class="paragraph">
<p>The <code>TransactionTimeout</code> annotation is used to specify the transaction
timeout for a given method.</p>
</div>
<div class="paragraph">
<p>The <code>value</code> of the annotation is the timeout used in the given <code>unit</code>
granularity. It must be a positive integer or 0. Whenever 0 is specified
the default domain configured timeout is used.</p>
</div>
<div class="paragraph">
<p>The <code>unit</code> specifies the granularity of the <code>value</code>. The actual value
used is converted to seconds. Specifying a granularity lower than
<code>SECONDS</code> is considered an error, even when the computed value will
result in an even amount of seconds.</p>
</div>
<div class="paragraph">
<p>For example:@TransactionTimeout(value = 10, unit = TimeUnit.SECONDS)</p>
</div>
</div>
<div class="sect2">
<h3 id="specification-of-transaction-timeout-in-the-deployment-descriptor">Specification of Transaction Timeout in the Deployment Descriptor</h3>
<div class="paragraph">
<p>The <code>trans-timeout</code> element is used to define the transaction timeout
for business, home, component, and message-listener interface methods;
no-interface view methods; web service endpoint methods; and timeout
callback methods.</p>
</div>
<div class="paragraph">
<p>The <code>trans-timeout</code> element resides in the <code>urn:trans-timeout</code> namespace
and is part of the standard <code>container-transaction</code> element as defined
in the jboss namespace.</p>
</div>
<div class="paragraph">
<p>For the rules when a <code>container-transaction</code> is applicable please refer
to EJB 3.1 FR 13.3.7.2.1.</p>
</div>
<div class="sect3">
<h4 id="example-of-trans-timeout">Example of trans-timeout</h4>
<div class="paragraph">
<p>jboss-ejb3.xml</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;jboss:ejb-jar xmlns:jboss="http://www.jboss.com/xml/ns/javaee"
               xmlns="http://java.sun.com/xml/ns/javaee"
               xmlns:tx="urn:trans-timeout"
               xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
               xsi:schemaLocation="http://www.jboss.com/xml/ns/javaee http://www.jboss.org/j2ee/schema/jboss-ejb3-2_0.xsd
http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/ejb-jar_3_1.xsd
urn:trans-timeout http://www.jboss.org/j2ee/schema/trans-timeout-1_0.xsd"
               version="3.1"
               impl-version="2.0"&gt;
    &lt;assembly-descriptor&gt;
        &lt;container-transaction&gt;
            &lt;method&gt;
                &lt;ejb-name&gt;BeanWithTimeoutValue&lt;/ejb-name&gt;
                &lt;method-name&gt;*&lt;/method-name&gt;
                &lt;method-intf&gt;Local&lt;/method-intf&gt;
            &lt;/method&gt;
            &lt;tx:trans-timeout&gt;
                &lt;tx:timeout&gt;10&lt;/tx:timeout&gt;
                &lt;tx:unit&gt;Seconds&lt;/tx:unit&gt;
            &lt;/tx:trans-timeout&gt;
        &lt;/container-transaction&gt;
    &lt;/assembly-descriptor&gt;
&lt;/jboss:ejb-jar&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="timer-service">Timer service</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The service is responsible to call the registered timeout methods of the
different session beans.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
A persistent timer will be identified by the name of the EAR, the name
of the sub-deployment JAR and the Bean&#8217;s name.<br>
If one of those names are changed (e.g. EAR name contain a version) the
timer entry became orphaned and the timer event will not longer be
fired.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="single-event-timer">Single event timer</h3>
<div class="paragraph">
<p>The timer is will be started once at the specified time.</p>
</div>
<div class="paragraph">
<p>In case of a server restart the timeout method of a persistent timer
will only be called directly if the specified time is elapsed.<br>
If the timer is not persistent (since EJB3.1 see 18.2.3) it will be not
longer available if JBoss is restarted or the application is redeployed.</p>
</div>
</div>
<div class="sect2">
<h3 id="recurring-timer">Recurring timer</h3>
<div class="paragraph">
<p>The timer will be started at the specified first occurrence and after
that point at each time if the interval is elapsed.<br>
If the timer will be started during the last execution is not finished
the execution will be suppressed with a warning to avoid concurrent
execution.</p>
</div>
<div class="paragraph">
<p>In case of server downtime for a persistent timer, the timeout method
will be called only once if one, or more than one, interval is
elapsed.<br>
If the timer is not persistent (since EJB3.1 see 18.2.3) it will not
longer be active after the server is restarted or the application is
redeployed.</p>
</div>
</div>
<div class="sect2">
<h3 id="calendar-timer">Calendar timer</h3>
<div class="paragraph">
<p>The timer will be started if the schedule expression match. It will be
automatically deactivated and removed if there will be no next
expiration possible, i.e. If you set a specific year.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Schedule( ... dayOfMonth="1", month="1", year="2012") +
// start once at 01-01-2012 00:00:00</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="programmatic-calendar-timer">Programmatic calendar timer</h4>
<div class="paragraph">
<p>If the timer is persistent it will be fetched at server start and the
missed timeouts are called concurrent.<br>
If a persistent timer contains an end date it will be executed once
nevertheless how many times the execution was missed. Also a retry will
be suppressed if the timeout method throw an Exception.<br>
In case of such expired timer access to the given Timer object might
throw a NoMoreTimeoutExcption or NoSuchObjectException.</p>
</div>
<div class="paragraph">
<p>If the timer is non persistent it will not longer be active after the
server is restarted or the application is redeployed.</p>
</div>
<div class="paragraph">
<p><strong>TODO</strong>: clarify whether this should happen concurrently/blocked or even
fired only once like a recurring timer!</p>
</div>
</div>
<div class="sect3">
<h4 id="annotated-calendar-timer">Annotated calendar timer</h4>
<div class="paragraph">
<p>If the timer is non persistent it will not activated for missed events
during the server is down. In case of server start the timer is
scheduled based on the @Schedule annotation.</p>
</div>
<div class="paragraph">
<p>If the timer is persistent (default if not deactivated by annotation)
all missed events are fetched at server start and the annotated timeout
method is called concurrent.</p>
</div>
<div class="paragraph">
<p><strong>TODO</strong>: clarify whether this should happen concurrently/blocked or even
fired only once like a recurring timer!</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Container_interceptors">Container interceptors</h2>
<div class="sectionbody">
<div class="quoteblock abstract">
<blockquote>
JBoss AS versions prior to WildFly8 allowed a JBoss specific way to
plug-in user application specific interceptors on the server side so
that those interceptors get invoked during an EJB invocation. Such
interceptors differed from the typical (portable) spec provided Java EE
interceptors. The Java EE interceptors are expected to run after the
container has done necessary invocation processing which involves
security context propagation, transaction management and other such
duties. As a result, these Java EE interceptors come too late into the
picture, if the user applications have to intercept the call before
certain container specific interceptor(s) are run.
</blockquote>
</div>
<div class="sect2">
<h3 id="typical-ejb-invocation-call-path-on-the-server">Typical EJB invocation call path on the server</h3>
<div class="paragraph">
<p>A typical EJB invocation looks like this:</p>
</div>
<div class="paragraph">
<p>Client application</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">MyBeanInterface bean = lookupBean();
 
bean.doSomething();</code></pre>
</div>
</div>
<div class="paragraph">
<p>The invocation on the bean.doSomething() triggers the following (only
relevant portion of the flow shown below):</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>WildFly specific interceptor (a.k.a container interceptor) 1</p>
</li>
<li>
<p>WildFly specific interceptor (a.k.a container interceptor) 2</p>
</li>
<li>
<p>&#8230;&#8203;.</p>
</li>
<li>
<p>WildFly specific interceptor (a.k.a container interceptor) N</p>
</li>
<li>
<p>User application specific Java EE interceptor(s) (if any)</p>
</li>
<li>
<p>Invocation on the EJB instance&#8217;s method</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The WildFly specific interceptors include the security context
propagation, transaction management and other container provided
services. In some cases, the " `container interceptors`" (let&#8217;s call
them that) might even decide break the invocation flow and not let the
invocation proceed (for example: due to the invoking caller not being
among the allowed user roles who can invoke the method on the bean).</p>
</div>
<div class="paragraph">
<p>Previous versions of JBoss AS allowed a way to plug-in the user
application specific interceptors (which relied on JBoss AS specific
libraries) into this invocation flow so that they do run some
application specific logic before the control reaches step#5 above. For
example, AS5 allowed the use of JBoss AOP interceptors to do this.</p>
</div>
<div class="paragraph">
<p>As of WildFly 8, this feature was implemented.</p>
</div>
</div>
<div class="sect2">
<h3 id="configuring-container-interceptors">Configuring container interceptors</h3>
<div class="paragraph">
<p>As you can see from the JIRA <a href="https://issues.jboss.org/browse/AS7-5897" class="bare">https://issues.jboss.org/browse/AS7-5897</a>,
one of the goals of this feature implementation was to make sure that we
don&#8217;t introduce any new WildFly specific library dependencies for the
container interceptors. So we decided to allow the Java EE interceptors
(which are just POJO classes with lifecycle callback annotations) to be
used as container interceptors. As such you won&#8217;t need any dependency on
any WildFly specific libraries. That will allow us to support this
feature for a longer time in future versions of WildFly.</p>
</div>
<div class="paragraph">
<p>Furthermore, configuring these container interceptors is similar to
configuring the Java EE interceptors for EJBs. In fact, it uses the same
xsd elements that are allowed in ejb-jar.xml for 3.1 version of ejb-jar
deployment descriptor.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Container interceptors can only be configured via deployment
descriptors. There&#8217;s no annotation based way to configure container
interceptors. This was an intentional decision, taken to avoid
introducing any WildFly specific library dependency for the annotation.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Configuring the container interceptors can be done in jboss-ejb3.xml
file, which then gets placed under the META-INF folder of the EJB
deployment, just like the ejb-jar.xml. Here&#8217;s an example of how the
container interceptor(s) can be configured in jboss-ejb3.xml:</p>
</div>
<div class="listingblock">
<div class="title">jboss-ejb3.xml</div>
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;jboss xmlns="http://www.jboss.com/xml/ns/javaee"
       xmlns:jee="http://java.sun.com/xml/ns/javaee"
       xmlns:ci ="urn:container-interceptors:1.0"&gt;
 
    &lt;jee:assembly-descriptor&gt;
        &lt;ci:container-interceptors&gt;
            &lt;!-- Default interceptor --&gt;
            &lt;jee:interceptor-binding&gt;
                &lt;ejb-name&gt;*&lt;/ejb-name&gt;
                &lt;interceptor-class&gt;org.jboss.as.test.integration.ejb.container.interceptor.ContainerInterceptorOne&lt;/interceptor-class&gt;
            &lt;/jee:interceptor-binding&gt;
            &lt;!-- Class level container-interceptor --&gt;
            &lt;jee:interceptor-binding&gt;
                &lt;ejb-name&gt;AnotherFlowTrackingBean&lt;/ejb-name&gt;
                &lt;interceptor-class&gt;org.jboss.as.test.integration.ejb.container.interceptor.ClassLevelContainerInterceptor&lt;/interceptor-class&gt;
            &lt;/jee:interceptor-binding&gt;
            &lt;!-- Method specific container-interceptor --&gt;
            &lt;jee:interceptor-binding&gt;
                &lt;ejb-name&gt;AnotherFlowTrackingBean&lt;/ejb-name&gt;
                &lt;interceptor-class&gt;org.jboss.as.test.integration.ejb.container.interceptor.MethodSpecificContainerInterceptor&lt;/interceptor-class&gt;
                &lt;method&gt;
                    &lt;method-name&gt;echoWithMethodSpecificContainerInterceptor&lt;/method-name&gt;
                &lt;/method&gt;
            &lt;/jee:interceptor-binding&gt;
            &lt;!-- container interceptors in a specific order --&gt;
            &lt;jee:interceptor-binding&gt;
                &lt;ejb-name&gt;AnotherFlowTrackingBean&lt;/ejb-name&gt;
                &lt;interceptor-order&gt;
                    &lt;interceptor-class&gt;org.jboss.as.test.integration.ejb.container.interceptor.ClassLevelContainerInterceptor&lt;/interceptor-class&gt;
                    &lt;interceptor-class&gt;org.jboss.as.test.integration.ejb.container.interceptor.MethodSpecificContainerInterceptor&lt;/interceptor-class&gt;
                    &lt;interceptor-class&gt;org.jboss.as.test.integration.ejb.container.interceptor.ContainerInterceptorOne&lt;/interceptor-class&gt;
                &lt;/interceptor-order&gt;
                &lt;method&gt;
                    &lt;method-name&gt;echoInSpecificOrderOfContainerInterceptors&lt;/method-name&gt;
                &lt;/method&gt;
            &lt;/jee:interceptor-binding&gt;
        &lt;/ci:container-interceptors&gt;
    &lt;/jee:assembly-descriptor&gt;
&lt;/jboss&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The usage of urn:container-interceptors:1.0 namespace which allows the
container-interceptors elements to be configured</p>
</li>
<li>
<p>The container-interceptors element which contain the interceptor
bindings</p>
</li>
<li>
<p>The interceptor bindings themselves are the same elements as what the
EJB3.1 xsd allows for standard Java EE interceptors</p>
</li>
<li>
<p>The interceptors can be bound either to all EJBs in the deployment
(using the the * wildcard) or individual bean level (using the specific
EJB name) or at specific method level for the EJBs.</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
The xsd for the urn:container-interceptors:1.0 namespace is available
here
<a href="https://github.com/jbossas/jboss-as/blob/master/ejb3/src/main/resources/jboss-ejb-container-interceptors_1_0.xsd" class="bare">https://github.com/jbossas/jboss-as/blob/master/ejb3/src/main/resources/jboss-ejb-container-interceptors_1_0.xsd</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The interceptor classes themselves are simple POJOs and use the
<code>@javax.annotation.AroundInvoke</code> to mark the around invoke method which
will get invoked during the invocation on the bean. Here&#8217;s an example of
the interceptor:</p>
</div>
<div class="listingblock">
<div class="title">Example of container interceptor</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class ClassLevelContainerInterceptor {
    @AroundInvoke
    private Object iAmAround(final InvocationContext invocationContext) throws Exception {
        return this.getClass().getName() + " " + invocationContext.proceed();
    }
 
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="container-interceptor-positioning-in-the-interceptor-chain">Container interceptor positioning in the interceptor chain</h3>
<div class="paragraph">
<p>The container interceptors configured for a EJB are guaranteed to be run
before the WildFly provided security interceptors, transaction
management interceptors and other such interceptors thus allowing the
user application specific container interceptors to setup any relevant
context data before the invocation proceeds.</p>
</div>
</div>
<div class="sect2">
<h3 id="semantic-difference-between-container-interceptors-and-java-ee-interceptors-api">Semantic difference between container interceptor(s) and Java EE</h3>
<div class="paragraph">
<p>interceptor(s) API</p>
</div>
<div class="paragraph">
<p>Although the container interceptors are modeled to be similar to the
Java EE interceptors, there are some differences in the API semantics.
One such difference is that invoking on
javax.interceptor.InvocationContext.getTarget() method is illegal for
container interceptors since these interceptors are invoked way before
the EJB components are setup or instantiated.</p>
</div>
</div>
<div class="sect2">
<h3 id="testcase">Testcase</h3>
<div class="paragraph">
<p>This testcase in the WildFly codebase can be used for reference for
implementing container interceptors in user applications
<a href="https://github.com/wildfly/wildfly/blob/master/testsuite/integration/basic/src/test/java/org/jboss/as/test/integration/ejb/container/interceptor/ContainerInterceptorsTestCase.java" class="bare">https://github.com/wildfly/wildfly/blob/master/testsuite/integration/basic/src/test/java/org/jboss/as/test/integration/ejb/container/interceptor/ContainerInterceptorsTestCase.java</a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="EJB3_Clustered_Database_Timers">EJB3 Clustered Database Timers</h2>
<div class="sectionbody">
<div class="quoteblock abstract">
<blockquote>
Wildfly now supports clustered database backed timers. The clustering
support is provided through the database, and as a result it is not
intended to be a super high performance solution that supports thousands
of timers going off a second, however properly tuned it should provide
sufficient performance for most use cases.
</blockquote>
</div>
<div class="paragraph">
<p>Note that database timers can also be used in non-clustered mode.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Note that for this to work correctly the underlying database must
support the READ_COMMITTED or SERIALIZABLE isolation mode and the
datasource must be configured accordingly
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="setup">Setup</h3>
<div class="paragraph">
<p>In order to use clustered timers it is necessary to add a database
backed timer store. This can be done from the CLI with the following
command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">/subsystem=ejb3/service=timer-service/database-data-store=my-clustered-store:add(allow-execution=true, datasource-jndi-name='java:/MyDatasource', refresh-interval=60000, database='postgresql', partition='mypartition')</code></pre>
</div>
</div>
<div class="paragraph">
<p>An explanation of the parameters is below:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>allow-execution</strong> - If this node is allowed to execute timers. If this
is false then timers added on this node will be added to the database
for another node to execute. This allows you to limit timer execution to
a few nodes in a cluster, which can greatly reduce database load for
large clusters.</p>
</li>
<li>
<p><strong>datasource-jndi-name</strong> - The datasource to use</p>
</li>
<li>
<p><strong>refresh-interval</strong> - The refresh interval in milliseconds. This is the
period of time that must elapse before this node will check the database
for new timers added by other nodes. A smaller value means that timers
will be picked up more quickly, however it will result in more load on
the database. This is most important to tune if you are adding timers
that will expire quickly. If the node that added the timer cannot
execute it (e.g. because it has failed or because allow-execution is
false), this timer may not be executed until a node has refreshed.</p>
</li>
<li>
<p><strong>database</strong> - Define the type of database that is in use. Some SQL
statements are customised by database, and this tells the data store
which version of the SQL to use.<br>
Without this attribute the server try to detected the type
automatically, current supported types are <em>postgresql, mysql, oracle,
db2, hsql</em> and <em>h2</em>.<br>
Note that this SQL resides in the file
<em>modules/system/layers/base/org/jboss/as/ejb3/main/timers/timer-sql.properties</em><br>
And as such is it possible to modify the SQL that is executed or add
support for new databases by adding new DB specific SQL to this file (if
you do add support for a new database it would be greatly appreciated if
you could contribute the SQL back to the project).</p>
</li>
<li>
<p><strong>partition</strong> - A node will only see timers from other nodes that have
the same partition name. This allows you to break a large cluster up
into several smaller clusters, which should improve performance. e.g.
instead of having a cluster of 100 nodes, where all hundred are trying
to execute and refresh the same timers, you can create 20 clusters of 5
nodes by giving ever group of 5 a different partition name.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="non-clustered-timers">Non clustered timers</h4>
<div class="paragraph">
<p>Note that you can still use the database data store for non-clustered
timers, in which case set the refresh interval to zero and make sure
that every node has a unique partition name (or uses a different
database).</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="using-clustered-timers-in-a-deployment">Using clustered timers in a deployment</h3>
<div class="paragraph">
<p>It is possible to use the data store as default for all applications by
changing the default-data-store within the ejb3 subsystem:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">    &lt;timer-service thread-pool-name="timer" default-data-store="clustered-store"&gt;
        &lt;data-stores&gt;
            &lt;database-data-store name="clustered-store" datasource-jndi-name="java:jboss/datasources/ExampleDS" partition="timer"/&gt;
        &lt;/data-stores&gt;
    &lt;/timer-service&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Another option is to use a separate data store for specific
applications, all that is required is to set the timer data store name
in jboss-ejb3.xml:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.1" encoding="UTF-8"?&gt;
&lt;jboss:ejb-jar xmlns:jboss="http://www.jboss.com/xml/ns/javaee"
               xmlns="http://java.sun.com/xml/ns/javaee"
               xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
               xmlns:timer="urn:timer-service:1.0"
               xsi:schemaLocation="http://www.jboss.com/xml/ns/javaee http://www.jboss.org/j2ee/schema/jboss-ejb3-2_0.xsd
                     http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/ejb-jar_3_1.xsd"
               version="3.1"
               impl-version="2.0"&gt;
    &lt;assembly-descriptor&gt;
            &lt;timer:timer&gt;
                &lt;ejb-name&gt;*&lt;/ejb-name&gt;
                &lt;timer:persistence-store-name&gt;my-clustered-store&lt;/timer:persistence-store-name&gt;
            &lt;/timer:timer&gt;
        &lt;/assembly-descriptor&gt;
&lt;/jboss:ejb-jar&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="technical-details">Technical details</h3>
<div class="paragraph">
<p>Internally every node that is allowed to execute timers schedules a
timeout for every timer is knows about. When this timeout expires then
this node attempts to 'lock' the timer, by updating its state to
running. The query this executes looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">UPDATE JBOSS_EJB_TIMER SET TIMER_STATE=? WHERE ID=? AND TIMER_STATE&lt;&gt;? AND NEXT_DATE=?;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Due to the use of a transaction and READ_COMMITTED or SERIALIZABLE
isolation mode only one node will succeed in updating the row, and this
is the node that the timer will run on.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="EJB_IIOP_Guide">EJB IIOP Guide</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="enabling-iiop">Enabling IIOP</h3>
<div class="paragraph">
<p>To enable IIOP you must have the JacORB subsystem installed, and the
<code>&lt;iiop/&gt;</code> element present in the ejb3 subsystem configuration. The
<code>standalone-full.xml</code> configuration that comes with the distribution has
both of these enabled.</p>
</div>
<div class="paragraph">
<p>The <code>&lt;iiop/&gt;</code> element takes two attributes that control the default
behaviour of the server, for full details see <a href="Admin_Guide.html#EJB3">EJB3
subsystem configuration guide</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="enabling-jts">Enabling JTS</h3>
<div class="paragraph">
<p>To enable JTS simply add a <code>&lt;jts/&gt;</code> element to the transactions
subsystem configuration.</p>
</div>
<div class="paragraph">
<p>It is also necessary to enable the JacORB transactions interceptor as
shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;subsystem xmlns="urn:jboss:domain:jacorb:1.1"&gt;
  &lt;orb&gt;
    &lt;initializers transactions="on"/&gt;
  &lt;/orb&gt;
&lt;/subsystem&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="dynamic-stubs">Dynamic Stub&#8217;s</h3>
<div class="paragraph">
<p>Downloading stubs directly from the server is no longer supported. If
you do not wish to pre-generate your stub classes JDK Dynamic stubs can
be used instead. The enable JDK dynamic stubs simply set the
<code>com.sun.CORBA.ORBUseDynamicStub</code> system property to <code>true</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="configuring-ejb-iiop-settings-via-jboss-ejb3.xml">Configuring EJB IIOP settings via jboss-ejb3.xml</h3>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="EJB_over_HTTP">EJB over HTTP</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Beginning with Wildfly 11 it is now possible to use HTTP as the
transport (instead of remoting) for remote EJB and JNDI invocations.</p>
</div>
<div class="paragraph">
<p>Everything mentioned below is applicable for both JNDI and EJB
functionality.</p>
</div>
<div class="sect2">
<h3 id="server-configuration">Server Configuration</h3>
<div class="paragraph">
<p>In order to configure the server the http-invoker needs to be enabled on
each virtual host you wish to use in the Undertow subsystem. This is
enabled by default in standard configs, but if it has been removed it
can be added via:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>/subsystem=undertow/server=default-server/host=default-host/setting=http-invoker:add(http-authentication-factory=myfactory, path='/wildfly-services')</pre>
</div>
</div>
<div class="paragraph">
<p>The Hhttp-invoker takes two parameters, a path (which defaults to
/wildfly-services) and a http-authentication-factory which must be a
reference to an Elytron http-authentication-factory.</p>
</div>
<div class="paragraph">
<p>Note that any deployment that wishes to use this must use Elytron
security with the same security domain that corresponds to the HTTP
authentication factory.</p>
</div>
</div>
<div class="sect2">
<h3 id="performing-invocations">Performing Invocations</h3>
<div class="paragraph">
<p>The mechanism for performing invocations is exactly the same as for the
remoting based EJB client, the only difference is that instead of a
'remote+http' URI you use a 'http' URI (which must include the path that
was configured in the invoker). For example if you are currently using
'remote+ <a href="http://localhost:8080'" class="bare">http://localhost:8080'</a> as the target URI, you would change this
to 'http://localhost:8080/wildfly-services'.</p>
</div>
</div>
<div class="sect2">
<h3 id="implementation-details">Implementation details</h3>
<div class="paragraph">
<p>The wire protocol is detailed at
<a href="https://github.com/wildfly/wildfly-http-client/blob/master/docs/src/main/asciidoc/wire-spec-v1.asciidoc" class="bare">https://github.com/wildfly/wildfly-http-client/blob/master/docs/src/main/asciidoc/wire-spec-v1.asciidoc</a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="jboss-ejb3">jboss-ejb3.xml Reference</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>jboss-ejb3.xml</code> is a custom deployment descriptor that can be placed in
either ejb-jar or war archives. If it is placed in an ejb-jar then it
must be placed in the <code>META-INF</code> folder, in a web archive it must be
placed in the <code>WEB-INF</code> folder.</p>
</div>
<div class="paragraph">
<p>The contents of <code>jboss-ejb3.xml</code> are merged with the contents of
<code>ejb-jar.xml</code>, with the <code>jboss-ejb3.xml</code> items taking precedence.</p>
</div>
<div class="sect2">
<h3 id="example-file">Example File</h3>
<div class="paragraph">
<p>A simple example is shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.1" encoding="UTF-8"?&gt;
&lt;jboss:ejb-jar xmlns:jboss="http://www.jboss.com/xml/ns/javaee"
               xmlns="http://java.sun.com/xml/ns/javaee"
               xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
               xmlns:s="urn:security:1.1"
               xsi:schemaLocation="http://www.jboss.com/xml/ns/javaee http://www.jboss.org/j2ee/schema/jboss-ejb3-2_0.xsd http://java.sun.com/xml/ns/javaee http://www.jboss.org/j2ee/schema/jboss-ejb3-spec-2_0.xsd"
               version="3.1"
               impl-version="2.0"&gt;
    &lt;enterprise-beans&gt;
        &lt;message-driven&gt;
            &lt;ejb-name&gt;ReplyingMDB&lt;/ejb-name&gt;
            &lt;ejb-class&gt;org.jboss.as.test.integration.ejb.mdb.messagedestination.ReplyingMDB&lt;/ejb-class&gt;
            &lt;activation-config&gt;
                &lt;activation-config-property&gt;
                    &lt;activation-config-property-name&gt;destination&lt;/activation-config-property-name&gt;
                    &lt;activation-config-property-value&gt;java:jboss/mdbtest/messageDestinationQueue
                    &lt;/activation-config-property-value&gt;
                &lt;/activation-config-property&gt;
            &lt;/activation-config&gt;
        &lt;/message-driven&gt;
    &lt;/enterprise-beans&gt;
    &lt;assembly-descriptor&gt;
        &lt;s:security&gt;
            &lt;ejb-name&gt;DDMyDomainSFSB&lt;/ejb-name&gt;
            &lt;s:security-domain&gt;myDomain&lt;/s:security-domain&gt;
            &lt;s:run-as-principal&gt;myPrincipal&lt;/s:run-as-principal&gt;
        &lt;/s:security&gt;
    &lt;/assembly-descriptor&gt;
&lt;/jboss:ejb-jar&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see the format is largely similar to <code>ejb-jar.xml</code>, in fact
they even use the same namespaces, however <code>jboss-ejb3.xml</code> adds some
additional namespaces of its own to allow for configuring non-spec info.
The format of the standard <code><a href="http://java.sun.com/xml/ns/javaee" class="bare">http://java.sun.com/xml/ns/javaee</a></code> is well
documented elsewhere, this document will cover the non-standard
namespaces.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Namespace "http://www.jboss.com/xml/ns/javaee" is bound to "jboss-ejb3-spec-2_0.xsd": this file redefines some elements of "ejb-jar_3_1.xml"
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="the-root-namespace-httpwww.jboss.comxmlnsjavaee">The root namespace <a href="http://www.jboss.com/xml/ns/javaee" class="bare">http://www.jboss.com/xml/ns/javaee</a></h4>

</div>
<div class="sect3">
<h4 id="assembly-descriptor-namespaces">Assembly descriptor namespaces</h4>
<div class="paragraph">
<p>The following namespaces can all be used in the <code>&lt;assembly-descriptor&gt;</code>
element. They can be used to apply their configuration to a single bean,
or to all beans in the deployment by using <code>*</code> as the <code>ejb-name</code>.</p>
</div>
<div class="sect4">
<h5 id="the-security-namespace-urnsecurity">The security namespace urn:security</h5>
<div class="paragraph">
<p>This allows you to set the security domain and the run-as principal for
an EJB.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;s:security&gt;
  &lt;ejb-name&gt;*&lt;/ejb-name&gt;
  &lt;s:security-domain&gt;myDomain&lt;/s:security-domain&gt;
  &lt;s:run-as-principal&gt;myPrincipal&lt;/s:run-as-principal&gt;
&lt;/s:security&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="the-resource-adaptor-namespace-urnresource-adapter-binding">The resource adaptor namespace urn:resource-adapter-binding</h5>
<div class="paragraph">
<p>This allows you to set the resource adaptor for an MDB.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;r:resource-adapter-binding&gt;
  &lt;ejb-name&gt;*&lt;/ejb-name&gt;
  &lt;r:resource-adapter-name&gt;myResourceAdaptor&lt;/r:resource-adapter-name&gt;
&lt;/r:resource-adapter-binding&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="the-iiop-namespace-urniiop">The IIOP namespace urn:iiop</h5>
<div class="paragraph">
<p>The IIOP namespace is where IIOP settings are configured. As there are
quite a large number of options these are covered in the
<a href="#EJB_IIOP_Guide">IIOP guide</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="the-pool-namespace-urnejb-pool1.0">The pool namespace urn:ejb-pool:1.0</h5>
<div class="paragraph">
<p>This allows you to select the pool that is used by the SLSB or MDB.
Pools are defined in the server configuration (i.e. <code>standalone.xml</code> or
<code>domain.xml</code>)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;p:pool&gt;
  &lt;ejb-name&gt;*&lt;/ejb-name&gt;
  &lt;p:bean-instance-pool-ref&gt;my-pool&lt;/p:bean-instance-pool-ref&gt;
&lt;/p:pool&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="the-cache-namespace-urnejb-cache1.0">The cache namespace urn:ejb-cache:1.0</h5>
<div class="paragraph">
<p>This allows you to select the cache that is used by the SFSB. Caches are
defined in the server configuration (i.e. <code>standalone.xml</code> or
<code>domain.xml</code>)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;c:cache&gt;
  &lt;ejb-name&gt;*&lt;/ejb-name&gt;
  &lt;c:cache-ref&gt;my-cache&lt;/c:cache-ref&gt;
&lt;/c:cache&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="the-clustering-namespace-urnclustering1.0">The clustering namespace urn:clustering:1.0</h5>
<div class="paragraph">
<p>This namespace is deprecated and as of WildFly {wildflyVersion} its use has no effect.
The clustering behavior of EJBs is determined by the profile in use on
the server.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Message_Driven_Beans_Controlled_Delivery">Message Driven Beans Controlled Delivery</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are three mechanisms in Wildfly that allow controlling if a
specific MDB is actively receiving or not messages:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>delivery active</p>
</li>
<li>
<p>delivery groups</p>
</li>
<li>
<p>clustered singleton</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We will see each one of them in the following sections.</p>
</div>
<div class="sect2">
<h3 id="delivery-active">Delivery Active</h3>
<div class="paragraph">
<p>Delivery active is simply an attribute associated with the MDB that
indicates if the MDB is receiving messages or not. If an MDB is not
currently receiving messages, the messages will be saved in the queue or
topic for later, according to the rules of the topic/queue.</p>
</div>
<div class="paragraph">
<p>You can configure delivery active using xml or annotations, and you can
change its value after deployment using the cli.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>jboss-ejb3.xml:</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In the jboss-ejb3 xml file, configure the value of active as false to
mark that the MDB will not be receiving messages as soon as it is
deployed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.1" encoding="UTF-8"?&gt;
&lt;jboss:ejb-jar xmlns:jboss="http://www.jboss.com/xml/ns/javaee"
               xmlns="http://java.sun.com/xml/ns/javaee"
               xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
               xmlns:d="urn:delivery-active:1.1"
               xsi:schemaLocation="http://www.jboss.com/xml/ns/javaee http://www.jboss.org/j2ee/schema/jboss-ejb3-2_0.xsd http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/ejb-jar_3_1.xsd"                version="3.1"
               impl-version="2.0"&gt;
    &lt;assembly-descriptor&gt;
        &lt;d:delivery&gt;
            &lt;ejb-name&gt;HelloWorldQueueMDB&lt;/ejb-name&gt;
            &lt;d:active&gt;false&lt;/d:active&gt;
        &lt;/d:delivery&gt;
    &lt;/assembly-descriptor&gt;
&lt;/jboss:ejb-jar&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can use a wildcard "*" in the place of ejb-name if you want to apply
that active value to all MDBs in your application.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>annotation</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Alternatively, you can use the org.jboss.ejb3.annotation.DeliveryActive
annotation, as in the example below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@MessageDriven(name = "HelloWorldMDB", activationConfig = {
 
 @ActivationConfigProperty(propertyName = "destinationType", propertyValue = "javax.jms.Queue"),
 
 @ActivationConfigProperty(propertyName = "destination", propertyValue = "queue/HELLOWORLDMDBQueue"),
 
 @ActivationConfigProperty(propertyName = "acknowledgeMode", propertyValue = "Auto-acknowledge") })
 
@DeliveryActive(false)
 
public class HelloWorldMDB implements MessageListener {
    public void onMessage(Message rcvMessage) {
      // ...
    }
}</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="start-delivery-and-stop-delivery">Start-delivery and Stop-Delivery</h4>
<div class="paragraph">
<p>These management operations dynamically change the value of the active
attribute, enabling or disabling delivery for the MDB. at runtime To use
them, connect to the Wildfly instance you want to manage, then enter the
path of the MDB you want to manage delivery for:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">[standalone@localhost:9990 /] cd deployment=jboss-helloworld-mdb.war/subsystem=ejb3/message-driven-bean=HelloWorldMDB
 
[standalone@localhost:9990 message-driven-bean=HelloWorldMDB] :stop-delivery
{"outcome" =&gt; "success"}
 
[standalone@localhost:9990 message-driven-bean=HelloWorldMDB] :start-delivery
{"outcome" =&gt; "success"}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="delivery-groups">Delivery Groups</h3>
<div class="paragraph">
<p>Delivery groups provide a straightforward way to manage delivery for a
group of MDBs. Every MDB belonging to a delivery group has delivery
active if and only if that group is active, and has delivery inactive
whenever the group is not active.</p>
</div>
<div class="paragraph">
<p>You can add a delivery group to the ejb3 subsystem using either the
subsystem xml or cli. Next, we will see examples of each case. In those
examples we will add only a single delivery group, but keep in mind that
you can add as many delivery groups as you need to a Wildfly instance.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the ejb3 subsystem xml (located in your configuration xml, such as
standalone.xml)</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;subsystem xmlns="urn:jboss:domain:ejb3:4.0"&gt;
    ...
    &lt;mdb&gt;
        ...
        &lt;delivery-groups&gt;
            &lt;delivery-group name="mdb-group-name" active="true"/&gt;
        &lt;/delivery-groups&gt;
    &lt;/mdb&gt;
    ...
&lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The example above adds a delivery group named "mdb-group-name" (you can
use whatever name suits you best as the group name). The "true" active
attribute indicates that all MDBs belonging to that group will have
delivery active right after deployment. If you mark that attribute as
false, you are indicating that every MDB belonging to the group will not
start receiving messages after deployment, a condition that will remain
until the group becomes active.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>jboss-cli</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can add a mdb-delivery-group using the add command as below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">[standalone@localhost:9990 /] ./subsystem=ejb3/mdb-delivery-group=mdb-group-name:add
{"outcome" =&gt; "success"}</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="reading-and-writing-the-delivery-state-of-a-delivery-group">Reading and Writing the Delivery State of a Delivery Group</h4>
<div class="paragraph">
<p>You can check whether delivery is active for a group by reading the
active attribute, which defaults to true:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">[standalone@localhost:9990 /] ./subsystem=ejb3/mdb-delivery-group=mdb-group-name:read-attribute(name=active)
{ "outcome" =&gt; "success", "result" =&gt; true }</code></pre>
</div>
</div>
<div class="paragraph">
<p>To make the the delivery-group inactive, just write the active attribute
with a false value:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">[standalone@localhost:9990 /] ./subsystem=ejb3/mdb-delivery-group=mdb-group-name:write-attribute(name=active,value=false)
{"outcome" =&gt; "success"}
 
[standalone@localhost:9990 /] ./subsystem=ejb3/mdb-delivery-group=mdb-group-name:read-attribute(name=active)
{ "outcome" =&gt; "success", "result" =&gt; false }</code></pre>
</div>
</div>
<div class="paragraph">
<p>To make it active again, write the attribute with a true value:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">[standalone@localhost:9990 /] ./subsystem=ejb3/mdb-delivery-group=mdb-group-name:write-attribute(name=active,value=true)
{"outcome" =&gt; "success"}
 
[standalone@localhost:9990 /] ./subsystem=ejb3/mdb-delivery-group=mdb-group-name:read-attribute(name=active)
{ "outcome" =&gt; "success", "result" =&gt; true }</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="using-delivery-groups">Using Delivery Groups</h4>
<div class="paragraph">
<p>To mark that an MDB belongs to a delivery-group, declare so in the
jboss-ejb3.xml file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.1" encoding="UTF-8"?&gt;
 
&lt;jboss:ejb-jar xmlns:jboss="http://www.jboss.com/xml/ns/javaee"
               xmlns="http://java.sun.com/xml/ns/javaee"
               xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
               xmlns:d="urn:delivery-active:1.1"
               xsi:schemaLocation="http://www.jboss.com/xml/ns/javaee http://www.jboss.org/j2ee/schema/jboss-ejb3-2_0.xsd http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/ejb-jar_3_1.xsd"
               version="3.1"
               impl-version="2.0"&gt;
    &lt;assembly-descriptor&gt;
        &lt;d:delivery&gt;
            &lt;ejb-name&gt;HelloWorldMDB&lt;/ejb-name&gt;
            &lt;d:group&gt;mdb-delivery-group&lt;/d:group&gt;
        &lt;/d:delivery&gt;
    &lt;/assembly-descriptor&gt;
&lt;/jboss:ejb-jar&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also use a wildcard to mark that all MDBs in your application
belong to a delivery-group. In the following example, we add all MDBs in
the application to group1, except for HelloWorldMDB, that is added to
group2:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.1" encoding="UTF-8"?&gt;
&lt;jboss:ejb-jar xmlns:jboss="http://www.jboss.com/xml/ns/javaee"
               xmlns="http://java.sun.com/xml/ns/javaee"
               xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
               xmlns:d="urn:delivery-active:1.1"
               xsi:schemaLocation="http://www.jboss.com/xml/ns/javaee http://www.jboss.org/j2ee/schema/jboss-ejb3-2_0.xsd http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/ejb-jar_3_1.xsd"
               version="3.1"
               impl-version="2.0"&gt;
    &lt;assembly-descriptor&gt;
        &lt;d:delivery&gt;
            &lt;ejb-name&gt;*&lt;/ejb-name&gt;
            &lt;d:group&gt;group1&lt;/d:group&gt;
        &lt;/d:delivery&gt;
        &lt;d:delivery&gt;
            &lt;ejb-name&gt;HelloWorldMDB&lt;/ejb-name&gt;
            &lt;d:group&gt;group2&lt;/d:group&gt;
        &lt;/d:delivery&gt;
    &lt;/assembly-descriptor&gt;
&lt;/jboss:ejb-jar&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Another option is to use org.jboss.ejb3.annotation.DeliveryGroup
annotation on each MDB class belonging to a group:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@MessageDriven(name = "HelloWorldQueueMDB", activationConfig = {
 @ActivationConfigProperty(propertyName = "destinationType", propertyValue = "javax.jms.Queue"),
 @ActivationConfigProperty(propertyName = "destination", propertyValue = "queue/HELLOWORLDMDBQueue"),
 @ActivationConfigProperty(propertyName = "acknowledgeMode", propertyValue = "Auto-acknowledge") })
 
@DeliveryGroup("group2")
 
public class HelloWorldMDB implements MessageListener {
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A MDB cannot belong to more than one delivery group. Also, all the
delivery-groups used by an application must be installed in the Wildfly
server upon deployment, or the deployment will fail with a message
stating that the delivery-group is missing.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="clustered-singleton-delivery">Clustered Singleton Delivery</h3>
<div class="paragraph">
<p>Delivery can be marked as singleton in a clustered environment. In this
case, only one node in the cluster will have delivery active for that
MDB, whereas in all other nodes, delivery will be inactive. This option
can be used for applications that are deployed in all nodes of the
cluster. Such applications will be active in all nodes of the cluster,
except for the MDBs that are marked as clustered singleton. For those
MDBs, only one cluster node will be processing their messages. In case
that node stops, another node will have delivery activated, guaranteeing
that there is always one node processing the messages. This node is what
we call the MDB clustered singleton master node.</p>
</div>
<div class="paragraph">
<p>Notice that applications using clustered singleton delivery can only be
deployed in clustered Wildfly servers (i.e., servers that are using the
ha configuration).</p>
</div>
<div class="paragraph">
<p>To mark delivery as clustered singleton, you can use the jboss-ejb3.xml
or the @ClusteredSingleton annotation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>jboss-ejb3.xml:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.1" encoding="UTF-8"?&gt;
&lt;jboss:ejb-jar xmlns:jboss="http://www.jboss.com/xml/ns/javaee"
               xmlns="http://java.sun.com/xml/ns/javaee"
               xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
               xmlns:c="urn:clustering:1.1"
               xsi:schemaLocation="http://www.jboss.com/xml/ns/javaee http://www.jboss.org/j2ee/schema/jboss-ejb3-2_0.xsd http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/ejb-jar_3_1.xsd"
               version="3.1"
               impl-version="2.0"&gt;
    &lt;assembly-descriptor&gt;
        &lt;c:clustering&gt;
            &lt;ejb-name&gt;HelloWorldMDB&lt;/ejb-name&gt;
            &lt;c:clustered-singleton&gt;true&lt;/c:clustered-singleton&gt;
        &lt;/c:clustering&gt;
    &lt;/assembly-descriptor&gt;
&lt;/jboss:ejb-jar&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As in the previous jboss-ejb3.xml examples, a wildcard can be used in
the place of the ejb-name to indicate that all MDBs in the application
are singleton clustered.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>annotation</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can use the org.jboss.ejb3.annotation.ClusteredSingleton annotation
to mark an MDB as clustered singleton:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@MessageDriven(name = "HelloWorldQueueMDB", activationConfig = {
 @ActivationConfigProperty(propertyName = "destinationType", propertyValue = "javax.jms.Queue"),
 @ActivationConfigProperty(propertyName = "destination", propertyValue = "queue/HELLOWORLDMDBQueue"),
 @ActivationConfigProperty(propertyName = "acknowledgeMode", propertyValue = "Auto-acknowledge") })
 
@ClusteredSingleton
 
public class HelloWorldMDB implements MessageListener { ... }</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="using-multiple-mdb-delivery-control-mechanisms">Using Multiple MDB Delivery Control Mechanisms</h3>
<div class="paragraph">
<p>The previous d eliver y control mechanisms can be used together in a
single MDB. In this case, they work as a set of restrictions for
delivery to be active in a MDB.</p>
</div>
<div class="paragraph">
<p>For example, if an MDB belongs to a delivery group and is also a
clustered singleton MDB, the delivery will be active for that MDB only
if the delivery group is active in the cluster node that was elected as
the singleton master.</p>
</div>
<div class="paragraph">
<p>Also, if you use jboss-cli to stopDelivery on a MDB that belongs to a
delivery group, the MDB will stop receiving messages in case that group
was active. If that group was not active, the MDB will continue in the
same, inactive state. But, once that group is active, the MDB will not
receive messages, unless a startDelivery operation is executed to revert
the previously exectued stopDelivery operation.</p>
</div>
<div class="paragraph">
<p>Invoking stopDelivery on an MDB that is marked as clustered singleton
will work in a similar way: no visible effect if the current node is not
the clustered singleton master; but it will stop delivery of messages
for that MDB if the current node is the clustered singleton master. If
the current node is not the master, but eventually becomes so, the
delivery of messages will not be active for that MDB, unless a
startDelivery operation is invoked.</p>
</div>
<div class="paragraph">
<p>In other words, when more than one delivery control mechanism is used in
conjunction, they act as a set of restrictions that need all to be true
in order for the MDB to receive messages:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>delivery-group + stop-delivery</strong>: the delivery group needs to be
active and the delivery needs to be started in order for that MDB to
start receiving messages;</p>
</li>
<li>
<p><strong>delivery-group + clustered singleton</strong>: the delivery group needs to be
active and the current node needs to be the clustered singleton master
node in order for that MDB to start receiving messages;</p>
</li>
<li>
<p><strong>delivery-group + clustered singleton + stop-delivery</strong>: as above,
delivery-group active, current node equals the clustered singleton
master node, plus, start-delivery needs to be invoked on that MDB, only
with these three factors being true the MDB will start receiving
messages.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Securing_EJBs">Securing EJBs</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Java EE spec specifies certain annotations (like @RolesAllowed,
@PermitAll, @DenyAll) which can be used on EJB implementation classes
and/or the business method implementations of the beans. Like with all
other configurations, these security related configurations can also be
done via the deployment descriptor (ejb-jar.xml). We <em>won&#8217;t</em> be going
into the details of Java EE specific annotations/deployment descriptor
configurations in this chapter but instead will be looking at the vendor
specific extensions to the security configurations.</p>
</div>
<div class="sect2">
<h3 id="security-domain-2">Security Domain</h3>
<div class="paragraph">
<p>The Java EE spec doesn&#8217;t mandate a specific way to configure security
domain for a bean. It leaves it to the vendor implementations to allow
such configurations, the way they wish. In WildFly {wildflyVersion}, the use of
<code>@org.jboss.ejb3.annotation.SecurityDomain</code> annotation allows the
developer to configure the security domain for a bean. Here&#8217;s an
example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import org.jboss.ejb3.annotation.SecurityDomain;
 
import javax.ejb.Stateless;
 
@Stateless
@SecurityDomain("other")
﻿public class MyBean ... 
{
 
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The use of @SecurityDomain annotation lets the developer to point the
container to the name of the security domain which is configured in the
EJB3 subsystem in the standalone/domain configuration. The configuration
of the security domain in the EJB3 subsystem is out of the scope of this
chapter.</p>
</div>
<div class="paragraph">
<p>An alternate way of configuring a security domain, instead of using
annotation, is to use jboss-ejb3.xml deployment descriptor. Here&#8217;s an
example of how the configuration will look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;jboss:jboss
        xmlns="http://java.sun.com/xml/ns/javaee"
        xmlns:jboss="http://www.jboss.com/xml/ns/javaee"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:s="urn:security:1.1"
         xsi:schemaLocation="http://www.jboss.com/xml/ns/javaee http://www.jboss.org/j2ee/schema/jboss-ejb3-2_0.xsd http://java.sun.com/xml/ns/javaee http://www.jboss.org/j2ee/schema/jboss-ejb3-spec-2_0.xsd"
         version="3.1" impl-version="2.0"&gt;
 
    &lt;assembly-descriptor&gt;
        &lt;s:security&gt;
   &lt;!-- Even wildcard * is supported --&gt;
            &lt;ejb-name&gt;MyBean&lt;/ejb-name&gt;
            &lt;!-- Name of the security domain which is configured in the EJB3 subsystem --&gt;
            &lt;s:security-domain&gt;other&lt;/s:security-domain&gt;
        &lt;/s:security&gt;
    &lt;/assembly-descriptor&gt;
&lt;/jboss:jboss&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see we use the security-domain element to configure the
security domain.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
The jboss-ejb3.xml is expected to be placed in the .jar/META-INF folder
of a .jar deployment or .war/WEB-INF folder of a .war deployment.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="absence-of-security-domain-configuration-but-presence-of-other-security-metadata">Absence of security domain configuration but presence of other</h3>
<div class="paragraph">
<p>security metadata</p>
</div>
<div class="paragraph">
<p>Let&#8217;s consider the following example bean:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Stateless
public class FooBean {
 
 @RolesAllowed("bar")
 public void doSomething() {
  ..
 }
...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see the <code>doSomething</code> method is configured to be accessible
for users with role "bar". However, the bean isn&#8217;t configured for any
specific security domain. Prior to WildFly {wildflyVersion}, the absence of an
explicitly configured security domain on the bean would leave the bean
unsecured, which meant that even if the <code>doSomething</code> method was
configured with <code>@RolesAllowed("bar")</code> anyone even without the "bar"
role could invoke on the bean.</p>
</div>
<div class="paragraph">
<p>In WildFly {wildflyVersion}, the presence of any security metadata (like @RolesAllowed,
@PermitAll, @DenyAll, @RunAs, @RunAsPrincipal) on the bean or any
business method of the bean, makes the bean secure, even in the absence
of an explicitly configured security domain. In such cases, the security
domain name is default to "other". Users can explicitly configure an
security domain for the bean if they want to using either the annotation
or deployment descriptor approach explained earlier.</p>
</div>
</div>
<div class="sect2">
<h3 id="access-to-methods-without-explicit-security-metadata-on-a-secured-bean">Access to methods without explicit security metadata, on a secured</h3>
<div class="paragraph">
<p>bean</p>
</div>
<div class="paragraph">
<p>Consider this example bean:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Stateless
public class FooBean {
 
 @RolesAllowed("bar")
 public void doSomething() {
  ..
 }
 
 
 public void helloWorld() {
  ...
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see the <code>doSomething</code> method is marked for access for only
users with role "bar". That enables security on the bean (with security
domain defaulted to "other"). However, notice that the method
<code>helloWorld</code> doesn&#8217;t have any specific security configurations.</p>
</div>
<div class="paragraph">
<p>In WildFly {wildflyVersion}, such methods which have no explicit security
configurations, in a secured bean, will be treated similar to a method
with <code>@DenyAll</code> configuration. What that means is, no one is allowed
access to the <code>helloWorld</code> method. This behaviour can be controlled via
the jboss-ejb3.xml deployment descriptor at a per bean level or a per
deployment level as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;jboss:jboss
        xmlns="http://java.sun.com/xml/ns/javaee"
        xmlns:jboss="http://www.jboss.com/xml/ns/javaee"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:s="urn:security:1.1"
        xsi:schemaLocation="http://www.jboss.com/xml/ns/javaee http://www.jboss.org/j2ee/schema/jboss-ejb3-2_0.xsd http://java.sun.com/xml/ns/javaee http://www.jboss.org/j2ee/schema/jboss-ejb3-spec-2_0.xsd"
        version="3.1" impl-version="2.0"&gt;
 
    &lt;assembly-descriptor&gt;
        &lt;s:security&gt;
   &lt;!-- Even wildcard * is supported where * is equivalent to all EJBs in the deployment --&gt;
            &lt;ejb-name&gt;FooBean&lt;/ejb-name&gt;
            &lt;s:missing-method-permissions-deny-access&gt;false&lt;/s:missing-method-permissions-deny-access&gt;
        &lt;/s:security&gt;
    &lt;/assembly-descriptor&gt;
&lt;/jboss:jboss&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice the use of <code>&lt;missing-method-permissions-deny-access&gt;</code> element.
The value for this element can either be true or false. If this element
isn&#8217;t configured then it is equivalent to a value of true i.e. no one is
allowed access to methods, which have no explicit security
configurations, on secured beans. Setting this to false allows access to
such methods for all users i.e. the behaviour will be switched to be
similar to <code>@PermitAll</code>.</p>
</div>
<div class="paragraph">
<p>This behaviour can also be configured at the EJB3 subsystem level so
that it applies to all EJB3 deployments on the server, as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;subsystem xmlns="urn:jboss:domain:ejb3:1.4"&gt;
...
            &lt;default-missing-method-permissions-deny-access value="true"/&gt;
...
&lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Again, the <code>default-missing-method-permissions-deny-access</code> element
accepts either a true or false value. A value of true makes the
behaviour similar to <code>@DenyAll</code> and a value of false makes it behave
like <code>@PermitAll</code></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ejb-client-interceptors">EJB Client Interceptors</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="implementing-client-interceptors">Implementing Client Interceptors</h3>
<div class="paragraph">
<p>The EJB client supports the notion of client side interceptors. These are interceptors
that are run before an invocation is dispatched, and can modify various properties of
the request before it is sent, as well as modifying parameters and the return value.</p>
</div>
<div class="paragraph">
<p>These interceptors are represented by the class <code>org.jboss.ejb.client.EJBClientInterceptor</code>,
and are generally registered placing interceptor class names in
<code>META-INF/services/org.jboss.ejb.client.EJBClientInterceptor</code>.</p>
</div>
<div class="paragraph">
<p>For more details about what can be modified refer to the EJB client JavaDoc.</p>
</div>
</div>
<div class="sect2">
<h3 id="accessing-invocation-context-data">Accessing invocation context data</h3>
<div class="paragraph">
<p>It is possible for client interceptors to access data from the invocation context context data map used in the server
invocation (i.e. <code>InvocationContext.getContextData()</code>). To access a specific key you must call
<code>org.jboss.ejb.client.EJBClientInvocationContext.addReturnedContextDataKey(String key)</code> with
the name of the key you are interested in. This method must be called from the <code>handleInvocation</code> method
of the interceptor.</p>
</div>
<div class="paragraph">
<p>If there is data in the context map under this specific key then it will be send back to the client
and will be available in the handleInvocationResult in the client invocations context data map.</p>
</div>
</div>
</div>
</div>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/wildflysite/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Wildfly</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Wildfly</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/wildfly"><svg class="svg-icon"><use xlink:href="/wildflysite/assets/minima-social-icons.svg#github"></use></svg> <span class="username">wildfly</span></a></li><li><a href="https://www.twitter.com/WildFlyAS"><svg class="svg-icon"><use xlink:href="/wildflysite/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">WildFlyAS</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p></p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
