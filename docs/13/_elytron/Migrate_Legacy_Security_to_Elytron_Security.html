<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Migrate Legacy Security to Elytron Security | Wildfly</title>
<meta name="generator" content="Jekyll v3.8.3" />
<meta property="og:title" content="Migrate Legacy Security to Elytron Security" />
<meta property="og:locale" content="en_US" />
<link rel="canonical" href="https://jbossorg.github.io/wildflysite/docs/13/_elytron/Migrate_Legacy_Security_to_Elytron_Security.html" />
<meta property="og:url" content="https://jbossorg.github.io/wildflysite/docs/13/_elytron/Migrate_Legacy_Security_to_Elytron_Security.html" />
<meta property="og:site_name" content="Wildfly" />
<script type="application/ld+json">
{"@type":"WebPage","url":"https://jbossorg.github.io/wildflysite/docs/13/_elytron/Migrate_Legacy_Security_to_Elytron_Security.html","headline":"Migrate Legacy Security to Elytron Security","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/wildflysite/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://jbossorg.github.io/wildflysite/feed.xml" title="Wildfly" /></head>
<body><div class="header navigation">
  <div class="logo-wrapper">
    <a href="/wildflysite/"><img class="wf-logo" src="/wildflysite/assets/img/wildfly_icons_one-color-logo.png"></a>
  </div>
  <div class="nav-container">
    <nav>
      <div class="nav-mobile"><a id="nav-toggle" href="#!"><span></span></a></div>
      <ul class="nav-list">
        <li>
          <a href="/wildflysite/" class="">Home</a>
        </li>
        <li>
          <a href="/wildflysite/downloads/" class="">Downloads</a>
        </li>
        <li>
          <a href="/wildflysite/blog/" class="">Blog</a>
        </li>
        <li>
          <a href="/wildflysite/about/" class="">About</a>
        </li>
        <li>
          <a href="/wildflysite/contribute/" class="">Contribute</a>
        </li>
        <li>
          <a href="/wildflysite/docs/" class="">Docs</a>
        </li>
        <li>
          <a class="button-cta secondary" href="https://github.com/wildfly/wildfly/fork" target="_blank">Fork</a>
        </li>
      </ul>
    </nav>
  </div>
</div>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <div class="sect1">
<h2 id="authentication-configuration">Authentication Configuration</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="Properties_File_Based_Authentication_Migration">Properties Based Authentication / Authorization</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="picketbox-based-configuration">PicketBox Based Configuration</h3>
<div class="paragraph">
<p>This migration example assumes a deployed web application is configured
to require authentication using FORM based authentication and is
referencing a PicketBox based security domain using the
UsersRolesLoginModule to load user information from a pair or properties
files.</p>
</div>
<div class="sect3">
<h4 id="original-configuration">Original Configuration</h4>
<div class="paragraph">
<p>A security domain can be defined in the legacy security subsystem using
the following management operations: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">./subsystem=security/security-domain=application-security:add
./subsystem=security/security-domain=application-security/authentication=classic:add(login-modules=[{code=UsersRoles, flag=Required, module-options={usersProperties=file://${jboss.server.config.dir}/example-users.properties, rolesProperties=file://${jboss.server.config.dir}/example-roles.properties}}])</code></pre>
</div>
</div>
<div class="paragraph">
<p>This would result in a security domain definition: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">  &lt;security-domain name="application-security"&gt;
    &lt;authentication&gt;
      &lt;login-module code="UsersRoles" flag="required"&gt;
        &lt;module-option name="usersProperties" value="file://${jboss.server.config.dir}/example-users.properties"/&gt;
        &lt;module-option name="rolesProperties" value="file://${jboss.server.config.dir}/example-roles.properties"/&gt;
      &lt;/login-module&gt;
    &lt;/authentication&gt;
  &lt;/security-domain&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="intermediate-configuration">Intermediate Configuration</h4>
<div class="paragraph">
<p>It is possible to take a previously defined PicketBox security domain
and expose it as an Elytron security realm so it can be wired into a
complete Elytron based configuration, if only properties based
authentication was to be migrated it would be recommended to jump to the
fully migration configuration and avoid the unnecessary dependency on
the legacy security subsystem but for situations where that is not
immediately possible these commands illustrate an intermediate solution.</p>
</div>
<div class="paragraph">
<p>These steps assume the original configuration is already in place.</p>
</div>
<div class="paragraph">
<p>The first step is to add a mapping to an Elytron security realm within
the legacy security subsystem.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">./subsystem=security/elytron-realm=application-security:add(legacy-jaas-config=application-security)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This results in the following configuration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">  &lt;subsystem xmlns="urn:jboss:domain:security:2.0"&gt;
    ...
    &lt;elytron-integration&gt;
      &lt;security-realms&gt;
        &lt;elytron-realm name="application-security" legacy-jaas-config="application-security"/&gt;
      &lt;/security-realms&gt;
    &lt;/elytron-integration&gt;
    ...
  &lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Within the Elytron subsystem a security domain can be defined which
references the exported security realm and also a http authentication
factory which supports FORM based authentication.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">./subsystem=elytron/security-domain=application-security:add(realms=[{realm=application-security}], default-realm=application-security, permission-mapper=default-permission-mapper)
./subsystem=elytron/http-authentication-factory=application-security-http:add(http-server-mechanism-factory=global, security-domain=application-security, mechanism-configurations=[{mechanism-name=FORM}])</code></pre>
</div>
</div>
<div class="paragraph">
<p>And the resulting configuration: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">  &lt;subsystem xmlns="urn:wildfly:elytron:1.0" final-providers="combined-providers" disallowed-providers="OracleUcrypto"&gt;
    ...
    &lt;security-domains&gt;
      ...
      &lt;security-domain name="application-security" default-realm="application-security" permission-mapper="default-permission-mapper"&gt;
        &lt;realm name="application-security"/&gt;
      &lt;/security-domain&gt;
    &lt;/security-domains&gt;
    ...
    &lt;http&gt;
      ...
      &lt;http-authentication-factory name="application-security-http" http-server-mechanism-factory="global" security-domain="application-security"&gt;
        &lt;mechanism-configuration&gt;
          &lt;mechanism mechanism-name="FORM"/&gt;
        &lt;/mechanism-configuration&gt;
      &lt;/http-authentication-factory&gt;
      ...
    &lt;/http&gt;
    ...
  &lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally configuration needs to be added to the Undertow subsystem to map
the security domain referenced by the deployment to the newly defined
http authentication factory.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">./subsystem=undertow/application-security-domain=application-security:add(http-authentication-factory=application-security-http)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Which results in: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">  &lt;subsystem xmlns="urn:jboss:domain:undertow:4.0"&gt;
    ...
    &lt;application-security-domains&gt;
      &lt;application-security-domain name="application-security" http-authentication-factory="application-security-http"/&gt;
    &lt;/application-security-domains&gt;
    ...
  &lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note: If the deployment was already deployed at this point the
application server should be reloaded or the deployment redeployed for
the application security domain mapping to take effect.</em></p>
</div>
<div class="paragraph">
<p>The following command can then be used to verify the mapping was applied
to the deployment.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">[standalone@localhost:9990 /] ./subsystem=undertow/application-security-domain=application-security:read-resource(include-runtime=true)
{
    "outcome" =&gt; "success",
    "result" =&gt; {
        "enable-jacc" =&gt; false,
        "http-authentication-factory" =&gt; "application-security-http",
        "override-deployment-config" =&gt; false,
        "referencing-deployments" =&gt; ["HelloWorld.war"],
        "setting" =&gt; undefined
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The deployment being tested here is 'HelloWorld.war' and the output from
the previous command shows this deployment is referencing the mapping.</p>
</div>
<div class="paragraph">
<p>At this stage the previously defined security domain is used for it&#8217;s
LoginModule configuration but this is wrapped by Elytron components
which take over authentication.</p>
</div>
</div>
<div class="sect3">
<h4 id="fully-migrated-configuration">Fully Migrated Configuration</h4>
<div class="paragraph">
<p>Alternatively the configuration can be completely defined within the
Elytron subsystem, in this case it is assumed none of the previous
commands have been executed and this is started from a clean
configuration - however if the security domain definition does exist in
the legacy security subsystem that will remain completely independent.</p>
</div>
<div class="paragraph">
<p>First a new security realm can be defined within the Elytron subsystem
referencing the files referenced previously: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">./subsystem=elytron/properties-realm=application-properties:add(users-properties={path=example-users.properties, relative-to=jboss.server.config.dir, plain-text=true, digest-realm-name="Application Security"}, groups-properties={path=example-roles.properties, relative-to=jboss.server.config.dir}, groups-attribute=Roles)</code></pre>
</div>
</div>
<div class="paragraph">
<p>As before a security domain and http authentication factory can be
defined.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">./subsystem=elytron/security-domain=application-security:add(realms=[{realm=application-properties}], default-realm=application-properties, permission-mapper=default-permission-mapper)
./subsystem=elytron/http-authentication-factory=application-security-http:add(http-server-mechanism-factory=global, security-domain=application-security, mechanism-configurations=[{mechanism-name=FORM}])</code></pre>
</div>
</div>
<div class="paragraph">
<p>This results in the following overall configuration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">  &lt;subsystem xmlns="urn:wildfly:elytron:1.0" final-providers="combined-providers" disallowed-providers="OracleUcrypto"&gt;
    ...
    &lt;security-domains&gt;
      ...
      &lt;security-domain name="application-security" default-realm="application-properties" permission-mapper="default-permission-mapper"&gt;
        &lt;realm name="application-properties"/&gt;
      &lt;/security-domain&gt;
    &lt;/security-domains&gt;
    &lt;security-realms&gt;
      ...
      &lt;properties-realm name="application-properties" groups-attribute="Roles"&gt;
        &lt;users-properties path="example-users.properties" relative-to="jboss.server.config.dir" digest-realm-name="Application Security" plain-text="true"/&gt;
        &lt;groups-properties path="example-roles.properties" relative-to="jboss.server.config.dir"/&gt;
      &lt;/properties-realm&gt;
    &lt;/security-realms&gt;
    ...
    &lt;http&gt;
      ...
      &lt;http-authentication-factory name="application-security-http" http-server-mechanism-factory="global" security-domain="application-security"&gt;
        &lt;mechanism-configuration&gt;
          &lt;mechanism mechanism-name="FORM"/&gt;
        &lt;/mechanism-configuration&gt;
      &lt;/http-authentication-factory&gt;
      ...
    &lt;/http&gt;
    ...
  &lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As before the application-security-domain mapping should be added to the
Undertow subsystem and the server reloaded or the deployment redeployed
as required.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">./subsystem=undertow/application-security-domain=application-security:add(http-authentication-factory=application-security-http)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Which results in: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">  &lt;subsystem xmlns="urn:jboss:domain:undertow:4.0"&gt;
    ...
    &lt;application-security-domains&gt;
      &lt;application-security-domain name="application-security" http-authentication-factory="application-security-http"/&gt;
    &lt;/application-security-domains&gt;
    ...
  &lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>At this stage the authentication is the equivalent of the original
configuration however now Elytron components are used exclusively.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="legacy-security-realm">Legacy Security Realm</h3>
<div class="sect3">
<h4 id="original-configuration-1">Original Configuration</h4>
<div class="paragraph">
<p>A legacy security realm can be defined using the following commands to
load users passwords and group information from properties files.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">./core-service=management/security-realm=ApplicationSecurity:add
./core-service=management/security-realm=ApplicationSecurity/authentication=properties:add(relative-to=jboss.server.config.dir, path=example-users.properties, plain-text=true)
./core-service=management/security-realm=ApplicationSecurity/authorization=properties:add(relative-to=jboss.server.config.dir, path=example-roles.properties)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This results in the following realm definition.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">  &lt;security-realm name="ApplicationSecurity"&gt;
    &lt;authentication&gt;
      &lt;properties path="example-users.properties" relative-to="jboss.server.config.dir" plain-text="true"/&gt;
    &lt;/authentication&gt;
    &lt;authorization&gt;
      &lt;properties path="example-roles.properties" relative-to="jboss.server.config.dir"/&gt;
    &lt;/authorization&gt;
  &lt;/security-realm&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>A legacy security realm would typically be used to secure either the
management interfaces or remoting connectors.</p>
</div>
</div>
<div class="sect3">
<h4 id="migrated-configuration">Migrated Configuration</h4>
<div class="paragraph">
<p>One of the motivations for adding the Elytron based security to the
application server is to allow a consistent security solution to be used
across the server, to replace the security realm the same steps as
described in the previous 'Fully Migrated' section can be followed again
up until the http-authentication-factory is defined.</p>
</div>
<div class="paragraph">
<p>A legacy security realm can also be used for SASL based authentication
so a sasl-authentication-factory should also be defined.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">./subsystem=elytron/sasl-authentication-factory=application-security-sasl:add(sasl-server-factory=elytron, security-domain=application-security, mechanism-configurations=[{mechanism-name=PLAIN}])</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">  &lt;subsystem xmlns="urn:wildfly:elytron:1.0" final-providers="combined-providers" disallowed-providers="OracleUcrypto"&gt;
    ...
    &lt;sasl&gt;
      ...
      &lt;sasl-authentication-factory name="application-security-sasl" sasl-server-factory="elytron" security-domain="application-security"&gt;
        &lt;mechanism-configuration&gt;
          &lt;mechanism mechanism-name="PLAIN"/&gt;
        &lt;/mechanism-configuration&gt;
      &lt;/sasl-authentication-factory&gt;
      ...
    &lt;/sasl&gt;
  &lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This can be associated with a Remoting connector to use for
authentication and the existing security realm reference cleared.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">./subsystem=remoting/http-connector=http-remoting-connector:write-attribute(name=sasl-authentication-factory, value=application-security-sasl)
./subsystem=remoting/http-connector=http-remoting-connector:undefine-attribute(name=security-realm)</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">  &lt;subsystem xmlns="urn:jboss:domain:remoting:4.0"&gt;
    ...
    &lt;http-connector name="http-remoting-connector" connector-ref="default" sasl-authentication-factory="application-security-sasl"/&gt;
  &lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If this new configuration was to be used to secure the management
interfaces more suitable names should be chosen but the following
commands illustrate how to set the two authentication factories and
clear the existing security realm reference.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">./core-service=management/management-interface=http-interface:write-attribute(name=http-authentication-factory, value=application-security-http)
./core-service=management/management-interface=http-interface:write-attribute(name=http-upgrade.sasl-authentication-factory, value=application-security-sasl)
./core-service=management/management-interface=http-interface:undefine-attribute(name=security-realm)</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">  &lt;management-interfaces&gt;
    &lt;http-interface http-authentication-factory="application-security-http"&gt;
      &lt;http-upgrade enabled="true" sasl-authentication-factory="application-security-sasl"/&gt;
      &lt;socket-binding http="management-http"/&gt;
    &lt;/http-interface&gt;
  &lt;/management-interfaces&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="LDAP_Based_Authentication_Migration">LDAP Authentication Migration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The section describing how to migrate from properties based
authentication using either PicketBox or legacy security realms to
Elytron also contained a lot of additional information regarding
defining security domains, authentication factories, and how these are
mapped to be used for authentication. This section will illustrate some
equivalent LDAP configuration using legacy security realms and PicketBox
security domains and show the equivalent configuration using Elytron but
will not repeat the steps to wire it all together covered in the
previous section.</p>
</div>
<div class="paragraph">
<p>These configuration examples are developed against a test LDAP sever
with user entries like: -</p>
</div>
<div class="literalblock">
<div class="content">
<pre>dn: uid=TestUserOne,ou=users,dc=group-to-principal,dc=wildfly,dc=org
objectClass: top
objectClass: inetOrgPerson
objectClass: uidObject
objectClass: person
objectClass: organizationalPerson
cn: Test User One
sn: Test User One
uid: TestUserOne
userPassword: {SSHA}UG8ov2rnrnBKakcARVvraZHqTa7mFWJZlWt2HA==</pre>
</div>
</div>
<div class="paragraph">
<p>The group entries then look like: -</p>
</div>
<div class="literalblock">
<div class="content">
<pre>dn: uid=GroupOne,ou=groups,dc=group-to-principal,dc=wildfly,dc=org
objectClass: top
objectClass: groupOfUniqueNames
objectClass: uidObject
cn: Group One
uid: GroupOne
uniqueMember: uid=TestUserOne,ou=users,dc=group-to-principal,dc=wildfly,dc=org</pre>
</div>
</div>
<div class="paragraph">
<p>For authentication purposes the username will be matched against the
'uid' attribute, also the resulting group name will be taken from the
'uid' attribute of the group entry.</p>
</div>
<div class="sect2">
<h3 id="legacy-security-realm">Legacy Security Realm</h3>
<div class="paragraph">
<p>A connection to the LDAP server and related security realm can be
created with the following commands: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">batch
./core-service=management/ldap-connection=MyLdapConnection:add(url="ldap://localhost:10389", search-dn="uid=admin,ou=system", search-credential="secret")
 
./core-service=management/security-realm=LDAPRealm:add
./core-service=management/security-realm=LDAPRealm/authentication=ldap:add(connection="MyLdapConnection", username-attribute=uid, base-dn="ou=users,dc=group-to-principal,dc=wildfly,dc=org")
 
 
./core-service=management/security-realm=LDAPRealm/authorization=ldap:add(connection=MyLdapConnection)
./core-service=management/security-realm=LDAPRealm/authorization=ldap/username-to-dn=username-filter:add(attribute=uid, base-dn="ou=users,dc=group-to-principal,dc=wildfly,dc=org")
./core-service=management/security-realm=LDAPRealm/authorization=ldap/group-search=group-to-principal:add(base-dn="ou=groups,dc=group-to-principal,dc=wildfly,dc=org", iterative=true, prefer-original-connection=true, principal-attribute=uniqueMember, search-by=DISTINGUISHED_NAME, group-name=SIMPLE, group-name-attribute=uid)
run-batch</code></pre>
</div>
</div>
<div class="paragraph">
<p>This results in the following configuration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">  &lt;management&gt;
    &lt;security-realms&gt;
      ...
      &lt;security-realm name="LDAPRealm"&gt;
        &lt;authentication&gt;
          &lt;ldap connection="MyLdapConnection" base-dn="ou=users,dc=group-to-principal,dc=wildfly,dc=org"&gt;
            &lt;username-filter attribute="uid"/&gt;
          &lt;/ldap&gt;
        &lt;/authentication&gt;
        &lt;authorization&gt;
          &lt;ldap connection="MyLdapConnection"&gt;
            &lt;username-to-dn&gt;
              &lt;username-filter base-dn="ou=users,dc=group-to-principal,dc=wildfly,dc=org" attribute="uid"/&gt;
            &lt;/username-to-dn&gt;
            &lt;group-search group-name="SIMPLE" iterative="true" group-name-attribute="uid"&gt;
              &lt;group-to-principal search-by="DISTINGUISHED_NAME" base-dn="ou=groups,dc=group-to-principal,dc=wildfly,dc=org" prefer-original-connection="true"&gt;
                &lt;membership-filter principal-attribute="uniqueMember"/&gt;
              &lt;/group-to-principal&gt;
            &lt;/group-search&gt;
          &lt;/ldap&gt;
        &lt;/authorization&gt;
      &lt;/security-realm&gt;
    &lt;/security-realms&gt;
    &lt;outbound-connections&gt;
      &lt;ldap name="MyLdapConnection" url="ldap://localhost:10389" search-dn="uid=admin,ou=system" search-credential="secret"/&gt;
    &lt;/outbound-connections&gt;
    ...
  &lt;/management&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="picketbox-ldapextloginmodule">PicketBox LdapExtLoginModule</h3>
<div class="paragraph">
<p>The following commands can create a PicketBox security domain configured
to use the LdapExtLoginModule to verify a username and password.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">./subsystem=security/security-domain=application-security:add
./subsystem=security/security-domain=application-security/authentication=classic:add(login-modules=[{code=LdapExtended, flag=Required, module-options={ \
java.naming.factory.initial=com.sun.jndi.ldap.LdapCtxFactory, \
java.naming.provider.url=ldap://localhost:10389, \
java.naming.security.authentication=simple, \
bindDN="uid=admin,ou=system", \
bindCredential=secret, \
baseCtxDN="ou=users,dc=group-to-principal,dc=wildfly,dc=org", \
baseFilter="(uid={0})", \
rolesCtxDN="ou=groups,dc=group-to-principal,dc=wildfly,dc=org",\
roleFilter="(uniqueMember={1})", \
roleAttributeID="uid" \
}}])</code></pre>
</div>
</div>
<div class="paragraph">
<p>This results in the following configuration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">  &lt;subsystem xmlns="urn:jboss:domain:security:2.0"&gt;
    ...
    &lt;security-domains&gt;
      ...
      &lt;security-domain name="application-security"&gt;
        &lt;authentication&gt;
          &lt;login-module code="LdapExtended" flag="required"&gt;
            &lt;module-option name="java.naming.factory.initial" value="com.sun.jndi.ldap.LdapCtxFactory"/&gt;
            &lt;module-option name="java.naming.provider.url" value="ldap://localhost:10389"/&gt;
            &lt;module-option name="java.naming.security.authentication" value="simple"/&gt;
            &lt;module-option name="bindDN" value="uid=admin,ou=system"/&gt;
            &lt;module-option name="bindCredential" value="secret"/&gt;
            &lt;module-option name="baseCtxDN" value="ou=users,dc=group-to-principal,dc=wildfly,dc=org"/&gt;
            &lt;module-option name="baseFilter" value="(uid={0})"/&gt;
            &lt;module-option name="rolesCtxDN" value="ou=groups,dc=group-to-principal,dc=wildfly,dc=org"/&gt;
            &lt;module-option name="roleFilter" value="(uniqueMember={1})"/&gt;
            &lt;module-option name="roleAttributeID" value="uid"/&gt;
          &lt;/login-module&gt;
        &lt;/authentication&gt;
      &lt;/security-domain&gt;
    &lt;/security-domains&gt;
  &lt;/subsystem&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="migrated">Migrated</h3>
<div class="paragraph">
<p>Within the Elytron subsystem a directory context can be defined for the
connection to LDAP: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">./subsystem=elytron/dir-context=ldap-connection:add(url=ldap://localhost:10389, principal="uid=admin,ou=system", credential-reference={clear-text=secret})</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then a security realm can be created to search LDAP and verify the
supplied password: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">./subsystem=elytron/ldap-realm=ldap-realm:add(dir-context=ldap-connection, \
direct-verification=true, \
identity-mapping={search-base-dn="ou=users,dc=group-to-principal,dc=wildfly,dc=org", \
rdn-identifier="uid", \
attribute-mapping=[{filter-base-dn="ou=groups,dc=group-to-principal,dc=wildfly,dc=org",filter="(uniqueMember={1})",from="uid",to="Roles"}]})</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the prior two examples information is loaded from LDAP to use
directly as groups or roles, in the Elytron case information can be
loaded from LDAP to associate with the identity as attributes - these
can subsequently be mapped to roles but attributes can be loaded for
other purposes as well.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
By default, if no <code>role-decoder</code> is defined for given <code>security-domain</code>,
identity attribute " `Roles`" is mapped to the identity roles.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This leads to the following configuration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">  &lt;subsystem xmlns="urn:wildfly:elytron:1.0" final-providers="combined-providers" disallowed-providers="OracleUcrypto"&gt;
    ...
    &lt;security-realms&gt;
      ...
      &lt;ldap-realm name="ldap-realm" dir-context="ldap-connection" direct-verification="true"&gt;
        &lt;identity-mapping rdn-identifier="uid" search-base-dn="ou=users,dc=group-to-principal,dc=wildfly,dc=org"&gt;
          &lt;attribute-mapping&gt;
            &lt;attribute from="uid" to="Roles" filter="(uniqueMember={1})" filter-base-dn="ou=groups,dc=group-to-principal,dc=wildfly,dc=org"/&gt;
          &lt;/attribute-mapping&gt;
        &lt;/identity-mapping&gt;
      &lt;/ldap-realm&gt;
    &lt;/security-realms&gt;
    ...
    &lt;dir-contexts&gt;
      &lt;dir-context name="ldap-connection" url="ldap://localhost:10389" principal="uid=admin,ou=system"&gt;
        &lt;credential-reference clear-text="secret"/&gt;
      &lt;/dir-context&gt;
    &lt;/dir-contexts&gt;
  &lt;/subsystem&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Composite_Stores_Migration">Composite Stores Migration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When using either PicketBox or the legacy security realms it is possible to define a configuration where authentication is performed against one identity store whilst the information used for authorization is loaded from a different store, when using WildFly Elytron this can be achieved by using an aggregate security realm.</p>
</div>
<div class="paragraph">
<p>The example here makes use of a properties file for authentication and then searches LDAP to load group / role information. Both of these are based on the previous examples within this document so the environmental information is not repeated here.</p>
</div>
<div class="sect2">
<h3 id="picketbox-based-configuration-2">PicketBox Based Configuration</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">./subsystem=security/security-domain=application-security:add
./subsystem=security/security-domain=application-security/authentication=classic:add(login-modules=[ \
{code=UsersRoles, flag=Required, module-options={ \
password-stacking=useFirstPass, \
usersProperties=file://${jboss.server.config.dir}/example-users.properties, \
rolesProperties=file://${jboss.server.config.dir}/example-roles.properties}} \
{code=LdapExtended, flag=Required, module-options={ \
password-stacking=useFirstPass, \
java.naming.factory.initial=com.sun.jndi.ldap.LdapCtxFactory, \
java.naming.provider.url=ldap://localhost:10389, \
java.naming.security.authentication=simple, \
bindDN="uid=admin,ou=system", \
bindCredential=secret, \
baseCtxDN="ou=users,dc=group-to-principal,dc=wildfly,dc=org", \
baseFilter="(uid={0})", \
rolesCtxDN="ou=groups,dc=group-to-principal,dc=wildfly,dc=org",\
roleFilter="(uniqueMember={1})", \
roleAttributeID="uid" \
}}])</code></pre>
</div>
</div>
<div class="paragraph">
<p>This results in the following domain definition</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;security-domain name="application-security"&gt;
  &lt;authentication&gt;
    &lt;login-module code="UsersRoles" flag="required"&gt;
      &lt;module-option name="password-stacking" value="useFirstPass"/&gt;
      &lt;module-option name="usersProperties" value="file://${jboss.server.config.dir}/example-users.properties"/&gt;
      &lt;module-option name="rolesProperties" value="file://${jboss.server.config.dir}/example-roles.properties"/&gt;
    &lt;/login-module&gt;
    &lt;login-module code="LdapExtended" flag="required"&gt;
      &lt;module-option name="password-stacking" value="useFirstPass"/&gt;
      &lt;module-option name="java.naming.factory.initial" value="com.sun.jndi.ldap.LdapCtxFactory"/&gt;
      &lt;module-option name="java.naming.provider.url" value="ldap://localhost:10389"/&gt;
      &lt;module-option name="java.naming.security.authentication" value="simple"/&gt;
      &lt;module-option name="bindDN" value="uid=admin,ou=system"/&gt;
      &lt;module-option name="bindCredential" value="secret"/&gt;
      &lt;module-option name="baseCtxDN" value="ou=users,dc=group-to-principal,dc=wildfly,dc=org"/&gt;
      &lt;module-option name="baseFilter" value="(uid={0})"/&gt;
      &lt;module-option name="rolesCtxDN" value="ou=groups,dc=group-to-principal,dc=wildfly,dc=org"/&gt;
      &lt;module-option name="roleFilter" value="(uniqueMember={1})"/&gt;
      &lt;module-option name="roleAttributeID" value="uid"/&gt;
    &lt;/login-module&gt;
  &lt;/authentication&gt;
&lt;/security-domain&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>During an authentication attempt the 'UsersRoles' login module will first be called to perform authentication based on the supplied credential, then the 'LdapExtLoginModule' will be called which will proceed to query LDAP to load the roles for the identity.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">./core-service=management/ldap-connection=MyLdapConnection:add(url="ldap://localhost:10389", search-dn="uid=admin,ou=system", search-credential="secret")

./core-service=management/security-realm=ApplicationSecurity:add
./core-service=management/security-realm=ApplicationSecurity/authentication=properties:add(path=example-users.properties, relative-to=jboss.server.config.dir, plain-text=true)

batch
./core-service=management/security-realm=ApplicationSecurity/authorization=ldap:add(connection=MyLdapConnection)
./core-service=management/security-realm=ApplicationSecurity/authorization=ldap/username-to-dn=username-filter:add(attribute=uid, base-dn="ou=users,dc=group-to-principal,dc=wildfly,dc=org")
./core-service=management/security-realm=ApplicationSecurity/authorization=ldap/group-search=group-to-principal:add(base-dn="ou=groups,dc=group-to-principal,dc=wildfly,dc=org", iterative=true, prefer-original-connection=true, principal-attribute=uniqueMember, search-by=DISTINGUISHED_NAME, group-name=SIMPLE, group-name-attribute=uid)
run-batch</code></pre>
</div>
</div>
<div class="paragraph">
<p>This results in the following realm definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;security-realm name="ApplicationSecurity"&gt;
  &lt;authentication&gt;
    &lt;properties path="example-users.properties" relative-to="jboss.server.config.dir" plain-text="true"/&gt;
  &lt;/authentication&gt;
  &lt;authorization&gt;
    &lt;ldap connection="MyLdapConnection"&gt;
      &lt;username-to-dn&gt;
        &lt;username-filter base-dn="ou=users,dc=group-to-principal,dc=wildfly,dc=org" attribute="uid"/&gt;
      &lt;/username-to-dn&gt;
      &lt;group-search group-name="SIMPLE" iterative="true" group-name-attribute="uid"&gt;
        &lt;group-to-principal search-by="DISTINGUISHED_NAME" base-dn="ou=groups,dc=group-to-principal,dc=wildfly,dc=org" prefer-original-connection="true"&gt;
          &lt;membership-filter principal-attribute="uniqueMember"/&gt;
        &lt;/group-to-principal&gt;
      &lt;/group-search&gt;
    &lt;/ldap&gt;
  &lt;/authorization&gt;
&lt;/security-realm&gt;

&lt;outbound-connections&gt;
  &lt;ldap name="MyLdapConnection" url="ldap://localhost:10389" search-dn="uid=admin,ou=system" search-credential="secret"/&gt;
&lt;/outbound-connections&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As with the PicketBox example, authentication is first performed using the properties file - then group searching is performed against LDAP.</p>
</div>
</div>
<div class="sect2">
<h3 id="migrated-wildfly-elytron-configuration">Migrated WildFly Elytron Configuration</h3>
<div class="paragraph">
<p>The equivalent WildFly Elytron configuration can be defined with the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">./subsystem=elytron/dir-context=ldap-connection:add(url=ldap://localhost:10389, principal="uid=admin,ou=system", credential-reference={clear-text=secret})

./subsystem=elytron/ldap-realm=ldap-realm:add(dir-context=ldap-connection, \
direct-verification=true, \
identity-mapping={search-base-dn="ou=users,dc=group-to-principal,dc=wildfly,dc=org", \
rdn-identifier="uid", \
attribute-mapping=[{filter-base-dn="ou=groups,dc=group-to-principal,dc=wildfly,dc=org",filter="(uniqueMember={1})",from="uid",to="Roles"}]})

./subsystem=elytron/properties-realm=application-properties:add(users-properties={path=example-users.properties, relative-to=jboss.server.config.dir, plain-text=true, digest-realm-name="Application Security"}, groups-properties={path=example-roles.properties, relative-to=jboss.server.config.dir}, groups-attribute=Roles)

./subsystem=elytron/aggregate-realm=combined-realm:add(authentication-realm=application-properties, authorization-realm=ldap-realm)

./subsystem=elytron/security-domain=application-security:add(realms=[{realm=combined-realm}], default-realm=combined-realm, permission-mapper=default-permission-mapper)
./subsystem=elytron/http-authentication-factory=application-security-http:add(http-server-mechanism-factory=global, security-domain=application-security, mechanism-configurations=[{mechanism-name=BASIC}])</code></pre>
</div>
</div>
<div class="paragraph">
<p>This results in the following realm definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;subsystem xmlns="urn:wildfly:elytron:1.1" final-providers="combined-providers" disallowed-providers="OracleUcrypto"&gt;
  ...
  &lt;security-domains&gt;
    ...
    &lt;security-domain name="application-security" default-realm="combined-realm" permission-mapper="default-permission-mapper"&gt;
      &lt;realm name="combined-realm"/&gt;
    &lt;/security-domain&gt;
  &lt;/security-domains&gt;
  &lt;security-realms&gt;
    &lt;aggregate-realm name="combined-realm" authentication-realm="application-properties" authorization-realm="ldap-realm"/&gt;
      ...
      &lt;properties-realm name="application-properties" groups-attribute="Roles"&gt;
        &lt;users-properties path="example-users.properties" relative-to="jboss.server.config.dir" digest-realm-name="Application Security" plain-text="true"/&gt;
        &lt;groups-properties path="example-roles.properties" relative-to="jboss.server.config.dir"/&gt;
      &lt;/properties-realm&gt;
      &lt;ldap-realm name="ldap-realm" dir-context="ldap-connection" direct-verification="true"&gt;
        &lt;identity-mapping rdn-identifier="uid" search-base-dn="ou=users,dc=group-to-principal,dc=wildfly,dc=org"&gt;
          &lt;attribute-mapping&gt;
            &lt;attribute from="uid" to="Roles" filter="(uniqueMember={1})" filter-base-dn="ou=groups,dc=group-to-principal,dc=wildfly,dc=org"/&gt;
          &lt;/attribute-mapping&gt;
        &lt;/identity-mapping&gt;
      &lt;/ldap-realm&gt;
  &lt;/security-realms&gt;
  ...
  &lt;http&gt;
    ...
    &lt;http-authentication-factory name="application-security-http" http-server-mechanism-factory="global" security-domain="application-security"&gt;
      &lt;mechanism-configuration&gt;
        &lt;mechanism mechanism-name="BASIC"/&gt;
      &lt;/mechanism-configuration&gt;
    &lt;/http-authentication-factory&gt;
    ...
  &lt;/http&gt;
  ...
  &lt;dir-contexts&gt;
    &lt;dir-context name="ldap-connection" url="ldap://localhost:10389" principal="uid=admin,ou=system"&gt;
      &lt;credential-reference clear-text="secret"/&gt;
    &lt;/dir-context&gt;
  &lt;/dir-contexts&gt;
&lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Within the WildFly Elytron example a new security realm 'aggregate-realm' has been defined, this definition specifies which of the defined security realms should be used for the authentication step and which of the security realms should be used for the loading of the identity used for subsequent authorization decisions.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Database_Authentication_Migration">Database Authentication</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The section describing how to migrate from database accessible via JDBC
datasource based authentication using PicketBox to Elytron. This section
will illustrate some equivalent configuration using PicketBox security
domains and show the equivalent configuration using Elytron but will not
repeat the steps to wire it all together covered in the previous
sections.</p>
</div>
<div class="paragraph">
<p>These configuration examples are developed against a test database with
users table like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">CREATE TABLE User (
    id BIGINT NOT NULL,
    username VARCHAR(255),
    password VARCHAR(255),
    role ENUM('admin', 'manager', 'user'),
    PRIMARY KEY (id),
    UNIQUE (username)
)</code></pre>
</div>
</div>
<div class="paragraph">
<p>For authentication purposes the username will be matched against the '
`username&#8217; column, password will be expected in hex-encoded MD5 hash in
' `password&#8217; column. User role for authorization purposes will be taken
from ' `role&#8217; column.</p>
</div>
<div class="sect2">
<h3 id="picketbox-database-loginmodule">PicketBox Database LoginModule</h3>
<div class="paragraph">
<p>The following commands can create a PicketBox security domain configured
to use database accessible via JDBC datasource to verify a username and
password and to assign roles.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">./subsystem=security/security-domain=application-security/:add
./subsystem=security/security-domain=application-security/authentication=classic:add(login-modules=[{code=Database, flag=Required, module-options={ \
    dsJndiName="java:jboss/datasources/ExampleDS", \
    principalsQuery="SELECT password FROM User WHERE username = ?", \
    rolesQuery="SELECT role, 'Roles' FROM User WHERE username = ?", \
    hashAlgorithm=MD5, \
    hashEncoding=base64 \
}}])</code></pre>
</div>
</div>
<div class="paragraph">
<p>This results in the following configuration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">        &lt;subsystem xmlns="urn:jboss:domain:security:2.0"&gt;
            &lt;security-domains&gt;
                ...
                &lt;security-domain name="application-security"&gt;
                    &lt;authentication&gt;
                        &lt;login-module code="Database" flag="required"&gt;
                            &lt;module-option name="dsJndiName" value="java:jboss/datasources/ExampleDS"/&gt;
                            &lt;module-option name="principalsQuery" value="SELECT password FROM User WHERE username = ?"/&gt;
                            &lt;module-option name="rolesQuery" value="SELECT role, 'Roles' FROM User WHERE username = ?"/&gt;
                            &lt;module-option name="hashAlgorithm" value="MD5"/&gt;
                            &lt;module-option name="hashEncoding" value="base64"/&gt;
                        &lt;/login-module&gt;
                    &lt;/authentication&gt;
                &lt;/security-domain&gt;
            &lt;/security-domains&gt;
        &lt;/subsystem&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="migrated">Migrated</h3>
<div class="paragraph">
<p>Within the Elytron subsystem to use database accesible via JDBC you need
to define <code>jdbc-realm</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">./subsystem=elytron/jdbc-realm=jdbc-realm:add(principal-query=[{ \
    data-source=ExampleDS, \
    sql="SELECT role, password FROM User WHERE username = ?", \
    attribute-mapping=[{index=1, to=Roles}] \
    simple-digest-mapper={algorithm=simple-digest-md5, password-index=2}, \
}])</code></pre>
</div>
</div>
<div class="paragraph">
<p>This results in the following overall configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">        &lt;subsystem xmlns="urn:wildfly:elytron:1.0" final-providers="combined-providers" disallowed-providers="OracleUcrypto"&gt;
            ...
            &lt;security-realms&gt;
                ...
                &lt;jdbc-realm name="jdbc-realm"&gt;
                    &lt;principal-query sql="SELECT role, password FROM User WHERE username = ?" data-source="ExampleDS"&gt;
                        &lt;attribute-mapping&gt;
                            &lt;attribute to="Roles" index="1"/&gt;
                        &lt;/attribute-mapping&gt;
                        &lt;simple-digest-mapper password-index="2"/&gt;
                    &lt;/principal-query&gt;
                &lt;/jdbc-realm&gt;
                ...
            &lt;/security-realms&gt;
            ...
        &lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In comparison with PicketBox solution, Elytron <code>jdbc-realm</code> use one SQL
query to obtain all user attributes and credentials. Their extraction
from SQL result specifies mappers.</p>
</div>
</div>
<div class="sect2">
<h3 id="n-m-relation-beetween-user-and-roles">N-M relation beetween user and roles</h3>
<div class="paragraph">
<p>When using a n:m-relation beetween user and roles (which means: the user has multiple roles), the previous configuration does not work.</p>
</div>
<div class="paragraph">
<p>The database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">CREATE TABLE User (
id BIGINT NOT NULL,
username VARCHAR(255),
password VARCHAR(255),
PRIMARY KEY (id),
UNIQUE (username)
)

CREATE TABLE Role(
id BIGINT NOT NULL,
rolename VARCHAR(255),
PRIMARY KEY (id),
UNIQUE (rolename)
)

CREATE TABLE Userrole(
userid BIGINT not null,
roleid BIGINT not null,
PRIMARY KEY (userid, roleid),
FOREIGN KEY (userid) references User(id,
FOREIGN KEY (roleid) references Role(id)
)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here you need two configure two principal queries:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;jdbc-realm name="jdbc-realm"&gt;
    &lt;principal-query sql="SELECT PASSWORD FROM USER WHERE USERNAME = ?" data-source="ExampleDS"&gt;
        &lt;clear-password-mapper password-index="1"/&gt;
    &lt;/principal-query&gt;
    &lt;principal-query sql="SELECT R.ROLENAME from ROLE AS R, USERROLE AS UR, USER AS U WHERE U.USERNAME=? AND UR.ROLEID = R.ID AND UR.USERID = U.ID" data-source="ExampleDS"&gt;
        &lt;attribute-mapping&gt;
            &lt;attribute to="roles" index="1"/&gt;
        &lt;/attribute-mapping&gt;
    &lt;/principal-query&gt;
&lt;/jdbc-realm&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The second query needs an attribute mapping to decode the selected rolename column (index 1):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;mappers&gt;
...
&lt;simple-role-decoder name="from-roles-attribute" attribute="roles"/&gt;
...
&lt;/mappers&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The role decoder is referenced by the security domain:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;security-domain name="MyDomain" default-realm="jdbc-realm" permission-mapper="default-permission-mapper"&gt;
&lt;realm name="MyDbRealm" role-decoder="from-roles-attribute"/&gt;
&lt;/security-domain&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Kerberos_Based_Authentication_Migration">Kerberos Authentication Migration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When working with Kerberos configuration it is possible for the
application server to rely on configuration from the environment or the
key configuration can be specified using system properties, for the
purpose of these examples I define system properties - these properties
are applicable to both the legacy configuration and the migrated Elytron
configuration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">./system-property=sun.security.krb5.debug:add(value=true)
./system-property=java.security.krb5.realm:add(value=ELYTRON.ORG)
./system-property=java.security.krb5.kdc:add(value=kdc.elytron.org)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first line makes debugging easier but the last two lines specify the
Kerberos realm in use and the address of the KDC.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">  &lt;system-properties&gt;
    &lt;property name="sun.security.krb5.debug" value="true"/&gt;
    &lt;property name="java.security.krb5.realm" value="ELYTRON.ORG"/&gt;
    &lt;property name="java.security.krb5.kdc" value="kdc.elytron.org"/&gt;
  &lt;/system-properties&gt;</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="http-authentication">HTTP Authentication</h3>
<div class="sect3">
<h4 id="legacy-security-realm">Legacy Security Realm</h4>
<div class="paragraph">
<p>A legacy security realm can be define so that SPNEGO authentication can
be enabled for the HTTP management interface.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">./core-service=management/security-realm=Kerberos:add
./core-service=management/security-realm=Kerberos/server-identity=kerberos:add
./core-service=management/security-realm=Kerberos/server-identity=kerberos/keytab=HTTP\/test-server.elytron.org@ELYTRON.ORG:add(path=/home/darranl/src/kerberos/test-server.keytab, debug=true)
./core-service=management/security-realm=Kerberos/authentication=kerberos:add(remove-realm=true)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This results in the following configuration: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">  &lt;security-realms&gt;
    ...
    &lt;security-realm name="Kerberos"&gt;
      &lt;server-identities&gt;
        &lt;kerberos&gt;
          &lt;keytab principal="HTTP/test-server.elytron.org@ELYTRON.ORG" path="/home/darranl/src/kerberos/test-server.keytab" debug="true"/&gt;
        &lt;/kerberos&gt;
      &lt;/server-identities&gt;
      &lt;authentication&gt;
        &lt;kerberos remove-realm="true"/&gt;
      &lt;/authentication&gt;
    &lt;/security-realm&gt;
  &lt;/security-realms&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="application-spnego">Application SPNEGO</h4>
<div class="paragraph">
<p>Alternatively deployed applications would make use of a pair of security
domains.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">./subsystem=security/security-domain=host:add
./subsystem=security/security-domain=host/authentication=classic:add
./subsystem=security/security-domain=host/authentication=classic/login-module=1:add(code=Kerberos, flag=Required, module-options={storeKey=true, useKeyTab=true, principal=HTTP/test-server.elytron.org@ELYTRON.ORG, keyTab=/home/darranl/src/kerberos/test-server.keytab, debug=true}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">./subsystem=security/security-domain=SPNEGO:add
./subsystem=security/security-domain=SPNEGO/authentication=classic:add
./subsystem=security/security-domain=SPNEGO/authentication=classic/login-module=1:add(code=SPNEGO, flag=requisite,  module-options={password-stacking=useFirstPass, serverSecurityDomain=host})
./subsystem=security/security-domain=SPNEGO/authentication=classic/login-module=1:write-attribute(name=module, value=org.jboss.security.negotiation)
./subsystem=security/security-domain=SPNEGO/authentication=classic/login-module=2:add(code=UsersRoles, flag=required, module-options={password-stacking=useFirstPass, usersProperties=file:///home/darranl/src/kerberos/spnego-users.properties, rolesProperties=file:///home/darranl/src/kerberos/spnego-roles.properties, defaultUsersProperties=file:///home/darranl/src/kerberos/spnego-users.properties, defaultRolesProperties=file:///home/darranl/src/kerberos/spnego-roles.properties})</code></pre>
</div>
</div>
<div class="paragraph">
<p>This results in: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">  &lt;subsystem xmlns="urn:jboss:domain:security:2.0"&gt;
    &lt;security-domains&gt;
      ...
      &lt;security-domain name="host"&gt;
        &lt;authentication&gt;
          &lt;login-module name="1" code="Kerberos" flag="required"&gt;
            &lt;module-option name="storeKey" value="true"/&gt;
            &lt;module-option name="useKeyTab" value="true"/&gt;
            &lt;module-option name="principal" value="HTTP/test-server.elytron.org@ELYTRON.ORG"/&gt;
            &lt;module-option name="keyTab" value="/home/darranl/src/kerberos/test-server.keytab"/&gt;
            &lt;module-option name="debug" value="true"/&gt;
          &lt;/login-module&gt;
        &lt;/authentication&gt;
      &lt;/security-domain&gt;
      &lt;security-domain name="SPNEGO"&gt;
        &lt;authentication&gt;
          &lt;login-module name="1" code="SPNEGO" flag="requisite" module="org.jboss.security.negotiation"&gt;
            &lt;module-option name="password-stacking" value="useFirstPass"/&gt;
            &lt;module-option name="serverSecurityDomain" value="host"/&gt;
          &lt;/login-module&gt;
          &lt;login-module name="2" code="UsersRoles" flag="required"&gt;
            &lt;module-option name="password-stacking" value="useFirstPass"/&gt;
            &lt;module-option name="usersProperties" value="file:///home/darranl/src/kerberos/spnego-users.properties"/&gt;
            &lt;module-option name="rolesProperties" value="file:///home/darranl/src/kerberos/spnego-roles.properties"/&gt;
            &lt;module-option name="defaultUsersProperties" value="file:///home/darranl/src/kerberos/spnego-users.properties"/&gt;
            &lt;module-option name="defaultRolesProperties" value="file:///home/darranl/src/kerberos/spnego-roles.properties"/&gt;
          &lt;/login-module&gt;
        &lt;/authentication&gt;
      &lt;/security-domain&gt;
    &lt;/security-domains&gt;
  &lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>An application can now be deployed referencing the SPNEGO security
domain and secured with SPNEGO mechanism.</p>
</div>
</div>
<div class="sect3">
<h4 id="migrated-spnego">Migrated SPNEGO</h4>
<div class="paragraph">
<p>The equivalent configuration can be achieved with WildFly Elytron by
first defining a security realm which will be used to load identity
information.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">./subsystem=elytron/properties-realm=spnego-properties:add(users-properties={path=/home/darranl/src/kerberos/spnego-users.properties, plain-text=true, digest-realm-name=ELYTRON.ORG}, groups-properties={path=/home/darranl/src/kerberos/spnego-roles.properties})</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next a Kerberos security factory is defined which allows the server to
load it&#8217;s own Kerberos identity.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">./subsystem=elytron/kerberos-security-factory=test-server:add(path=/home/darranl/src/kerberos/test-server.keytab, principal=HTTP/test-server.elytron.org@ELYTRON.ORG, debug=true)</code></pre>
</div>
</div>
<div class="paragraph">
<p>As with the previous examples we define a security realm to pull
together the policy as well as a HTTP authentication factory for the
authentication policy.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">./subsystem=elytron/security-domain=SPNEGODomain:add(default-realm=spnego-properties, realms=[{realm=spnego-properties, role-decoder=groups-to-roles}], permission-mapper=default-permission-mapper)
./subsystem=elytron/http-authentication-factory=spnego-http-authentication:add(security-domain=SPNEGODomain, http-server-mechanism-factory=global,mechanism-configurations=[{mechanism-name=SPNEGO, credential-security-factory=test-server}])</code></pre>
</div>
</div>
<div class="paragraph">
<p>Overall this results in the following configuration: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">  &lt;subsystem xmlns="urn:wildfly:elytron:1.0" final-providers="combined-providers" disallowed-providers="OracleUcrypto"&gt;
    ...
    &lt;security-domains&gt;
    ...
      &lt;security-domain name="SPNEGODomain" default-realm="spnego-properties" permission-mapper="default-permission-mapper"&gt;
        &lt;realm name="spnego-properties" role-decoder="groups-to-roles"/&gt;
      &lt;/security-domain&gt;
    &lt;/security-domains&gt;
    &lt;security-realms&gt;
      ...
      &lt;properties-realm name="spnego-properties"&gt;
        &lt;users-properties path="/home/darranl/src/kerberos/spnego-users.properties" digest-realm-name="ELYTRON.ORG" plain-text="true"/&gt;
        &lt;groups-properties path="/home/darranl/src/kerberos/spnego-roles.properties"/&gt;
      &lt;/properties-realm&gt;
    &lt;/security-realms&gt;
    &lt;credential-security-factories&gt;
      &lt;kerberos-security-factory name="test-server" principal="HTTP/test-server.elytron.org@ELYTRON.ORG" path="/home/darranl/src/kerberos/test-server.keytab" debug="true"/&gt;
    &lt;/credential-security-factories&gt;
    ...
    &lt;http&gt;
      ...
      &lt;http-authentication-factory name="spnego-http-authentication" http-server-mechanism-factory="global" security-domain="SPNEGODomain"&gt;
        &lt;mechanism-configuration&gt;
          &lt;mechanism mechanism-name="SPNEGO" credential-security-factory="test-server"/&gt;
        &lt;/mechanism-configuration&gt;
      &lt;/http-authentication-factory&gt;
      ...
    &lt;/http&gt;
    ...
  &lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, to enable SPNEGO authentication for the HTTP management interface,
update this interface to reference the <code>http-authentication-factory</code>
defined above, as described in the
<a href="https://docs.jboss.org/author/display/WFLY/Migrate+Legacy+Security+to+Elytron+Security#MigrateLegacySecuritytoElytronSecurity-MigratedConfiguration">properties
authentication section</a>.</p>
</div>
<div class="paragraph">
<p>Alternatively, to secure an application using SPNEGO authentication, an
application security domain can be defined in the Undertow subsystem to
map security domains to the <code>http-authentication-factory</code> defined above,
as described in the
<a href="https://docs.jboss.org/author/display/WFLY/Migrate+Legacy+Security+to+Elytron+Security#MigrateLegacySecuritytoElytronSecurity-FullyMigratedConfiguration">properties
authentication section</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="remoting-sasl-authentication">Remoting / SASL Authentication</h3>
<div class="sect3">
<h4 id="legacy-security-realm-1">Legacy Security Realm</h4>
<div class="paragraph">
<p>It is also possible to define a legacy security realm for Kerberos /
GSSAPI SASL authenticatio for Remoting authentication such as the native
management interface.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">./core-service=management/security-realm=Kerberos:add
./core-service=management/security-realm=Kerberos/server-identity=kerberos:add
./core-service=management/security-realm=Kerberos/server-identity=kerberos/keytab=remote\/test-server.elytron.org@ELYTRON.ORG:add(path=/home/darranl/src/kerberos/remote-test-server.keytab, debug=true)
./core-service=management/security-realm=Kerberos/authentication=kerberos:add(remove-realm=true)</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">  &lt;management&gt;
    &lt;security-realms&gt;
      ...
      &lt;security-realm name="Kerberos"&gt;
        &lt;server-identities&gt;
          &lt;kerberos&gt;
            &lt;keytab principal="remote/test-server.elytron.org@ELYTRON.ORG" path="/home/darranl/src/kerberos/remote-test-server.keytab" debug="true"/&gt;
          &lt;/kerberos&gt;
        &lt;/server-identities&gt;
        &lt;authentication&gt;
          &lt;kerberos remove-realm="true"/&gt;
        &lt;/authentication&gt;
      &lt;/security-realm&gt;
    &lt;/security-realms&gt;
    ...
  &lt;/management&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="migrated-gssapi">Migrated GSSAPI</h4>
<div class="paragraph">
<p>The steps to define the equivalent Elytron configuration are very
similar to the HTTP example.</p>
</div>
<div class="paragraph">
<p>First define the security realm to load the identity from: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">./path=kerberos:add(relative-to=user.home, path=src/kerberos)
./subsystem=elytron/properties-realm=kerberos-properties:add(users-properties={path=kerberos-users.properties, relative-to=kerberos, digest-realm-name=ELYTRON.ORG}, groups-properties={path=kerberos-groups.properties, relative-to=kerberos})</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then define the Kerberos security factory for the server&#8217;s identity.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">./subsystem=elytron/kerberos-security-factory=test-server:add(relative-to=kerberos, path=remote-test-server.keytab, principal=remote/test-server.elytron.org@ELYTRON.ORG)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally define the security domain and this time a SASL authentication
factory.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">./subsystem=elytron/security-domain=KerberosDomain:add(default-realm=kerberos-properties, realms=[{realm=kerberos-properties, role-decoder=groups-to-roles}], permission-mapper=default-permission-mapper)
./subsystem=elytron/sasl-authentication-factory=gssapi-authentication-factory:add(security-domain=KerberosDomain, sasl-server-factory=elytron, mechanism-configurations=[{mechanism-name=GSSAPI, credential-security-factory=test-server}])</code></pre>
</div>
</div>
<div class="paragraph">
<p>This results in the following subsystem configuration: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">  &lt;subsystem xmlns="urn:wildfly:elytron:1.0" final-providers="combined-providers" disallowed-providers="OracleUcrypto"&gt;
    ...
    &lt;security-domains&gt;
      ...
      &lt;security-domain name="KerberosDomain" default-realm="kerberos-properties" permission-mapper="default-permission-mapper"&gt;
        &lt;realm name="kerberos-properties" role-decoder="groups-to-roles"/&gt;
      &lt;/security-domain&gt;
    &lt;/security-domains&gt;
    &lt;security-realms&gt;
     ...
       &lt;properties-realm name="kerberos-properties"&gt;
         &lt;users-properties path="kerberos-users.properties" relative-to="kerberos" digest-realm-name="ELYTRON.ORG"/&gt;
         &lt;groups-properties path="kerberos-groups.properties" relative-to="kerberos"/&gt;
       &lt;/properties-realm&gt;
     &lt;/security-realms&gt;
     &lt;credential-security-factories&gt;
       &lt;kerberos-security-factory name="test-server" principal="remote/test-server.elytron.org@ELYTRON.ORG" path="remote-test-server.keytab" relative-to="kerberos"/&gt;
     &lt;/credential-security-factories&gt;
     ...
     &lt;sasl&gt;
       ...
       &lt;sasl-authentication-factory name="gssapi-authentication-factory" sasl-server-factory="elytron" security-domain="KerberosDomain"&gt;
         &lt;mechanism-configuration&gt;
           &lt;mechanism mechanism-name="GSSAPI" credential-security-factory="test-server"/&gt;
         &lt;/mechanism-configuration&gt;
       &lt;/sasl-authentication-factory&gt;
       ...
     &lt;/sasl&gt;
   &lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The management interface or Remoting connectors can now be updated to
reference the SASL authentication factory.</p>
</div>
<div class="paragraph">
<p>The two Elytron examples defined here could also be combined into one to
use a shared security domain and security realm and just use protocol
specific authentication factories each referencing their own Kerberos
security factory.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Caching_Migration">Caching Migration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Where a PicketBox based security domain is defined it is possible to enable caching for that security domain, this enables subsequent hits to the identity store to be avoided as an in memory cache can be used instead, this example demonstrates how caching can be used with a WildFly Elytron based configuration.</p>
</div>
<div class="paragraph">
<p>The purpose of this chapter is to highlight the migration of a configuration with caching enabled, this example is based in the previous LDAP example but with caching enabled.</p>
</div>
<div class="sect2">
<h3 id="picketbox-example">PicketBox Example</h3>
<div class="paragraph">
<p>A PicketBox based security domain can be defined with the following commands.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">./subsystem=security/security-domain=application-security:add(cache-type=default)
./subsystem=security/security-domain=application-security/authentication=classic:add(login-modules=[{code=LdapExtended, flag=Required, module-options={ \
java.naming.factory.initial=com.sun.jndi.ldap.LdapCtxFactory, \
java.naming.provider.url=ldap://localhost:10389, \
java.naming.security.authentication=simple, \
bindDN="uid=admin,ou=system", \
bindCredential=secret, \
baseCtxDN="ou=users,dc=group-to-principal,dc=wildfly,dc=org", \
baseFilter="(uid={0})", \
rolesCtxDN="ou=groups,dc=group-to-principal,dc=wildfly,dc=org",\
roleFilter="(uniqueMember={1})", \
roleAttributeID="uid" \
}}])</code></pre>
</div>
</div>
<div class="paragraph">
<p>Resulting in the following security domain definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;subsystem xmlns="urn:jboss:domain:security:2.0"&gt;
  &lt;security-domains&gt;
    ...
    &lt;security-domain name="application-security" cache-type="default"&gt;
      &lt;authentication&gt;
        &lt;login-module code="LdapExtended" flag="required"&gt;
          &lt;module-option name="java.naming.factory.initial" value="com.sun.jndi.ldap.LdapCtxFactory"/&gt;
          &lt;module-option name="java.naming.provider.url" value="ldap://localhost:10389"/&gt;
          &lt;module-option name="java.naming.security.authentication" value="simple"/&gt;
          &lt;module-option name="bindDN" value="uid=admin,ou=system"/&gt;
          &lt;module-option name="bindCredential" value="secret"/&gt;
          &lt;module-option name="baseCtxDN" value="ou=users,dc=group-to-principal,dc=wildfly,dc=org"/&gt;
          &lt;module-option name="baseFilter" value="(uid={0})"/&gt;
          &lt;module-option name="rolesCtxDN" value="ou=groups,dc=group-to-principal,dc=wildfly,dc=org"/&gt;
          &lt;module-option name="roleFilter" value="(uniqueMember={1})"/&gt;
          &lt;module-option name="roleAttributeID" value="uid"/&gt;
        &lt;/login-module&gt;
      &lt;/authentication&gt;
    &lt;/security-domain&gt;
  &lt;/security-domains&gt;
&lt;/subsystem&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="migrated-example">Migrated Example</h3>
<div class="paragraph">
<p>When using WildFly Elytron where caching is required the individual security realm is wrapped using a cache, a migrated configuration can be defined with the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">./subsystem=elytron/dir-context=ldap-connection:add(url=ldap://localhost:10389, principal="uid=admin,ou=system", credential-reference={clear-text=secret})
./subsystem=elytron/ldap-realm=ldap-realm:add(dir-context=ldap-connection, \
direct-verification=true, \
identity-mapping={search-base-dn="ou=users,dc=group-to-principal,dc=wildfly,dc=org", \
rdn-identifier="uid", \
attribute-mapping=[{filter-base-dn="ou=groups,dc=group-to-principal,dc=wildfly,dc=org",filter="(uniqueMember={1})",from="uid",to="Roles"}]})
./subsystem=elytron/caching-realm=cached-ldap:add(realm=ldap-realm)</code></pre>
</div>
</div>
<div class="paragraph">
<p>These can then be used in a security domain and subsequently an authentication factory.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">./subsystem=elytron/security-domain=application-security:add(realms=[{realm=cached-ldap}], default-realm=cached-ldap, permission-mapper=default-permission-mapper)
./subsystem=elytron/http-authentication-factory=application-security-http:add(http-server-mechanism-factory=global, security-domain=application-security, mechanism-configurations=[{mechanism-name=BASIC}])</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this final step it is very important that the caching-realm is referenced rather than the original realm otherwise caching will be bypassed.</p>
</div>
<div class="paragraph">
<p>This results in the following definitions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;subsystem xmlns="urn:wildfly:elytron:1.1" final-providers="combined-providers" disallowed-providers="OracleUcrypto"&gt;
  ...
  &lt;security-domains&gt;
    ...
    &lt;security-domain name="application-security" default-realm="cached-ldap" permission-mapper="default-permission-mapper"&gt;
      &lt;realm name="cached-ldap"/&gt;
    &lt;/security-domain&gt;
  &lt;/security-domains&gt;
  &lt;security-realms&gt;
    ...
    &lt;ldap-realm name="ldap-realm" dir-context="ldap-connection" direct-verification="true"&gt;
      &lt;identity-mapping rdn-identifier="uid" search-base-dn="ou=users,dc=group-to-principal,dc=wildfly,dc=org"&gt;
        &lt;attribute-mapping&gt;
          &lt;attribute from="uid" to="Roles" filter="(uniqueMember={1})" filter-base-dn="ou=groups,dc=group-to-principal,dc=wildfly,dc=org"/&gt;
        &lt;/attribute-mapping&gt;
      &lt;/identity-mapping&gt;
    &lt;/ldap-realm&gt;
    &lt;caching-realm name="cached-ldap" realm="ldap-realm"/&gt;
  &lt;/security-realms&gt;
  ...
  &lt;http&gt;
    ...
    &lt;http-authentication-factory name="application-security-http" http-server-mechanism-factory="global" security-domain="application-security"&gt;
      &lt;mechanism-configuration&gt;
        &lt;mechanism mechanism-name="BASIC"/&gt;
      &lt;/mechanism-configuration&gt;
    &lt;/http-authentication-factory&gt;
    ...
  &lt;/http&gt;
  ...
  &lt;dir-contexts&gt;
    &lt;dir-context name="ldap-connection" url="ldap://localhost:10389" principal="uid=admin,ou=system"&gt;
      &lt;credential-reference clear-text="secret"/&gt;
    &lt;/dir-context&gt;
  &lt;/dir-contexts&gt;
&lt;/subsystem&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="clients">Clients</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="Application_Client_Migration">Application Client Migration</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="naming-client">Naming Client</h3>
<div class="paragraph">
<p>This migration example assumes a client application performs a remote
JNDI lookup using an ﻿﻿ <code>InitialContext</code> backed by the
<code>org.jboss.naming.remote.client.InitialContextFactory</code> class.</p>
</div>
<div class="sect3">
<h4 id="original-configuration">Original Configuration</h4>
<div class="paragraph">
<p>An <code>InitialContext</code> backed by the
<code>org.jboss.naming.remote.client.InitialContextFactory</code> class can be
created by specifying properties that contain the URL of the naming
provider to connect to along with appropriate user credentials:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Properties properties = new Properties();
properties.put(Context.INITIAL_CONTEXT_FACTORY, "org.jboss.naming.remote.client.InitialContextFactory");
properties.put(Context.PROVIDER_URL, "http-remoting://127.0.0.1:8080");
properties.put(Context.SECURITY_PRINCIPAL, "bob");
properties.put(Context.SECURITY_CREDENTIALS, "secret");
InitialContext context = new InitialContext(properties);
Bar bar = (Bar) context.lookup("foo/bar");
...</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="migrated-configuration">Migrated Configuration</h4>
<div class="paragraph">
<p>An <code>InitialContext</code> backed by the
<code>org.wildfly.naming.client.WildFlyInitialContextFactory</code> class can be
created by specifying a property that contains the URL of the naming
provider to connect to. The user credentials can be specified using a
WildFly client configuration file or programmatically.</p>
</div>
<div class="sect4">
<h5 id="configuration-file-approach">Configuration File Approach</h5>
<div class="paragraph">
<p>A <code>wildfly-config.xml</code> file that contains the user credentials to use
when establishing a connection to the naming provider can be added to
the client application&#8217;s <code>META-INF</code> directory:</p>
</div>
<div class="paragraph">
<p><strong>wildfly-config.xml</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;configuration&gt;
    &lt;authentication-client xmlns="urn:elytron:1.0"&gt;
        &lt;authentication-rules&gt;
            &lt;rule use-configuration="namingConfig"&gt;
                &lt;match-host name="127.0.0.1"/&gt;
            &lt;/rule&gt;
        &lt;/authentication-rules&gt;
        &lt;authentication-configurations&gt;
            &lt;configuration name="namingConfig"&gt;
                &lt;set-user-name name="bob"/&gt;
                &lt;credentials&gt;
                    &lt;clear-password password="secret"/&gt;
                &lt;/credentials&gt;
            &lt;/configuration&gt;
        &lt;/authentication-configurations&gt;
    &lt;/authentication-client&gt;
&lt;/configuration&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>An <code>InitialContext</code> can then be created as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Properties properties = new Properties();
properties.put(Context.INITIAL_CONTEXT_FACTORY, "org.wildfly.naming.client.WildFlyInitialContextFactory");
properties.put(Context.PROVIDER_URL, "remote+http://127.0.0.1:8080");
InitialContext context = new InitialContext(properties);
Bar bar = (Bar) context.lookup("foo/bar");
...</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="programmatic-approach">Programmatic Approach</h5>
<div class="paragraph">
<p>The user credentials to use when establishing a connection to the naming
provider can be specified directly in the client application&#8217;s code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">// create your authentication configuration
AuthenticationConfiguration namingConfig = AuthenticationConfiguration.empty().useName("bob").usePassword("secret");
 
// create your authentication context
AuthenticationContext context = AuthenticationContext.empty().with(MatchRule.ALL.matchHost("127.0.0.1"), namingConfig);
 
// create a callable that creates and uses an InitialContext
Callable&lt;Void&gt; callable = () -&gt; {
    Properties properties = new Properties();
    properties.put(Context.INITIAL_CONTEXT_FACTORY, "org.wildfly.naming.client.WildFlyInitialContextFactory");
    properties.put(Context.PROVIDER_URL, "remote+http://127.0.0.1:8080");
    InitialContext context = new InitialContext(properties);
    Bar bar = (Bar) context.lookup("foo/bar");
    ...
    return null;
};
 
// use your authentication context to run your callable
context.runCallable(callable);</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ejb-client">EJB Client</h3>
<div class="paragraph">
<p>This migration example assumes a client application is configured to
invoke an EJB deployed on a remote server using a
<code>jboss-ejb-client.properties</code> file.</p>
</div>
<div class="sect3">
<h4 id="original-configuration-1">Original Configuration</h4>
<div class="paragraph">
<p>A <code>jboss-ejb-client.properties</code> file that contains the information
needed to connect to the remote server can be specified in a client
application&#8217;s <code>META-INF</code> directory:</p>
</div>
<div class="paragraph">
<p><strong>jboss-ejb-client.properties</strong></p>
</div>
<div class="literalblock">
<div class="content">
<pre>remote.connectionprovider.create.options.org.xnio.Options.SSL_ENABLED=false
remote.connections=default
remote.connection.default.host=127.0.0.1
remote.connection.default.port = 8080
remote.connection.default.username=bob
remote.connection.default.password=secret</pre>
</div>
</div>
<div class="paragraph">
<p>An EJB can then be looked up and a method can be invoked on it as
follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">// create an InitialContext
Properties properties = new Properties();
properties.put(Context.INITIAL_CONTEXT_FACTORY, "org.jboss.naming.remote.client.InitialContextFactory");
properties.put(Context.URL_PKG_PREFIXES, "org.jboss.ejb.client.naming");
InitialContext context = new InitialContext(properties);
 
// look up an EJB and invoke one of its methods
RemoteCalculator statelessRemoteCalculator = (RemoteCalculator) context.lookup(
    "ejb:/ejb-remote-server-side//CalculatorBean!" + RemoteCalculator.class.getName());
int sum = statelessRemoteCalculator.add(101, 202);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="migrated-configuration-1">Migrated Configuration</h4>
<div class="paragraph">
<p>The information needed to connect to the remote server can be specified
using a WildFly client configuration file or programmatically.</p>
</div>
<div class="sect4">
<h5 id="configuration-file-approach-1">Configuration File Approach</h5>
<div class="paragraph">
<p>A <code>wildfly-config.xml</code> file that contains the information needed to
connect to the remote server can be added to the client application&#8217;s
<code>META-INF</code> directory:</p>
</div>
<div class="paragraph">
<p><strong>wildfly-config.xml</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;configuration&gt;
    &lt;authentication-client xmlns="urn:elytron:1.0"&gt;
        &lt;authentication-rules&gt;
            &lt;rule use-configuration="ejbConfig"&gt;
                &lt;match-host name="127.0.0.1"/&gt;
            &lt;/rule&gt;
        &lt;/authentication-rules&gt;
        &lt;authentication-configurations&gt;
            &lt;configuration name="ejbConfig"&gt;
                &lt;set-user-name name="bob"/&gt;
                &lt;credentials&gt;
                    &lt;clear-password password="secret"/&gt;
                &lt;/credentials&gt;
            &lt;/configuration&gt;
        &lt;/authentication-configurations&gt;
    &lt;/authentication-client&gt;
    &lt;jboss-ejb-client xmlns="urn:jboss:wildfly-client-ejb:3.0"&gt;
        &lt;connections&gt;
            &lt;connection uri="remote+http://127.0.0.1:8080" /&gt;
        &lt;/connections&gt;
    &lt;/jboss-ejb-client&gt;
&lt;/configuration&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>An EJB can then be looked up and a method can be invoked on it as
follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">// create an InitialContext
Properties properties = new Properties();
properties.put(Context.INITIAL_CONTEXT_FACTORY, "org.wildfly.naming.client.WildFlyInitialContextFactory");
InitialContext context = new InitialContext(properties);
 
// look up an EJB and invoke one of its methods (same as before)
RemoteCalculator statelessRemoteCalculator = (RemoteCalculator) context.lookup(
    "ejb:/ejb-remote-server-side//CalculatorBean!" + RemoteCalculator.class.getName());
int sum = statelessRemoteCalculator.add(101, 202);</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="programmatic-approach-1">Programmatic Approach</h5>
<div class="paragraph">
<p>The information needed to connect to the remote server can be specified
directly in the client application&#8217;s code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">// create your authentication configuration
AuthenticationConfiguration ejbConfig = AuthenticationConfiguration.empty().useName("bob").usePassword("secret");
 
// create your authentication context
AuthenticationContext context = AuthenticationContext.empty().with(MatchRule.ALL.matchHost("127.0.0.1"), ejbConfig);
 
// create a callable that invokes an EJB
Callable&lt;Void&gt; callable = () -&gt; {
 
    // create an InitialContext
    Properties properties = new Properties();
    properties.put(Context.INITIAL_CONTEXT_FACTORY, "org.wildfly.naming.client.WildFlyInitialContextFactory");
    properties.put(Context.PROVIDER_URL, "remote+http://127.0.0.1:8080");
    InitialContext context = new InitialContext(properties);
 
    // look up an EJB and invoke one of its methods (same as before)
    RemoteCalculator statelessRemoteCalculator = (RemoteCalculator) context.lookup(
        "ejb:/ejb-remote-server-side//CalculatorBean!" + RemoteCalculator.class.getName());
    int sum = statelessRemoteCalculator.add(101, 202);
    ...
    return null;
};
 
// use your authentication context to run your callable
context.runCallable(callable);</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="general-utilities">General Utilities</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="Security_Vault_Migration">Security Vault Migration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Security Vault is primarily used in legacy configurations, a vault is
used to store sensitive strings outside of the configuration files.
WildFly server may only contain a single security vault.</p>
</div>
<div class="paragraph">
<p>Credential Store introduced in WildFly 11 is meant to expand Security
Vault in terms of storing different credential types and introduce easy
to implemnent SPI which allows to deploy custom implemenations of
CredentialStore SPI. Credentials are stored safely encrypted in storage
file outside WildFly configuration files. Each WildFly server may
contain multiple credential stores.</p>
</div>
<div class="paragraph">
<p>To easily migrate vault content into credential store we have added
"vault" command into WildFly Elytron Tool. The tool could be found at
$JBOSS_HOME/bin directory. It has several scripts named "elytron-tool.*"
dependent on your platform of choice. One can use also simple form "java
-jar $JBOSS_HOME/bin/wildfly-elytron-tool.jar &lt;command&gt; &lt;arguments&gt;" if
it better suites ones needs.</p>
</div>
<div class="sect2">
<h3 id="single-security-vault-conversion">Single Security Vault Conversion</h3>
<div class="paragraph">
<p>To convert <strong>single</strong> security vault credential store use following
example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>to get sample vault use testing resources of Elytron Tool project from
<a href="https://github.com/wildfly-security/wildfly-elytron-tool/tree/master/src/test/resources/vault-v1">GitHub</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Command to run actual conversion:</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><code>./bin/elytron-tool.sh vault --enc-dir vault_data/ --keystore vault-jceks.keystore --keystore-password MASK-2hKo56F1a3jYGnJwhPmiF5 --iteration 34 --salt 12345678 --alias test --location cs-v1.store --summary</code></p>
</div>
</div>
</div>
<div class="paragraph">
<p>Output:</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><code>Vault (enc-dir="vault_data/";keystore="vault-jceks.keystore") converted to credential store "cs-v1.store"</code><br>
<code>Vault Conversion summary:</code><br>
<code>--------------------------------------</code><br>
<code>Vault Conversion Successful</code><br>
<code>CLI command to add new credential store:</code><br>
<code>/subsystem=elytron/credential-store=test:add(relative-to=jboss.server.data.dir,create=true,modifiable=true,location="cs-v1.store",implementation-properties={"keyStoreType"&#8658;"JCEKS"},credential-reference={clear-text="MASK-2hKo56F1a3jYGnJwhPmiF5;12345678;34"})</code></p>
</div>
</div>
</div>
<div class="paragraph">
<p>Use elytron-tool.sh vault --help to get description of all parameters.</p>
</div>
<div class="sect3">
<h4 id="notes">Notes:</h4>
<div class="ulist">
<ul>
<li>
<p>Elytron Tool cannot handle very first version of Security Vault data
file.<br></p>
</li>
<li>
<p>--keystore-password can come in two forms (1) masked as shown in the
example or (2) clear text. Parameter --salt and --iteration are there to
supply information to decrypt the masked password or to generate masked
password in output. In case --salt and --iteration are omitted default
values are used.<br></p>
</li>
<li>
<p>When --summary parameter is specified, one can see nice output with
CLI command to be used in WildFly console to add converted credential
store to the configuration.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="bulk-security-vault-conversion">Bulk Security Vault Conversion</h3>
<div class="paragraph">
<p>There is possibility to convert multiple vaults to credential store
using --bulk-convert parameter with description file.<br>
Example of description file from our <a href="https://github.com/wildfly-security/wildfly-elytron-tool/blob/master/src/test/java/org/wildfly/security/tool/VaultCommandTest.java">tests</a>:</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><code># Bulk conversion descriptor</code><br>
<code>keystore:target/test-classes/vault-v1/vault-jceks.keystore</code><br>
<code>keystore-password:MASK-2hKo56F1a3jYGnJwhPmiF5</code><br>
<code>enc-dir:target/test-classes/vault-v1/vault_data/</code><br>
<code>salt:12345678</code><br>
<code>iteration:34</code><br>
<code>location:target/v1-cs-1.store</code><br>
<code>alias:test</code></p>
</div>
<div class="paragraph">
<p><code>keystore:target/test-classes/vault-v1/vault-jceks.keystore</code><br>
<code>keystore-password:secretsecret</code><br>
<code>enc-dir:target/test-classes/vault-v1/vault_data/</code><br>
<code>location:target/v1-cs-2.store</code><br>
<code>alias:test</code></p>
</div>
<div class="paragraph">
<p><code># different vault vault-v1-more</code><br>
<code>keystore:target/test-classes/vault-v1-more/vault-jceks.keystore</code><br>
<code>keystore-password:MASK-2hKo56F1a3jYGnJwhPmiF5</code><br>
<code>enc-dir:target/test-classes/vault-v1-more/vault_data/</code><br>
<code>salt:12345678</code><br>
<code>iteration:34</code><br>
<code>location:target/v1-cs-more.store</code><br>
<code>alias:test</code></p>
</div>
</div>
</div>
<div class="paragraph">
<p>After each "keystore:" option new conversion starts. All options are
mandatory except "salt:", "iteration:" and "properties:"</p>
</div>
<div class="paragraph">
<p>Execute following command:</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><code>./bin/elytron-tool.sh vault --bulk-convert bulk-vault-conversion-desc --summary</code></p>
</div>
</div>
</div>
<div class="paragraph">
<p>Output:</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><code>Vault (enc-dir="vault-v1/vault_data/";keystore="vault-v1/vault-jceks.keystore") converted to credential store "v1-cs-1.store"</code><br>
<code>Vault Conversion summary:</code><br>
<code>--------------------------------------</code><br>
<code>Vault Conversion Successful</code><br>
<code>CLI command to add new credential store:</code><br>
<code>/subsystem=elytron/credential-store=test:add(relative-to=jboss.server.data.dir,create=true,modifiable=true,location="v1-cs-1.store",implementation-properties={"keyStoreType"&#8658;"JCEKS"},credential-reference={clear-text="MASK-2hKo56F1a3jYGnJwhPmiF5;12345678;34"})</code><br>
<code>--------------------------------------</code></p>
</div>
<div class="paragraph">
<p><code>Vault (enc-dir="vault-v1/vault_data/";keystore="vault-v1/vault-jceks.keystore") converted to credential store "v1-cs-2.store"</code><br>
<code>Vault Conversion summary:</code><br>
<code>--------------------------------------</code><br>
<code>Vault Conversion Successful</code><br>
<code>CLI command to add new credential store:</code><br>
<code>/subsystem=elytron/credential-store=test:add(relative-to=jboss.server.data.dir,create=true,modifiable=true,location="v1-cs-2.store",implementation-properties={"keyStoreType"&#8658;"JCEKS"},credential-reference={clear-text="secretsecret"})</code><br>
<code>--------------------------------------</code></p>
</div>
<div class="paragraph">
<p><code>Vault (enc-dir="vault-v1-more/vault_data/";keystore="vault-v1-more/vault-jceks.keystore") converted to credential store "v1-cs-more.store"</code><br>
<code>Vault Conversion summary:</code><br>
<code>--------------------------------------</code><br>
<code>Vault Conversion Successful</code><br>
<code>CLI command to add new credential store:</code><br>
<code>/subsystem=elytron/credential-store=test:add(relative-to=jboss.server.data.dir,create=true,modifiable=true,location="v1-cs-more.store",implementation-properties={"keyStoreType"&#8658;"JCEKS"},credential-reference={clear-text="MASK-2hKo56F1a3jYGnJwhPmiF5;12345678;34"})</code><br>
<code>--------------------------------------</code></p>
</div>
</div>
</div>
<div class="paragraph">
<p>The result is conversion of all vaults with proper CLI commands.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Security_Property_Migration">Security Properties</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Lets suppose security properties "a" and "c" defined in legacy security:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">        &lt;subsystem xmlns="urn:jboss:domain:security:2.0"&gt;
            ...
            &lt;security-properties&gt;
                &lt;property name="a" value="b" /&gt;
                &lt;property name="c" value="d" /&gt;
            &lt;/security-properties&gt;
        &lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>To define security properties in Elytron subsystem you need to set
attribute <code>security-properties</code> of the subsystem:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">./subsystem=elytron:write-attribute(name=security-properties, value={ \
    a = "b", \
    c = "d" \
})</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also add or change one another property without modification of
others using map operations. Following command will set property "e":</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">./subsystem=elytron:map-put(name=security-properties, key=e, value=f)</code></pre>
</div>
</div>
<div class="paragraph">
<p>By the same way you can also remove one of properties - in example newly
created property "e":</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">./subsystem=elytron:map-remove(name=security-properties, key=e)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Output XML configuration will be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">        &lt;subsystem xmlns="urn:wildfly:elytron:1.0" final-providers="combined-providers" disallowed-providers="OracleUcrypto"&gt;
            &lt;security-properties&gt;
                &lt;security-property name="a" value="b"/&gt;
                &lt;security-property name="c" value="d"/&gt;
            &lt;/security-properties&gt;
            ...
        &lt;/subsystem&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ssl-migration">SSL Migration</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="Simple_SSL_Migration">Simple SSL Migration</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="simple-ssl-migration">Simple SSL Migration</h3>
<div class="paragraph">
<p>This section describe securing HTTP connections to the server using SSL
using Elytron.<br>
It suppose you have already configured SSL using legacy
<code>security-realm</code>, for example by
<a href="Admin_Guide.html#src-557075_AdminGuide-EnableSSL">Admin Guide#Enable
SSL</a>, and your configuration looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;security-realm name="ApplicationRealm"&gt;
  &lt;server-identities&gt;
    &lt;ssl&gt;
      &lt;keystore path="server.keystore" relative-to="jboss.server.config.dir" keystore-password="keystore_password" alias="server" key-password="key_password" /&gt;
    &lt;/ssl&gt;
  &lt;/server-identities&gt;
&lt;/security-realm&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>To switch to Elytron you need to:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create Elytron <code>key-store</code> - specifying where is the keystore file
stored and password by which it is encrypted. Default type of keystore
generated using keytool is JKS:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">/subsystem=elytron/key-store=LocalhostKeyStore:add(path=server.keystore,relative-to=jboss.server.config.dir,credential-reference={clear-text="keystore_password"},type=JKS)</code></pre>
</div>
</div>
</li>
<li>
<p>Create Elytron <code>key-manager</code> - specifying keystore, alias (using
<code>alias-filter</code>) and password of key:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">/subsystem=elytron/key-manager=LocalhostKeyManager:add(key-store=LocalhostKeyStore,alias-filter=server,credential-reference={clear-text="key_password"})</code></pre>
</div>
</div>
</li>
<li>
<p>Create Elytron <code>server-ssl-context</code> - specifying only reference to
<code>key-manager</code> defined above:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">/subsystem=elytron/server-ssl-context=LocalhostSslContext:add(key-manager=LocalhostKeyManager)</code></pre>
</div>
</div>
</li>
<li>
<p>Switch <code>https-listener</code> from legacy <code>security-realm</code> to newly
created Elytron <code>ssl-context</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">/subsystem=undertow/server=default-server/https-listener=https:undefine-attribute(name=security-realm)
/subsystem=undertow/server=default-server/https-listener=https:write-attribute(name=ssl-context,value=LocalhostSslContext)</code></pre>
</div>
</div>
</li>
<li>
<p>And reload the server:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">reload</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Output XML configuration of Elytron subsystem should look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">        &lt;subsystem xmlns="urn:wildfly:elytron:1.0" ...&gt;
            ...
            &lt;tls&gt;
                &lt;key-stores&gt;
                    &lt;key-store name="LocalhostKeyStore"&gt;
                        &lt;credential-reference clear-text="keystore_password"/&gt;
                        &lt;implementation type="JKS"/&gt;
                        &lt;file path="server.keystore" relative-to="jboss.server.config.dir"/&gt;
                    &lt;/key-store&gt;
                &lt;/key-stores&gt;
                &lt;key-managers&gt;
                    &lt;key-manager name="LocalhostKeyManager" key-store="LocalhostKeyStore"&gt;
                        &lt;credential-reference clear-text="key_password"/&gt;
                    &lt;/key-manager&gt;
                &lt;/key-managers&gt;
                &lt;server-ssl-contexts&gt;
                    &lt;server-ssl-context name="LocalhostSslContext" key-manager="LocalhostKeyManager"/&gt;
                &lt;/server-ssl-contexts&gt;
            &lt;/tls&gt;
        &lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Output <code>https-listener</code> in Undertow subsystem should be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;https-listener name="https" socket-binding="https" ssl-context="LocalhostSslContext" enable-http2="true"/&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="client-cert-ssl-authentication-migration">Client-Cert SSL Authentication Migration</h3>
<div class="paragraph">
<p>This suppose you have already configured Client-Cert SSL authentication
using <code>truststore</code> in legacy <code>security-realm</code>, for example by
<a href="Admin_Guide.html#src-557075_AdminGuide-AddClient-CerttoSSL">Admin
Guide#Add Client-Cert to SSL</a>, and your configuration looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;security-realm name="ApplicationRealm"&gt;
  &lt;server-identities&gt;
    &lt;ssl&gt;
      &lt;keystore path="server.keystore" relative-to="jboss.server.config.dir" keystore-password="keystore_password" alias="server" key-password="key_password" /&gt;
    &lt;/ssl&gt;
  &lt;/server-identities&gt;
  &lt;authentication&gt;
    &lt;truststore path="server.truststore" relative-to="jboss.server.config.dir" keystore-password="truststore_password" /&gt;
    &lt;local default-user="$local"/&gt;
    &lt;properties path="application-users.properties" relative-to="jboss.server.config.dir"/&gt;
  &lt;/authentication&gt;
&lt;/security-realm&gt;</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Following configuration is sufficient to prevent users without valid
certificate and private key to access the server, but it does not
provide user identity to the application. That require to define
<code>CLIENT_CERT</code> HTTP mechanism / <code>EXTERNAL</code> SASL mechanism, which will be
described later.)
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>At first use steps above to migrate basic part of the configuration.
Then continue by following:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create <code>key-store</code> of truststore - like for keystore above:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">/subsystem=elytron/key-store=TrustStore:add(path=server.truststore,relative-to=jboss.server.config.dir,credential-reference={clear-text="truststore_password"},type=JKS)</code></pre>
</div>
</div>
</li>
<li>
<p>Create <code>trust-manager</code> - specifying <code>key-store</code> of trustore, created
above:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">/subsystem=elytron/trust-manager=TrustManager:add(key-store=TrustStore)</code></pre>
</div>
</div>
</li>
<li>
<p>Modify <code>server-ssl-context</code> to use newly created trustmanager:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">/subsystem=elytron/server-ssl-context=LocalhostSslContext:write-attribute(name=trust-manager,value=TrustManager)</code></pre>
</div>
</div>
</li>
<li>
<p>Enable client authentication for <code>server-ssl-context</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">/subsystem=elytron/server-ssl-context=LocalhostSslContext:write-attribute(name=need-client-auth,value=true)</code></pre>
</div>
</div>
</li>
<li>
<p>And reload the server:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">reload</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Output XML configuration of Elytron subsystem should look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;subsystem xmlns="urn:wildfly:elytron:1.0" ...&gt;
    ...
    &lt;tls&gt;
        &lt;key-stores&gt;
            &lt;key-store name="LocalhostKeyStore"&gt;
                &lt;credential-reference clear-text="keystore_password"/&gt;
                &lt;implementation type="JKS"/&gt;
                &lt;file path="server.keystore" relative-to="jboss.server.config.dir"/&gt;
            &lt;/key-store&gt;
            &lt;key-store name="TrustStore"&gt;
                &lt;credential-reference clear-text="truststore_password"/&gt;
                &lt;implementation type="JKS"/&gt;
                &lt;file path="server.truststore" relative-to="jboss.server.config.dir"/&gt;
            &lt;/key-store&gt;
        &lt;/key-stores&gt;
        &lt;key-managers&gt;
            &lt;key-manager name="LocalhostKeyManager" key-store="LocalhostKeyStore" alias-filter="server"&gt;
                &lt;credential-reference clear-text="key_password"/&gt;
            &lt;/key-manager&gt;
        &lt;/key-managers&gt;
        &lt;trust-managers&gt;
            &lt;trust-manager name="TrustManager" key-store="TrustStore"/&gt;
        &lt;/trust-managers&gt;
        &lt;server-ssl-contexts&gt;
            &lt;server-ssl-context name="LocalhostSslContext" need-client-auth="true" key-manager="LocalhostKeyManager" trust-manager="TrustManager"/&gt;
        &lt;/server-ssl-contexts&gt;
    &lt;/tls&gt;
&lt;/subsystem&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="SSL_with_Client_Cert_Migration">SSL with Client Cert Migration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As this documentation is primarily intended for users migrating to WildFly Elytron I am going to jump straight into the configuration required with WildFly Elytron.</p>
</div>
<div class="paragraph">
<p>This section will cover how to create the various resources required to achieve CLIENT_CERT authentication with fallback to username / password authentication for both HTTP and SASL (i.e. Remoting) - both are being covered at the same time as predominantly they require the same core configuration, it is not until the definition of the authentication factories that the configuration becomes really specific.</p>
</div>
<div class="paragraph">
<p>The WildFly Elytron project already contains a dummy certificate authority set up that we use for testing, the KeyStores within this documentation are from the dummy certificate authority although for anything other than testing these should be replaced with your own.</p>
</div>
<div class="paragraph">
<p>As a first step we define some paths that point to the wildfly-elytron project so we can use these in the subsequent configuration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">./subsystem=security/security-domain=application-security:add
./subsystem=security/security-domain=application-security/authentication=classic:add(login-modules=[{code=UsersRoles, flag=Required, module-options={usersProperties=file://${jboss.server.config.dir}/example-users.properties, rolesProperties=file://${jboss.server.config.dir}/example-roles.properties}}])</code></pre>
</div>
</div>
<div class="paragraph">
<p>This results in the following configuration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;paths&gt;
  &lt;path name="elytron.project" path="/home/darranl/src/wildfly10/wildfly-elytron"/&gt;
  &lt;path name="elytron.project.jks" path="src/test/resources/ca/jks" relative-to="elytron.project"/&gt;
  &lt;path name="elytron.project.properties" path="src/test/resources/org/wildfly/security/auth/realm" relative-to="elytron.project"/&gt;
&lt;/paths&gt;</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="keystores-keymanagers-and-trustmanagers">KeyStores, KeyManagers, and TrustManagers.</h3>
<div class="paragraph">
<p>The next step is to define the KeyStore resources, for this example three different keystores are used: -</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">localhost.keystore</dt>
<dd>
<p>Contains the servers key and certificate for 'localhost'.</p>
</dd>
<dt class="hdlist1">beetles.keystore</dt>
<dd>
<p>Contains the individual client certificates.</p>
</dd>
<dt class="hdlist1">ca.keystore</dt>
<dd>
<p>Contains the certificate of the certificate authority.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>When we define the overall configuration we will use the localhost keystore along with the ca keystore for the incoming connections so initially all client certificates signed by the certificate authority will be accepted and subsequently a security realm will check it against the actual certificates within beetles keystore.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">./subsystem=elytron/key-store=localhost:add(type=jks, relative-to=elytron.project.jks, path=localhost.keystore, credential-reference={clear-text=Elytron})
./subsystem=elytron/key-store=beetles:add(type=jks, relative-to=elytron.project.jks, path=beetles.keystore, credential-reference={clear-text=Elytron})
./subsystem=elytron/key-store=ca:add(type=jks, relative-to=elytron.project.jks, path=ca.truststore, credential-reference={clear-text=Elytron})</code></pre>
</div>
</div>
<div class="paragraph">
<p>This results in the following configuration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;subsystem xmlns="urn:wildfly:elytron:1.1" final-providers="combined-providers" disallowed-providers="OracleUcrypto"&gt;
  ...
  &lt;tls&gt;
    &lt;key-stores&gt;
      &lt;key-store name="localhost"&gt;
        &lt;credential-reference clear-text="Elytron"/&gt;
        &lt;implementation type="jks"/&gt;
        &lt;file path="localhost.keystore" relative-to="elytron.project.jks"/&gt;
      &lt;/key-store&gt;
      &lt;key-store name="beetles"&gt;
        &lt;credential-reference clear-text="Elytron"/&gt;
        &lt;implementation type="jks"/&gt;
        &lt;file path="beetles.keystore" relative-to="elytron.project.jks"/&gt;
      &lt;/key-store&gt;
      &lt;key-store name="ca"&gt;
        &lt;credential-reference clear-text="Elytron"/&gt;
        &lt;implementation type="jks"/&gt;
        &lt;file path="ca.truststore" relative-to="elytron.project.jks"/&gt;
      &lt;/key-store&gt;
    &lt;/key-stores&gt;
  &lt;/tls&gt;
&lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next the key and trust manager resources will be defined using these keystores.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">./subsystem=elytron/key-manager=localhost-manager:add(algorithm=SunX509, key-store=localhost, credential-reference={clear-text=Elytron})
./subsystem=elytron/trust-manager=ca-manager:add(algorithm=SunX509, key-store=ca)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Resulting in:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;subsystem xmlns="urn:wildfly:elytron:1.1" final-providers="combined-providers" disallowed-providers="OracleUcrypto"&gt;
  ...
  &lt;tls&gt;
   ...
     &lt;key-managers&gt;
       &lt;key-manager name="localhost-manager" algorithm="SunX509" key-store="localhost"&gt;
         &lt;credential-reference clear-text="Elytron"/&gt;
       &lt;/key-manager&gt;
     &lt;/key-managers&gt;
     &lt;trust-managers&gt;
       &lt;trust-manager name="ca-manager" algorithm="SunX509" key-store="ca"/&gt;
     &lt;/trust-managers&gt;
  &lt;/tls&gt;
&lt;/subsystem&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="realms-and-domains">Realms and Domains</h3>
<div class="paragraph">
<p>Two security realms are now defined, one of these uses properties files from within the WildFly Elytron project to support username/password authentication and the other using the clients certificates for verification.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">./subsystem=elytron/properties-realm=test-users:add(users-properties={relative-to=elytron.project.properties, path=clear.properties, plain-text=true, digest-realm-name=ManagementRealm}, groups-properties={relative-to=elytron.project.properties, path=groups.properties})
./subsystem=elytron/key-store-realm=key-store-realm:add(key-store=beetles)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Resulting in:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;subsystem xmlns="urn:wildfly:elytron:1.1" final-providers="combined-providers" disallowed-providers="OracleUcrypto"&gt;
  ...
  &lt;security-realms&gt;
    ...
    &lt;key-store-realm name="key-store-realm" key-store="beetles"/&gt;
    ...
    &lt;properties-realm name="test-users"&gt;
      &lt;users-properties path="clear.properties" relative-to="elytron.project.properties" digest-realm-name="ManagementRealm" plain-text="true"/&gt;
      &lt;groups-properties path="groups.properties" relative-to="elytron.project.properties"/&gt;
    &lt;/properties-realm&gt;
  &lt;/security-realms&gt;
  ...
&lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>These security realms can now be referenced from a security domain:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">./subsystem=elytron/security-domain=client-cert-domain:add(realms=[{realm=test-users},{realm=key-store-realm}], \
  default-realm=test-users, \
  permission-mapper=default-permission-mapper)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Resulting in:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;subsystem xmlns="urn:wildfly:elytron:1.1" final-providers="combined-providers" disallowed-providers="OracleUcrypto"&gt;
  ...
  &lt;security-domains&gt;
    ...
    &lt;security-domain name="client-cert-domain" default-realm="test-users" permission-mapper="default-permission-mapper"&gt;
      &lt;realm name="test-users"/&gt;
      &lt;realm name="key-store-realm"/&gt;
    &lt;/security-domain&gt;
  &lt;/security-domains&gt;
  ...
&lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Before moving onto the individual authentication factories a couple of additional utility resources are also required: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre>./subsystem=elytron/constant-realm-mapper=key-store-realm:add(realm-name=key-store-realm)
./subsystem=elytron/x500-attribute-principal-decoder=x500-decoder:add(attribute-name=CN, maximum-segments=1)</pre>
</div>
</div>
<div class="paragraph">
<p>Resulting in: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;subsystem xmlns="urn:wildfly:elytron:1.1" final-providers="combined-providers" disallowed-providers="OracleUcrypto"&gt;
  ...
  &lt;mappers&gt;
    ...
    &lt;x500-attribute-principal-decoder name="x500-decoder" attribute-name="CN" maximum-segments="1"/&gt;
    ...
    &lt;constant-realm-mapper name="key-store-realm" realm-name="key-store-realm"/&gt;
    ...
  &lt;/mappers&gt;
  ...
&lt;/subsystem&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="http-authentication-factory">HTTP Authentication Factory</h3>
<div class="paragraph">
<p>For the HTTP connections we now define a HTTP authentication factory using the previously defined resources and it is configured to support CLIENT_CERT and DIGEST authentication.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>./subsystem=elytron/http-authentication-factory=client-cert-digest:add(http-server-mechanism-factory=global, \
  security-domain=client-cert-domain, \
 mechanism-configurations=[{ \
  mechanism-name=CLIENT_CERT, \
  realm-mapper=key-store-realm, \
  pre-realm-principal-transformer=x500-decoder}, \
 {mechanism-name=DIGEST, mechanism-realm-configurations=[{realm-name=ManagementRealm}]}])</pre>
</div>
</div>
<div class="paragraph">
<p>Resulting in: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&lt;subsystem xmlns="urn:wildfly:elytron:1.1" final-providers="combined-providers" disallowed-providers="OracleUcrypto"&gt;
  ...
  &lt;http&gt;
    ...
    &lt;http-authentication-factory name="client-cert-digest" http-server-mechanism-factory="global" security-domain="client-cert-domain"&gt;
      &lt;mechanism-configuration&gt;
        &lt;mechanism mechanism-name="CLIENT_CERT" pre-realm-principal-transformer="x500-decoder" realm-mapper="key-store-realm"/&gt;
        &lt;mechanism mechanism-name="DIGEST"&gt;
          &lt;mechanism-realm realm-name="ManagementRealm"/&gt;
        &lt;/mechanism&gt;
      &lt;/mechanism-configuration&gt;
    &lt;/http-authentication-factory&gt;
    ...
  &lt;/http&gt;
  ...
&lt;/subsystem&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>Where DIGEST authentication is used we rely on the default configuration within the security domain to select the 'test-users' realm, however where CLIENT_CERT authentication is in use an alternative realm-mapper is referenced to ensure the 'key-store-realm' is used.</p>
</div>
<div class="paragraph">
<p>Additionally for CLIENT_CERT authentication a principal-transformer is referenced to extract the CN attribute from the distinguished name of the client certificate and use this when accessing the identity from the security realm.</p>
</div>
</div>
<div class="sect2">
<h3 id="sasl-authentication-factory">SASL Authentication Factory</h3>
<div class="paragraph">
<p>The architecture of the two authentication factories if very similar so a SASL authentication factory can be defined in the same way as the HTTP equivalent.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>./subsystem=elytron/sasl-authentication-factory=client-cert-digest:add(sasl-server-factory=elytron, \
  security-domain=client-cert-domain, \
  mechanism-configurations=[{mechanism-name=EXTERNAL, \
  realm-mapper=key-store-realm, \
  pre-realm-principal-transformer=x500-decoder}, \
  {mechanism-name=DIGEST-MD5, mechanism-realm-configurations=[{realm-name=ManagementRealm}]}])</pre>
</div>
</div>
<div class="paragraph">
<p>This results in: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;subsystem xmlns="urn:wildfly:elytron:1.1" final-providers="combined-providers" disallowed-providers="OracleUcrypto"&gt;
  ...
  &lt;sasl&gt;
    ...
    &lt;sasl-authentication-factory name="client-cert-digest" sasl-server-factory="elytron" security-domain="client-cert-domain"&gt;
      &lt;mechanism-configuration&gt;
        &lt;mechanism mechanism-name="EXTERNAL" pre-realm-principal-transformer="x500-decoder" realm-mapper="key-store-realm"/&gt;
        &lt;mechanism mechanism-name="DIGEST-MD5"&gt;
          &lt;mechanism-realm realm-name="ManagementRealm"/&gt;
        &lt;/mechanism&gt;
      &lt;/mechanism-configuration&gt;
    &lt;/sasl-authentication-factory&gt;
    ...
  &lt;/sasl&gt;
  ...
&lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Realm mappers and principal transformers are defined in the same way as were defined for HTTP.</p>
</div>
</div>
<div class="sect2">
<h3 id="ssl-context">SSL Context</h3>
<div class="paragraph">
<p>An SSL context is also defined for use by the server.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>./subsystem=elytron/server-ssl-context=localhost:add(key-manager=localhost-manager, trust-manager=ca-manager, \
  security-domain=client-cert-domain, \
  authentication-optional=true, \
  want-client-auth=true, \
  need-client-auth=false)</pre>
</div>
</div>
<div class="paragraph">
<p>Resulting in: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;subsystem xmlns="urn:wildfly:elytron:1.1" final-providers="combined-providers" disallowed-providers="OracleUcrypto"&gt;
  ...
  &lt;tls&gt;
    ...
    &lt;server-ssl-contexts&gt;
      &lt;server-ssl-context name="localhost" security-domain="client-cert-domain" want-client-auth="true" need-client-auth="false" authentication-optional="true" key-manager="localhost-manager" trust-manager="ca-manager"/&gt;
    &lt;/server-ssl-contexts&gt;
  &lt;/tls&gt;
&lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As we will be supporting fallback to username/password authentication need-client-auth is set to false as well as authentication-optional being set to false, this allows connections to be established but an alternative form of authentication will be required.</p>
</div>
</div>
<div class="sect2">
<h3 id="using-for-management">Using for Management</h3>
<div class="paragraph">
<p>At this point the management interfaces can be updated to use the newly defined resources, we need to add references to the two new authentication factories and the SSL context, we can also remove the existing reference to the legacy security realm. As this is modifying existing interfaces a server reload will also be required.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>./core-service=management/management-interface=http-interface:write-attribute(name=ssl-context, value=localhost)
./core-service=management/management-interface=http-interface:write-attribute(name=secure-socket-binding, value=management-https)
./core-service=management/management-interface=http-interface:write-attribute(name=http-authentication-factory, value=client-cert-digest)
./core-service=management/management-interface=http-interface:write-attribute(name=http-upgrade.sasl-authentication-factory, value=client-cert-digest)
./core-service=management/management-interface=http-interface:undefine-attribute(name=security-realm)
:reload</pre>
</div>
</div>
<div class="paragraph">
<p>The management interface configuration then becomes: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;management&gt;
  ...
  &lt;management-interfaces&gt;
    &lt;http-interface http-authentication-factory="client-cert-digest" ssl-context="localhost"&gt;
      &lt;http-upgrade enabled="true" sasl-authentication-factory="client-cert-digest"/&gt;
      &lt;socket-binding http="management-http" https="management-https"/&gt;
    &lt;/http-interface&gt;
  &lt;/management-interfaces&gt;
  ...
&lt;/management&gt;</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="admin-clients">Admin Clients</h4>
<div class="paragraph">
<p>At this stage assuming the same files have been used as in this example it should be possible to connect to the management interface of the server either using a web browser or the JBoss CLI with the username elytron and password passwd12#$</p>
</div>
<div class="paragraph">
<p>For certificate based authentication the keys and certificates from the WildFly Elytron tests can be used, these are found in JKS keystores under 'src/test/resources/ca/jks', these keystores have a password of Elytron.</p>
</div>
<div class="sect4">
<h5 id="web-browser-configuration">Web Browser Configuration</h5>
<div class="paragraph">
<p>A PKCS#12 file can be created from the test keystores,this can then be imported into the web browser to use when connecting to the server.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>keytool -importkeystore -srckeystore ladybird.keystore \
  -destkeystore ladybird.pkcs12 \
  -srcstoretype jks \
  -deststoretype pkcs12 \
  -deststorepass Elytron \
  -srcalias ladybird \
  -destalias ladybird</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="cli-configuration">CLI Configuration</h5>
<div class="paragraph">
<p>Since the integration of WildFly Elytron it is possible with the CLI to use a configuration file wildfly-config.xml to define the security settings including the settings for the client side SSL context.</p>
</div>
<div class="paragraph">
<p>For the purpose of this example copy the ladybird,keystore and ca.truststore from the Wildfly Elytron testsuite to the location the JBoss CLI is being started from, the following wildfly-config.xml can be created in this location as well: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;

&lt;configuration&gt;
    &lt;authentication-client xmlns="urn:elytron:1.0"&gt;
        &lt;key-stores&gt;
            &lt;key-store name="ladybird" type="jks" &gt;
                &lt;file name="ladybird.keystore"/&gt;
                &lt;key-store-clear-password password="Elytron" /&gt;
            &lt;/key-store&gt;
            &lt;key-store name="ca" type="jks"&gt;
                &lt;file name="ca.truststore"/&gt;
                &lt;key-store-clear-password password="Elytron" /&gt;
            &lt;/key-store&gt;
        &lt;/key-stores&gt;
        &lt;ssl-context-rules&gt;
            &lt;rule use-ssl-context="default" /&gt;
        &lt;/ssl-context-rules&gt;
        &lt;ssl-contexts&gt;
            &lt;ssl-context name="default"&gt;
                &lt;key-store-ssl-certificate key-store-name="ladybird" alias="ladybird"&gt;
                    &lt;key-store-clear-password password="Elytron" /&gt;
                &lt;/key-store-ssl-certificate&gt;
                &lt;trust-store key-store-name="ca" /&gt;
            &lt;/ssl-context&gt;
        &lt;/ssl-contexts&gt;
    &lt;/authentication-client&gt;
&lt;/configuration&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The CLI can now be started using the following command: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre>./jboss-cli.sh -c -Dwildfly.config.url=wildfly-config.xml</pre>
</div>
</div>
<div class="paragraph">
<p>The :whoami command can be used within the CLI to double check the current identity.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[standalone@localhost:9993 /] :whoami(verbose=true)
{
    "outcome" =&gt; "success",
    "result" =&gt; {
        "identity" =&gt; {"username" =&gt; "Ladybird"},
        "mapped-roles" =&gt; ["SuperUser"]
    }
}</pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="documentation-still-needed">Documentation Still Needed</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>How to migrate application which uses different identity store for
authentication and authorization (migration to Elytron aggregate-realm).</p>
</li>
<li>
<p>How migrate to using cache (migration to caching-realm)</p>
</li>
<li>
<p>Limitations for migration from PicketBox/legacy security to Elytron,
for example, Infinispan cache cannot be used, any others?</p>
</li>
</ul>
</div>
</div>
</div>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/wildflysite/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Wildfly</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Wildfly</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/wildfly"><svg class="svg-icon"><use xlink:href="/wildflysite/assets/minima-social-icons.svg#github"></use></svg> <span class="username">wildfly</span></a></li><li><a href="https://www.twitter.com/WildFlyAS"><svg class="svg-icon"><use xlink:href="/wildflysite/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">WildFlyAS</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p></p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
