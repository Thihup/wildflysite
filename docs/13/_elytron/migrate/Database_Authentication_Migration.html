<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <link rel="shortcut icon" type="image/png" href="/wildflysite/favicon.ico" >
  <link rel="stylesheet" href="/wildflysite/assets/css/main.css" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">


</head>

<body class="Database Authentication">
  <div class="header-banner">
  <p>This site is in beta. Please share feedback by creating an <a href="https://github.com/jbossorg/wildflysite/issues/new" target="_blank">issue ticket</a>.</p>
</div>

  <div class="content">
    <div class="header navigation">
  <div class="logo-wrapper">
    <a href="/wildflysite/"><img class="wf-logo" src="/wildflysite/assets/img/wildfly_icons_one-color-logo.png"></a>
  </div>
  <div class="nav-container">
    <nav>
      <div class="nav-mobile"><a id="nav-toggle" href="#!"><span></span></a></div>
      <ul class="nav-list">
        <li>
          <a href="/wildflysite/" class="">Home</a>
        </li>
        <li>
          <a href="/wildflysite/downloads/" class="">Downloads</a>
        </li>
        <li>
          <a href="/wildflysite/blog/" class="">Blog</a>
        </li>
        <li>
          <a href="/wildflysite/about/" class="">About</a>
        </li>
        <li>
          <a href="/wildflysite/contribute/" class="">Contribute</a>
        </li>
        <li>
          
            <a href="/wildflysite/docs/14/" class="active">Docs</a>
          
        </li>
        <li>
          <a class="button-cta secondary" href="https://github.com/wildfly/wildfly/fork" target="_blank">Fork</a>
        </li>
      </ul>
    </nav>
  </div>
</div>

    <div class="docs-page grid-wrapper">
  <div class="grid__item width-12-12 docs-v-icons">
    <a href="/wildflysite/docs/14/" ><img src="/wildflysite/assets/img/docs/wildfly_icons_docs-14-inactive.png"></a>
    <a href="/wildflysite/docs/13/" ><img src="/wildflysite/assets/img/docs/wildfly_icons_docs-13-active.png"></a>
    <a href="https://docs.wildfly.org/12/" target="_blank"><img src="/wildflysite/assets/img/docs/wildfly_icons_docs-12-inactive.png"></a>
    <img src="/wildflysite/assets/img/docs/wildfly_icons_docs-11-coming.png">
    <img src="/wildflysite/assets/img/docs/wildfly_icons_docs-10-coming.png">
    <img src="/wildflysite/assets/img/docs/wildfly_icons_docs-09-coming.png">
    <img src="/wildflysite/assets/img/docs/wildfly_icons_docs-08-coming.png">
  </div>
  <div class="grid__item width-12-12"><h1 class="title">Database Authentication</h1></div>
  <div class="grid__item width-3-12 doc-toc"><ul class="inline_toc">
  <li><a href="#picketbox-database-loginmodule">PicketBox Database LoginModule</a></li>
  <li><a href="#migrated">Migrated</a></li>
  <li><a href="#n-m-relation-beetween-user-and-roles">N-M relation beetween user and roles</a></li>
</ul></div>
  <div class="grid__item width-9-12 doc-content"><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The section describing how to migrate from database accessible via JDBC
datasource based authentication using PicketBox to Elytron. This section
will illustrate some equivalent configuration using PicketBox security
domains and show the equivalent configuration using Elytron but will not
repeat the steps to wire it all together covered in the previous
sections.</p>
</div>
<div class="paragraph">
<p>These configuration examples are developed against a test database with
users table like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">CREATE TABLE User (
    id BIGINT NOT NULL,
    username VARCHAR(255),
    password VARCHAR(255),
    role ENUM('admin', 'manager', 'user'),
    PRIMARY KEY (id),
    UNIQUE (username)
)</code></pre>
</div>
</div>
<div class="paragraph">
<p>For authentication purposes the username will be matched against the '
`username&#8217; column, password will be expected in hex-encoded MD5 hash in
' `password&#8217; column. User role for authorization purposes will be taken
from ' `role&#8217; column.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="picketbox-database-loginmodule">PicketBox Database LoginModule</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following commands can create a PicketBox security domain configured
to use database accessible via JDBC datasource to verify a username and
password and to assign roles.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">./subsystem=security/security-domain=application-security/:add
./subsystem=security/security-domain=application-security/authentication=classic:add(login-modules=[{code=Database, flag=Required, module-options={ \
    dsJndiName="java:jboss/datasources/ExampleDS", \
    principalsQuery="SELECT password FROM User WHERE username = ?", \
    rolesQuery="SELECT role, 'Roles' FROM User WHERE username = ?", \
    hashAlgorithm=MD5, \
    hashEncoding=base64 \
}}])</code></pre>
</div>
</div>
<div class="paragraph">
<p>This results in the following configuration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">        &lt;subsystem xmlns="urn:jboss:domain:security:2.0"&gt;
            &lt;security-domains&gt;
                ...
                &lt;security-domain name="application-security"&gt;
                    &lt;authentication&gt;
                        &lt;login-module code="Database" flag="required"&gt;
                            &lt;module-option name="dsJndiName" value="java:jboss/datasources/ExampleDS"/&gt;
                            &lt;module-option name="principalsQuery" value="SELECT password FROM User WHERE username = ?"/&gt;
                            &lt;module-option name="rolesQuery" value="SELECT role, 'Roles' FROM User WHERE username = ?"/&gt;
                            &lt;module-option name="hashAlgorithm" value="MD5"/&gt;
                            &lt;module-option name="hashEncoding" value="base64"/&gt;
                        &lt;/login-module&gt;
                    &lt;/authentication&gt;
                &lt;/security-domain&gt;
            &lt;/security-domains&gt;
        &lt;/subsystem&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="migrated">Migrated</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Within the Elytron subsystem to use database accesible via JDBC you need
to define <code>jdbc-realm</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">./subsystem=elytron/jdbc-realm=jdbc-realm:add(principal-query=[{ \
    data-source=ExampleDS, \
    sql="SELECT role, password FROM User WHERE username = ?", \
    attribute-mapping=[{index=1, to=Roles}] \
    simple-digest-mapper={algorithm=simple-digest-md5, password-index=2}, \
}])</code></pre>
</div>
</div>
<div class="paragraph">
<p>This results in the following overall configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">        &lt;subsystem xmlns="urn:wildfly:elytron:1.0" final-providers="combined-providers" disallowed-providers="OracleUcrypto"&gt;
            ...
            &lt;security-realms&gt;
                ...
                &lt;jdbc-realm name="jdbc-realm"&gt;
                    &lt;principal-query sql="SELECT role, password FROM User WHERE username = ?" data-source="ExampleDS"&gt;
                        &lt;attribute-mapping&gt;
                            &lt;attribute to="Roles" index="1"/&gt;
                        &lt;/attribute-mapping&gt;
                        &lt;simple-digest-mapper password-index="2"/&gt;
                    &lt;/principal-query&gt;
                &lt;/jdbc-realm&gt;
                ...
            &lt;/security-realms&gt;
            ...
        &lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In comparison with PicketBox solution, Elytron <code>jdbc-realm</code> use one SQL
query to obtain all user attributes and credentials. Their extraction
from SQL result specifies mappers.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="n-m-relation-beetween-user-and-roles">N-M relation beetween user and roles</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When using a n:m-relation beetween user and roles (which means: the user has multiple roles), the previous configuration does not work.</p>
</div>
<div class="paragraph">
<p>The database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">CREATE TABLE User (
id BIGINT NOT NULL,
username VARCHAR(255),
password VARCHAR(255),
PRIMARY KEY (id),
UNIQUE (username)
)

CREATE TABLE Role(
id BIGINT NOT NULL,
rolename VARCHAR(255),
PRIMARY KEY (id),
UNIQUE (rolename)
)

CREATE TABLE Userrole(
userid BIGINT not null,
roleid BIGINT not null,
PRIMARY KEY (userid, roleid),
FOREIGN KEY (userid) references User(id,
FOREIGN KEY (roleid) references Role(id)
)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here you need two configure two principal queries:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;jdbc-realm name="jdbc-realm"&gt;
    &lt;principal-query sql="SELECT PASSWORD FROM USER WHERE USERNAME = ?" data-source="ExampleDS"&gt;
        &lt;clear-password-mapper password-index="1"/&gt;
    &lt;/principal-query&gt;
    &lt;principal-query sql="SELECT R.ROLENAME from ROLE AS R, USERROLE AS UR, USER AS U WHERE U.USERNAME=? AND UR.ROLEID = R.ID AND UR.USERID = U.ID" data-source="ExampleDS"&gt;
        &lt;attribute-mapping&gt;
            &lt;attribute to="roles" index="1"/&gt;
        &lt;/attribute-mapping&gt;
    &lt;/principal-query&gt;
&lt;/jdbc-realm&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The second query needs an attribute mapping to decode the selected rolename column (index 1):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;mappers&gt;
...
&lt;simple-role-decoder name="from-roles-attribute" attribute="roles"/&gt;
...
&lt;/mappers&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The role decoder is referenced by the security domain:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;security-domain name="MyDomain" default-realm="jdbc-realm" permission-mapper="default-permission-mapper"&gt;
&lt;realm name="MyDbRealm" role-decoder="from-roles-attribute"/&gt;
&lt;/security-domain&gt;</code></pre>
</div>
</div>
</div>
</div></div>
</div>



  </div>

  <div class="content project-footer">
  <div class="footer-section">
    <div class="logo-wrapper">
      <a href="/wildflysite/"><img class="wf-logo" src="/wildflysite/assets/img/wildfly_icons_one-color-logo.png"></a>
    </div>
  </div>
  <div class="grid-wrapper">
    <p class="grid__item width-3-12">WildFly is open. All dependencies of this project are available under the <a href='https://www.gnu.org/licenses/old-licenses/lgpl-2.1.en.html' target='_blank'>LGPL 2.1</a> or compatible license.<br/><br/>This website was built with <a href='https://jekyllrb.com/' target='_blank'>Jekyll</a> is hosted on <a href='https://pages.github.com/' target='_blank'>Github Pages</a> and is completely open source. If you want to make it better, <a href='https://github.com/wildfly/wildfly.org/fork' target='_blank'>fork it</a> and show us what you’ve got.</p>

    
      <div class="width-1-12 project-links">
        <strong>Navigation</strong>
        <ul class="footer-links width-1-12">
          
            <li><a href="/wildflysite/downloads">Downloads</a></li>
          
            <li><a href="/wildflysitef/docs">Docs</a></li>
          
            <li><a href="https://github.com/wildfly/wildfly">Github</a></li>
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <strong>Contribute</strong>
        <ul class="footer-links width-1-12">
          
            <li><a href="https://issues.jboss.org/browse/WFLY">Submit a bug</a></li>
          
            <li><a href="https://community.jboss.org/en/wildfly?view=discussion">Join the forum</a></li>
          
            <li><a href="https://github.com/wildfly/wildfly/fork">Fork WildFly</a></li>
          
            <li><a href="https://twitter.com/WildFlyAS">Follow us</a></li>
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <strong>Get Help</strong>
        <ul class="footer-links width-1-12">
          
            <li><a href="https://community.jboss.org/en/wildfly?view=discussion">Join the forum</a></li>
          
            <li><a href="https://www.hipchat.com/gFOhnVQke">Join HipChat</a></li>
          
        </ul>
      </div>
    

    
      <div class="width-6-12 more-links">
        <strong>Find more Red Hat Middleware Community Projects</strong>
        <ul class="footer-links">
          
            <li><a href="https://www.apiman.io/">APIMan</a></li>
          
            <li><a href="http://arquillian.org">Arquillian</a></li>
          
            <li><a href="http://byteman.jboss.org/">Byteman</a></li>
          
            <li><a href="http://capedwarf.org/">CapeDwarf</a></li>
          
            <li><a href="https://github.com/alechenninger/chronicler">Chronicler</a></li>
          
            <li><a href="https://github.com/darcy-framework">Darcy</a></li>
          
            <li><a href="http://debezium.io/">Debezium</a></li>
          
            <li><a href="https://www.drools.org/">Drools</a></li>
          
            <li><a href="http://gatein.jboss.org/">GateIn</a></li>
          
            <li><a href="http://www.hawkular.org/">Hawkular</a></li>
          
            <li><a href="http://hawt.io/">Hawtio</a></li>
          
            <li><a href="http://hibernate.org/">Hibernate</a></li>
          
            <li><a href="http://www.infinispan.org/">Infinispan</a></li>
          
            <li><a href="https://devstudio.jboss.com/">JBoss DevStudio</a></li>
          
            <li><a href="http://forge.jboss.org/">JBoss Forge</a></li>
          
            <li><a href="https://github.com/jboss-logging">JBoss Logging</a></li>
          
            <li><a href="http://jbossremoting.jboss.org/">JBoss Remoting</a></li>
          
            <li><a href="https://www.jbpm.org/">jBPM</a></li>
          
            <li><a href="https://jsfunit.jboss.org/">JSFUnit</a></li>
          
            <li><a href="https://www.keycloak.org/">Keycloak</a></li>
          
            <li><a href="http://modcluster.io/">Mod Cluster</a></li>
          
            <li><a href="http://modeshape.jboss.org/">ModeShape</a></li>
          
            <li><a href="https://www.optaplanner.org/">OptaPlanner</a></li>
          
            <li><a href="https://picketbox.jboss.org/">Picketbox</a></li>
          
            <li><a href="http://resteasy.jboss.org/">RESTEasy</a></li>
          
            <li><a href="https://riftsaw.jboss.org/">Riftsaw</a></li>
          
            <li><a href="http://savara.jboss.org/">Savara</a></li>
          
            <li><a href="http://seamframework.org/">Seam</a></li>
          
            <li><a href="http://arquillian.org/">Shrinkwrap</a></li>
          
            <li><a href="http://snowdrop.jboss.org/">Snowdrop</a></li>
          
            <li><a href="https://switchyard.jboss.org/">Switchyard</a></li>
          
            <li><a href="https://tattletale.jboss.org/">Tattletale</a></li>
          
            <li><a href="http://teiid.jboss.org/">Teiid</a></li>
          
            <li><a href="http://wildfly-swarm.io/">WildFly Swarm</a></li>
          
            <li><a href="http://wise.jboss.org/">Wise</a></li>
          
            <li><a href="https://xnio.jboss.org/">XNIO</a></li>
          
        </ul>
      </div>
    
  </div>
</div>
  <div class="content redhat-footer">
  <div class="grid-wrapper">
    <span class="licence">
      <i class="fab fa-creative-commons"></i><i class="fab fa-creative-commons-by"></i> <a href="https://creativecommons.org/licenses/by/3.0/" target="_blank">CC by 3.0</a>
    </span>
    <span class="redhat">
      a Red Hat sponsored project   
    </span>
    <span class="redhat-logo">
      <a href="https://www.redhat.com/"><img src="/wildflysite/assets/img/RHLogo_white.svg"></a>
    </span>
  </div>
</div>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
  <script type="text/javascript" src="/wildflysite/assets/javascript/mobile-nav.js"></script>
</body>

</html>