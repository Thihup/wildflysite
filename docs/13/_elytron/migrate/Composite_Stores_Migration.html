<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="description" content="">
  <link rel="shortcut icon" type="image/png" href="/wildflysite/favicon.ico" >
  <link rel="stylesheet" href="/wildflysite/assets/css/main.css" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">


</head>

<body class="Composite Stores Migration">
  <div class="content">
    <div class="header navigation">
  <div class="logo-wrapper">
    <a href="/wildflysite/"><img class="wf-logo" src="/wildflysite/assets/img/wildfly_icons_one-color-logo.png"></a>
  </div>
  <div class="nav-container">
    <nav>
      <div class="nav-mobile"><a id="nav-toggle" href="#!"><span></span></a></div>
      <ul class="nav-list">
        <li>
          <a href="/wildflysite/" class="">Home</a>
        </li>
        <li>
          <a href="/wildflysite/downloads/" class="">Downloads</a>
        </li>
        <li>
          <a href="/wildflysite/blog/" class="">Blog</a>
        </li>
        <li>
          <a href="/wildflysite/about/" class="">About</a>
        </li>
        <li>
          <a href="/wildflysite/contribute/" class="">Contribute</a>
        </li>
        <li>
          
            <a href="/wildflysite/docs/14/" class="active">Docs</a>
          
        </li>
        <li>
          <a class="button-cta secondary" href="https://github.com/wildfly/wildfly/fork" target="_blank">Fork</a>
        </li>
      </ul>
    </nav>
  </div>
</div>

    <div class="docs-page grid-wrapper">
  <div class="grid__item width-12-12 docs-v-icons">
    <a href="/wildflysite/docs/14/" ><img src="/wildflysite/assets/img/docs/wildfly_icons_docs-14-inactive.png"></a>
    <a href="/wildflysite/docs/13/" ><img src="/wildflysite/assets/img/docs/wildfly_icons_docs-13-active.png"></a>
    <a href="https://docs.wildfly.org/12/" target="_blank"><img src="/wildflysite/assets/img/docs/wildfly_icons_docs-12-inactive.png"></a>
    <img src="/wildflysite/assets/img/docs/wildfly_icons_docs-11-coming.png">
    <img src="/wildflysite/assets/img/docs/wildfly_icons_docs-10-coming.png">
    <img src="/wildflysite/assets/img/docs/wildfly_icons_docs-09-coming.png">
    <img src="/wildflysite/assets/img/docs/wildfly_icons_docs-08-coming.png">
  </div>
  <div class="grid__item width-12-12"><h1 class="title">Composite Stores Migration</h1></div>
  <div class="grid__item width-3-12 doc-toc"><ul class="inline_toc">
  <li><a href="#picketbox-based-configuration">PicketBox Based Configuration</a></li>
  <li><a href="#migrated-wildfly-elytron-configuration">Migrated WildFly Elytron Configuration</a></li>
</ul></div>
  <div class="grid__item width-9-12 doc-content"><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>When using either PicketBox or the legacy security realms it is possible to define a configuration where authentication is performed against one identity store whilst the information used for authorization is loaded from a different store, when using WildFly Elytron this can be achieved by using an aggregate security realm.</p>
</div>
<div class="paragraph">
<p>The example here makes use of a properties file for authentication and then searches LDAP to load group / role information. Both of these are based on the previous examples within this document so the environmental information is not repeated here.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="picketbox-based-configuration">PicketBox Based Configuration</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">./subsystem=security/security-domain=application-security:add
./subsystem=security/security-domain=application-security/authentication=classic:add(login-modules=[ \
{code=UsersRoles, flag=Required, module-options={ \
password-stacking=useFirstPass, \
usersProperties=file://${jboss.server.config.dir}/example-users.properties, \
rolesProperties=file://${jboss.server.config.dir}/example-roles.properties}} \
{code=LdapExtended, flag=Required, module-options={ \
password-stacking=useFirstPass, \
java.naming.factory.initial=com.sun.jndi.ldap.LdapCtxFactory, \
java.naming.provider.url=ldap://localhost:10389, \
java.naming.security.authentication=simple, \
bindDN="uid=admin,ou=system", \
bindCredential=secret, \
baseCtxDN="ou=users,dc=group-to-principal,dc=wildfly,dc=org", \
baseFilter="(uid={0})", \
rolesCtxDN="ou=groups,dc=group-to-principal,dc=wildfly,dc=org",\
roleFilter="(uniqueMember={1})", \
roleAttributeID="uid" \
}}])</code></pre>
</div>
</div>
<div class="paragraph">
<p>This results in the following domain definition</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;security-domain name="application-security"&gt;
  &lt;authentication&gt;
    &lt;login-module code="UsersRoles" flag="required"&gt;
      &lt;module-option name="password-stacking" value="useFirstPass"/&gt;
      &lt;module-option name="usersProperties" value="file://${jboss.server.config.dir}/example-users.properties"/&gt;
      &lt;module-option name="rolesProperties" value="file://${jboss.server.config.dir}/example-roles.properties"/&gt;
    &lt;/login-module&gt;
    &lt;login-module code="LdapExtended" flag="required"&gt;
      &lt;module-option name="password-stacking" value="useFirstPass"/&gt;
      &lt;module-option name="java.naming.factory.initial" value="com.sun.jndi.ldap.LdapCtxFactory"/&gt;
      &lt;module-option name="java.naming.provider.url" value="ldap://localhost:10389"/&gt;
      &lt;module-option name="java.naming.security.authentication" value="simple"/&gt;
      &lt;module-option name="bindDN" value="uid=admin,ou=system"/&gt;
      &lt;module-option name="bindCredential" value="secret"/&gt;
      &lt;module-option name="baseCtxDN" value="ou=users,dc=group-to-principal,dc=wildfly,dc=org"/&gt;
      &lt;module-option name="baseFilter" value="(uid={0})"/&gt;
      &lt;module-option name="rolesCtxDN" value="ou=groups,dc=group-to-principal,dc=wildfly,dc=org"/&gt;
      &lt;module-option name="roleFilter" value="(uniqueMember={1})"/&gt;
      &lt;module-option name="roleAttributeID" value="uid"/&gt;
    &lt;/login-module&gt;
  &lt;/authentication&gt;
&lt;/security-domain&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>During an authentication attempt the 'UsersRoles' login module will first be called to perform authentication based on the supplied credential, then the 'LdapExtLoginModule' will be called which will proceed to query LDAP to load the roles for the identity.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">./core-service=management/ldap-connection=MyLdapConnection:add(url="ldap://localhost:10389", search-dn="uid=admin,ou=system", search-credential="secret")

./core-service=management/security-realm=ApplicationSecurity:add
./core-service=management/security-realm=ApplicationSecurity/authentication=properties:add(path=example-users.properties, relative-to=jboss.server.config.dir, plain-text=true)

batch
./core-service=management/security-realm=ApplicationSecurity/authorization=ldap:add(connection=MyLdapConnection)
./core-service=management/security-realm=ApplicationSecurity/authorization=ldap/username-to-dn=username-filter:add(attribute=uid, base-dn="ou=users,dc=group-to-principal,dc=wildfly,dc=org")
./core-service=management/security-realm=ApplicationSecurity/authorization=ldap/group-search=group-to-principal:add(base-dn="ou=groups,dc=group-to-principal,dc=wildfly,dc=org", iterative=true, prefer-original-connection=true, principal-attribute=uniqueMember, search-by=DISTINGUISHED_NAME, group-name=SIMPLE, group-name-attribute=uid)
run-batch</code></pre>
</div>
</div>
<div class="paragraph">
<p>This results in the following realm definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;security-realm name="ApplicationSecurity"&gt;
  &lt;authentication&gt;
    &lt;properties path="example-users.properties" relative-to="jboss.server.config.dir" plain-text="true"/&gt;
  &lt;/authentication&gt;
  &lt;authorization&gt;
    &lt;ldap connection="MyLdapConnection"&gt;
      &lt;username-to-dn&gt;
        &lt;username-filter base-dn="ou=users,dc=group-to-principal,dc=wildfly,dc=org" attribute="uid"/&gt;
      &lt;/username-to-dn&gt;
      &lt;group-search group-name="SIMPLE" iterative="true" group-name-attribute="uid"&gt;
        &lt;group-to-principal search-by="DISTINGUISHED_NAME" base-dn="ou=groups,dc=group-to-principal,dc=wildfly,dc=org" prefer-original-connection="true"&gt;
          &lt;membership-filter principal-attribute="uniqueMember"/&gt;
        &lt;/group-to-principal&gt;
      &lt;/group-search&gt;
    &lt;/ldap&gt;
  &lt;/authorization&gt;
&lt;/security-realm&gt;

&lt;outbound-connections&gt;
  &lt;ldap name="MyLdapConnection" url="ldap://localhost:10389" search-dn="uid=admin,ou=system" search-credential="secret"/&gt;
&lt;/outbound-connections&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As with the PicketBox example, authentication is first performed using the properties file - then group searching is performed against LDAP.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="migrated-wildfly-elytron-configuration">Migrated WildFly Elytron Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The equivalent WildFly Elytron configuration can be defined with the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">./subsystem=elytron/dir-context=ldap-connection:add(url=ldap://localhost:10389, principal="uid=admin,ou=system", credential-reference={clear-text=secret})

./subsystem=elytron/ldap-realm=ldap-realm:add(dir-context=ldap-connection, \
direct-verification=true, \
identity-mapping={search-base-dn="ou=users,dc=group-to-principal,dc=wildfly,dc=org", \
rdn-identifier="uid", \
attribute-mapping=[{filter-base-dn="ou=groups,dc=group-to-principal,dc=wildfly,dc=org",filter="(uniqueMember={1})",from="uid",to="Roles"}]})

./subsystem=elytron/properties-realm=application-properties:add(users-properties={path=example-users.properties, relative-to=jboss.server.config.dir, plain-text=true, digest-realm-name="Application Security"}, groups-properties={path=example-roles.properties, relative-to=jboss.server.config.dir}, groups-attribute=Roles)

./subsystem=elytron/aggregate-realm=combined-realm:add(authentication-realm=application-properties, authorization-realm=ldap-realm)

./subsystem=elytron/security-domain=application-security:add(realms=[{realm=combined-realm}], default-realm=combined-realm, permission-mapper=default-permission-mapper)
./subsystem=elytron/http-authentication-factory=application-security-http:add(http-server-mechanism-factory=global, security-domain=application-security, mechanism-configurations=[{mechanism-name=BASIC}])</code></pre>
</div>
</div>
<div class="paragraph">
<p>This results in the following realm definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;subsystem xmlns="urn:wildfly:elytron:1.1" final-providers="combined-providers" disallowed-providers="OracleUcrypto"&gt;
  ...
  &lt;security-domains&gt;
    ...
    &lt;security-domain name="application-security" default-realm="combined-realm" permission-mapper="default-permission-mapper"&gt;
      &lt;realm name="combined-realm"/&gt;
    &lt;/security-domain&gt;
  &lt;/security-domains&gt;
  &lt;security-realms&gt;
    &lt;aggregate-realm name="combined-realm" authentication-realm="application-properties" authorization-realm="ldap-realm"/&gt;
      ...
      &lt;properties-realm name="application-properties" groups-attribute="Roles"&gt;
        &lt;users-properties path="example-users.properties" relative-to="jboss.server.config.dir" digest-realm-name="Application Security" plain-text="true"/&gt;
        &lt;groups-properties path="example-roles.properties" relative-to="jboss.server.config.dir"/&gt;
      &lt;/properties-realm&gt;
      &lt;ldap-realm name="ldap-realm" dir-context="ldap-connection" direct-verification="true"&gt;
        &lt;identity-mapping rdn-identifier="uid" search-base-dn="ou=users,dc=group-to-principal,dc=wildfly,dc=org"&gt;
          &lt;attribute-mapping&gt;
            &lt;attribute from="uid" to="Roles" filter="(uniqueMember={1})" filter-base-dn="ou=groups,dc=group-to-principal,dc=wildfly,dc=org"/&gt;
          &lt;/attribute-mapping&gt;
        &lt;/identity-mapping&gt;
      &lt;/ldap-realm&gt;
  &lt;/security-realms&gt;
  ...
  &lt;http&gt;
    ...
    &lt;http-authentication-factory name="application-security-http" http-server-mechanism-factory="global" security-domain="application-security"&gt;
      &lt;mechanism-configuration&gt;
        &lt;mechanism mechanism-name="BASIC"/&gt;
      &lt;/mechanism-configuration&gt;
    &lt;/http-authentication-factory&gt;
    ...
  &lt;/http&gt;
  ...
  &lt;dir-contexts&gt;
    &lt;dir-context name="ldap-connection" url="ldap://localhost:10389" principal="uid=admin,ou=system"&gt;
      &lt;credential-reference clear-text="secret"/&gt;
    &lt;/dir-context&gt;
  &lt;/dir-contexts&gt;
&lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Within the WildFly Elytron example a new security realm 'aggregate-realm' has been defined, this definition specifies which of the defined security realms should be used for the authentication step and which of the security realms should be used for the loading of the identity used for subsequent authorization decisions.</p>
</div>
</div>
</div></div>
</div>



  </div>

  <div class="content project-footer">
  <div class="footer-section">
    <div class="logo-wrapper">
      <a href="/wildflysite/"><img class="wf-logo" src="/wildflysite/assets/img/wildfly_icons_one-color-logo.png"></a>
    </div>
  </div>
  <div class="grid-wrapper">
    <p class="grid__item width-3-12">WildFly is open. All dependencies of this project are available under the <a href='https://www.gnu.org/licenses/old-licenses/lgpl-2.1.en.html' target='_blank'>LGPL 2.1</a> or compatible license.<br/><br/>This website was built with <a href='https://jekyllrb.com/' target='_blank'>Jekyll</a> is hosted on <a href='https://pages.github.com/' target='_blank'>Github Pages</a> and is completely open source. If you want to make it better, <a href='https://github.com/wildfly/wildfly.org/fork' target='_blank'>fork it</a> and show us what youâ€™ve got.</p>

    
      <div class="width-1-12 project-links">
        <strong>Navigation</strong>
        <ul class="footer-links width-1-12">
          
            <li><a href="/wildflysite/downloads">Downloads</a></li>
          
            <li><a href="/wildflysitef/docs">Docs</a></li>
          
            <li><a href="https://github.com/wildfly/wildfly">Github</a></li>
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <strong>Contribute</strong>
        <ul class="footer-links width-1-12">
          
            <li><a href="https://issues.jboss.org/browse/WFLY">Submit a bug</a></li>
          
            <li><a href="https://community.jboss.org/en/wildfly?view=discussion">Join the forum</a></li>
          
            <li><a href="https://github.com/wildfly/wildfly/fork">Fork WildFly</a></li>
          
            <li><a href="https://twitter.com/WildFlyAS">Follow us</a></li>
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <strong>Get Help</strong>
        <ul class="footer-links width-1-12">
          
            <li><a href="https://community.jboss.org/en/wildfly?view=discussion">Join the forum</a></li>
          
            <li><a href="https://www.hipchat.com/gFOhnVQke">Join HipChat</a></li>
          
        </ul>
      </div>
    

    
      <div class="width-6-12 more-links">
        <strong>Find more Red Hat Middleware Community Projects</strong>
        <ul class="footer-links">
          
            <li><a href="https://www.apiman.io/">APIMan</a></li>
          
            <li><a href="http://arquillian.org">Arquillian</a></li>
          
            <li><a href="http://byteman.jboss.org/">Byteman</a></li>
          
            <li><a href="http://capedwarf.org/">CapeDwarf</a></li>
          
            <li><a href="https://github.com/alechenninger/chronicler">Chronicler</a></li>
          
            <li><a href="https://github.com/darcy-framework">Darcy</a></li>
          
            <li><a href="http://debezium.io/">Debezium</a></li>
          
            <li><a href="https://www.drools.org/">Drools</a></li>
          
            <li><a href="http://gatein.jboss.org/">GateIn</a></li>
          
            <li><a href="http://www.hawkular.org/">Hawkular</a></li>
          
            <li><a href="http://hawt.io/">Hawtio</a></li>
          
            <li><a href="http://hibernate.org/">Hibernate</a></li>
          
            <li><a href="http://www.infinispan.org/">Infinispan</a></li>
          
            <li><a href="https://devstudio.jboss.com/">JBoss DevStudio</a></li>
          
            <li><a href="http://forge.jboss.org/">JBoss Forge</a></li>
          
            <li><a href="https://github.com/jboss-logging">JBoss Logging</a></li>
          
            <li><a href="http://jbossremoting.jboss.org/">JBoss Remoting</a></li>
          
            <li><a href="https://www.jbpm.org/">jBPM</a></li>
          
            <li><a href="https://jsfunit.jboss.org/">JSFUnit</a></li>
          
            <li><a href="https://www.keycloak.org/">Keycloak</a></li>
          
            <li><a href="http://modcluster.io/">Mod Cluster</a></li>
          
            <li><a href="http://modeshape.jboss.org/">ModeShape</a></li>
          
            <li><a href="https://www.optaplanner.org/">OptaPlanner</a></li>
          
            <li><a href="https://picketbox.jboss.org/">Picketbox</a></li>
          
            <li><a href="http://resteasy.jboss.org/">RESTEasy</a></li>
          
            <li><a href="https://riftsaw.jboss.org/">Riftsaw</a></li>
          
            <li><a href="http://savara.jboss.org/">Savara</a></li>
          
            <li><a href="http://seamframework.org/">Seam</a></li>
          
            <li><a href="http://arquillian.org/">Shrinkwrap</a></li>
          
            <li><a href="http://snowdrop.jboss.org/">Snowdrop</a></li>
          
            <li><a href="https://switchyard.jboss.org/">Switchyard</a></li>
          
            <li><a href="https://tattletale.jboss.org/">Tattletale</a></li>
          
            <li><a href="http://teiid.jboss.org/">Teiid</a></li>
          
            <li><a href="http://wildfly-swarm.io/">WildFly Swarm</a></li>
          
            <li><a href="http://wise.jboss.org/">Wise</a></li>
          
            <li><a href="https://xnio.jboss.org/">XNIO</a></li>
          
        </ul>
      </div>
    
  </div>
</div>
  <div class="content redhat-footer">
  <div class="grid-wrapper">
    <span class="licence">
      <i class="fab fa-creative-commons"></i><i class="fab fa-creative-commons-by"></i> <a href="https://creativecommons.org/licenses/by/3.0/" target="_blank">CC by 3.0</a>
    </span>
    <span class="redhat">
      a Red Hat sponsored project   
    </span>
    <span class="redhat-logo">
      <a href="https://www.redhat.com/"><img src="/wildflysite/assets/img/RHLogo_white.svg"></a>
    </span>
  </div>
</div>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
  <script type="text/javascript" src="/wildflysite/assets/javascript/mobile-nav.js"></script>
</body>

</html>