<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Subsystem_support | Wildfly</title>
<meta name="generator" content="Jekyll v3.8.3" />
<meta property="og:title" content="Subsystem_support" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Subsystem Support" />
<meta property="og:description" content="Subsystem Support" />
<link rel="canonical" href="https://jbossorg.github.io/wildflysite/docs/13/_high-availability/Subsystem_Support.html" />
<meta property="og:url" content="https://jbossorg.github.io/wildflysite/docs/13/_high-availability/Subsystem_Support.html" />
<meta property="og:site_name" content="Wildfly" />
<script type="application/ld+json">
{"description":"Subsystem Support","@type":"WebPage","url":"https://jbossorg.github.io/wildflysite/docs/13/_high-availability/Subsystem_Support.html","headline":"Subsystem_support","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/wildflysite/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://jbossorg.github.io/wildflysite/feed.xml" title="Wildfly" /></head>
<body><div class="header navigation">
  <div class="logo-wrapper">
    <a href="/wildflysite/"><img class="wf-logo" src="/wildflysite/assets/img/wildfly_icons_one-color-logo.png"></a>
  </div>
  <div class="nav-container">
    <nav>
      <div class="nav-mobile"><a id="nav-toggle" href="#!"><span></span></a></div>
      <ul class="nav-list">
        <li>
          <a href="/wildflysite/" class="">Home</a>
        </li>
        <li>
          <a href="/wildflysite/downloads/" class="">Downloads</a>
        </li>
        <li>
          <a href="/wildflysite/blog/" class="">Blog</a>
        </li>
        <li>
          <a href="/wildflysite/about/" class="">About</a>
        </li>
        <li>
          <a href="/wildflysite/contribute/" class="">Contribute</a>
        </li>
        <li>
          <a href="/wildflysite/docs/" class="">Docs</a>
        </li>
        <li>
          <a class="button-cta secondary" href="https://github.com/wildfly/wildfly/fork" target="_blank">Fork</a>
        </li>
      </ul>
    </nav>
  </div>
</div>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <div class="sect1">
<h2 id="Subsystem_Support">Subsystem Support</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="Infinispan_Subsystem">Infinispan Subsystem</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Infinispan subsystem configures a set of Infinispan cache containers and cache configurations for use by WildFly clustering services.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cache-container">Cache container</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A cache container manages a set of cache configurations that share the same transport and marshalling configuration.
Cache containers returned by the Infinispan subsystem are auto-configured with the following customizations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A custom <a href="#transport">transport</a> capable of sharing a JGroups channel defined by the JGroups subsystem.</p>
</li>
<li>
<p>Uses WildFly&#8217;s mbean server, if the org.jboss.as.jmx extension is present.</p>
</li>
<li>
<p>Marshaller configured to resolve classes using JBoss Modules.</p>
</li>
<li>
<p>Marshaller configured with a set of marshalling optimizations for common JDK classes</p>
</li>
<li>
<p>Marshaller configured with additional Externalizers loadable from the configured module attribute.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>e.g. To create a new cache container that loads marshallers from the "org.bar" module:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>/subsystem=infinispan/cache-container=foo:add(module=org.foo)</code></pre>
</div>
</div>
<div class="paragraph">
<p>A cache container may designate a specific cache as its default cache, i.e. the cache returned via <a href="http://docs.jboss.org/infinispan/9.2/apidocs/org/infinispan/manager/CacheContainer.html#getCache--">CacheContainer.getCache()</a>:</p>
</div>
<div class="paragraph">
<p>e.g. To set "bar" as the default cache of the "foo" container:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>/subsystem=infinispan/cache-container=foo:write-attribute(name=default-cache, value=bar)</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="transport">Transport</h3>
<div class="paragraph">
<p>Configures the mechanism used by clustered caches to communicate with each other.
It is only necessary to define a transport if the cache container contains clustered caches.</p>
</div>
<div class="paragraph">
<p>To create a JGroups transport using the default channel of the server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>/subsystem=infinispan/cache-container=foo/transport=jgroups:add()</code></pre>
</div>
</div>
<div class="paragraph">
<p>To create a JGroups transport using a distinct "alpha" channel, that uses the "tcp" stack:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>/subsystem=jgroups/channel=alpha:add(stack=tcp)
/subsystem=infinispan/cache-container=foo/transport=jgroups:add(channel=alpha)</code></pre>
</div>
</div>
<div class="paragraph">
<p>For a complete list of transport attributes, refer to the <a href="https://wildscribe.github.io/">WildFly management model documentation</a></p>
</div>
<div class="paragraph">
<p>To remove an existing JGroups transport, you can either use the standard remove resource operation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>/subsystem=infinispan/cache-container=foo/transport=jgroups:remove()</code></pre>
</div>
</div>
<div class="paragraph">
<p>&#8230;&#8203; or by adding the "none" transport (which will auto-remove any existing transport):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>/subsystem=infinispan/cache-container=foo/transport=none:add(){allow-resource-service-restart=true}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cache-types">Cache types</h3>
<div class="paragraph">
<p>Infinispan supports a number of cache types for use in both HA and non-HA server profiles.</p>
</div>
<div class="sect3">
<h4 id="local">Local</h4>
<div class="paragraph">
<p>A local cache stores a given cache entry only on the local node.
A local cache does not require a transport, as cache reads and writes are always local.</p>
</div>
<div class="paragraph">
<p>For more information about this cache type, refer to the <a href="http://infinispan.org/docs/stable/user_guide/user_guide.html#local_mode">the Infinispan documentation</a>.</p>
</div>
<div class="paragraph">
<p>To create a local cache:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>/subsystem=infinispan/cache-container=foo/local-cache=bar:add()</code></pre>
</div>
</div>
<div class="paragraph">
<p>For a complete list of local-cache attributes, refer to the <a href="https://wildscribe.github.io/">WildFly management model documentation</a></p>
</div>
</div>
<div class="sect3">
<h4 id="replicated">Replicated</h4>
<div class="paragraph">
<p>A replicated cache stores a given cache entry on every node in the cluster.
A replicated cache requires a transport, as cache writes are replicated to all nodes in the cluster on which the associated cache is running.</p>
</div>
<div class="paragraph">
<p>For more information about this cache type, refer to the <a href="http://infinispan.org/docs/stable/user_guide/user_guide.html#replicated_mode">the Infinispan documentation</a>.</p>
</div>
<div class="paragraph">
<p>To create a replicated cache:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>/subsystem=infinispan/cache-container=foo/replicated-cache=bar:add()</code></pre>
</div>
</div>
<div class="paragraph">
<p>For a complete list of replicated-cache attributes, refer to the <a href="https://wildscribe.github.io/">WildFly management model documentation</a></p>
</div>
</div>
<div class="sect3">
<h4 id="distributed">Distributed</h4>
<div class="paragraph">
<p>A distributed cache stores a given cache entry on a configurable number of nodes in the cluster, assigned via an algorithm based on consistent hashing.
A distributed cache requires a transport, as cache writes need to forward to each owner, and cache reads from a non-owner require a remote request.</p>
</div>
<div class="paragraph">
<p>For more information about this cache type, refer to the <a href="http://infinispan.org/docs/stable/user_guide/user_guide.html#distribution_mode">the Infinispan documentation</a>.</p>
</div>
<div class="paragraph">
<p>To create a distributed cache where a given entry is stored on 3 nodes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>/subsystem=infinispan/cache-container=foo/distributed-cache=bar:add(owners=3)</code></pre>
</div>
</div>
<div class="paragraph">
<p>For a complete list of distributed-cache attributes, refer to the <a href="https://wildscribe.github.io/">WildFly management model documentation</a></p>
</div>
</div>
<div class="sect3">
<h4 id="scattered">Scattered</h4>
<div class="paragraph">
<p>A scattered cache is a variation of a distributed cache that maintains 2 copies of a particular cache entry.
Consequently, it can only tolerate failure of a single node at a time.
Primary ownership of a cache entry is determined by the same mechanism used by a distributed cache,
while the backup copy is the node that last updated the entry.</p>
</div>
<div class="paragraph">
<p>This design means that a scattered cache only requires 1 remote invocation to write a given cache entry, regardless of which node initiated the cache operation.
By comparison, a distributed cache (with 2 owners) uses 1 remote invocation to write a cache entry if and only if the primary owner initiated the cache operation, and otherwise requires 2 remote invocations.</p>
</div>
<div class="paragraph">
<p>For more information about this cache type, refer to the <a href="http://infinispan.org/docs/stable/user_guide/user_guide.html#scattered_mode">the Infinispan documentation</a>.</p>
</div>
<div class="paragraph">
<p>To create a scattered cache:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>/subsystem=infinispan/cache-container=foo/scattered-cache=bar:add()</code></pre>
</div>
</div>
<div class="paragraph">
<p>For a complete list of scattered-cache attributes, refer to the <a href="https://wildscribe.github.io/">WildFly management model documentation</a></p>
</div>
</div>
<div class="sect3">
<h4 id="invalidation">Invalidation</h4>
<div class="paragraph">
<p>An invalidation cache is a special type of clustered cache that does not share state, but instead ensures that remote state is invalidated any time a given entry is updated locally.
An invalidation cache requires a transport, as cache writes trigger invalidation on remote nodes on which the associated cache is running.</p>
</div>
<div class="paragraph">
<p>For more information about this cache type, refer to the <a href="http://infinispan.org/docs/stable/user_guide/user_guide.html#invalidation_mode">the Infinispan documentation</a>.</p>
</div>
<div class="paragraph">
<p>To create an invalidation cache:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>/subsystem=infinispan/cache-container=foo/invalidation-cache=bar:add()</code></pre>
</div>
</div>
<div class="paragraph">
<p>For a complete list of invalidation-cache attributes, refer to the <a href="https://wildscribe.github.io/">WildFly management model documentation</a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cache-features">Cache features</h3>
<div class="paragraph">
<p>The configuration of a cache is divided into several components, each defining a specific cache feature.
Because a given cache configuration requires each component relevant to its cache type, cache add operations and cache component add operations are typically batched.
Any undefined components are auto-created using their defaults.</p>
</div>
<div class="paragraph">
<p>e.g. The following cache add operation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>/subsystem=infinispan/cache-container=foo/local-cache=bar:add()</code></pre>
</div>
</div>
<div class="paragraph">
<p>&#8230;&#8203; is actually equivalent to the following sequence of operations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>batch
/subsystem=infinispan/cache-container=foo/local-cache=bar:add()
/subsystem=infinispan/cache-container=foo/local-cache=bar/component=expiration:add()
/subsystem=infinispan/cache-container=foo/local-cache=bar/component=locking:add()
/subsystem=infinispan/cache-container=foo/local-cache=bar/component=transaction:add()
/subsystem=infinispan/cache-container=foo/local-cache=bar/memory=object:add()
/subsystem=infinispan/cache-container=foo/local-cache=bar/store=none:add()
run-batch</code></pre>
</div>
</div>
<div class="paragraph">
<p>Similarly, you can reset all the attributes of a component by simply removing the component.
e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>/subsystem=infinispan/cache-container=foo/local-cache=bar:component=expiration:remove(){allow-resource-service-restart=true}</code></pre>
</div>
</div>
<div class="paragraph">
<p>&#8230;&#8203; is equivalent to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>/subsystem=infinispan/cache-container=foo/local-cache=bar:component=expiration:remove(){allow-resource-service-restart=true}
/subsystem=infinispan/cache-container=foo/local-cache=bar:component=expiration:add(){allow-resource-service-restart=true}</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="memory">Memory</h4>
<div class="paragraph">
<p>An Infinispan cache can be configured to store cache entries as Java objects or as binary data (i.e. byte[]), either on or off the JVM heap.
The type of storage used has semantic implications for the user of the cache.
When using object storage, the cache has store-as-reference semantics, whereas when using binary storage the cache has call-by-value semantics.
Consider the following logic:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">List&lt;String&gt; list = new ArrayList&lt;&gt;();
cache.startBatch();
cache.put("a", list);
list.add("test");
cache.endBatch(true);

List&lt;String&gt; result = cache.get("a");
System.out.println(result.size());</code></pre>
</div>
</div>
<div class="paragraph">
<p>How many elements are in the "result" list? The answer depends on how the cache is configured.</p>
</div>
<div class="paragraph">
<p>When the cache is configured to use object memory, our result list has 1 element.
When the cache is configured to use binary (or off-heap) memory, our result list is empty.
When using binary memory, the cache value must be marshalled to a byte[] on write and unmarshalled on read, thus any mutations of the cache value in the interim are not reflected in the cache.</p>
</div>
<div class="sect4">
<h5 id="object-storage">Object storage</h5>
<div class="paragraph">
<p>When using object storage, cache keys and values are stored as Java object references.
Object storage may be configured with a maximum size.
When the number of entries in the cache exceeds this threshold, the least recently used entries are evicted from memory.</p>
</div>
<div class="paragraph">
<p>e.g. To store a maximum of 100 objects in the Java heap:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>/subsystem=infinispan/cache-container=foo/local-cache=bar/memory=object:add(size=100)</code></pre>
</div>
</div>
<div class="paragraph">
<p>For a complete list of memory=object attributes, refer to the <a href="https://wildscribe.github.io/">WildFly management model documentation</a></p>
</div>
</div>
<div class="sect4">
<h5 id="binary-storage-on-heap">Binary storage (on-heap)</h5>
<div class="paragraph">
<p>When using binary storage, each cache entry is stored as a byte[] within the JVM heap.
Binary storage may also be configured with a maximum size.
This size can be specified either as a maximum number of entries (i.e. COUNT), or as a maximum number of bytes (i.e. MEMORY).
When the number of entries in the cache exceeds this threshold, the least recently used entries are evicted from memory.</p>
</div>
<div class="paragraph">
<p>e.g. To store a maximum of 1 MB of binary data in the Java heap:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>/subsystem=infinispan/cache-container=foo/local-cache=bar/memory=binary:add(size=1048576, eviction-type=MEMORY)</code></pre>
</div>
</div>
<div class="paragraph">
<p>For a complete list of memory=binary attributes, refer to the <a href="https://wildscribe.github.io/">WildFly management model documentation</a></p>
</div>
</div>
<div class="sect4">
<h5 id="off-heap-binary-storage">Off-heap binary storage</h5>
<div class="paragraph">
<p>When using off-heap storage, each cache entry is stored as a byte[] in native memory allocated via sun.misc.Unsafe.
Off-heap memory storage may also be configured with a maximum size, specified either as a maximum number of entries (i.e. COUNT), or as a maximum number of bytes (i.e. MEMORY).
When the number of entries in the cache exceeds this threshold, the least recently used entries are evicted from memory.</p>
</div>
<div class="paragraph">
<p>e.g. To store a maximum of 1 GB of binary data in native memory outside of the Java heap:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>/subsystem=infinispan/cache-container=foo/local-cache=bar/memory=off-heap:add(size=1073741824)</code></pre>
</div>
</div>
<div class="paragraph">
<p>For a complete list of memory=off-heap attributes, refer to the <a href="https://wildscribe.github.io/">WildFly management model documentation</a></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="transactions">Transactions</h4>
<div class="paragraph">
<p>An Infinispan cache can be configured as transactional or non-transactional.
This behavior is determined by the mode attribute, which supports the following values:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">NONE</dt>
<dd>
<p>Non-transactional cache (the default behavior).</p>
</dd>
<dt class="hdlist1">BATCH</dt>
<dd>
<p>Transactional cache using a local Infinispan transaction manager.
Infinispan transactions are started/committed/rolled-back using <a href="http://docs.jboss.org/infinispan/9.2/apidocs/org/infinispan/commons/api/BatchingCache.html">Infinispan&#8217;s batching API</a>.</p>
</dd>
<dt class="hdlist1">NON_XA</dt>
<dd>
<p>Transactional cache configured to use the server&#8217;s transaction manager, registering as a Synchronization to the current transaction.
Cache commit/rollback happens after the associated transaction completes.</p>
</dd>
<dt class="hdlist1">NON_DURABLE_XA</dt>
<dd>
<p>Transactional cache configured to use the server&#8217;s transaction manager, enlisting as an XAResource to the current transaction, but without transaction recovery support.</p>
</dd>
<dt class="hdlist1">FULL_XA</dt>
<dd>
<p>Transactional cache configured to use the server&#8217;s transaction manager, with full transaction recovery support.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Within the context of a transaction, cache write operations must obtain a lock on the affected keys.
Locks may be acquired either pessimistically (the default), i.e. before invoking the operation, or optimistically, i.e. before transaction commit.</p>
</div>
<div class="paragraph">
<p>e.g. To configure a transactional cache using local Infinispan transactions with OPTIMISTIC locking:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>/subsystem=infinispan/cache-container=foo/local-cache=bar/component=transaction(mode=BATCH, locking=OPTIMISTIC)</code></pre>
</div>
</div>
<div class="paragraph">
<p>For a complete list of transaction attributes, refer to the <a href="https://wildscribe.github.io/">WildFly management model documentation</a></p>
</div>
</div>
<div class="sect3">
<h4 id="locking">Locking</h4>
<div class="paragraph">
<p>Within the context of a transaction, entries read from the cache are isolated from other concurrent transactions according to the configured isolation level.
Infinispan supports the following transaction isolation levels:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">READ_COMMITTED</dt>
<dd>
<p>A cache read may return a different value than a previous read within the same transaction, even if a concurrent transaction updated the entry.
This is the default isolation level.</p>
</dd>
<dt class="hdlist1">REPEATABLE_READ</dt>
<dd>
<p>A cache read will return the same value as a previous read within the same transaction, even if a concurrent transaction updated the entry.</p>
</dd>
</dl>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Cache reads are always lock-free unless invoked using Flag.FORCE_WRITE_LOCK.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>e.g. To configure a cache using REPEATABLE_READ isolation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>/subsystem=infinispan/cache-container=foo/local-cache=bar/component=locking(isolation=REPEATABLE_READ)</code></pre>
</div>
</div>
<div class="paragraph">
<p>For a complete list of locking attributes, refer to the <a href="https://wildscribe.github.io/">WildFly management model documentation</a></p>
</div>
</div>
<div class="sect3">
<h4 id="expiration">Expiration</h4>
<div class="paragraph">
<p>The expiration component configures expiration defaults for cache entries.
Cache entries may be configured to expire after some duration since creation (i.e. lifespan) or since last accessed (i.e. max-idle).</p>
</div>
<div class="paragraph">
<p>e.g. To configure expiration of entries older than 1 day, or that have not been accessed within the past hour:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>/subsystem=infinispan/cache-container=foo/local-cache=bar/component=expiration(lifespan=86400000, max-idle=3600000)</code></pre>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">
max-idle based expiration is not generally safe for use with clustered caches, as the meta data of a cache entry is not replicated by cache read operations
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For a complete list of expiration attributes, refer to the <a href="https://wildscribe.github.io/">WildFly management model documentation</a></p>
</div>
</div>
<div class="sect3">
<h4 id="persistence">Persistence</h4>
<div class="paragraph">
<p>An Infinispan cache can optionally load/store cache entries from an external storage.
All cache stores support the following attributes:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">fetch-state</dt>
<dd>
<p>Indicates whether to refresh persistent state from cluster members on cache start.
Does not apply to a local or invalidation cache, nor a shared store.
Default is true.</p>
</dd>
<dt class="hdlist1">passivation</dt>
<dd>
<p>Indicates whether cache entries should only be persisted upon eviction from memory.
Default is true.</p>
</dd>
<dt class="hdlist1">preload</dt>
<dd>
<p>Indicates whether cache entries should be loaded into memory on cache start.
Default is false.</p>
</dd>
<dt class="hdlist1">purge</dt>
<dd>
<p>Indicates whether the cache store should be purged on cache start.
Purge should never be enabled on a shared store.
Default is true.</p>
</dd>
<dt class="hdlist1">shared</dt>
<dd>
<p>Indicates that the same cache store endpoint (e.g. database, data grid, etc.) is used by all members of the cluster.
When using a shared cache store, cache entries are only persisted by the primary owner of a given cache entry.
Default is false.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>To remove an existing cache store, you can either use the standard resource remove operation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>/subsystem=infinispan/cache-container=foo/local-cache=bar/store=file:remove()</code></pre>
</div>
</div>
<div class="paragraph">
<p>&#8230;&#8203; or by adding the "none" store (which auto-removes any existing store):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>/subsystem=infinispan/cache-container=foo/local-cache=bar/store=none:add(){allow-resource-service-restart=true}</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="file-store">File store</h5>
<div class="paragraph">
<p>A file store persists cache entries to the local filesystem.
By default, files are stored in a file named "<em>cache-name</em>.dat" within a subdirectory named "infinispan/<em>container-name</em>" relative to the server&#8217;s data directory.</p>
</div>
<div class="paragraph">
<p>e.g. To persist cache entries to $HOME/foo/bar.dat:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>/subsystem=infinispan/cache-container=foo/local-cache=bar/store=file:add(path=foo, relative-to=user.home)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="jdbc-store">JDBC store</h5>
<div class="paragraph">
<p>A JDBC store persists cache entries to a database.</p>
</div>
<div class="paragraph">
<p>e.g. To persist cache entries to an H2 database via the ExampleDS data-source:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>/subsystem=infinispan/cache-container=foo/local-cache=bar/store=jdbc:add(data-source=ExampleDS, dialect=H2)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="remote-cache-store">Remote cache store</h5>
<div class="paragraph">
<p>A remote store persists cache entries to a set of remote Infinispan server instances via the HotRod protocol.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>/socket-binding-group=standard-sockets/remote-destination-outbound-socket-binding=node1:add(host=server1, port=1000)
/socket-binding-group=standard-sockets/remote-destination-outbound-socket-binding=node2:add(host=server2, port=1000)
/subsystem=infinispan/cache-container=foo/local-cache=bar/store=remote:add(remote-servers=[node1,node2])</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="state-transfer">State transfer</h4>
<div class="paragraph">
<p>The state transfer component defines the behavior for the initial transfer of state from remote caches on cache start.
State transfer is only applicable to distributed and replicated caches.
When configured with a timeout, a cache is only available after its initial state transfer completes.
If state transfer does not complete within the configured timeout, the cache will fail to start.</p>
</div>
<div class="paragraph">
<p>e.g. To configure a state-transfer timeout of 1 minute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>/subsystem=infinispan/cache-container=foo/local-cache=bar/component=state-transfer:add(timeout=60000)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, state transfer can be configured to be non-blocking, by configuring a timeout of 0.
While this prevents timeouts due to large state transfers, cache operations on the new node will require remote invocations to retrieve the requisite state until state transfer is complete.</p>
</div>
<div class="paragraph">
<p>e.g. To configure a non-blocking state transfer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>/subsystem=infinispan/cache-container=foo/local-cache=bar/component=state-transfer:add(timeout=0)</code></pre>
</div>
</div>
<div class="paragraph">
<p>For a complete list of state-transfer attributes, refer to the <a href="https://wildscribe.github.io/">WildFly management model documentation</a></p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="offloading_hotrod_store">Offloading session state to remote Infinispan Server cluster</h2>
<div class="sectionbody">
<div class="paragraph">
<p>While Infinispan project is used as a library internally by WildFly to provide data distribution, Infinispan project is also distributed in a standalone server mode.
The Infinispan Server cluster operates as a language-independent service accessed remotely over a number of protocols (HotRod, REST, etc).</p>
</div>
<div class="paragraph">
<p>HotRod is Infinispan&#8217;s custom optimized binary protocol which was designed to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>enable faster client/server interactions compared to other existing text-based protocols,</p>
</li>
<li>
<p>allow clients to make more intelligent decisions with regards to load-balancing, failover,</p>
</li>
<li>
<p>and provide advanced cache operations.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To learn more about the HotRod protocol itself and how to setup and run Infinispan Server,
refer to <a href="http://infinispan.org/documentation/">Infinispan documentation</a> for the appropriate version.</p>
</div>
<div class="paragraph">
<p>WildFly 13 introduced a custom optimized cache store based on HotRod protocol
and integrating with security features provided by WildFly&#8217;s Elytron subsystem.</p>
</div>
<div class="sect2">
<h3 id="remote_cache_container">Configuring remote cache container</h3>
<div class="paragraph">
<p>To configure <code>remote-cache-container</code> ensure you have a list of available Infinispan Server nodes.
The following example CLI script first adds socket bindings to two known Infinispan Server nodes,
followed by configuration of the cluster.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>batch
/socket-binding-group=standard-sockets/remote-destination-outbound-socket-binding=infinispan-server-1:add(host=server1.example.com,port=11622)
/socket-binding-group=standard-sockets/remote-destination-outbound-socket-binding=infinispan-server-2:add(host=server2.example.com,port=11722)
/subsystem=infinispan/remote-cache-container=web-sessions:add(default-remote-cluster=infinispan-server-cluster)
/subsystem=infinispan/remote-cache-container=web-sessions/remote-cluster=infinispan-server-cluster:add(socket-bindings=[infinispan-server-1,infinispan-server-2])
run-batch</code></pre>
</div>
</div>
<div class="paragraph">
<p>Upon reload, this will register necessary services for the client.
A HotRod client can be injected directly into Java EE applications using the <code>@Resource</code> annotation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Resource(lookup = "java:jboss/infinispan/remote-container/web-sessions")
private org.infinispan.client.hotrod.RemoteCacheContainer client;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="hotrod_store">Configuring HotRod store</h3>
<div class="paragraph">
<p>The HotRod store uses one dedicated remote cache for each cache created by the server.
For Infinispan Server versions supporting protocol version 2.7 and above (Infinispan Server version 9.2)
a persistent remote cache will be automatically created based on default configuration.
The recommended configuration for the remote cache where session data will be offloaded is transactional distribution mode cache with pessimistic locking.
When using Infinispan Server version prior to 9.2, the caches need to be configured manually on the server where cache names correspond to the deployment file names (e.g. <code>test.war</code>).</p>
</div>
<div class="paragraph">
<p>Once <code>remote-cache-container</code> is configured a <code>hotrod</code> store can be configured replacing any existing store.
The following CLI script demonstrates a typical use case for offloading sessions is in conjunction with the <code>invalidation-cache</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>batch
/subsystem=infinispan/cache-container=web/invalidation-cache=hotrod-persistence:add()
/subsystem=infinispan/cache-container=web/invalidation-cache=hotrod-persistence/store=hotrod:add(remote-cache-container=web-sessions,fetch-state=false,purge=false,passivation=false,shared=true)
/subsystem=infinispan/cache-container=web/invalidation-cache=hotrod-persistence/component=transaction:add(mode=BATCH)
/subsystem=infinispan/cache-container=web/invalidation-cache=hotrod-persistence/component=locking:add(isolation=REPEATABLE_READ)
/subsystem=infinispan/cache-container=web:write-attribute(name=default-cache,value=hotrod-persistence)
run-batch</code></pre>
</div>
</div>
<div class="paragraph">
<p>The script configures a new invalidation cache.
Session data is then maintained in the cache for performance and also written to the store for resilience.</p>
</div>
</div>
<div class="sect2">
<h3 id="hotrod_store_security">Security</h3>
<div class="paragraph">
<p>Securing the store is just a matter of configuring the <code>remote-cache-container</code> with SSL context.
Please follow the Elytron security guide on how to configure new SSL context
and <a href="http://infinispan.org/documentation/">Infinispan documentation</a> on how to secure Infinispan Server instances.</p>
</div>
<div class="paragraph">
<p>Once the SSL Context is configured, use the following CLI script to configure <code>remote-cache-container</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>/subsystem=infinispan/remote-cache-container=web-sessions/component=security:write-attribute(name=ssl-context,value=hotrod-ssl-context)</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="JGroups_Subsystem">JGroups Subsystem</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="jgroups-purpose">Purpose</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The JGroups subsystem provides group communication support for HA
services in the form of JGroups channels.</p>
</div>
<div class="paragraph">
<p>Named channel instances permit application peers in a cluster to
communicate as a group and in such a way that the communication
satisfies defined properties (e.g. reliable, ordered,
failure-sensitive). Communication properties are configurable for each
channel and are defined by the protocol stack used to create the
channel. Protocol stacks consist of a base transport layer (used to
transport messages around the cluster) together with a user-defined,
ordered stack of protocol layers, where each protocol layer supports a
given communication property.</p>
</div>
<div class="paragraph">
<p>The JGroups subsystem provides the following features:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>allows definition of named protocol stacks</p>
</li>
<li>
<p>view run-time metrics associated with channels</p>
</li>
<li>
<p>specify a default stack for general use</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In the following sections, we describe the JGroups subsystem.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
JGroups channels are created transparently as part of the clustering
functionality (e.g. on clustered application deployment, channels will
be created behind the scenes to support clustered features such as
session replication or transmission of SSO contexts around the cluster).
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="jgroups-configuration-example">Configuration example</h2>
<div class="sectionbody">
<div class="paragraph">
<p>What follows is a sample JGroups subsystem configuration showing all of
the possible elements and attributes which may be configured. We shall
use this example to explain the meaning of the various elements and
attributes.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
The schema for the subsystem, describing all valid elements and
attributes, can be found in the WildFly distribution, in the <code>docs/schema</code>
directory.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;subsystem xmlns="urn:jboss:domain:jgroups:6.0"&gt;
    &lt;channels default="ee"&gt;
        &lt;channel name="ee" stack="udp" cluster="ejb"/&gt;
    &lt;/channels&gt;
    &lt;stacks&gt;
        &lt;stack name="udp"&gt;
            &lt;transport type="UDP" socket-binding="jgroups-udp"/&gt;
            &lt;protocol type="PING"/&gt;
            &lt;protocol type="MERGE3"/&gt;
            &lt;protocol type="FD_SOCK"/&gt;
            &lt;protocol type="FD_ALL"/&gt;
            &lt;protocol type="VERIFY_SUSPECT"/&gt;
            &lt;protocol type="pbcast.NAKACK2"/&gt;
            &lt;protocol type="UNICAST3"/&gt;
            &lt;protocol type="pbcast.STABLE"/&gt;
            &lt;protocol type="pbcast.GMS"/&gt;
            &lt;protocol type="UFC"/&gt;
            &lt;protocol type="MFC"/&gt;
            &lt;protocol type="FRAG3"/&gt;
        &lt;/stack&gt;
        &lt;stack name="tcp"&gt;
            &lt;transport type="TCP" socket-binding="jgroups-tcp"/&gt;
            &lt;socket-protocol type="MPING" socket-binding="jgroups-mping"/&gt;
            &lt;protocol type="MERGE3"/&gt;
            &lt;protocol type="FD_SOCK"/&gt;
            &lt;protocol type="FD_ALL"/&gt;
            &lt;protocol type="VERIFY_SUSPECT"/&gt;
            &lt;protocol type="pbcast.NAKACK2"/&gt;
            &lt;protocol type="UNICAST3"/&gt;
            &lt;protocol type="pbcast.STABLE"/&gt;
            &lt;protocol type="pbcast.GMS"/&gt;
            &lt;protocol type="MFC"/&gt;
            &lt;protocol type="FRAG3"/&gt;
        &lt;/stack&gt;
    &lt;/stacks&gt;
&lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="subsystem">&lt;subsystem&gt;</h3>
<div class="paragraph">
<p>This element is used to configure the subsystem within a WildFly system
profile.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>xmlns</code> This attribute specifies the XML namespace of the JGroups
subsystem and, in particular, its version.</p>
</li>
<li>
<p><code>default-stack</code> This attribute is used to specify a default stack for
the JGroups subsystem. This default stack will be used whenever a stack
is required but no stack is specified.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="stack">&lt;stack&gt;</h3>
<div class="paragraph">
<p>This element is used to configure a JGroups protocol stack.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>name</code> This attribute is used to specify the name of the stack.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="jgroups-transport">&lt;transport&gt;</h3>
<div class="paragraph">
<p>This element is used to configure the transport layer (required) of the
protocol stack.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>type</code> This attribute specifies the transport type (e.g. UDP, TCP,
TCPGOSSIP)</p>
</li>
<li>
<p><code>socket-binding</code> This attribute references a defined socket binding in
the server profile. It is used when JGroups needs to create general
sockets internally.</p>
</li>
<li>
<p><code>diagnostics-socket-binding</code> This attribute references a defined
socket binding in the server profile. It is used when JGroups needs to
create sockets for use with the diagnostics program. For more about the
use of diagnostics, see the JGroups documentation for probe.sh.</p>
</li>
<li>
<p><code>default-executor</code> This attribute references a defined thread pool
executor in the threads subsystem. It governs the allocation and
execution of runnable tasks to handle incoming JGroups messages.</p>
</li>
<li>
<p><code>oob-executor</code> This attribute references a defined thread pool
executor in the threads subsystem. It governs the allocation and
execution of runnable tasks to handle incoming JGroups OOB
(out-of-bound) messages.</p>
</li>
<li>
<p><code>timer-executor</code> This attribute references a defined thread pool
executor in the threads subsystem. It governs the allocation and
execution of runnable timer-related tasks.</p>
</li>
<li>
<p><code>shared</code> This attribute indicates whether or not this transport is
shared amongst several JGroups stacks or not.</p>
</li>
<li>
<p><code>thread-factory</code> This attribute references a defined thread factory in
the threads subsystem. It governs the allocation of threads for running
tasks which are not handled by the executors above.</p>
</li>
<li>
<p><code>site</code> This attribute defines a site (data centre) id for this node.</p>
</li>
<li>
<p><code>rack</code> This attribute defines a rack (server rack) id for this node.</p>
</li>
<li>
<p><code>machine</code> This attribute defines a machine (host) is for this node.</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
site, rack and machine ids are used by the Infinispan topology-aware
consistent hash function, which when using dist mode, prevents dist mode
replicas from being stored on the same host, rack or site
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>.</p>
</div>
<div class="sect3">
<h4 id="property">&lt;property&gt;</h4>
<div class="paragraph">
<p>This element is used to configure a transport property.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>name</code> This attribute specifies the name of the protocol property. The
value is provided as text for the property element.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="protocol">&lt;protocol&gt;</h3>
<div class="paragraph">
<p>This element is used to configure a (non-transport) protocol layer in
the JGroups stack. Protocol layers are ordered within the stack.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>type</code> This attribute specifies the name of the JGroups protocol
implementation (e.g. MPING, pbcast.GMS), with the package prefix
org.jgroups.protocols removed.</p>
</li>
<li>
<p><code>socket-binding</code> This attribute references a defined socket binding in
the server profile. It is used when JGroups needs to create general
sockets internally for this protocol instance.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="relay">&lt;relay&gt;</h3>
<div class="paragraph">
<p>This element is used to configure the RELAY protocol for a JGroups
stack. RELAY is a protocol which provides cross-site replication between
defined sites (data centres). In the RELAY protocol, defined sites
specify the names of remote sites (backup sites) to which their data
should be backed up. Channels are defined between sites to permit the
RELAY protocol to transport the data from the current site to a backup
site.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>site</code> This attribute specifies the name of the current site. Site
names can be referenced elsewhere (e.g. in the JGroups remote-site
configuration elements, as well as backup configuration elements in the
Infinispan subsystem)</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="remote-site">&lt;remote-site&gt;</h4>
<div class="paragraph">
<p>This element is used to configure a remote site for the RELAY protocol.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>name</code> This attribute specifies the name of the remote site to which
this configuration applies.</p>
</li>
<li>
<p><code>stack</code> This attribute specifies a JGroups protocol stack to use for
communication between this site and the remote site.</p>
</li>
<li>
<p><code>cluster</code> This attribute specifies the name of the JGroups channel to
use for communication between this site and the remote site.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="jgroups-use-cases">Use Cases</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In many cases, channels will be configured via XML as in the example
above, so that the channels will be available upon server startup.
However, channels may also be added, removed or have their
configurations changed in a running server by making use of the WildFly
management API command-line interface (CLI). In this section, we present
some key use cases for the JGroups management API.</p>
</div>
<div class="paragraph">
<p>The key use cases covered are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>adding a stack</p>
</li>
<li>
<p>adding a protocol to an existing stack</p>
</li>
<li>
<p>adding a property to a protocol</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
The WildFly management API command-line interface (CLI) itself can be
used to provide extensive information on the attributes and commands
available in the JGroups subsystem interface used in these examples.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="add-a-stack">Add a stack</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>/subsystem=jgroups/stack=mystack:add(transport={}, protocols={})</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="add-a-protocol-to-a-stack">Add a protocol to a stack</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>/subsystem=jgroups/stack=mystack/transport=TRANSPORT:add(type=&lt;type&gt;, socket-binding=&lt;socketbinding&gt;)</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>/subsystem=jgroups/stack=mystack:add-protocol(type=&lt;type&gt;, socket-binding=&lt;socketbinding&gt;)</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="add-a-property-to-a-protocol">Add a property to a protocol</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>/subsystem=jgroups/stack=mystack/transport=TRANSPORT/property=&lt;property&gt;:add(value=&lt;value&gt;)</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="discovery-for-kubernetes">Discovery for Kubernetes</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>KUBE_PING</code> is a discovery protocol for JGroups cluster nodes managed by Kubernetes.
Since Kubernetes is in charge of launching nodes, it knows the addresses of all pods it started,
and is therefore an ideal place to ask for cluster discovery.
Discovery is therefore done by asking Kubernetes for a list of addresses of all cluster nodes.
Combined with <code>bind_port</code> / <code>port_range</code>, the protocol will then send a discovery request to all instances and wait for the responses.</p>
</div>
<div class="paragraph">
<p>To reconfigure an existing server profile with <code>KUBE_PING</code> use the following CLI batch replacing the namespace,
labels and stack name (<code>tcp</code>) with the target stack:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>batch
/subsystem=jgroups/stack=tcp/protocol=MPING:remove()
/subsystem=jgroups/stack=tcp/protocol=kubernetes.KUBE_PING:add(add-index=0,properties={namespace="production",labels="cluster=nyc"})
run-batch</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
To be able to query the Kubernetes server ensure view permissions are granted on the service account.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For advanced configuration options, please visit protocol&#8217;s documentation <a href="https://github.com/jgroups-extras/jgroups-kubernetes/blob/master/README.adoc">here</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mod_cluster_Subsystem">mod_cluster Subsystem</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The mod_cluster integration is done via the <code>mod_cluster</code> subsystem.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuration">Configuration</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="instance-id-or-jvmroute">Instance ID or JVMRoute</h3>
<div class="paragraph">
<p>The instance-id or JVMRoute defaults to <code>jboss.node.name</code> property passed
on server startup (e.g. via <code>-Djboss.node.name=XYZ</code>).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>[standalone@localhost:9990 /] /subsystem=undertow/:read-attribute(name=instance-id)
{
    "outcome" =&gt; "success",
    "result" =&gt; expression "${jboss.node.name}"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To configure instance-id statically, configure the corresponding
property in Undertow subsystem:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>[standalone@localhost:9990 /] /subsystem=undertow/:write-attribute(name=instance-id,value=myroute)
{
    "outcome" =&gt; "success",
    "response-headers" =&gt; {
        "operation-requires-reload" =&gt; true,
        "process-state" =&gt; "reload-required"
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="proxies">Proxies</h3>
<div class="paragraph">
<p>By default, mod_cluster is configured for multicast-based discovery. To
specify a static list of proxies, create a remote-socket-binding for
each proxy and then reference them in the 'proxies' attribute. See the
following example for configuration in the domain mode:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>[domain@localhost:9990 /] /socket-binding-group=ha-sockets/remote-destination-outbound-socket-binding=proxy1:add(host=10.21.152.86, port=6666)
{
    "outcome" =&gt; "success",
    "result" =&gt; undefined,
    "server-groups" =&gt; undefined
}
[domain@localhost:9990 /] /socket-binding-group=ha-sockets/remote-destination-outbound-socket-binding=proxy2:add(host=10.21.152.87, port=6666)
{
    "outcome" =&gt; "success",
    "result" =&gt; undefined,
    "server-groups" =&gt; undefined
}
[domain@localhost:9990 /] /profile=ha/subsystem=modcluster/mod-cluster-config=configuration/:write-attribute(name=proxies, value=[proxy1, proxy2])
{
    "outcome" =&gt; "success",
    "result" =&gt; undefined,
    "server-groups" =&gt; undefined
}
[domain@localhost:9990 /] :reload-servers
{
    "outcome" =&gt; "success",
    "result" =&gt; undefined,
    "server-groups" =&gt; undefined
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="runtime-operations">Runtime Operations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The modcluster subsystem supports several operations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>[standalone@localhost:9999 subsystem=modcluster] :read-operation-names
{
    "outcome" =&gt; "success",
    "result" =&gt; [
        "add",
        "add-custom-metric",
        "add-metric",
        "add-proxy",
        "disable",
        "disable-context",
        "enable",
        "enable-context",
        "list-proxies",
        "read-attribute",
        "read-children-names",
        "read-children-resources",
        "read-children-types",
        "read-operation-description",
        "read-operation-names",
        "read-proxies-configuration",
        "read-proxies-info",
        "read-resource",
        "read-resource-description",
        "refresh",
        "remove-custom-metric",
        "remove-metric",
        "remove-proxy",
        "reset",
        "stop",
        "stop-context",
        "validate-address",
        "write-attribute"
    ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The operations specific to the modcluster subsystem are divided in 3
categories the ones that affects the configuration and require a restart
of the subsystem, the one that just modify the behaviour temporarily and
the ones that display information from the httpd part.</p>
</div>
<div class="sect2">
<h3 id="operations-displaying-httpd-informations">operations displaying httpd information</h3>
<div class="paragraph">
<p>There are 2 operations that display how Apache httpd sees the node:</p>
</div>
<div class="sect3">
<h4 id="read-proxies-configuration">read-proxies-configuration</h4>
<div class="paragraph">
<p>Send a DUMP message to all Apache httpd the node is connected to and
display the message received from Apache httpd.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>[standalone@localhost:9999 subsystem=modcluster] :read-proxies-configuration
{
    "outcome" =&gt; "success",
    "result" =&gt; [
        "neo3:6666",
        "balancer: [1] Name: mycluster Sticky: 1 [JSESSIONID]/[jsessionid] remove: 0 force: 1 Timeout: 0 Maxtry: 1
node: [1:1],Balancer: mycluster,JVMRoute: 498bb1f0-00d9-3436-a341-7f012bc2e7ec,Domain: [],Host: 127.0.0.1,Port: 8080,Type: http,flushpackets: 0,flushwait: 10,ping: 10,smax: 26,ttl: 60,timeout: 0
host: 1 [example.com] vhost: 1 node: 1
host: 2 [localhost] vhost: 1 node: 1
host: 3 [default-host] vhost: 1 node: 1
context: 1 [/myapp] vhost: 1 node: 1 status: 1
context: 2 [/] vhost: 1 node: 1 status: 1
",
        "jfcpc:6666",
        "balancer: [1] Name: mycluster Sticky: 1 [JSESSIONID]/[jsessionid] remove: 0 force: 1 Timeout: 0 maxAttempts: 1
node: [1:1],Balancer: mycluster,JVMRoute: 498bb1f0-00d9-3436-a341-7f012bc2e7ec,LBGroup: [],Host: 127.0.0.1,Port: 8080,Type: http,flushpackets: 0,flushwait: 10,ping: 10,smax: 26,ttl: 60,timeout: 0
host: 1 [default-host] vhost: 1 node: 1
host: 2 [localhost] vhost: 1 node: 1
host: 3 [example.com] vhost: 1 node: 1
context: 1 [/] vhost: 1 node: 1 status: 1
context: 2 [/myapp] vhost: 1 node: 1 status: 1
"
    ]
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="read-proxies-info">read-proxies-info</h4>
<div class="paragraph">
<p>Send a INFO message to all Apache httpd the node is connected to and
display the message received from Apache httpd.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>[standalone@localhost:9999 subsystem=modcluster] :read-proxies-info
{
    "outcome" =&gt; "success",
    "result" =&gt; [
        "neo3:6666",
        "Node: [1],Name: 498bb1f0-00d9-3436-a341-7f012bc2e7ec,Balancer: mycluster,Domain: ,Host: 127.0.0.1,Port: 8080,Type: http,Flushpackets: Off,Flushwait: 10000,Ping: 10000000,Smax: 26,Ttl: 60000000,Elected: 0,Read: 0,Transfered: 0,Connected: 0,Load: -1
Vhost: [1:1:1], Alias: example.com
Vhost: [1:1:2], Alias: localhost
Vhost: [1:1:3], Alias: default-host
Context: [1:1:1], Context: /myapp, Status: ENABLED
Context: [1:1:2], Context: /, Status: ENABLED
",
        "jfcpc:6666",
        "Node: [1],Name: 498bb1f0-00d9-3436-a341-7f012bc2e7ec,Balancer: mycluster,LBGroup: ,Host: 127.0.0.1,Port: 8080,Type: http,Flushpackets: Off,Flushwait: 10,Ping: 10,Smax: 26,Ttl: 60,Elected: 0,Read: 0,Transfered: 0,Connected: 0,Load: 1
Vhost: [1:1:1], Alias: default-host
Vhost: [1:1:2], Alias: localhost
Vhost: [1:1:3], Alias: example.com
Context: [1:1:1], Context: /, Status: ENABLED
Context: [1:1:2], Context: /myapp, Status: ENABLED
"
    ]
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="operations-that-handle-the-proxies-the-node-is-connected-too">operations that handle the proxies the node is connected too</h4>
<div class="paragraph">
<p>There are 3 operation that could be used to manipulate the list of
Apache httpd the node is connected to.</p>
</div>
</div>
<div class="sect3">
<h4 id="list-proxies">list-proxies</h4>
<div class="paragraph">
<p>Displays the httpd that are connected to the node. The httpd could be
discovered via the Advertise protocol or via the proxy-list attribute.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>[standalone@localhost:9999 subsystem=modcluster] :list-proxies
{
    "outcome" =&gt; "success",
    "result" =&gt; [
        "proxy1:6666",
        "proxy2:6666"
    ]
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="remove-proxy">remove-proxy</h4>
<div class="paragraph">
<p>Remove a proxy from the discovered proxies or temporarily from the
proxy-list attribute.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>[standalone@localhost:9999 subsystem=modcluster] :remove-proxy(host=jfcpc, port=6666)
{"outcome" =&gt; "success"}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="add-proxy">add-proxy</h4>
<div class="paragraph">
<p>Add a proxy to the discovered proxies or temporarily to the proxy-list
attribute.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>[standalone@localhost:9999 subsystem=modcluster] :add-proxy(host=jfcpc, port=6666)
{"outcome" =&gt; "success"}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="context-related-operations">Context related operations</h3>
<div class="paragraph">
<p>Those operations allow to send context related commands to Apache httpd.
They are send automatically when deploying or undeploying webapps.</p>
</div>
<div class="sect3">
<h4 id="enable-context">enable-context</h4>
<div class="paragraph">
<p>Tell Apache httpd that the context is ready receive requests.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>[standalone@localhost:9999 subsystem=modcluster] :enable-context(context=/myapp, virtualhost=default-host)
{"outcome" =&gt; "success"}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="disable-context">disable-context</h4>
<div class="paragraph">
<p>Tell Apache httpd that it shouldn&#8217;t send new session requests to the
context of the virtualhost.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>[standalone@localhost:9999 subsystem=modcluster] :disable-context(context=/myapp, virtualhost=default-host)
{"outcome" =&gt; "success"}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="stop-context">stop-context</h4>
<div class="paragraph">
<p>Tell Apache httpd that it shouldn&#8217;t send requests to the context of the
virtualhost.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>[standalone@localhost:9999 subsystem=modcluster] :stop-context(context=/myapp, virtualhost=default-host, waittime=50)
{"outcome" =&gt; "success"}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="node-related-operations">Node related operations</h3>
<div class="paragraph">
<p>Those operations are like the context operation but they apply to all
webapps running on the node and operation that affect the whole node.</p>
</div>
<div class="sect3">
<h4 id="refresh">refresh</h4>
<div class="paragraph">
<p>Refresh the node by sending a new CONFIG message to Apache httpd.</p>
</div>
</div>
<div class="sect3">
<h4 id="reset">reset</h4>
<div class="paragraph">
<p>Reset the connection between Apache httpd and the node.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuration-1">Configuration</h3>
<div class="sect3">
<h4 id="metric-configuration">Metric configuration</h4>
<div class="paragraph">
<p>There are 4 metric operations corresponding to add and remove load
metrics to the dynamic-load-provider. Note that when nothing is defined
a simple-load-provider is use with a fixed load factor of one.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>[standalone@localhost:9999 subsystem=modcluster] :read-resource(name=mod-cluster-config)
{
    "outcome" =&gt; "success",
    "result" =&gt; {"simple-load-provider" =&gt; {"factor" =&gt; "1"}}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>that corresponds to the following configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;subsystem xmlns="urn:jboss:domain:modcluster:1.0"&gt;
            &lt;mod-cluster-config&gt;
                &lt;simple-load-provider factor="1"/&gt;
            &lt;/mod-cluster-config&gt;
 &lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="add-metric">add-metric</h5>
<div class="paragraph">
<p>Add a metric to the dynamic-load-provider, the dynamic-load-provider in
configuration is created if needed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">[standalone@localhost:9999 subsystem=modcluster] :add-metric(type=cpu)
{"outcome" =&gt; "success"}
[standalone@localhost:9999 subsystem=modcluster] :read-resource(name=mod-cluster-config)
{
    "outcome" =&gt; "success",
    "result" =&gt; {
        "dynamic-load-provider" =&gt; {
            "history" =&gt; 9,
            "decay" =&gt; 2,
            "load-metric" =&gt; [{
                "type" =&gt; "cpu"
            }]
        }
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="remove-metric">remove-metric</h5>
<div class="paragraph">
<p>Remove a metric from the dynamic-load-provider.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>[standalone@localhost:9999 subsystem=modcluster] :remove-metric(type=cpu)
{"outcome" =&gt; "success"}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="add-custom-metric-remove-custom-metric">add-custom-metric / remove-custom-metric</h5>
<div class="paragraph">
<p>like the add-metric and remove-metric except they require a class
parameter instead the type. Usually they needed additional properties
which can be specified</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>[standalone@localhost:9999 subsystem=modcluster] :add-custom-metric(class=myclass, property=[("pro1" =&gt; "value1"), ("pro2" =&gt; "value2")]
{"outcome" =&gt; "success"}</code></pre>
</div>
</div>
<div class="paragraph">
<p>which corresponds the following in the xml configuration file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;subsystem xmlns="urn:jboss:domain:modcluster:1.0"&gt;
            &lt;mod-cluster-config&gt;
                &lt;dynamic-load-provider history="9" decay="2"&gt;
                    &lt;custom-load-metric class="myclass"&gt;
                        &lt;property name="pro1" value="value1"/&gt;
                        &lt;property name="pro2" value="value2"/&gt;
                    &lt;/custom-load-metric&gt;
                &lt;/dynamic-load-provider&gt;
            &lt;/mod-cluster-config&gt;
&lt;/subsystem&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="SSL_Configuration_using_Elytron_Subsystem">SSL Configuration using Elytron Subsystem</h3>
<div class="quoteblock abstract">
<blockquote>
This document provides information how to configure mod_cluster
subsystem to protect communication between mod_cluster and load balancer
using SSL/TLS using <a href="WildFly_Elytron_Security.html#Elytron_Subsystem">Elytron Subsystem</a>.
</blockquote>
</div>
</div>
<div class="sect2">
<h3 id="overview">Overview</h3>
<div class="paragraph">
<p>Elytron subsystem provides a powerful and flexible model to configure
different security aspects for applications and the application server
itself. At its core, Elytron subsystem exposes different capabilities to
the application server in order centralize security related
configuration in a single place and to allow other subsystems to consume
these capabilities. One of the security capabilities exposed by Elytron
subsystem is a Client <code>ssl-context</code> that can be used to configure
mod_cluster subsystem to communicate with a load balancer using SSL/TLS.</p>
</div>
<div class="paragraph">
<p>When protecting the communication between the application server and the
load balancer, you need do define a Client <code>ssl-context</code> in order to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Define a trust store holding the certificate chain that will be used
to validate load balancer&#8217;s certificate</p>
</li>
<li>
<p>Define a trust manager to perform validations against the load
balancer&#8217;s certificate</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="defining-a-trust-store-with-the-trusted-certificates">Defining a Trust Store with the Trusted Certificates</h3>
<div class="paragraph">
<p>To define a trust store in Elytron you can execute the following CLI
command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>[standalone@localhost:9990 /] /subsystem=elytron/key-store=default-trust-store:add(type=JKS, relative-to=jboss.server.config.dir, path=application.truststore, credential-reference={clear-text=password})</code></pre>
</div>
</div>
<div class="paragraph">
<p>In order to successfully execute the command above you must have a
<strong>application.truststore</strong> file inside your
<strong>JBOSS_HOME/standalone/configuration</strong> directory. Where the trust store
is protected by a password with a value <strong>password</strong>. The trust store must
contain the certificates associated with the load balancer or a
certificate chain in case the load balancer&#8217;s certificate is signed by a
CA.</p>
</div>
<div class="paragraph">
<p>We strongly recommend you to avoid using self-signed certificates with
your load balancer. Ideally, certificates should be signed by a CA and
your trust store should contain a certificate chain representing your
ROOT and Intermediary CAs.</p>
</div>
</div>
<div class="sect2">
<h3 id="defining-a-trust-manager-to-validate-certificates">Defining a Trust Manager To Validate Certificates</h3>
<div class="paragraph">
<p>To define a trust manager in Elytron you can execute the following CLI
command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>[standalone@localhost:9990 /] /subsystem=elytron/trust-managers=default-trust-manager:add(algorithm=PKIX, key-store=default-trust-store)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we are setting the <strong>default-trust-store</strong> as the source of the
certificates that the application server trusts.</p>
</div>
</div>
<div class="sect2">
<h3 id="defining-a-client-ssl-context-and-configuring-mod_cluster-subsystem">Defining a Client SSL Context and Configuring mod_cluster Subsystem</h3>
<div class="paragraph">
<p>Finally, you can create the Client SSL Context that is going to be used
by the mod_cluster subsystem when connecting to the load balancer using
SSL/TLS:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>[standalone@localhost:9990 /] /subsystem=elytron/client-ssl-context=modcluster-client-ssl-context:add(trust-managers=default-trust-manager)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that the Client <code>ssl-context</code> is defined you can configure
mod_cluster subsystem as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>[standalone@localhost:9990 /] /subsystem=modcluster/mod-cluster-config=configuration:write-attribute(name=ssl-context, value=modcluster-client-ssl-context)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once you execute the last command above, reload the server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>[standalone@localhost:9990 /] reload</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="using-a-certificate-revocation-list">Using a Certificate Revocation List</h3>
<div class="paragraph">
<p>In case you want to validate the load balancer certificate against a
Certificate Revocation List (CRL), you can configure the <code>trust-manager</code>
in Elytron subsystem as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>[standalone@localhost:9990 /] /subsystem=elytron/trust-managers=default-trust-manager:write-attribute(name=certificate-revocation-list.path, value=intermediate.crl.pem)</code></pre>
</div>
</div>
<div class="paragraph">
<p>To use a CRL your trust store must contain the certificate chain in
order to check validity of both CRL list and the load balancer`s
certificate.</p>
</div>
<div class="paragraph">
<p>A different way to configure a CRL is using the <em>Distribution Points</em>
embedded in your certificates. For that, you need to configure a
<code>certificate-revocation-list</code> as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>/subsystem=elytron/trust-managers=default-trust-manager:write-attribute(name=certificate-revocation-list)</code></pre>
</div>
</div>
</div>
</div>
</div>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/wildflysite/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Wildfly</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Wildfly</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/wildfly"><svg class="svg-icon"><use xlink:href="/wildflysite/assets/minima-social-icons.svg#github"></use></svg> <span class="username">wildfly</span></a></li><li><a href="https://www.twitter.com/WildFlyAS"><svg class="svg-icon"><use xlink:href="/wildflysite/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">WildFlyAS</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p></p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
