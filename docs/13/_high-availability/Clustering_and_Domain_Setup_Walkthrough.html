<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Clustering and Domain Setup Walkthrough | Wildfly</title>
<meta name="generator" content="Jekyll v3.8.3" />
<meta property="og:title" content="Clustering and Domain Setup Walkthrough" />
<meta property="og:locale" content="en_US" />
<link rel="canonical" href="https://jbossorg.github.io/wildflysite/docs/13/_high-availability/Clustering_and_Domain_Setup_Walkthrough.html" />
<meta property="og:url" content="https://jbossorg.github.io/wildflysite/docs/13/_high-availability/Clustering_and_Domain_Setup_Walkthrough.html" />
<meta property="og:site_name" content="Wildfly" />
<script type="application/ld+json">
{"@type":"WebPage","url":"https://jbossorg.github.io/wildflysite/docs/13/_high-availability/Clustering_and_Domain_Setup_Walkthrough.html","headline":"Clustering and Domain Setup Walkthrough","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/wildflysite/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://jbossorg.github.io/wildflysite/feed.xml" title="Wildfly" /></head>
<body><div class="header navigation">
  <div class="logo-wrapper">
    <a href="/wildflysite/"><img class="wf-logo" src="/wildflysite/assets/img/wildfly_icons_one-color-logo.png"></a>
  </div>
  <div class="nav-container">
    <nav>
      <div class="nav-mobile"><a id="nav-toggle" href="#!"><span></span></a></div>
      <ul class="nav-list">
        <li>
          <a href="/wildflysite/" class="">Home</a>
        </li>
        <li>
          <a href="/wildflysite/downloads/" class="">Downloads</a>
        </li>
        <li>
          <a href="/wildflysite/blog/" class="">Blog</a>
        </li>
        <li>
          <a href="/wildflysite/about/" class="">About</a>
        </li>
        <li>
          <a href="/wildflysite/contribute/" class="">Contribute</a>
        </li>
        <li>
          <a href="/wildflysite/docs/" class="">Docs</a>
        </li>
        <li>
          <a class="button-cta secondary" href="https://github.com/wildfly/wildfly/fork" target="_blank">Fork</a>
        </li>
      </ul>
    </nav>
  </div>
</div>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In this article, I&#8217;d like to show you how to setup WildFly in domain
mode and enable clustering so we could get HA and session replication
among the nodes. It&#8217;s a step to step guide so you can follow the
instructions in this article and build the sandbox by yourself.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="preparation-scenario">Preparation &amp; Scenario</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="preparation">Preparation</h3>
<div class="paragraph">
<p>We need to prepare two hosts (or virtual hosts) to do the experiment. We
will use these two hosts as following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Install Fedora on them (Other linux version may also fine but I&#8217;ll
use Fedora in this article)</p>
</li>
<li>
<p>Make sure that they are in same local network</p>
</li>
<li>
<p>Make sure that they can access each other via different TCP/UDP
ports (better turn off firewall and disable SELinux during the experiment
or they will cause network problems).</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="scenario">Scenario</h3>
<div class="paragraph">
<p>Here are some details on what we are going to do:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Let&#8217;s call one host as 'master', the other one as 'slave'.</p>
</li>
<li>
<p>Both master and slave will run WildFly, and master will run as
domain controller, slave will under the domain management of master.</p>
</li>
<li>
<p>Apache httpd will be run on master, and in httpd we will enable the
mod_cluster module. The WildFly on master and slave will form a
cluster and discovered by httpd.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><span class="image"><img src="/wildflysite/assets/img/posts/clustering/Clustering.jpg" alt="images/clustering/Clustering.jpg"></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>We will deploy a demo project into domain, and verify that the project
is deployed into both master and slave by domain controller. Thus we
could see that domain management provide us a single point to manage the
deployments across multiple hosts in a single domain.</p>
</li>
<li>
<p>We will access the cluster URL and verify that httpd has distributed
the request to one of the WildFly host. So we could see the cluster is
working properly.</p>
</li>
<li>
<p>We will try to make a request on cluster, and if the request is
forwarded to master, we then kill the WildFly process on master. After
that we will go on requesting cluster and we should see the request is
forwarded to slave, but the session is not lost. Our goal is to verify
the HA is working and sessions are replicated.</p>
</li>
<li>
<p>After previous step finished, we reconnect the master by restarting
it. We should see the master is registered back into cluster, also we
should see slave sees master as domain controller again and connect to
it.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><span class="image"><img src="/wildflysite/assets/img/posts/clustering/test_scenario.jpg" alt="images/clustering/test_scenario.jpg"></span></p>
</div>
<div class="paragraph">
<p>Please don&#8217;t worry if you cannot digest so many details currently. Let&#8217;s
move on and you will get the points step by step.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="download-wildfly">Download WildFly</h2>
<div class="sectionbody">
<div class="paragraph">
<p>First we should download WildFly from the <a href="http://wildfly.org/downloads/">WildFly website</a>.</p>
</div>
<div class="paragraph">
<p>Then I unzipped the package to master and try to make a test run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">unzip wildfly-{wildflyVersion}.0.0.Final.zip
cd wildfly-{wildflyVersion}.0.0.Final/bin
./domain.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>If everything ok we should see WildFly successfully startup in domain
mode:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">wildfly-{wildflyVersion}.0.0.Final/bin$ ./domain.sh
=========================================================================
 
  JBoss Bootstrap Environment
 
  JBOSS_HOME: /Users/weli/Downloads/wildfly-{wildflyVersion}.0.0.Final
 
  JAVA: /Library/Java/Home/bin/java
 
  JAVA_OPTS: -Xms64m -Xmx512m -XX:MaxPermSize=256m -Djava.net.preferIPv4Stack=true -Dorg.jboss.resolver.warning=true -Dsun.rmi.dgc.client.gcInterval=3600000 -Dsun.rmi.dgc.server.gcInterval=3600000 -Djboss.modules.system.pkgs=org.jboss.byteman -Djava.awt.headless=true
 
=========================================================================
...
 
[Server:server-two] 14:46:12,375 INFO  [org.jboss.as] (Controller Boot Thread) JBAS015874: WildFly {wildflyVersion}.0.0.Final "Kenny" started in 8860ms - Started 210 of 258 services (8{wildflyVersion} services are lazy, passive or on-demand)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now exit master and let&#8217;s repeat the same steps on slave host. Finally
we get WildFly run on both master and slave, then we could move on to
next step.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="domain-configuration">Domain Configuration</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="interface-config-on-master">Interface config on master</h3>
<div class="paragraph">
<p>In this section we&#8217;ll setup both master and slave for them to run in
domain mode. And we will configure master to be the domain controller.</p>
</div>
<div class="paragraph">
<p>First open the host.xml in master for editing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">vi domain/configuration/host.xml</code></pre>
</div>
</div>
<div class="paragraph">
<p>The default settings for interface in this file is like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;interfaces&gt;
    &lt;interface name="management"&gt;
        &lt;inet-address value="${jboss.bind.address.management:127.0.0.1}"/&gt;
    &lt;/interface&gt;
    &lt;interface name="public"&gt;
       &lt;inet-address value="${jboss.bind.address:127.0.0.1}"/&gt;
    &lt;/interface&gt;
    &lt;interface name="unsecured"&gt;       
       &lt;inet-address value="127.0.0.1" /&gt;    
    &lt;/interface&gt;
&lt;/interfaces&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We need to change the address to the management interface so slave could
connect to master. The public interface allows the application to be
accessed by non-local HTTP, and the unsecured interface allows remote
RMI access. My master&#8217;s ip address is 10.211.55.7, so I change the
config to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;interfaces&gt;
    &lt;interface name="management"
        &lt;inet-address value="${jboss.bind.address.management:10.211.55.7}"/&gt;
    &lt;/interface&gt;
    &lt;interface name="public"&gt;
       &lt;inet-address value="${jboss.bind.address:10.211.55.7}"/&gt;
    &lt;/interface&gt;    
    &lt;interface name="unsecured"&gt;
       &lt;inet-address value="10.211.55.7" /&gt;    
    &lt;/interface&gt;
&lt;/interfaces&gt; </code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="interface-config-on-slave">Interface config on slave</h3>
<div class="paragraph">
<p>Now we will setup interfaces on slave. Let&#8217;s edit host.xml. Similar to
the steps on master, open host.xml first:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">vi domain/configuration/host.xml</code></pre>
</div>
</div>
<div class="paragraph">
<p>The configuration we&#8217;ll use on slave is a little bit different, because
we need to let slave connect to master. First we need to set the
hostname. We change the name property from:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;host name="master" xmlns="urn:jboss:domain:3.0"&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;host name="slave" xmlns="urn:jboss:domain:3.0"&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we need to modify domain-controller section so slave can connect to
master&#8217;s management port:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;domain-controller&gt;
   &lt;remote protocol="remote" host="10.211.55.7" port="9999" /&gt;
&lt;/domain-controller&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As we know, 10.211.55.7 is the ip address of master.
You may use discovery options to define multiple mechanisms to connect
to the remote domain controller :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;domain-controller&gt;
 &lt;remote security-realm="ManagementRealm" &gt;
   &lt;discovery-options&gt;
     &lt;static-discovery name="master-native" protocol="remote"  host="10.211.55.7" port=9999" /&gt;
     &lt;static-discovery name="master-https" protocol="https-remoting" host="10.211.55.7" port="9993" security-realm="ManagementRealm"/&gt;
     &lt;static-discovery name="master-http" protocol="http-remoting" host="10.211.55.7" port="9990" /&gt;
   &lt;/discovery-options&gt;
 &lt;/remote&gt;
&lt;/domain-controller&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, we also need to configure interfaces section and expose the
management ports to public address:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;interfaces&gt;
    &lt;interface name="management"&gt;
        &lt;inet-address value="${jboss.bind.address.management:10.211.55.2}"/&gt;
    &lt;/interface&gt;
    &lt;interface name="public"&gt;
       &lt;inet-address value="${jboss.bind.address:10.211.55.2}"/&gt;
    &lt;/interface&gt;
    &lt;interface name="unsecured"&gt;       
       &lt;inet-address value="10.211.55.2" /&gt;    
    &lt;/interface&gt;
&lt;/interfaces&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>10.211.55.2 is the ip address of the slave. Refer to the domain
controller configuration above for an explanation of the management,
public, and unsecured interfaces.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
It is easier to turn off all firewalls for testing, but in production,
you need to enable the firewall and allow access to the following ports:
9999.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="security-configuration">Security Configuration</h3>
<div class="paragraph">
<p>If you start WildFly on both master and slave now, you will see the
slave cannot be started with following error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>[Host Controller] 20:31:24,575 ERROR [org.jboss.remoting.remote] (Remoting "endpoint" read-1) JBREM000200: Remote connection failed: javax.security.sasl.SaslException: Authentication failed: all available authentication mechanisms failed
[Host Controller] 20:31:24,579 WARN  [org.jboss.as.host.controller] (Controller Boot Thread) JBAS010900: Could not connect to remote domain controller 10.211.55.7:9999
[Host Controller] 20:31:24,582 ERROR [org.jboss.as.host.controller] (Controller Boot Thread) JBAS010901: Could not connect to master. Aborting. Error was: java.lang.IllegalStateException: JBAS010942: Unable to connect due to authentication failure.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Because we haven&#8217;t properly set up the authentication between master and
slave. Now let&#8217;s work on it:</p>
</div>
<div class="sect3">
<h4 id="master">Master</h4>
<div class="paragraph">
<p>In bin directory there is a script called add-user.sh, we&#8217;ll use it to
add new users to the properties file used for domain management
authentication:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">./add-user.sh
 
Enter the details of the new user to add.
Realm (ManagementRealm) :
Username : admin
Password recommendations are listed below. To modify these restrictions edit the add-user.properties configuration file.
 - The password should not be one of the following restricted values {root, admin, administrator}
 - The password should contain at least 8 characters, 1 alphabetic character(s), 1 digit(s), 1 non-alphanumeric symbol(s)
 - The password should be different from the username
Password : passw0rd!
Re-enter Password : passw0rd!
The username 'admin' is easy to guess
Are you sure you want to add user 'admin' yes/no? yes
About to add user 'admin' for realm 'ManagementRealm'
Is this correct yes/no? yes
Added user 'admin' to file '/home/weli/projs/wildfly-{wildflyVersion}.0.0.Final/standalone/configuration/mgmt-users.properties'
Added user 'admin' to file '/home/weli/projs/wildfly-{wildflyVersion}.0.0.Final/domain/configuration/mgmt-users.properties'</code></pre>
</div>
</div>
<div class="paragraph">
<p>As shown above, we have created a user named 'admin' and its password is
'passw0rd!'. Then we add another user called 'slave':</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">./add-user.sh
 
Enter the details of the new user to add.
Realm (ManagementRealm) :
Username : slave
Password recommendations are listed below. To modify these restrictions edit the add-user.properties configuration file.
 - The password should not be one of the following restricted values {root, admin, administrator}
 - The password should contain at least 8 characters, 1 alphabetic character(s), 1 digit(s), 1 non-alphanumeric symbol(s)
 - The password should be different from the username
Password : passw0rd!
Re-enter Password : passw0rd!
What groups do you want this user to belong to? (Please enter a comma separated list, or leave blank for none)[  ]:
About to add user 'slave' for realm 'ManagementRealm'
Is this correct yes/no? yes
Added user 'slave' to file '/home/weli/projs/wildfly-{wildflyVersion}.0.0.Final/standalone/configuration/mgmt-users.properties'
Added user 'slave' to file '/home/weli/projs/wildfly-{wildflyVersion}.0.0.Final/domain/configuration/mgmt-users.properties'
Added user 'slave' with groups  to file '/home/weli/projs/wildfly-{wildflyVersion}.0.0.Final/standalone/configuration/mgmt-groups.properties'
Added user 'slave' with groups  to file '/home/weli/projs/wildfly-{wildflyVersion}.0.0.Final/domain/configuration/mgmt-groups.properties'
Is this new user going to be used for one AS process to connect to another AS process?
e.g. for a slave host controller connecting to the master or for a Remoting connection for server to server EJB calls.
yes/no? yes
To represent the user add the following to the server-identities definition &lt;secret value="cGFzc3cwcmQh" /&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We will use this user for slave host to connect to master. The
add-user.sh will let you choose the type of the user. Here we need to
choose 'Management User' type for both 'admin' and 'slave' account.</p>
</div>
</div>
<div class="sect3">
<h4 id="slave">Slave</h4>
<div class="paragraph">
<p>In slave we need to configure host.xml for authentication. We should
change the security-realms section as following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">&lt;security-realms&gt;
   &lt;security-realm name="ManagementRealm"&gt;
       &lt;server-identities&gt;
           &lt;secret value="cGFzc3cwcmQh" /&gt;
           &lt;!-- This is required for SSL remoting --&gt;
           &lt;ssl&gt;
             &lt;keystore path="server.keystore" relative-to="jboss.domain.config.dir" keystore-password="jbossas" alias="jboss" key-password="jbossas"/&gt;
           &lt;/ssl&gt;
       &lt;/server-identities&gt;
       &lt;authentication&gt;
           &lt;properties path="mgmt-users.properties" relative-to="jboss.domain.config.dir"/&gt;
       &lt;/authentication&gt;
   &lt;/security-realm&gt;
&lt;/security-realms&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;ve added server-identities into security-realm, which is used for
authentication host when slave tries to connect to master. In secret
value property we have 'cGFzc3cwcmQh', which is the base64 code for
'passw0rd!'. You can generate this value by using a base64 calculator
such as the one at <a href="http://www.webutils.pl/index.php?idx=base64" class="bare">http://www.webutils.pl/index.php?idx=base64</a>.</p>
</div>
<div class="paragraph">
<p>Then in domain controller section we also need to add security-realm
property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;domain-controller&gt;
   &lt;remote protocol="remote" host="10.211.55.7" port="9999" username="slave" security-realm="ManagementRealm"  /&gt;
&lt;/domain-controller&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>So the slave host could use the authentication information we provided
in 'ManagementRealm'.</p>
</div>
</div>
<div class="sect3">
<h4 id="dry-run">Dry Run</h4>
<div class="paragraph">
<p>Now everything is set for the two hosts to run in domain mode. Let&#8217;s
start them by running domain.sh on both hosts. If everything goes fine,
we could see from the log on master:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">[Host Controller] 21:30:52,042 INFO  [org.jboss.as.domain] (management-handler-threads - 1) JBAS010918: Registered remote slave host slave</code></pre>
</div>
</div>
<div class="paragraph">
<p>That means all the configurations are correct and two hosts are run in
domain mode now as expected. Hurrah!</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deployment">Deployment</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now we can deploy a demo project into the domain. I have created a
simple project located at:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">https://github.com/liweinan/cluster-demo</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can use git command to fetch a copy of the demo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">git clone git://github.com/liweinan/cluster-demo.git</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this demo project we have a very simple web application. In web.xml
we&#8217;ve enabled session replication by adding following entry:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;distributable/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>And it contains a jsp page called put.jsp which will put current time to
a session entry called 'current.time':</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">&lt;%
    session.setAttribute("current.time", new java.util.Date());
%&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we could fetch this value from get.jsp:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">The time is &lt;%= session.getAttribute("current.time") %&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s an extremely simple project but it could help us to test the
cluster later: We will access put.jsp from cluster and see the request
are distributed to master, then we disconnect master and access get.jsp.
We should see the request is forwarded to slave but the 'current.time'
value is held by session replication. We&#8217;ll cover more details on this
one later.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s go back to this demo project. Now we need to create a war from it.
In the project directory, run the following command to get the war:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>mvn package</code></pre>
</div>
</div>
<div class="paragraph">
<p>It will generate cluster-demo.war. Then we need to deploy the war into
domain. First we should access the http management console on
master(Because master is acting as domain controller):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>http://10.211.55.7:9990</code></pre>
</div>
</div>
<div class="paragraph">
<p>It will popup a windows ask you to input account name and password, we
can use the 'admin' account we&#8217;ve added just now. After logging in we
could see the 'Server Instances' window. By default there are three
servers listed, which are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>server-one</p>
</li>
<li>
<p>server-two</p>
</li>
<li>
<p>server-three</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We could see server-one and server-two are in running status and they
belong to main-server-group; server-three is in idle status, and it
belongs to other-server-group.</p>
</div>
<div class="paragraph">
<p>All these servers and server groups are set in domain.xml on master as7.
What we are interested in is the 'other-server-group' in domain.xml:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;server-group name="other-server-group" profile="ha"&gt;
   &lt;jvm name="default"&gt;
       &lt;heap size="64m" max-size="512m"/&gt;
   &lt;/jvm&gt;
   &lt;socket-binding-group ref="ha-sockets"/&gt;
&lt;/server-group&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We could see this server-group is using 'ha' profile, which then uses
'ha-sockets' socket binding group. It enable all the modules we need to
establish cluster later(including infinispan, jgroup and mod_cluster
modules). So we will deploy our demo project into a server that belongs
to 'other-server-group', so 'server-three' is our choice.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
In newer version of WildFly, the profile 'ha' changes to 'full-ha':
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;server-group name="other-server-group" profile="full-ha"&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s go back to domain controller&#8217;s management console:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>http://10.211.55.7:9990</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now server-three is not running, so let&#8217;s click on 'server-three' and
then click the 'start' button at bottom right of the server list. Wait a
moment and server-three should start now.</p>
</div>
<div class="paragraph">
<p>Now we should also enable 'server-three' on slave: From the top of menu
list on left side of the page, we could see now we are managing master
currently. Click on the list, and click 'slave', then choose
'server-three', and we are in slave host management page now.</p>
</div>
<div class="paragraph">
<p>Then repeat the steps we&#8217;ve done on master to start 'server-three' on
slave.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
server-three on master and slave are two different hosts, their names
can be different.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>After server-three on both master and slave are started, we will add our
cluster-demo.war for deployment. Click on the 'Manage Deployments' link
at the bottom of left menu list.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="/wildflysite/assets/img/posts/clustering/JBoss_Management.png" alt="images/clustering/JBoss_Management.png"></span><br>
(We should ensure the server-three should be started on both master and
slave)</p>
</div>
<div class="paragraph">
<p>After enter 'Manage Deployments' page, click 'Add Content' at top right
corner. Then we should choose our cluster-demo.war, and follow the
instruction to add it into our content repository.</p>
</div>
<div class="paragraph">
<p>Now we can see cluster-demo.war is added. Next we click 'Add to Groups'
button and add the war to 'other-server-group' and then click 'save'.</p>
</div>
<div class="paragraph">
<p>Wait a few seconds, management console will tell you that the project is
deployed into 'other-server-group'.：</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="/wildflysite/assets/img/posts/clustering/JBoss_Management_2.png" alt="images/clustering/JBoss_Management_2.png"></span></p>
</div>
<div class="paragraph">
<p>Please note we have two hosts participate in this server group, so the
project should be deployed in both master and slave now - that&#8217;s the
power of domain management.</p>
</div>
<div class="paragraph">
<p>Now let&#8217;s verify this, trying to access cluster-demo from both master
and slave, and they should all work now:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>http://10.211.55.7:8330/cluster-demo/</code></pre>
</div>
</div>
<div class="paragraph">
<p><span class="image"><img src="/wildflysite/assets/img/posts/clustering/http---10.211.55.7-8330-cluster-demo-.png" alt="images/clustering/http---10.211.55.7-8330-cluster-demo-.png"></span></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>http://10.211.55.2:8330/cluster-demo/</code></pre>
</div>
</div>
<div class="paragraph">
<p><span class="image"><img src="/wildflysite/assets/img/posts/clustering/http---10.211.55.2-8330-cluster-demo-.png" alt="images/clustering/http---10.211.55.2-8330-cluster-demo-.png"></span></p>
</div>
<div class="paragraph">
<p>Now that we have finished the project deployment and see the usages of
domain controller, we will then head up for using these two hosts to
establish a cluster <span class="icon yellow">[smile o]</span></p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Why is the port number 8330 instead of 8080? Please check the settings
in host.xml on both master and slave:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;server name="server-three" group="other-server-group" auto-start="false"&gt;
    &lt;!-- server-three avoids port conflicts by incrementing the ports in
         the default socket-group declared in the server-group --&gt;
    &lt;socket-bindings port-offset="250"/&gt;
&lt;/server&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The port-offset is set to 250, so 8080 + 250 = 8330</p>
</div>
<div class="paragraph">
<p>Now we quit the WildFly process on both master and slave. We have some
work left on host.xml configurations. Open the host.xml of master, and
do some modifications the servers section from:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;server name="server-three" group="other-server-group" auto-start="false"&gt;
    &lt;!-- server-three avoids port conflicts by incrementing the ports in
         the default socket-group declared in the server-group --&gt;
    &lt;socket-bindings port-offset="250"/&gt;
&lt;/server&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;server name="server-three" group="other-server-group" auto-start="true"&gt;
    &lt;!-- server-three avoids port conflicts by incrementing the ports in
         the default socket-group declared in the server-group --&gt;
    &lt;socket-bindings port-offset="250"/&gt;
&lt;/server&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;ve set auto-start to true so we don&#8217;t need to enable it in management
console each time WildFly restart. Now open slave&#8217;s host.xml, and modify
the server-three section:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;server name="server-three-slave" group="other-server-group" auto-start="true"&gt;
    &lt;!-- server-three avoids port conflicts by incrementing the ports in
         the default socket-group declared in the server-group --&gt;
    &lt;socket-bindings port-offset="250"/&gt;
&lt;/server&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Besides setting auto-start to true, we&#8217;ve renamed the 'server-three' to
'server-three-slave'. We need to do this because mod_cluster will fail
to register the hosts with same name in a single server group. It will
cause name conflict.</p>
</div>
<div class="paragraph">
<p>After finishing the above configuration, let&#8217;s restart two as7 hosts and
go on cluster configuration.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cluster-configuration">Cluster Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We will use mod_cluster + apache httpd on master as our cluster
controller here. Because WildFly has been configured to support
mod_cluster out of box so it&#8217;s the easiest way.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
The WildFly domain controller and httpd are not necessary to be on
same host. But in this article I just install them all on master for
convenience.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>First we need to ensure that httpd is installed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">sudo yum install httpd</code></pre>
</div>
</div>
<div class="paragraph">
<p>And then we need to download newer version of mod_cluster from its
website:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>http://www.jboss.org/mod_cluster/downloads</code></pre>
</div>
</div>
<div class="paragraph">
<p>The version I downloaded is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>http://downloads.jboss.org/mod_cluster/1.1.3.Final/mod_cluster-1.1.3.Final-linux2-x86-so.tar.gz</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
Jean-Frederic has suggested to use mod_cluster 1.2.x. Because 1.1.x it
is affected by CVE-2011-4608
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>With mod_cluster-1.2.0 you need to add EnableMCPMReceive in the
VirtualHost.</p>
</div>
<div class="paragraph">
<p>Then we extract it into:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>/etc/httpd/modules</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we edit httpd.conf:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">sudo vi /etc/httpd/conf/httpd.conf</code></pre>
</div>
</div>
<div class="paragraph">
<p>We should add the modules:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>LoadModule slotmem_module modules/mod_slotmem.so
LoadModule manager_module modules/mod_manager.so
LoadModule proxy_cluster_module modules/mod_proxy_cluster.so
LoadModule advertise_module modules/mod_advertise.so</code></pre>
</div>
</div>
<div class="paragraph">
<p>Please note we should comment out:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">#LoadModule proxy_balancer_module modules/mod_proxy_balancer.so</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is conflicted with cluster module. And then we need to make httpd
to listen to public address so we could do the testing. Because we
installed httpd on master host so we know the ip address of it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Listen 10.211.55.7:80</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we do the necessary configuration at the bottom of httpd.conf:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># This Listen port is for the mod_cluster-manager, where you can see the status of mod_cluster.
# Port 10001 is not a reserved port, so this prevents problems with SELinux.
Listen 10.211.55.7:10001
# This directive only applies to Red Hat Enterprise Linux. It prevents the temmporary
# files from being written to /etc/httpd/logs/ which is not an appropriate location.
MemManagerFile /var/cache/httpd
 
&lt;VirtualHost 10.211.55.7:10001&gt;
 
  &lt;Directory /&gt;
    Order deny,allow
    Deny from all
    Allow from 10.211.55.
  &lt;/Directory&gt;
 
 
  # This directive allows you to view mod_cluster status at URL http://10.211.55.4:10001/mod_cluster-manager
  &lt;Location /mod_cluster-manager&gt;
   SetHandler mod_cluster-manager
   Order deny,allow
   Deny from all
   Allow from 10.211.55.
  &lt;/Location&gt;
 
  KeepAliveTimeout 60
  MaxKeepAliveRequests 0
 
  ManagerBalancerName other-server-group
  AdvertiseFrequency 5
 
&lt;/VirtualHost&gt;</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
For more details on mod_cluster configurations please see this document:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">http://docs.jboss.org/mod_cluster/1.1.0/html/Quick_Start_Guide.html</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="testing">Testing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If everything goes fine we can start httpd service now:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">service httpd start</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we access the cluster:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>http://10.211.55.7/cluster-demo/put.jsp</code></pre>
</div>
</div>
<div class="paragraph">
<p><span class="image"><img src="/wildflysite/assets/img/posts/clustering/http---10.211.55.7-cluster-demo-put.jsp.png" alt="images/clustering/http---10.211.55.7-cluster-demo-put.jsp.png"></span></p>
</div>
<div class="paragraph">
<p>We should see the request is distributed to one of the hosts(master or
slave) from the WildFly log. For me the request is sent to master:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>[Server:server-three] 16:06:22,256 INFO  [stdout] (http-10.211.55.7-10.211.55.7-8330-4) Putting date now</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now I disconnect master by using the management interface. Select
'runtime' and the server 'master' in the upper corners.</p>
</div>
<div class="paragraph">
<p>Select 'server-three' and kick the stop button, the active-icon should
change.</p>
</div>
<div class="paragraph">
<p>Killing the server by using system commands will have the effect that
the Host-Controller restart the instance immediately!</p>
</div>
<div class="paragraph">
<p>Then wait for a few seconds and access cluster:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>http://10.211.55.7/cluster-demo/get.jsp</code></pre>
</div>
</div>
<div class="paragraph">
<p><span class="image"><img src="/wildflysite/assets/img/posts/clustering/http---10.211.55.7-cluster-demo-get.jsp.png" alt="images/clustering/http---10.211.55.7-cluster-demo-get.jsp.png"></span></p>
</div>
<div class="paragraph">
<p>Now the request should be served by slave and we should see the log from
slave:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">[Server:server-three-slave] 16:08:29,860 INFO  [stdout] (http-10.211.55.2-10.211.55.2-8330-1) Getting date now</code></pre>
</div>
</div>
<div class="paragraph">
<p>And from the get.jsp we should see that the time we get is the same
we&#8217;ve put by 'put.jsp'. Thus it&#8217;s proven that the session is correctly
replicated to slave.</p>
</div>
<div class="paragraph">
<p>Now we restart master and should see the host is registered back to
cluster.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
It doesn&#8217;t matter if you found the request is distributed to slave at
first time. Then just disconnect slave and do the testing, the request
should be sent to master instead. The point is we should see the request
is redirect from one host to another and the session is held.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="special-thanks">Special Thanks</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://community.jboss.org/people/wdfink">Wolf-Dieter Fink</a> has
contributed the updated add-user.sh usages and configs in host.xml from
7.1.0.Final.<br>
<a href="https://community.jboss.org/people/jfclere">Jean-Frederic Clere</a> provided
the mod_cluster 1.2.0 usages.<br>
Misty Stanley-Jones has given a lot of suggestions and helps to make
this document readable.</p>
</div>
</div>
</div>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/wildflysite/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Wildfly</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Wildfly</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/wildfly"><svg class="svg-icon"><use xlink:href="/wildflysite/assets/minima-social-icons.svg#github"></use></svg> <span class="username">wildfly</span></a></li><li><a href="https://www.twitter.com/WildFlyAS"><svg class="svg-icon"><use xlink:href="/wildflysite/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">WildFlyAS</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p></p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
